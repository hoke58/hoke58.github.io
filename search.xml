<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Centos 升级内核的正确姿势</title>
    <url>/systemops/centos-upgrade-kernel.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><div class="note warn">
            <p>本文仅适合在线 Yum 方式安装升级</p>
          </div>
<a id="more"></a>
<h1 id="查看当前内核版本"><a href="#查看当前内核版本" class="headerlink" title="查看当前内核版本"></a>查看当前内核版本</h1><p>升级前查看下现在发行版的内核</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># uname -sr</span></span><br><span class="line">Linux 3.10.0-1062.4.1.el7.x86_64</span><br></pre></td></tr></table></figure>
<h1 id="安装最新内核"><a href="#安装最新内核" class="headerlink" title="安装最新内核"></a>安装最新内核</h1><ol>
<li>导入 ELRepo 公钥<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>ELRepo 项目使用的 GPG 密钥的详细信息访问<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxyZXBvLm9yZy90aWtpL2tleQ==" title="https://www.elrepo.org/tiki/key">https://www.elrepo.org/tiki/key<i class="fa fa-external-link"></i></span></p>
<ol start="2">
<li>安装 ELRepo 仓库，根据自己 OS 的发行版选对应命令。</li>
</ol>
<ul>
<li><p>To install ELRepo for <strong>RHEL-8</strong> or <strong>CentOS-8</strong>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install https://www.elrepo.org/elrepo-release-8.0-2.el8.elrepo.noarch.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>To install ELRepo for <strong>RHEL-7, SL-7 or CentOS-7</strong>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>To install ELRepo for <strong>RHEL-6, SL-6 or CentOS-6</strong>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install https://www.elrepo.org/elrepo-release-6-9.el6.elrepo.noarch.rpm</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="3">
<li><p>为了使用镜像系统，请同时安装 <code>yum-plugin-fastestmirror</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install yum-plugin-fastestmirror -y</span><br></pre></td></tr></table></figure>
</li>
<li><p>ELRepo 安装后，使用下面的命令列出可用的系统内核相关包</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@yunwei ~]<span class="comment"># yum --disablerepo="*" --enablerepo="elrepo-kernel" list available</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Repository base is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line">Repository updates is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line">Repository extras is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line">Repository epel is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * elrepo-kernel: hkg.mirror.rackspace.com</span><br><span class="line">Available Packages</span><br><span class="line">kernel-lt.x86_64                                                 4.4.204-1.el7.elrepo                                elrepo-kernel</span><br><span class="line">kernel<span class="_">-lt</span>-devel.x86_64                                           4.4.204-1.el7.elrepo                                elrepo-kernel</span><br><span class="line">kernel<span class="_">-lt</span>-doc.noarch                                             4.4.204-1.el7.elrepo                                elrepo-kernel</span><br><span class="line">kernel<span class="_">-lt</span>-headers.x86_64                                         4.4.204-1.el7.elrepo                                elrepo-kernel</span><br><span class="line">kernel<span class="_">-lt</span>-tools.x86_64                                           4.4.204-1.el7.elrepo                                elrepo-kernel</span><br><span class="line">kernel<span class="_">-lt</span>-tools-libs.x86_64                                      4.4.204-1.el7.elrepo                                elrepo-kernel</span><br><span class="line">kernel<span class="_">-lt</span>-tools-libs-devel.x86_64                                4.4.204-1.el7.elrepo                                elrepo-kernel</span><br><span class="line">kernel-ml-devel.x86_64                                           5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br><span class="line">kernel-ml-doc.noarch                                             5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br><span class="line">kernel-ml-headers.x86_64                                         5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br><span class="line">kernel-ml-tools.x86_64                                           5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br><span class="line">kernel-ml-tools-libs.x86_64                                      5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br><span class="line">kernel-ml-tools-libs-devel.x86_64                                5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br><span class="line">perf.x86_64                                                      5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br><span class="line">python-perf.x86_64                                               5.4.0-1.el7.elrepo                                  elrepo-kernel</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>kernel-ml</code> 最新版本是 5.4.0 了</p>
</li>
</ol>
<ol start="5">
<li>安装最新的主线稳定内核<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum --enablerepo=elrepo-kernel install kernel-ml</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="修改grub中默认的内核版本"><a href="#修改grub中默认的内核版本" class="headerlink" title="修改grub中默认的内核版本"></a>修改grub中默认的内核版本</h1><p>内核升级完毕后，目前内核还是默认的版本，如果此时直接执行 <code>reboot</code> 命令，重启后使用的内核版本还是默认的 3.10，不会使用最新安装的内核版本，首先，我们可以通过命令查看默认启动顺序：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@yunwei ~]<span class="comment"># awk -F\' '$1=="menuentry " &#123;print $2&#125;' /etc/grub2.cfg</span></span><br><span class="line">CentOS Linux (5.4.0-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class="line">CentOS Linux (3.10.0-1062.4.1.el7.x86_64) 7 (Core)</span><br><span class="line">CentOS Linux (0-rescue-7d26c16f128042a684ea474c9e2c240f) 7 (Core)</span><br></pre></td></tr></table></figure>
<p>由上面可以看出新内核(5.4.0)目前位置在0，原来的内核(3.10.0)目前位置在1，所以如果想生效最新的内核，还需要我们修改内核的启动顺序为0：</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span><span class="keyword">default</span><span class="regexp">/grub</span></span><br></pre></td></tr></table></figure>
<p><img src="https://upyun.hoke58.cn/img/centos-upgrade-kernel-grub.jpg" alt="centos-upgrade-kernel-grub.jpg"></p>
<div class="note warn">
            <p>Centos 6 更改的文件相同，使用命令确定新内核位置后，然后将参数default更改为0即可。</p>
          </div>

<p>接着运行grub2-mkconfig命令来重新创建内核配置</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@yunwei ~]<span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br><span class="line">Generating grub configuration file ...</span><br><span class="line">Found linux image: /boot/vmlinuz-5.4.0-1.el7.elrepo.x86_64</span><br><span class="line">Found initrd image: /boot/initramfs-5.4.0-1.el7.elrepo.x86_64.img</span><br><span class="line">Found linux image: /boot/vmlinuz-3.10.0-1062.4.1.el7.x86_64</span><br><span class="line">Found initrd image: /boot/initramfs-3.10.0-1062.4.1.el7.x86_64.img</span><br><span class="line">Found linux image: /boot/vmlinuz-0-rescue-7d26c16f128042a684ea474c9e2c240f</span><br><span class="line">Found initrd image: /boot/initramfs-0-rescue-7d26c16f128042a684ea474c9e2c240f.img</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h1 id="重启，验证最新内核"><a href="#重启，验证最新内核" class="headerlink" title="重启，验证最新内核"></a>重启，验证最新内核</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">reboot</span><br><span class="line"></span><br><span class="line">[root@yunwei ~]<span class="comment"># uname -sr</span></span><br><span class="line">Linux 5.4.0-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure>

<h1 id="删除旧内核"><a href="#删除旧内核" class="headerlink" title="删除旧内核"></a>删除旧内核</h1><ol>
<li>查看系统中全部的内核 RPM 包<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@yunwei ~]<span class="comment"># rpm -aq |grep kernel</span></span><br><span class="line">kernel-headers-3.10.0-1062.4.1.el7.x86_64</span><br><span class="line">kernel-debug-devel-3.10.0-1062.4.1.el7.x86_64</span><br><span class="line">kernel-tools-libs-3.10.0-1062.4.1.el7.x86_64</span><br><span class="line">kernel-tools-3.10.0-1062.4.1.el7.x86_64</span><br><span class="line">kernel-ml-5.4.0-1.el7.elrepo.x86_64</span><br><span class="line">kernel-3.10.0-1062.4.1.el7.x86_64</span><br><span class="line">kernel-devel-3.10.0-1062.4.1.el7.x86_64</span><br></pre></td></tr></table></figure></li>
<li>删除旧内核<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum remove kernel-headers-3.10.0-1062.4.1.el7.x86_64 kernel-debug-devel-3.10.0-1062.4.1.el7.x86_64 kernel-tools-3.10.0-1062.4.1.el7.x86_64 kernel-3.10.0-1062.4.1.el7.x86_64 kernel-devel-3.10.0-1062.4.1.el7.x86_64</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="安装最新版-kernel-tool，-kernel-headers，-kernel-devel"><a href="#安装最新版-kernel-tool，-kernel-headers，-kernel-devel" class="headerlink" title="安装最新版 kernel-tool， kernel-headers， kernel-devel"></a>安装最新版 kernel-tool， kernel-headers， kernel-devel</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum --enablerepo=elrepo-kernel install kernel-ml-devel.x86_64 kernel-ml-headers.x86_64 kernel-ml-tools.x86_64</span><br></pre></td></tr></table></figure>

<h1 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2VscmVwby5vcmcvdGlraS9pbmRleC5waHA=" title="http://elrepo.org/tiki/index.php">ELRepo.org<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VybmVsLm9yZw==" title="https://www.kernel.org">The Linux Kernel Archives<i class="fa fa-external-link"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>系统运维</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>centos</tag>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>某厂 Fabric 初探</title>
    <url>/blockchain/HSL-Fabric-Test.html</url>
    <content><![CDATA[<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><p>Hyperledger Fabric v1.1.1</p>
<a id="more"></a>
<h2 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@b3f3826264fa:/<span class="comment"># peer channel list</span></span><br><span class="line">2019-12-04 02:09:39.549 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2019-12-04 02:09:39.549 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2019-12-04 02:09:39.555 UTC [channelCmd] InitCmdFactory -&gt; INFO 003 Endorser and orderer connections initialized</span><br><span class="line">2019-12-04 02:09:39.555 UTC [msp/identity] Sign -&gt; DEBU 004 Sign: plaintext: 0A9D070A5C08031A0C08E3AA9CEF0510...631A0D0A0B4765744368616E6E656C73</span><br><span class="line">2019-12-04 02:09:39.555 UTC [msp/identity] Sign -&gt; DEBU 005 Sign: digest: A33C440C5A4370A0E455D742CDA69CC36021F5B2FC192C62E99A7A5EAFD254E2</span><br><span class="line">Channels peers has joined:</span><br><span class="line">xxxx004</span><br><span class="line">xxxxchannel</span><br><span class="line">default</span><br><span class="line">factortest</span><br><span class="line">xxxx003</span><br><span class="line">2019-12-04 02:09:39.558 UTC [main] main -&gt; INFO 006 Exiting.....</span><br></pre></td></tr></table></figure>

<h2 id="chaincode"><a href="#chaincode" class="headerlink" title="chaincode"></a>chaincode</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@b3f3826264fa:/<span class="comment"># peer chaincode list --installed</span></span><br><span class="line">2019-12-04 02:07:02.544 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2019-12-04 02:07:02.544 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2019-12-04 02:07:02.544 UTC [msp/identity] Sign -&gt; DEBU 003 Sign: plaintext: 0A9D070A5C08031A0C08C6A99CEF0510...74616C6C6564436861696E636F646573</span><br><span class="line">2019-12-04 02:07:02.544 UTC [msp/identity] Sign -&gt; DEBU 004 Sign: digest: 9016D98CD8F36AA34046329907B503286F13C3D987761275FFF21453F4972DCE</span><br><span class="line">Get installed chaincodes on peer:</span><br><span class="line">Name: factor, Version: 1.0.0, Path: /var/hyperledger/production/chaincodes/xxxxchannel/factor.1.0.0, Id: 5fae66d11e0090cf4d5fb6d31c2b0af52312247553392b2653193a364eb146a6, ChannelId: xxxxchannel, TypeName: GOLANGName: factor, Version: 1.0.1, Path: /var/hyperledger/production/chaincodes/xxxxchannel/factor.1.0.1, Id: 6bd9bdeeabc4ebbb883c7e7446a3617abc7df9237f2395418d1d775939d7bde9, ChannelId: xxxxchannel, TypeName: GOLANGName: commondata, Version: 1.0.0, Path: /var/hyperledger/production/chaincodes/default/commondata.1.0.0, Id: 0b9852f6bf0d9012aa04edb7bb23722cbdc989c8ca4151929742f6162b0acd06, ChannelId: default,</span><br><span class="line">TypeName: JAVA2019-12-04 02:07:02.566 UTC [main] main -&gt; INFO 005 Exiting.....</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以查看 <strong>system channel</strong></p>
</blockquote>
<h1 id="主要差异比较"><a href="#主要差异比较" class="headerlink" title="主要差异比较"></a>主要差异比较</h1><h2 id="crypto-config-yaml"><a href="#crypto-config-yaml" class="headerlink" title="crypto-config.yaml"></a>crypto-config.yaml</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">PeerOrgs:</span></span><br><span class="line"><span class="attr">  - Name:</span> <span class="string">xxxx</span></span><br><span class="line"><span class="attr">Domain:</span> <span class="string">xxxxtest.fabric.test</span></span><br><span class="line"><span class="attr">EnableNodeOUs:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">CA:</span></span><br><span class="line"><span class="attr">  Country:</span> <span class="string">CN</span></span><br><span class="line"><span class="attr">  Province:</span> <span class="string">Beijing</span></span><br><span class="line"><span class="attr">  Locality:</span> <span class="string">Beijing</span></span><br><span class="line"><span class="attr">Specs:</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">kafka0</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">kafka1</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">kafka2</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">kafka3</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">orderer0</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">orderer1</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">peer0</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">peer1</span></span><br><span class="line"><span class="attr">  - Hostname:</span> <span class="string">sdk</span></span><br><span class="line"><span class="attr">Users:</span></span><br><span class="line"><span class="attr">  Count:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>弃用 <code>OrdererOrgs</code> Ordere 和 Peer 节点用同一套 CA</p>
<h2 id="configtx-yaml"><a href="#configtx-yaml" class="headerlink" title="configtx.yaml"></a>configtx.yaml</h2><p>仅差异部分</p>
<h3 id="Profiles-只有-xxxxOrdererGenesis-（既是-Orderer-组织，又是-Peer-组织）"><a href="#Profiles-只有-xxxxOrdererGenesis-（既是-Orderer-组织，又是-Peer-组织）" class="headerlink" title="Profiles 只有 xxxxOrdererGenesis （既是 Orderer 组织，又是 Peer 组织）"></a>Profiles 只有 xxxxOrdererGenesis （既是 Orderer 组织，又是 Peer 组织）</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Profiles:</span></span><br><span class="line"><span class="attr">xxxxOrdererGenesis:</span></span><br><span class="line"><span class="attr">Capabilities:</span></span><br><span class="line"><span class="string">&lt;&lt;:</span> <span class="meta">*ChannelCapabilities</span></span><br><span class="line"><span class="attr">Orderer:</span></span><br><span class="line"><span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></span><br><span class="line"><span class="attr">Organizations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="meta">*xxxx</span></span><br><span class="line"><span class="attr">Capabilities:</span></span><br><span class="line"><span class="string">&lt;&lt;:</span> <span class="meta">*OrdererCapabilities</span></span><br><span class="line"><span class="attr">Consortiums:</span></span><br><span class="line"><span class="attr">xxxx:</span></span><br><span class="line"><span class="attr">Organizations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="meta">*xxxx</span></span><br><span class="line"><span class="attr">Consortium:</span> <span class="string">xxxx</span></span><br><span class="line"><span class="attr">Application:</span></span><br><span class="line"><span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationDefaults</span></span><br><span class="line"><span class="attr">Organizations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="meta">*xxxx</span></span><br><span class="line"><span class="attr">Capabilities:</span></span><br><span class="line"><span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationCapabilities</span></span><br></pre></td></tr></table></figure>

<h3 id="Organizations-增加了-Role-键-orderer-peer-均用-orderer0-MSP"><a href="#Organizations-增加了-Role-键-orderer-peer-均用-orderer0-MSP" class="headerlink" title="Organizations 增加了 Role 键, orderer, peer 均用 orderer0 MSP"></a>Organizations 增加了 Role 键, orderer, peer 均用 orderer0 MSP</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Organizations:</span></span><br><span class="line">  <span class="comment"># SampleOrg defines an MSP using the sampleconfig.  It should never be used</span></span><br><span class="line">  <span class="comment"># in production but may be used as a template for other definitions</span></span><br><span class="line"><span class="bullet">  -</span> <span class="meta">&amp;xxxx</span></span><br><span class="line"><span class="comment"># DefaultOrg defines the organization which is used in the sampleconfig</span></span><br><span class="line"><span class="comment"># of the fabric.git development environment</span></span><br><span class="line"><span class="attr">Name:</span> <span class="string">xxxx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ID to load the MSP definition as</span></span><br><span class="line"><span class="attr">ID:</span> <span class="string">xxxx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MSPDir is the filesystem path which contains the MSP configuration</span></span><br><span class="line"><span class="attr">MSPDir:</span> <span class="string">xxxx.orderer0/msp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AdminPrincipal: Role.admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BCCSP (Blockchain crypto provider): Select which crypto implementation or</span></span><br><span class="line"><span class="comment"># library to use</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Role:</span> <span class="string">Core_Member,</span> <span class="string">Main_Member,</span> <span class="string">Operator,</span> <span class="string">developer,</span> <span class="string">KYC</span></span><br><span class="line"><span class="attr">AnchorPeers:</span></span><br><span class="line">  <span class="comment"># AnchorPeers defines the location of peers which can be used</span></span><br><span class="line">  <span class="comment"># for cross org gossip communication.  Note, this value is only</span></span><br><span class="line">  <span class="comment"># encoded in the genesis block in the Application section context</span></span><br><span class="line"><span class="attr">  - Host:</span> <span class="string">peer0.xxxxtest.fabric.test</span></span><br><span class="line"><span class="attr">Port:</span> <span class="number">7051</span></span><br><span class="line"><span class="attr">  - Host:</span> <span class="string">peer1.xxxxtest.fabric.test</span></span><br><span class="line"><span class="attr">Port:</span> <span class="number">7051</span></span><br></pre></td></tr></table></figure>

<h3 id="Application-增加了-EndorsementPolicy-键"><a href="#Application-增加了-EndorsementPolicy-键" class="headerlink" title="Application 增加了 EndorsementPolicy 键"></a>Application 增加了 EndorsementPolicy 键</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Application:</span> <span class="meta">&amp;ApplicationDefaults</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Organizations is the list of orgs which are defined as participants on</span></span><br><span class="line"><span class="comment"># the application side of the network</span></span><br><span class="line"><span class="attr">Organizations:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">EndorsementPolicy:</span></span><br><span class="line">   <span class="comment"># 核心成员、运营机构和KYC机构参与背书签名</span></span><br><span class="line"><span class="attr">   Role:</span> <span class="string">Core_Member,</span> <span class="string">Operator,</span> <span class="string">KYC,</span> <span class="string">Regulator</span></span><br><span class="line">   <span class="comment"># 要求超过51%的结果一致</span></span><br><span class="line"><span class="attr">   Percentage:</span> <span class="number">51</span></span><br><span class="line">   <span class="comment"># 可以特别定审计机构参与背书验证</span></span><br><span class="line">   <span class="comment"># AuditOrgMspIDs:</span></span><br><span class="line">   <span class="comment">#- xxxmspid</span></span><br></pre></td></tr></table></figure>

<h3 id="Policy"><a href="#Policy" class="headerlink" title="Policy"></a>Policy</h3><p>某厂版本未配置 <strong>Policy</strong> ，默认为<code>MAJORITY</code>, 我们定义 <strong>Policy.Rule</strong> 为 <code>ANY</code></p>
<h3 id="Orderer-切块部分配置"><a href="#Orderer-切块部分配置" class="headerlink" title="Orderer 切块部分配置"></a>Orderer 切块部分配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Orderer:</span></span><br><span class="line">  <span class="meta">&amp;OrdererDefaults</span> <span class="comment"># Batch Timeout: The amount of time to wait before creating a batch</span></span><br><span class="line"><span class="attr">  BatchTimeout:</span> <span class="number">2</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Batch Size: Controls the number of messages batched into a block</span></span><br><span class="line"><span class="attr">  BatchSize:</span></span><br><span class="line"><span class="comment"># Max Message Count: The maximum number of messages to permit in a batch</span></span><br><span class="line"><span class="attr">MaxMessageCount:</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Absolute Max Bytes: The absolute maximum number of bytes allowed for</span></span><br><span class="line"><span class="comment"># the serialized messages in a batch.</span></span><br><span class="line"><span class="attr">AbsoluteMaxBytes:</span> <span class="number">32</span> <span class="string">MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Preferred Max Bytes: The preferred maximum number of bytes allowed for</span></span><br><span class="line"><span class="comment"># the serialized messages in a batch. A message larger than the preferred</span></span><br><span class="line"><span class="comment"># max bytes will result in a batch larger than preferred max bytes.</span></span><br><span class="line"><span class="attr">PreferredMaxBytes:</span> <span class="number">512</span> <span class="string">KB</span></span><br></pre></td></tr></table></figure>

<p>对比自己的切块基线值</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Orderer:</span> <span class="meta">&amp;OrdererDefaults</span></span><br><span class="line"><span class="attr">  BatchTimeout:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">  BatchSize:</span></span><br><span class="line"><span class="attr">MaxMessageCount:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">AbsoluteMaxBytes:</span> <span class="number">98</span> <span class="string">MB</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>另外如 <code>kafka.timeout</code>, <code>peer.keepalive</code> 等类似切块的键值，对此次验证影响不大，不再列举</p>
</blockquote>
<h2 id="orderer-docker-compose-yml-及配置"><a href="#orderer-docker-compose-yml-及配置" class="headerlink" title="orderer docker-compose.yml 及配置"></a>orderer docker-compose.yml 及配置</h2><ol>
<li><p>开启客户端 <strong>TLS</strong> 认证</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置orderer节点是否开启客户端TLS连接验证</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_CLIENTAUTHREQUIRED=true</span></span><br><span class="line"><span class="comment"># 设置orderer所属机构客户端的中间TLS证书，以数组形式指定</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_CLIENTROOTCAS=[xxxx.orderer0/tls/ca.crt]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>orederer</strong> 与 <strong>kafka</strong> 通讯 <strong>TLS</strong> 证书为 <strong>MSP</strong> 证书</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Kafka:</span></span><br><span class="line"><span class="attr">  TLS:</span></span><br><span class="line"><span class="attr">PrivateKey:</span></span><br><span class="line"><span class="attr">  File:</span> <span class="string">/etc/hyperledger/fabric/xxxx.orderer0/tls/server.key</span></span><br><span class="line"><span class="attr">Certificate:</span></span><br><span class="line"><span class="attr">  File:</span> <span class="string">/etc/hyperledger/fabric/xxxx.orderer0/tls/server.crt</span></span><br><span class="line"><span class="attr">RootCAs:</span></span><br><span class="line"><span class="attr">  File:</span> <span class="string">/etc/hyperledger/fabric/tlsca.xxxxtest.fabric.test.cer</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>增加 <strong>Orderer Authentication</strong> </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">General:</span></span><br><span class="line">    <span class="comment"># Orderer Authentication</span></span><br><span class="line"><span class="attr">    Authentication:</span></span><br><span class="line"><span class="attr">        Readers:</span>    <span class="string">/Channel/Readers</span></span><br><span class="line"><span class="attr">        Writers:</span>    <span class="string">/Channel/Writes</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="peer-docker-compose-yml-及配置"><a href="#peer-docker-compose-yml-及配置" class="headerlink" title="peer docker-compose.yml 及配置"></a>peer docker-compose.yml 及配置</h2><ol>
<li><p>开启客户端/双向 <strong>TLS</strong> 认证</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CLIENTAUTHREQUIRED=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CLIENTROOTCAS_FILES=xxxx.peer0/tls/ca.crt</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>指定 <strong>Leader</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">peer:</span></span><br><span class="line"><span class="attr">  gossip:</span></span><br><span class="line"><span class="attr">useLeaderElection:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">orgLeader:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>system chaincode</strong> 启用</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">chaincode:</span></span><br><span class="line"><span class="attr">  system:</span></span><br><span class="line"><span class="attr">cscc:</span> <span class="string">enable</span></span><br><span class="line"><span class="attr">lscc:</span> <span class="string">enable</span></span><br><span class="line"><span class="attr">escc:</span> <span class="string">enable</span></span><br><span class="line"><span class="attr">vscc:</span> <span class="string">enable</span></span><br><span class="line"><span class="attr">qscc:</span> <span class="string">enable</span></span><br><span class="line"><span class="attr">rscc:</span> <span class="string">disable</span></span><br><span class="line"><span class="attr">votescc:</span> <span class="string">enable</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="操作问题记录"><a href="#操作问题记录" class="headerlink" title="操作问题记录"></a>操作问题记录</h1><p>以下操作在测试环境未找找到相关工具及痕迹，故用 <strong>fabric-samples</strong> 命令执行，记录如下</p>
<h2 id="creat-channel-artifacts"><a href="#creat-channel-artifacts" class="headerlink" title="creat channel artifacts"></a>creat channel artifacts</h2><h3 id="主要步骤"><a href="#主要步骤" class="headerlink" title="主要步骤"></a>主要步骤</h3><ol>
<li><p>使用 <strong>fabric-samples</strong> <code>configtxgen</code> 工具及某厂版本 <code>configtx.yaml</code> 生成 <strong>artifacts</strong>，结果如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /home/blockchain/cli-peer0.org1/tools]<span class="comment"># ./generate_artifacts.sh 2 xxxxchannel</span></span><br><span class="line">xxxxchannel</span><br><span class="line">mkdir: cannot create directory ‘channel-artifacts’: File exists</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">### Generating channel configuration transaction 'channel.tx' ###</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/configtxgen.old -profile xxxxOrdererGenesis -outputCreateChannelTx ./channel-artifacts/xxxxchannel_tx.pb -channelID xxxxchannel</span><br><span class="line">2019-12-04 09:43:45.891 CST [common/tools/configtxgen] main -&gt; INFO 001 Loading configuration</span><br><span class="line">2019-12-04 09:43:45.896 CST [common/tools/configtxgen/localconfig] Load -&gt; CRIT 002 Error unmarshaling config into struct:  6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">2019-12-04 09:43:45.896 CST [common/tools/configtxgen] func1 -&gt; CRIT 003 Error unmarshaling config into struct: 6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">panic: Error unmarshaling config into struct: 6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role [recovered]</span><br><span class="line">	panic: Error unmarshaling config into struct: 6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">github.com/hyperledger/fabric/vendor/github.com/op/go-logging.(*Logger).Panic(0xc4201cdc20, 0xc4202d1a20, 0x1, 0x1)</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/vendor/github.com/op/go-logging/logger.go:188 +0xc7</span><br><span class="line">main.main.func1()</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/common/tools/configtxgen/main.go:242 +0x125</span><br><span class="line">panic(0xc92ec0, 0xc4202d1a10)</span><br><span class="line">	/usr/<span class="built_in">local</span>/go/src/runtime/panic.go:491 +0x283</span><br><span class="line">github.com/hyperledger/fabric/vendor/github.com/op/go-logging.(*Logger).Panic(0xc4201cda70, 0xc4202cd180, 0x2, 0x2)</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/vendor/github.com/op/go-logging/logger.go:188 +0xc7</span><br><span class="line">github.com/hyperledger/fabric/common/tools/configtxgen/localconfig.Load(0x7ffd18f586b5, 0x12, 0x0)</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/common/tools/configtxgen/localconfig/config.go:249 +0x6c0</span><br><span class="line">main.main()</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/common/tools/configtxgen/main.go:250 +0x527</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">#######Generating anchor peer update for Org1MSP   ##########</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/configtxgen.old -profile xxxxOrdererGenesis -outputAnchorPeersUpdate ./channel-artifacts/anchorxxxxchannel_tx.pb -channelID xxxxchannel -asOrg xxxx</span><br><span class="line">2019-12-04 09:43:45.913 CST [common/tools/configtxgen] main -&gt; INFO 001 Loading configuration</span><br><span class="line">2019-12-04 09:43:45.918 CST [common/tools/configtxgen/localconfig] Load -&gt; CRIT 002 Error unmarshaling config into struct:  6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">2019-12-04 09:43:45.918 CST [common/tools/configtxgen] func1 -&gt; CRIT 003 Error unmarshaling config into struct: 6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">panic: Error unmarshaling config into struct: 6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role [recovered]</span><br><span class="line">	panic: Error unmarshaling config into struct: 6 error(s) decoding:</span><br><span class="line"></span><br><span class="line">* <span class="string">'Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application'</span> has invalid keys: EndorsementPolicy</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Application.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Consortiums[xxxx].Organizations[0]'</span> has invalid keys: Role</span><br><span class="line">* <span class="string">'Profiles[xxxxOrdererGenesis].Orderer.Organizations[0]'</span> has invalid keys: Role</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">github.com/hyperledger/fabric/vendor/github.com/op/go-logging.(*Logger).Panic(0xc420226c60, 0xc420322390, 0x1, 0x1)</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/vendor/github.com/op/go-logging/logger.go:188 +0xc7</span><br><span class="line">main.main.func1()</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/common/tools/configtxgen/main.go:242 +0x125</span><br><span class="line">panic(0xc92ec0, 0xc420322380)</span><br><span class="line">	/usr/<span class="built_in">local</span>/go/src/runtime/panic.go:491 +0x283</span><br><span class="line">github.com/hyperledger/fabric/vendor/github.com/op/go-logging.(*Logger).Panic(0xc420226ab0, 0xc420305dc0, 0x2, 0x2)</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/vendor/github.com/op/go-logging/logger.go:188 +0xc7</span><br><span class="line">github.com/hyperledger/fabric/common/tools/configtxgen/localconfig.Load(0x7ffedb4256a8, 0x12, 0x0)</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/common/tools/configtxgen/localconfig/config.go:249 +0x6c0</span><br><span class="line">main.main()</span><br><span class="line">	/home/xwu/gocode/src/github.com/hyperledger/fabric/common/tools/configtxgen/main.go:250 +0x527</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用某厂版本的 <code>configtxgen</code> 工具及 <code>configtx.yaml</code> 生成 <strong>artifacts</strong>，结果如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /home/blockchain/cli-peer0.org1/tools]<span class="comment"># ./generate_artifacts.sh 2 xxxxchannel</span></span><br><span class="line">xxxxchannel</span><br><span class="line">mkdir: cannot create directory ‘channel-artifacts’: File exists</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">### Generating channel configuration transaction 'channel.tx' ###</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/configtxgen -profile xxxxOrdererGenesis -outputCreateChannelTx ./channel-artifacts/xxxxchannel_tx.pb -channelID xxxxchannel</span><br><span class="line">2019-12-04 09:19:55.816 CST [common/tools/configtxgen] main -&gt; INFO 001 Loading configuration</span><br><span class="line">2019-12-04 09:19:55.824 CST [common/tools/configtxgen] doOutputChannelCreateTx -&gt; INFO 002 Generating new channel configtx</span><br><span class="line">2019-12-04 09:19:55.824 CST [common/tools/configtxgen] main -&gt; CRIT 003 Error on outputChannelCreateTx: config update generation failure: could not parse application to application group: setting up the MSP manager failed: expected at least one CA certificate</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">#######Generating anchor peer update for Org1MSP   ##########</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/configtxgen -profile xxxxOrdererGenesis -outputAnchorPeersUpdate ./channel-artifacts/anchorxxxxchannel_tx.pb -channelID xxxxchannel -asOrg xxxx</span><br><span class="line">2019-12-04 09:19:55.836 CST [common/tools/configtxgen] main -&gt; INFO 001 Loading configuration</span><br><span class="line">2019-12-04 09:19:55.844 CST [common/tools/configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 002 Generating anchor peer update</span><br><span class="line">2019-12-04 09:19:55.844 CST [common/tools/configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 003 Writing anchor peer update</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li>注释 <code>configtx.yaml</code> 中红框部分</li>
</ol>
<p><img src="https://upyun.hoke58.cn/img/hsl_blockchain-20191204094905.png" alt="hsl_blockchain-20191204094905.png"><br><img src="https://upyun.hoke58.cn/img/hsl_blockchain-20191204094931.png" alt="hsl_blockchain-20191204094931.png"></p>
<ol start="2">
<li>使用 <strong>fabric-samples</strong> <code>configtxgen</code> 工具生成<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /home/blockchain/cli-peer0.org1/tools]<span class="comment"># ./generate_artifacts.sh 2 xxxxchannel</span></span><br><span class="line">xxxxchannel</span><br><span class="line">mkdir: cannot create directory ‘channel-artifacts’: File exists</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">### Generating channel configuration transaction 'channel.tx' ###</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/configtxgen.old -profile xxxxOrdererGenesis -outputCreateChannelTx ./channel-artifacts/xxxxchannel_tx.pb -channelID xxxxchannel</span><br><span class="line">2019-12-04 09:22:47.365 CST [common/tools/configtxgen] main -&gt; INFO 001 Loading configuration</span><br><span class="line">2019-12-04 09:22:47.373 CST [common/tools/configtxgen] doOutputChannelCreateTx -&gt; INFO 002 Generating new channel configtx</span><br><span class="line">2019-12-04 09:22:47.399 CST [common/tools/configtxgen] doOutputChannelCreateTx -&gt; INFO 003 Writing new channel tx</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">#######Generating anchor peer update for Org1MSP   ##########</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/configtxgen.old -profile xxxxOrdererGenesis -outputAnchorPeersUpdate ./channel-artifacts/anchorxxxxchannel_tx.pb -channelID xxxxchannel -asOrg xxxx</span><br><span class="line">2019-12-04 09:22:47.415 CST [common/tools/configtxgen] main -&gt; INFO 001 Loading configuration</span><br><span class="line">2019-12-04 09:22:47.422 CST [common/tools/configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 002 Generating anchor peer update</span><br><span class="line">2019-12-04 09:22:47.423 CST [common/tools/configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 003 Writing anchor peer update</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="peer-channel-create"><a href="#peer-channel-create" class="headerlink" title="peer channel create"></a>peer channel create</h2><h3 id="主要步骤-1"><a href="#主要步骤-1" class="headerlink" title="主要步骤"></a>主要步骤</h3><ol>
<li><p>使用某厂版本的 <code>peer</code> ， 提示没有 <strong>peer channel create</strong> 命令</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /home/blockchain/cli-peer0.org1/tools]<span class="comment"># ./worktoolsxxxxfft.sh 1</span></span><br><span class="line">*******************创建 channel****************************</span><br><span class="line">使用peer可执行程序 -&gt; /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/peer.hsl</span><br><span class="line">CORE_PEER_TLS_ROOTCERT_FILE=/home/blockchain/cli-peer0.org1/tools/crypto-config/peerOrganizations/xxxxtest.fabric.test/peers/peer0.xxxxtest.fabric.test/tls/ca.crt</span><br><span class="line">CORE_PEER_LOCALMSPID=xxxx</span><br><span class="line">CORE_PEER_TLS_ENABLED=<span class="literal">true</span></span><br><span class="line">CORE_PEER_MSPCONFIGPATH=/home/blockchain/cli-peer0.org1/tools/crypto-config/peerOrganizations/xxxxtest.fabric.test/users/Admin@xxxxtest.fabric.test/msp</span><br><span class="line">CORE_PEER_ADDRESS=peer0.xxxxtest.fabric.test:7051</span><br><span class="line">peer:</span><br><span class="line"> Version: 1.1.1</span><br><span class="line"> Patch: HSL-1.5.0</span><br><span class="line"> Go version: go1.9.2</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Experimental features: <span class="literal">true</span></span><br><span class="line"> Chaincode:</span><br><span class="line">  Base Image Version: 0.4.6</span><br><span class="line">  Base Docker Namespace: hyperledger</span><br><span class="line">  Base Docker Label: org.hyperledger.fabric</span><br><span class="line">  Docker Namespace: hyperledger</span><br><span class="line"></span><br><span class="line">2019-12-04 11:35:06.791 CST [main] main -&gt; INFO 001 Exiting.....</span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/peer.hsl channel create -o orderer0.xxxxtest.fabric.test:7050 -c xxxxchannel -f ./channel-artifacts/xxxxchannel_tx.pb</span><br><span class="line">Error: unknown shorthand flag: <span class="string">'c'</span> <span class="keyword">in</span> -c</span><br><span class="line">Usage:</span><br><span class="line">  peer channel [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  fetch   Fetch a block</span><br><span class="line">  getinfo get blockchain information of a specified channel.</span><br><span class="line">  joinJoins the peer to a channel.</span><br><span class="line">  listList of channels peer has joined.</span><br><span class="line">  members List channel members.</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  --cafile string   Path to file containing PEM-encoded trusted certificate(s) <span class="keyword">for</span> the ordering endpoint</span><br><span class="line">  --certfile string Path to file containing PEM-encoded X509 public key to use <span class="keyword">for</span> mutual TLS communication with the orderer endpoint</span><br><span class="line">  --clientauth  Use mutual TLS when communicating with the orderer endpoint</span><br><span class="line">  --keyfile string  Path to file containing PEM-encoded private key to use <span class="keyword">for</span> mutual TLS communication with the orderer endpoint</span><br><span class="line">  -o, --orderer string  Ordering service endpoint</span><br><span class="line">  --ordererTLSHostnameOverride string   The hostname override to use when validating the TLS connection to the orderer.</span><br><span class="line">  --tls Use TLS when communicating with the orderer endpoint</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">  --logging-level string   Default logging level and overrides, see core.yaml <span class="keyword">for</span> full syntax</span><br><span class="line">  -v, --versionDisplay current version of fabric peer server</span><br><span class="line"></span><br><span class="line">Use <span class="string">"peer channel [command] --help"</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">+ <span class="built_in">local</span> verifyresult=1</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>fabric-samples</strong> <code>peer</code> 报错如下</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /home/blockchain/cli-peer0.org1/tools]<span class="comment"># ./worktoolsxxxxfft.sh 1</span></span><br><span class="line">*******************创建 channel****************************</span><br><span class="line">使用peer可执行程序 -&gt; /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/peer</span><br><span class="line">CORE_PEER_TLS_ROOTCERT_FILE=/home/blockchain/cli-peer0.org1/tools/crypto-config/peerOrganizations/xxxxtest.fabric.test/peers/peer0.xxxxtest.fabric.test/tls/ca.crt</span><br><span class="line">CORE_PEER_LOCALMSPID=xxxx</span><br><span class="line">CORE_PEER_TLS_ENABLED=<span class="literal">true</span></span><br><span class="line">CORE_PEER_MSPCONFIGPATH=/home/blockchain/cli-peer0.org1/tools/crypto-config/peerOrganizations/xxxxtest.fabric.test/users/Admin@xxxxtest.fabric.test/msp</span><br><span class="line">CORE_PEER_ADDRESS=peer0.xxxxtest.fabric.test:7051</span><br><span class="line">peer:</span><br><span class="line"> Version: 1.1.1</span><br><span class="line"> Go version: go1.9.2</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Experimental features: <span class="literal">false</span></span><br><span class="line"> Chaincode:</span><br><span class="line">  Base Image Version: 0.4.6</span><br><span class="line">  Base Docker Namespace: hyperledger</span><br><span class="line">  Base Docker Label: org.hyperledger.fabric</span><br><span class="line">  Docker Namespace: hyperledger</span><br><span class="line"></span><br><span class="line">2019-12-04 12:00:47.652 CST [main] main -&gt; INFO 001 Exiting.....</span><br><span class="line">+ /home/blockchain/cli-peer0.org1/tools/cryptotool/linux-amd64/bin/peer channel create -o orderer0.xxxxtest.fabric.test:7050 -c xxxxchannel -f ./channel-artifacts/xxxxchannel_tx.pb --tls <span class="literal">true</span> --cafile /home/blockchain/cli-peer0.org1/tools/crypto-config/ordererOrganizations/xxxxtest.fabric.test/orderers/orderer0.xxxxtest.fabric.test/msp/tlscacerts/tlsca.xxxxtest.fabric.test-cert.pem</span><br><span class="line">2019-12-04 12:00:47.692 CST [msp] GetLocalMSP -&gt; DEBU 001 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2019-12-04 12:00:47.692 CST [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2019-12-04 12:00:47.695 CST [channelCmd] InitCmdFactory -&gt; INFO 003 Endorser and orderer connections initialized</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetLocalMSP -&gt; DEBU 004 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetLocalMSP -&gt; DEBU 006 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetDefaultSigningIdentity -&gt; DEBU 007 Obtaining default signing identity</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp/identity] Sign -&gt; DEBU 008 Sign: plaintext: 0AB3060A046374667512AA062D2D2D2D...6F727469756D120812060A0443544655</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp/identity] Sign -&gt; DEBU 009 Sign: digest: 3D20D3A1B50641CDE2241B7E131D667C3158497039C027F39DF949FCF03CA35C</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetLocalMSP -&gt; DEBU 00a Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetDefaultSigningIdentity -&gt; DEBU 00b Obtaining default signing identity</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetLocalMSP -&gt; DEBU 00c Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp] GetDefaultSigningIdentity -&gt; DEBU 00d Obtaining default signing identity</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp/identity] Sign -&gt; DEBU 00e Sign: plaintext: 0AEF060A1A08021A0608EFDE9CEF0522...D3856AD347D982641EBF603504E4F04E</span><br><span class="line">2019-12-04 12:00:47.695 CST [msp/identity] Sign -&gt; DEBU 00f Sign: digest: ECFEBB59FDA71489900BDC45BF072EBE380619BB4644ACF399BA2ADBB05772BB</span><br><span class="line">Error: got unexpected status: FORBIDDEN -- Send config transaction directly is not allowed! please using CSCC workflow instead.</span><br><span class="line">Usage:</span><br><span class="line">  peer channel create [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -c, --channelID string   In <span class="keyword">case</span> of a newChain <span class="built_in">command</span>, the channel ID to create.</span><br><span class="line">  -f, --file stringConfiguration transaction file generated by a tool such as configtxgen <span class="keyword">for</span> submitting to orderer</span><br><span class="line">  -t, --timeout intChannel creation timeout (default 5)</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">  --cafile string   Path to file containing PEM-encoded trusted certificate(s) <span class="keyword">for</span> the ordering endpoint</span><br><span class="line">  --certfile string Path to file containing PEM-encoded X509 public key to use <span class="keyword">for</span> mutual TLS communication with the orderer endpoint</span><br><span class="line">  --clientauth  Use mutual TLS when communicating with the orderer endpoint</span><br><span class="line">  --keyfile string  Path to file containing PEM-encoded private key to use <span class="keyword">for</span> mutual TLS communication with the orderer endpoint</span><br><span class="line">  --logging-level stringDefault logging level and overrides, see core.yaml <span class="keyword">for</span> full syntax</span><br><span class="line">  -o, --orderer string  Ordering service endpoint</span><br><span class="line">  --ordererTLSHostnameOverride string   The hostname override to use when validating the TLS connection to the orderer.</span><br><span class="line">  --tls Use TLS when communicating with the orderer endpoint</span><br><span class="line">  -v, --version Display current version of fabric peer server</span><br><span class="line"></span><br><span class="line">+ <span class="built_in">local</span> verifyresult=1</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>对应 <strong>orderer</strong> 日志</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.784 UTC [orderer/common/server] Deliver -&gt; DEBU 183 Starting new Deliver handler</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.784 UTC [common/deliver] Handle -&gt; DEBU 184 Starting new deliver loop <span class="keyword">for</span> 10.10.255.47:50124</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.784 UTC [common/deliver] Handle -&gt; DEBU 185 Attempting to <span class="built_in">read</span> seek info message from 10.10.255.47:50124</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.787 UTC [orderer/common/server] Broadcast -&gt; DEBU 186 Starting new Broadcast handler</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.787 UTC [orderer/common/broadcast] Handle -&gt; DEBU 187 Starting new broadcast loop <span class="keyword">for</span> 10.10.255.47:50126</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.788 UTC [orderer/common/broadcast] Handle -&gt; WARN 188 [channel: xxxxchannel] received a config update transaction directly 10.10.255.47:50126: %!s(&lt;nil&gt;)</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.788 UTC [orderer/common/server] func1 -&gt; DEBU 189 Closing Broadcast stream</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.789 UTC [common/deliver] Handle -&gt; WARN 18a Error reading from 10.10.255.47:50124: rpc error: code = Canceled desc = context canceled</span><br><span class="line">xxxx.orderer0  | 2019-12-04 09:57:35.789 UTC [orderer/common/server] func1 -&gt; DEBU 18b Closing Deliver stream</span><br></pre></td></tr></table></figure>

<blockquote>
<p>至此 <strong>fabric-samples</strong> 命令操作对该版本底层失效</p>
</blockquote>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li>注释 <strong>configtx.yaml</strong> 文件中 <code>Organizations.Role</code>, <code>Application.EndorsementPolicy</code> 键值</li>
<li>使用 <strong>fabric-samples</strong> 提供的二进制工具重新生成 <code>genesis.block</code>, <code>channel_tx</code>, <code>anchor_tx</code></li>
<li>使用开源版本 <strong>orderer images</strong> 创建 <strong>orderer</strong> 容器</li>
<li>执行 <code>peer channel create</code>  创建 <strong>channel</strong> 成功</li>
</ol>
<blockquote>
<p>综上分析某厂重构过底层源码，无法直接操作其底层</p>
</blockquote>
<h1 id="区块链控台测试"><a href="#区块链控台测试" class="headerlink" title="区块链控台测试"></a>区块链控台测试</h1><p>test case:</p>
<ol>
<li>新增一个 peer 机构的 peer0 节点，加入 channel 安装 chaincode ==&gt; success</li>
<li>新增一个 orderer 机构的 orderer0 节点 ==&gt; failure</li>
</ol>
<p>case 2 说明： 控台功能不支持 orderer 的操作，某厂版本底层不支持开源版本命令行模式动态加盟的操作</p>
]]></content>
      <categories>
        <category>区块链</category>
      </categories>
      <tags>
        <tag>fabric</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下的/proc/[pid]目录下的文件分析</title>
    <url>/systemops/Linux-proc-pid.html</url>
    <content><![CDATA[<h1 id="auxv"><a href="#auxv" class="headerlink" title="auxv"></a>auxv</h1><p><code>/proc/[pid]/auxv</code>包含传递给进程的<code>ELF</code>解释器信息，格式是每一项都是一个<code>unsigned long</code>长度的<code>ID</code>加上一个<code>unsigned long</code>长度的值。最后一项以连续的两个<code>0x00</code>开头。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hexdump -x /proc/2948/auxv</span></span><br><span class="line">0000000    0021    0000    0000    0000    0000    1a82    7ffd    0000</span><br><span class="line">0000010    0010    0000    0000    0000    dbf5    1fc9    0000    0000</span><br><span class="line">0000020    0006    0000    0000    0000    1000    0000    0000    0000</span><br><span class="line">0000030    0011    0000    0000    0000    0064    0000    0000    0000</span><br><span class="line">0000040    0003    0000    0000    0000    2040    4326    7f4a    0000</span><br><span class="line">0000050    0004    0000    0000    0000    0038    0000    0000    0000</span><br><span class="line">0000060    0005    0000    0000    0000    0009    0000    0000    0000</span><br><span class="line">0000070    0007    0000    0000    0000    f000    4303    7f4a    0000</span><br><span class="line">0000080    0008    0000    0000    0000    0000    0000    0000    0000</span><br><span class="line">0000090    0009    0000    0000    0000    8e67    4327    7f4a    0000</span><br><span class="line">00000a0    000b    0000    0000    0000    0000    0000    0000    0000</span><br><span class="line">00000b0    000c    0000    0000    0000    0000    0000    0000    0000</span><br><span class="line">00000c0    000d    0000    0000    0000    0000    0000    0000    0000</span><br><span class="line">00000d0    000e    0000    0000    0000    0000    0000    0000    0000</span><br><span class="line">00000e0    0017    0000    0000    0000    0000    0000    0000    0000</span><br><span class="line">00000f0    0019    0000    0000    0000    3de9    1a80    7ffd    0000</span><br><span class="line">0000100    001f    0000    0000    0000    4fe5    1a80    7ffd    0000</span><br><span class="line">0000110    000f    0000    0000    0000    3df9    1a80    7ffd    0000</span><br><span class="line">0000120    0000    0000    0000    0000    0000    0000    0000    0000</span><br><span class="line">0000130</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="cmdline"><a href="#cmdline" class="headerlink" title="cmdline"></a>cmdline</h1><p><code>/proc/[pid]/cmdline</code>是一个只读文件，包含进程的完整命令行信息。如果这个进程是<code>zombie</code>进程，则这个文件没有任何内容。举例如下：    </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ps -ef | grep 2948</span></span><br><span class="line">root       2948      1  0 Nov05 ?        00:00:04 /usr/sbin/libvirtd --listen</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /proc/2948/cmdline</span></span><br><span class="line">/usr/sbin/libvirtd--listen</span><br></pre></td></tr></table></figure>
<h1 id="comm"><a href="#comm" class="headerlink" title="comm"></a>comm</h1><p><code>/proc/[pid]/comm</code>包含进程的命令名。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/2948/comm</span></span><br><span class="line">libvirtd</span><br></pre></td></tr></table></figure>
<h1 id="cwd"><a href="#cwd" class="headerlink" title="cwd"></a>cwd</h1><p><code>/proc/[pid]/cwd</code>是进程当前工作目录的符号链接。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -lt /proc/2948/cwd</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Nov  9 12:14 /proc/2948/cwd -&gt; /</span><br></pre></td></tr></table></figure>

<h1 id="environ"><a href="#environ" class="headerlink" title="environ"></a>environ</h1><p><code>/proc/[pid]/environ</code>显示进程的环境变量。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># strings /proc/2948/environ</span></span><br><span class="line">LANG=POSIX</span><br><span class="line">LC_CTYPE=en_US.UTF-8</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">NOTIFY_SOCKET=@/org/freedesktop/systemd1/notify</span><br><span class="line">LIBVIRTD_CONFIG=/etc/libvirt/libvirtd.conf</span><br><span class="line">LIBVIRTD_ARGS=--listen</span><br><span class="line">LIBVIRTD_NOFILES_LIMIT=2048</span><br></pre></td></tr></table></figure>
<h1 id="exe"><a href="#exe" class="headerlink" title="exe"></a>exe</h1><p><code>/proc/[pid]/exe</code>为实际运行程序的符号链接。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -lt /proc/2948/exe</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Nov  5 13:04 /proc/2948/exe -&gt; /usr/sbin/libvirtd</span><br></pre></td></tr></table></figure>
<h1 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h1><p><code>/proc/[pid]/fd</code>是一个目录，包含进程打开文件的情况。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -lt /proc/3801/fd</span></span><br><span class="line">total 0</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 0 -&gt; socket:[37445]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 1 -&gt; socket:[37446]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 10 -&gt; socket:[31729]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 11 -&gt; socket:[34562]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 12 -&gt; socket:[39978]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 13 -&gt; socket:[34574]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 14 -&gt; socket:[39137]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 15 -&gt; socket:[39208]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 16 -&gt; socket:[39221]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 17 -&gt; socket:[41080]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 18 -&gt; socket:[40014]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 19 -&gt; socket:[34617]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 20 -&gt; socket:[34620]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 23 -&gt; socket:[42357]</span><br><span class="line">lr-x------. 1 root root 64 Apr 18 16:51 3 -&gt; /dev/urandom</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 4 -&gt; socket:[37468]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 5 -&gt; socket:[37471]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 6 -&gt; socket:[289532]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 7 -&gt; socket:[31728]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 8 -&gt; socket:[37450]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 9 -&gt; socket:[37451]</span><br><span class="line">l-wx------. 1 root root 64 Apr 13 16:35 2 -&gt; /root/.vnc/localhost.localdomain:1.log</span><br><span class="line">```    </span><br><span class="line">目录中的每一项都是一个符号链接，指向打开的文件，数字则代表文件描述符。  </span><br><span class="line"></span><br><span class="line"><span class="comment"># latency  </span></span><br><span class="line">`/proc/[pid]/latency`显示哪些代码造成的延时比较大（使用这个`feature`，需要执行“`<span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/latencytop`”）。举例如下：  </span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># cat /proc/2948/latency</span></span><br><span class="line">Latency Top version : v0.1</span><br><span class="line">30667 10650491 4891 poll_schedule_timeout do_sys_poll SyS_poll system_call_fastpath 0x7f636573dc1d</span><br><span class="line">8 105 44 futex_wait_queue_me futex_wait do_futex SyS_futex system_call_fastpath 0x7f6365a167bc</span><br></pre></td></tr></table></figure>
<p>每一行前三个数字分别是后面代码执行的次数，总共执行延迟时间（单位是微秒）和最长执行延迟时间（单位是微秒），后面则是代码完整的调用栈。</p>
<h1 id="limits"><a href="#limits" class="headerlink" title="limits"></a>limits</h1><p><code>/proc/[pid]/limits</code>显示当前进程的资源限制。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/2948/limits</span></span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        0                    unlimited            bytes</span><br><span class="line">Max resident <span class="built_in">set</span>          unlimited            unlimited            bytes</span><br><span class="line">Max processes             6409                 6409                 processes</span><br><span class="line">Max open files            1024                 4096                 files</span><br><span class="line">Max locked memory         65536                65536                bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       6409                 6409                 signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         0                    0</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br></pre></td></tr></table></figure>
<p><code>Soft Limit</code>表示<code>kernel</code>设置给资源的值，<code>Hard Limit</code>表示<code>Soft Limit</code>的上限，而<code>Units</code>则为计量单元。</p>
<h1 id="maps"><a href="#maps" class="headerlink" title="maps"></a>maps</h1><p><code>/proc/[pid]/maps</code>显示进程的内存区域映射信息。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/2948/maps</span></span><br><span class="line">......</span><br><span class="line">address                   perms offset  dev   inode                      pathname</span><br><span class="line">7f4a2e2ad000-7f4a2e2ae000 rw-p 00006000 08:14 6505977                    /usr/lib64/sasl2/libsasldb.so.3.0.0</span><br><span class="line">7f4a2e2ae000-7f4a2e2af000 ---p 00000000 00:00 0</span><br><span class="line">7f4a2e2af000-7f4a2eaaf000 rw-p 00000000 00:00 0                          [stack:94671]</span><br><span class="line">7f4a2eaaf000-7f4a2eab0000 ---p 00000000 00:00 0</span><br><span class="line">7f4a2eab0000-7f4a2f2b0000 rw-p 00000000 00:00 0                          [stack:94670]</span><br><span class="line">......</span><br><span class="line">7f4a434d0000-7f4a434d5000 rw-p 0006e000 08:14 4292988                    /usr/sbin/libvirtd</span><br><span class="line">7f4a4520a000-7f4a452f7000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7ffd1a7e4000-7ffd1a805000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">7ffd1a820000-7ffd1a821000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br></pre></td></tr></table></figure>
<p>其中注意的一点是<code>[stack:&lt;tid&gt;]</code>是线程的堆栈信息，对应于<code>/proc/[pid]/task/[tid]/</code>路径。  </p>
<h1 id="root"><a href="#root" class="headerlink" title="root"></a>root</h1><p><code>/proc/[pid]/root</code>是进程根目录的符号链接。举例如下： </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -lt /proc/2948/root</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Nov  9 12:14 /proc/2948/root -&gt; /</span><br></pre></td></tr></table></figure>
<h1 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h1><p><code>/proc/[pid]/stack</code>显示当前进程的内核调用栈信息，只有内核编译时打开了<code>CONFIG_STACKTRACE</code>编译选项，才会生成这个文件。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/2948/stack</span></span><br><span class="line">[&lt;ffffffff80168375&gt;] poll_schedule_timeout+0x45/0x60</span><br><span class="line">[&lt;ffffffff8016994d&gt;] do_sys_poll+0x49d/0x550</span><br><span class="line">[&lt;ffffffff80169abd&gt;] SyS_poll+0x5d/0xf0</span><br><span class="line">[&lt;ffffffff804c16e7&gt;] system_call_fastpath+0x16/0x1b</span><br><span class="line">[&lt;00007f4a41ff2c1d&gt;] 0x7f4a41ff2c1d</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</span><br></pre></td></tr></table></figure>
<h1 id="statm"><a href="#statm" class="headerlink" title="statm"></a>statm</h1><p><code>/proc/[pid]/statm</code>显示进程所占用内存大小的统计信息，包含七个值，度量单位是<code>page</code>（<code>page</code>大小可通过<code>getconf PAGESIZE</code>得到）。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/2948/statm  </span></span><br><span class="line">72362 12945 4876 569 0 24665 0</span><br></pre></td></tr></table></figure>
<p>各个值含义：<br>    a）进程占用的总的内存；<br>    b）进程当前时刻占用的物理内存；<br>    c）同其它进程共享的内存；<br>    d）进程的代码段；<br>    e）共享库（从<code>2.6</code>版本起，这个值为<code>0</code>）；<br>    f）进程的堆栈；<br>    g）<code>dirty pages</code>（从<code>2.6</code>版本起，这个值为<code>0</code>）。  </p>
<h1 id="status"><a href="#status" class="headerlink" title="status"></a>status</h1><p><code>/proc/[pid]/status</code>包含进程的状态信息。其很多内容与<code>/proc/[pid]/stat</code>和<code>/proc/[pid]/statm</code>，但是却是以一种更清晰地方式展现出来。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/$$/status</span></span><br><span class="line">Name:   bash</span><br><span class="line">Umask:  0022</span><br><span class="line">State:  S (sleeping)</span><br><span class="line">Tgid:   15694</span><br><span class="line">Ngid:   0</span><br><span class="line">Pid:    15694</span><br><span class="line">PPid:   15692</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    0       0       0       0</span><br><span class="line">Gid:    0       0       0       0</span><br><span class="line">FDSize: 256</span><br><span class="line">Groups: 0 1 2 3 4 6 10 19</span><br><span class="line">NStgid: 15694</span><br><span class="line">NSpid:  15694</span><br><span class="line">NSpgid: 15694</span><br><span class="line">NSsid:  15694</span><br><span class="line">VmPeak:    26040 kB</span><br><span class="line">VmSize:    26040 kB</span><br><span class="line">VmLck:         0 kB</span><br><span class="line">VmPin:         0 kB</span><br><span class="line">VmHWM:      5412 kB</span><br><span class="line">VmRSS:      5412 kB</span><br><span class="line">RssAnon:            2272 kB</span><br><span class="line">RssFile:            3140 kB</span><br><span class="line">RssShmem:              0 kB</span><br><span class="line">VmData:     2244 kB</span><br><span class="line">VmStk:       132 kB</span><br><span class="line">VmExe:       792 kB</span><br><span class="line">VmLib:      2732 kB</span><br><span class="line">VmPTE:        68 kB</span><br><span class="line">VmPMD:        12 kB</span><br><span class="line">VmSwap:        0 kB</span><br><span class="line">HugetlbPages:          0 kB</span><br><span class="line">Threads:        1</span><br><span class="line">SigQ:   0/11753</span><br><span class="line">SigPnd: 0000000000000000</span><br><span class="line">ShdPnd: 0000000000000000</span><br><span class="line">SigBlk: 0000000000010000</span><br><span class="line">SigIgn: 0000000000380004</span><br><span class="line">SigCgt: 000000004b817efb</span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000003fffffffff</span><br><span class="line">CapEff: 0000003fffffffff</span><br><span class="line">CapBnd: 0000003fffffffff</span><br><span class="line">CapAmb: 0000000000000000</span><br><span class="line">NoNewPrivs:     0</span><br><span class="line">Seccomp:        0</span><br><span class="line">Cpus_allowed:   f</span><br><span class="line">Cpus_allowed_list:      0-3</span><br><span class="line">Mems_allowed:   00000000,00000001</span><br><span class="line">Mems_allowed_list:      0</span><br><span class="line">voluntary_ctxt_switches:        1045</span><br><span class="line">nonvoluntary_ctxt_switches:     30</span><br></pre></td></tr></table></figure>
<p>关于信号（<code>signal</code>）的信息：<code>SigQ</code>分为两部分（例如<code>0/11753</code>），前面表示当前处在队列中的信号（<code>0</code>），后面则表示队列一共可以存储多少信号（<code>11753</code>）；<code>SigPnd</code>表示当前线程<code>pending</code>的信号，而<code>ShdPnd</code>则表示整个进程<code>pending</code>的信号；<code>SigBlk</code>、<code>SigIgn</code>和<code>SigCgt</code>分别表示对信号的处理是阻塞，忽略，还是捕获。（关于<code>Unix</code>信号的相关知识，可以参考<span class="exturl" data-url="aHR0cHM6Ly93d3cubmV0d29ya3dvcmxkLmNvbS9hcnRpY2xlLzMyMTEyOTYvbGludXgvdW5peC1kZWFsaW5nLXdpdGgtc2lnbmFscy5odG1s" title="https://www.networkworld.com/article/3211296/linux/unix-dealing-with-signals.html">Unix: Dealing with signals<i class="fa fa-external-link"></i></span>）。</p>
<h1 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h1><p><code>/proc/[pid]/syscall</code>显示当前进程正在执行的系统调用。举例如下：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/2948/syscall</span></span><br><span class="line">7 0x7f4a452cbe70 0xb 0x1388 0xffffffffffdff000 0x7f4a4274a750 0x0 0x7ffd1a8033f0 0x7f4a41ff2c1d</span><br><span class="line">```    </span><br><span class="line">第一个值是系统调用号（`7`代表`poll`），后面跟着`6`个系统调用的参数值（位于寄存器中），最后两个值依次是堆栈指针和指令计数器的值。如果当前进程虽然阻塞，但阻塞函数并不是系统调用，则系统调用号的值为`-1`，后面只有堆栈指针和指令计数器的值。如果进程没有阻塞，则这个文件只有一个“`running`”的字符串。</span><br><span class="line"></span><br><span class="line">内核编译时打开了`CONFIG_HAVE_ARCH_TRACEHOOK`编译选项，才会生成这个文件。  </span><br><span class="line"></span><br><span class="line"><span class="comment"># wchan  </span></span><br><span class="line">`/proc/[pid]/wchan`显示当进程`sleep`时，`kernel`当前运行的函数。举例如下：  </span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># cat /proc/2948/wchan</span></span><br><span class="line">kauditd_thread</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>系统运维</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo+NexT打造极简个人博客[持续更新]</title>
    <url>/web/deploy-hexo-next.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>markdown</code>记录, 纯静态, <code>git</code>免费托管个人网站, 拥有网上个人小窝so easy, 来吧和我一起折腾解锁各位高阶用法</p>
<a id="more"></a>
<h2 id="环境与工具"><a href="#环境与工具" class="headerlink" title="环境与工具"></a>环境与工具</h2><ul>
<li>OS: Deepin 15.11</li>
<li>Node.js: v12.13.0</li>
<li>Npm: 6.12.0</li>
<li>Hexo: 4.0.0</li>
<li>NexT: 7.4.2</li>
<li>IDE: VS Code</li>
</ul>
<h1 id="Node-js"><a href="#Node-js" class="headerlink" title="Node.js"></a>Node.js</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnL3poLWNuL2Rvd25sb2FkLw==" title="https://nodejs.org/zh-cn/download/">Node.js官网下载页面<i class="fa fa-external-link"></i></span>选择自己的OS版本下载部署包, 推荐长期支持版（LTS）, 因为是我Linux环境, 选择<strong>Linux 二进制文件 (x64)</strong>, 以下是我的安装步骤</p>
<ol>
<li>下载二制包并解压<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-202 ~]$ wget https://nodejs.org/dist/v12.13.0/node-v12.13.0-linux-x64.tar.xz</span><br><span class="line">[root@VM-202 ~]$ sudo tar -xJvf node-v12.13.0-linux-x64.tar.xz -C /usr/local/lib</span><br><span class="line">[root@VM-202 ~]$ sudo vi /etc/profile</span><br></pre></td></tr></table></figure></li>
<li>配置<code>/etc/profile</code>, 在最后增加, 确保路径正确<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">export PATH=/usr/local/lib/node-v12.<span class="number">13.0</span>-linux-x64/bin:$PATH</span><br></pre></td></tr></table></figure></li>
<li>重载<code>/etc/profile</code>, 测试效果<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-202 ~]$ sudo source /etc/profile</span><br><span class="line">[root@VM-202 ~]$ npm version</span><br><span class="line">&#123;</span><br><span class="line">  npm: '6.12.0',</span><br><span class="line">  ares: '1.15.0',</span><br><span class="line">  brotli: '1.0.7',</span><br><span class="line">  cldr: '35.1',</span><br><span class="line">  http_parser: '2.8.0',</span><br><span class="line">  icu: '64.2',</span><br><span class="line">  llhttp: '1.1.4',</span><br><span class="line">  modules: '72',</span><br><span class="line">  napi: '5',</span><br><span class="line">  nghttp2: '1.39.2',</span><br><span class="line">  node: '12.13.0',</span><br><span class="line">  openssl: '1.1.1d',</span><br><span class="line">  tz: '2019a',</span><br><span class="line">  unicode: '12.1',</span><br><span class="line">  uv: '1.32.0',</span><br><span class="line">  v8: '7.7.299.13-node.12',</span><br><span class="line">  zlib: '1.2.11'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>配置国内镜像<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-202 ~]# npm config set registry https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置后可通过下面方式来验证是否成功</span></span><br><span class="line">[root@VM-202 ~]# npm config get registry</span><br></pre></td></tr></table></figure>
<h2 id="升级Node-js和NPM（可选）"><a href="#升级Node-js和NPM（可选）" class="headerlink" title="升级Node.js和NPM（可选）"></a>升级Node.js和NPM（可选）</h2></li>
<li>升级<strong>Node.js</strong><br><code>npm</code>中有一个模块叫做<code>n</code>, 专门用来管理<strong>Node.js</strong>版本的。<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-202 ~]# npm install -g n</span><br><span class="line">[root@VM-202 ~]# n --help</span><br><span class="line"></span><br><span class="line">Usage: n [options] [COMMAND] [args]</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line"></span><br><span class="line">  n                              Display downloaded node versions and install selection</span><br><span class="line">  n latest                       Install the latest node release (downloading if necessary)</span><br><span class="line">  n lts                          Install the latest LTS node release (downloading if necessary)</span><br><span class="line">  n &lt;version&gt;                    Install node &lt;version&gt; (downloading if necessary)</span><br><span class="line">  n run &lt;version&gt; [args ...]     Execute downloaded node &lt;version&gt; with [args ...]</span><br><span class="line">  n which &lt;version&gt;              Output path for downloaded node &lt;version&gt;</span><br><span class="line">  n exec &lt;vers&gt; &lt;cmd&gt; [args...]  Execute command with modified PATH, so downloaded node &lt;version&gt; and npm first</span><br><span class="line">  n rm &lt;version ...&gt;             Remove the given downloaded version(s)</span><br><span class="line">  n prune                        Remove all downloaded versions except the installed version</span><br><span class="line">  n --latest                     Output the latest node version available</span><br><span class="line">  n --lts                        Output the latest LTS node version available</span><br><span class="line">  n ls                           Output downloaded versions</span><br><span class="line">  n ls-remote [version]          Output matching versions available for download</span><br><span class="line">  n uninstall                    Remove the installed node and npm</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"></span><br><span class="line">  -V, --version   Output version of n</span><br><span class="line">  -h, --help      Display help information</span><br><span class="line">  -q, --quiet     Disable curl output (if available)</span><br><span class="line">  -d, --download  Download only</span><br><span class="line">  -a, --arch      Override system architecture</span><br><span class="line">  --all           ls-remote displays all matches instead of last 20</span><br><span class="line">  --insecure      Turn off certificate checking for https requests (may be needed from behind a proxy server)</span><br><span class="line"></span><br><span class="line">Aliases:</span><br><span class="line"></span><br><span class="line">  which: bin</span><br><span class="line">  run: use, as</span><br><span class="line">  ls: list</span><br><span class="line">  lsr: ls-remote</span><br><span class="line">  rm: -</span><br><span class="line">  lts: stable</span><br><span class="line">  latest: current</span><br><span class="line"></span><br><span class="line">Versions:</span><br><span class="line"></span><br><span class="line">  Numeric version numbers can be complete or incomplete, with an optional leading 'v'.</span><br><span class="line">  Versions can also be specified by label, or codename,</span><br><span class="line">  and other downloadable releases by &lt;remote-folder&gt;/&lt;version&gt;</span><br><span class="line"></span><br><span class="line">    4.9.1, 8, v6.1    Numeric versions</span><br><span class="line">    lts               Newest Long Term Support official release</span><br><span class="line">    latest, current   Newest official release</span><br><span class="line">    boron, carbon     Codenames for release streams</span><br><span class="line">    and nightly, chakracore-release/latest, rc/10 et al</span><br></pre></td></tr></table></figure>
安装最新<code>LTS</code>版<strong>Node.js</strong><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM<span class="number">-202</span> ~]#n lts</span><br></pre></td></tr></table></figure></li>
<li>升级<strong>NPM</strong><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-202 ~]# npm -g install npm</span><br><span class="line">/usr/local/bin/npm -&gt; /usr/local/lib/node_modules/npm/bin/npm-cli.js</span><br><span class="line">/usr/local/bin/npx -&gt; /usr/local/lib/node_modules/npm/bin/npx-cli.js</span><br><span class="line">+ npm@6.13.0</span><br><span class="line">added 2 packages from 2 contributors, removed 2 packages and updated 15 packages in 7.73s</span><br></pre></td></tr></table></figure></li>
<li>注释<code>/etc/profile</code>中老版本的配置<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/lib/node-v12.13.0-linux-x64/bin:<span class="variable">$PATH</span></span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p><strong>windows</strong>的童鞋可参考<span class="exturl" data-url="aHR0cDovL3d3dy5ydW5vb2IuY29tL25vZGVqcy9ub2RlanMtaW5zdGFsbC1zZXR1cC5odG1s" title="http://www.runoob.com/nodejs/nodejs-install-setup.html">菜鸟教程<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><p><strong>Linux</strong>系统下安装Git非常简单, 用包管理命令: </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install git</span><br><span class="line"></span><br><span class="line">yum install git</span><br></pre></td></tr></table></figure>
<p><strong>windows</strong>下就直接到<em><span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9kb3dubG9hZC93aW4=" title="https://git-scm.com/download/win">Git官网<i class="fa fa-external-link"></i></span></em> 下载安装即可</p>
<p>安装完成后执行 <code>git --version</code> 验证是否成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-202 ~]# git --version</span><br><span class="line">git version 2.17.0</span><br></pre></td></tr></table></figure>
<h1 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h1><p>安装<strong>Hexo</strong>只需一条命令, 详细移步至<span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3Mv" title="https://hexo.io/zh-cn/docs/">官档<i class="fa fa-external-link"></i></span>, 重点说常用命令和配置</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo init &lt;folder&gt; # 初始化一个网站. 如果没有设置 folder , Hexo 默认在目前的文件夹建立网站</span><br><span class="line">hexo new &lt;layout&gt; &lt;title&gt; # 新建一篇文章. 如果没有设置 layout 的话, 默认使用 _config.yml 中的 default_layout 参数代替. 如果标题包含空格的话, 请使用引号括起来</span><br><span class="line">hexo clean # 清除缓存文件 (db.json) 和已生成的静态文件 (public)</span><br><span class="line">hexo g # 等于hexo generate # 生成静态文件</span><br><span class="line">hexo s # 等于hexo server # 本地预览</span><br><span class="line">hexo d # 等于hexo deploy # 部署, 可与hexo g合并为 hexo d -g</span><br><span class="line">hexo version # 查看版本</span><br></pre></td></tr></table></figure>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><blockquote>
<p>注意<code>_config.yml</code>的区分：<code>hexo init</code>生成的目录下的<code>_config.yml</code>为<font color=red>Hexo配置文件</font>, <code>themes</code>目录下主题文件夹里的 <code>_config.yml</code>为<font color=red>主题配置文件</font>, 如<code>themes\next\_config.yml</code>。</p>
</blockquote>
<p>我的Hexo配置文件<code>_config.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">Hoke's</span> <span class="string">blog</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">何可的博客</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">一名追求简单实用的运维开发工程师</span></span><br><span class="line"><span class="attr">keywords:</span> <span class="string">何可,</span> <span class="string">hoke,</span> <span class="string">hoke58,</span> <span class="string">hoke58.cn,</span> <span class="string">博客,</span> <span class="string">个人博客,</span> <span class="string">个人网站,</span> <span class="string">devops,</span> <span class="string">运维,</span> <span class="string">运维开发</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">Hoke</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-CN</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">url:</span> <span class="attr">http://www.hoke58.cn</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:category/:title.html</span></span><br><span class="line"><span class="attr">permalink_defaults:</span></span><br><span class="line"><span class="attr">pretty_urls:</span></span><br><span class="line"><span class="attr">  trailing_index:</span> <span class="literal">false</span> <span class="comment"># Set to false to remove trailing index.html from permalinks</span></span><br><span class="line"><span class="attr">source_dir:</span> <span class="string">source</span></span><br><span class="line"><span class="attr">public_dir:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">archive_dir:</span> <span class="string">archives</span></span><br><span class="line"><span class="attr">category_dir:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">code_dir:</span> <span class="string">downloads/code</span></span><br><span class="line"><span class="attr">i18n_dir:</span> <span class="string">:lang</span></span><br><span class="line"><span class="attr">skip_render:</span></span><br><span class="line"><span class="attr">new_post_name:</span> <span class="string">:title.md</span> <span class="comment"># File name of new posts</span></span><br><span class="line"><span class="attr">default_layout:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">titlecase:</span> <span class="literal">false</span> <span class="comment"># Transform title into titlecase</span></span><br><span class="line"><span class="attr">external_link:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span> <span class="comment"># Open external links in new tab</span></span><br><span class="line"><span class="attr">  field:</span> <span class="string">site</span> <span class="comment"># Apply to the whole site</span></span><br><span class="line"><span class="attr">  exclude:</span></span><br><span class="line"><span class="attr">filename_case:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">render_drafts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">false</span> <span class="comment"># 启动asset文件夹</span></span><br><span class="line"><span class="attr">relative_link:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">future:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">highlight:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  line_number:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  auto_detect:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  tab_replace:</span></span><br><span class="line"><span class="attr">index_generator:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">  per_page:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  order_by:</span> <span class="bullet">-date</span></span><br><span class="line"><span class="attr">default_category:</span> <span class="string">uncategorized</span></span><br><span class="line"><span class="attr">category_map:</span></span><br><span class="line">  <span class="string">系统运维:</span> <span class="string">systemops</span></span><br><span class="line"><span class="attr">  DevOps:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">  Web:</span> <span class="string">web</span></span><br><span class="line">  <span class="string">数据库:</span> <span class="string">databases</span></span><br><span class="line"><span class="attr">  Docker:</span> <span class="string">docker</span></span><br><span class="line">  <span class="string">开发:</span> <span class="string">development</span></span><br><span class="line">  <span class="string">监控:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">tag_map:</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">meta_generator:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">date_format:</span> <span class="string">YYYY-MM-DD</span></span><br><span class="line"><span class="attr">time_format:</span> <span class="attr">HH:mm:ss</span></span><br><span class="line"><span class="attr">use_date_for_updated:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">per_page:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">pagination_dir:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line"><span class="attr">  symbols:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  time:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  total_symbols:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  total_time:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="attr">https://github.com/hoke58/hoke58.github.io</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>我的Hexo应用程序信息<code>package.json</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"hexo-site"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.0"</span>,</span><br><span class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"hexo generate"</span>,</span><br><span class="line">    <span class="attr">"clean"</span>: <span class="string">"hexo clean"</span>,</span><br><span class="line">    <span class="attr">"deploy"</span>: <span class="string">"hexo deploy"</span>,</span><br><span class="line">    <span class="attr">"server"</span>: <span class="string">"hexo server"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hexo"</span>: &#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"4.0.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"hexo"</span>: <span class="string">"^4.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-archive"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-category"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-index"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-tag"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-related-popular-posts"</span>: <span class="string">"^3.0.6"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-ejs"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-marked"</span>: <span class="string">"^2.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-stylus"</span>: <span class="string">"^1.1.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-server"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-symbols-count-time"</span>: <span class="string">"^0.6.3"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="NexT"><a href="#NexT" class="headerlink" title="NexT"></a>NexT</h1><p>使用 <code>Hexo</code> 也是因为喜欢 <code>NexT</code> 模板, 简单漂亮。本章节主要介绍安装、配置、自定义页面模板</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>最简单的安装方式是直接克隆整个仓库：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> &lt;hexo-init-folder&gt;</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>
<p>此外, 如果你想要使用其他方式, 你也可以参见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0L2Jsb2IvbWFzdGVyL2RvY3MvemgtQ04vSU5TVEFMTEFUSU9OLm1k" title="https://github.com/theme-next/hexo-theme-next/blob/master/docs/zh-CN/INSTALLATION.md">详细安装步骤<i class="fa fa-external-link"></i></span>。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在开始之前需要先将 Hexo 默认的主题配置改为 NexT</p>
<p>打开 <strong>Hexo 配置文件</strong>, 找到 <code>theme</code> 字段, 并将其值更改为 <code>next</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br></pre></td></tr></table></figure>
<p>然后 <code>hexo clean &amp;&amp; hexo g -d &amp;&amp; hexo s</code> 即可预览 NexT 默认的主题效果</p>
<h3 id="数据文件"><a href="#数据文件" class="headerlink" title="数据文件"></a>数据文件</h3><p>当使用 <code>git pull</code> 更新 NexT 主题时经常需要解决冲突问题, 而在手动下载 release 版本时也经常需要手动合并配置, 所以为了解决版本冲突的问题我们使用 NexT 的数据文件</p>
<p>如果在新的 release 中出现了任何新的选项, 那么你只需要从 <code>/themes/next/_config.yml</code> 中将他们复制到 <code>/source/_data/next.yml</code> 中并设置它们的值为你想要的选项。</p>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><ol>
<li>请确认你的 Hexo 版本为 3.0 或更高。</li>
<li>在你站点的 <code>/source/_data</code> 目录创建一个 <code>next.yml</code> 文件（如果 <code>_data</code> 目录不存在, 请创建之）。</li>
</ol>
<p align="center">以上步骤之后有 <b>两种选择</b>, 请<b>任选其一</b>然后<b>继续后面的步骤</b>。</p>

<ul>
<li><p><strong>选择 1：<code>override: false</code>（默认）</strong>：</p>
<ol>
<li>检查默认 NexT 配置中的 <code>override</code> 选项, 必须设置为 <code>false</code>。<br>在 <code>next.yml</code> 文件中, 也要设置为 <code>false</code>, 或者不定义此选项。</li>
<li>从站点配置文件（<code>/_config.yml</code>）与主题配置文件（<code>/themes/next/_config.yml</code>）中复制你需要的选项到 <code>/source/_data/next.yml</code> 中。</li>
</ol>
</li>
<li><p><strong>选择 2：<code>override: true</code></strong>：</p>
<ol>
<li>在 <code>next.yml</code> 中设置 <code>override</code> 选项为 <code>true</code>。</li>
<li>从 <code>/themes/next/_config.yml</code> 配置文件中复制<strong>所有</strong>的 NexT 主题选项到 <code>/source/_data/next.yml</code> 中。</li>
</ol>
</li>
</ul>
<ol start="3">
<li>然后, 在站点的 <code>/_config.yml</code> 中需要定义 <code>theme: next</code> 选项（如果需要的话, <code>source_dir: source</code>）。</li>
<li>使用标准参数来启动服务器, 生成或部署（<code>hexo clean &amp;&amp; hexo g -d &amp;&amp; hexo s</code>）。</li>
</ol>
<p>最佳实践为<strong>选择 1</strong> , copy 需要修改的选项至 <code>next.yml</code> , 配置文件中的注释说明基本够用, 不清楚地参考<span class="exturl" data-url="aHR0cDovL3RoZW1lLW5leHQuaWlzc25hbi5jb20vZ2V0dGluZy1zdGFydGVkLmh0bWw=" title="http://theme-next.iissnan.com/getting-started.html">NexT官方文档<i class="fa fa-external-link"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lpc3NuYW4vaGV4by10aGVtZS1uZXh0" title="https://github.com/iissnan/hexo-theme-next">NexT github<i class="fa fa-external-link"></i></span>, <code>NexT github</code>托管项目 <code>docs</code> 目录下有markdown文档, 有中文版的哦。</p>
<h3 id="自定义-scheme"><a href="#自定义-scheme" class="headerlink" title="自定义 scheme"></a><del>自定义 scheme</del></h3><div class="note info">
            <p>不建议自定义，如果官方对 scheme 有更新，需要人工检查原 scheme 的修改内容，再更新至新增的自定义 scheme，费事儿</p>
          </div>

<p><del>由于我对 scheme 修改较多, 怕 <code>git pull</code> 更新时报冲突, 干脆直接新增专用 scheme , 以下是基本思路：</del></p>
<ol>
<li>选择中意的 schemes 我是基于 Mist 基础上修改的, 在<code>/themes/next/source/css/_schemes</code>下复制 <code>Mist</code> 为 <code>Hoke</code> （自定义）</li>
<li><code>/themes/next/source/css/_variables</code>下 复制 <code>Mist.styl</code> 为 <code>Hoke.styl</code></li>
<li>全局搜索 <code>Mist</code> 在匹配到的文件中按照 <code>Mist</code> 新增 <code>Hoke</code> 部分<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">[root@VM-202 /home/hoke/Documents/blog/themes/next]# git diff scripts/filters/minify.js </span><br><span class="line">diff --git a/scripts/filters/minify.js b/scripts/filters/minify.js</span><br><span class="line">index 6640242..6238bbc 100644</span><br><span class="line"><span class="comment">--- a/scripts/filters/minify.js</span></span><br><span class="line"><span class="comment">+++ b/scripts/filters/minify.js</span></span><br><span class="line">@@ -50,4 +50,7 @@ hexo.extend.filter.register('after_generate', () =&gt; &#123;</span><br><span class="line">   &#125; else if (theme.scheme <span class="comment">=== 'Pisces' || theme.scheme === 'Gemini') &#123;</span></span><br><span class="line">     hexo.route.remove('js/schemes/muse.js');</span><br><span class="line">   &#125;</span><br><span class="line"><span class="addition">+  if (theme.scheme === 'Hoke') &#123;</span></span><br><span class="line"><span class="addition">+    hexo.route.remove('js/local-search.js');</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line">[root@VM-202 /home/hoke/Documents/blog/themes/next]# git diff source/css/_common/outline/header/github-banner.styl </span><br><span class="line">diff --git a/source/css/_common/outline/header/github-banner.styl b/source/css/_common/outline/header/github-banner.styl</span><br><span class="line">index 42a433a..434c08d 100644</span><br><span class="line"><span class="comment">--- a/source/css/_common/outline/header/github-banner.styl</span></span><br><span class="line"><span class="comment">+++ b/source/css/_common/outline/header/github-banner.styl</span></span><br><span class="line"><span class="meta">@@ -47,7 +47,7 @@</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-  if ($scheme == 'Mist') &#123;</span></span><br><span class="line"><span class="addition">+  if ($scheme == 'Mist') || ($scheme.scheme === 'Hoke') &#123;</span></span><br><span class="line">     +mobile() &#123;</span><br><span class="line">       svg &#123;</span><br><span class="line">         top: inherit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@VM-202 /home/hoke/Documents/blog/themes/next]# git diff source/js/utils.js </span><br><span class="line">diff --git a/source/js/utils.js b/source/js/utils.js</span><br><span class="line">index a249585..754423f 100644</span><br><span class="line"><span class="comment">--- a/source/js/utils.js</span></span><br><span class="line"><span class="comment">+++ b/source/js/utils.js</span></span><br><span class="line">@@ -335,6 +335,10 @@ NexT.utils = &#123;</span><br><span class="line">     return CONFIG.scheme <span class="comment">=== 'Mist';</span></span><br><span class="line">   &#125;,</span><br><span class="line"> </span><br><span class="line"><span class="addition">+  isHoke: function() &#123;</span></span><br><span class="line"><span class="addition">+    return CONFIG.scheme === 'Hoke';</span></span><br><span class="line"><span class="addition">+  &#125;, </span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   isPisces: function() &#123;</span><br><span class="line">     return CONFIG.scheme <span class="comment">=== 'Pisces';</span></span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure></li>
<li><code>/source/_data/next.yml</code> 新增 scheme<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#scheme: Muse</span></span><br><span class="line"><span class="comment">#scheme: Mist</span></span><br><span class="line"><span class="comment">#scheme: Pisces</span></span><br><span class="line"><span class="comment">#scheme: Gemini</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Hoke</span></span><br></pre></td></tr></table></figure></li>
<li>执行 <code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</code> 可预览效果, 如果遇报错别慌, 看一下报错的文件是不是哪个地方还漏改啦</li>
</ol>
<p>成功之后就可以在自定义的 scheme 上折腾啦！</p>
<h1 id="Git-及源码管理"><a href="#Git-及源码管理" class="headerlink" title="Git 及源码管理"></a>Git 及源码管理</h1><p>安装 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLWRlcGxveWVyLWdpdA==" title="https://github.com/hexojs/hexo-deployer-git">hexo-deployer-git<i class="fa fa-external-link"></i></span></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<h2 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLw==" title="https://github.com/">Github<i class="fa fa-external-link"></i></span> 需要开通 <span class="exturl" data-url="aHR0cHM6Ly9wYWdlcy5naXRodWIuY29tLw==" title="https://pages.github.com/">Github Page<i class="fa fa-external-link"></i></span> , 网上一搜一大把, 不啰嗦啦</p>
<p>打 Hexo 配置文件 <code>_config.yml</code> , 拉到底部, 修改部署配置: </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="attr">https://github.com/hoke58/hoke58.github.io</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>hexo clean &amp;&amp; hexo g -d</code> , 输入 Git 的账号和密码,完成后在浏览器输入 <code>yourName.github.io</code>, Enjoy it!</p>
<h2 id="Coding-or-Gitee"><a href="#Coding-or-Gitee" class="headerlink" title="Coding or Gitee"></a>Coding or Gitee</h2><blockquote>
<p>Gitee Pages 免费版不支持自定义域名，放弃转 coding</p>
</blockquote>
<p>登录 <span class="exturl" data-url="aHR0cHM6Ly9jb2RpbmcubmV0" title="https://coding.net">Coding<i class="fa fa-external-link"></i></span> 创建一个同名账号的 repository ，在项目仓库内一键开通 Pages 服务</p>
<p>打 Hexo 配置文件 <code>_config.yml</code> , 拉到底部, 修改部署配置: </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> </span><br><span class="line"><span class="attr">    github:</span> <span class="attr">https://github.com/hoke58/hoke58.github.io</span></span><br><span class="line"><span class="attr">    coding:</span> <span class="attr">https://git.coding.net/hoke58/hoke58.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>hexo clean &amp;&amp; hexo g -d</code> , 输入 Git 的账号和密码, 完成后在浏览器输入 <code>yourName.coding.me</code> 测试</p>
<h2 id="网站源码管理最佳实践"><a href="#网站源码管理最佳实践" class="headerlink" title="网站源码管理最佳实践"></a>网站源码管理最佳实践</h2><p>本节主要介绍如何管理网站源码</p>
<h3 id="NexT-源码"><a href="#NexT-源码" class="headerlink" title="NexT 源码"></a>NexT 源码</h3><p>大家总会对 NexT 自定义修改，目标是管理自定义修改源码兼顾 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0" title="https://github.com/theme-next/hexo-theme-next">hexo-theme-next 官方<i class="fa fa-external-link"></i></span>更新，涉及 Git 基础知识。</p>
<ol>
<li><p><code>cd themes/next</code> 进入 NexT 主题目录，本地仓库创建自己源码分支 <code>git checkout -b &lt;branch&gt;</code>, 并在该分支上修改自己的配置，源码</p>
</li>
<li><p>修改后的内容提交本地仓库</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">'注释'</span></span><br></pre></td></tr></table></figure></li>
<li><p>Fork <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0" title="https://github.com/theme-next/hexo-theme-next">hexo-theme-next<i class="fa fa-external-link"></i></span> 至自己的 Github 仓库</p>
</li>
<li><p>执行以下命令添加自己的 Fork 的仓库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git remote add github git@github.com:theme-next/hexo-theme-next.git <span class="comment"># 记得替换成自己的仓库</span></span><br><span class="line">git remote -v <span class="comment"># 添加成功后检查</span></span><br></pre></td></tr></table></figure></li>
<li><p>把当前分支推送自己 Github 远程库</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ git push -u github hoke</span><br><span class="line">Counting objects: 46, <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 4 threads.</span><br><span class="line">Compressing objects: 100% (46/46), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (46/46), 287.64 KiB | 932.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 46 (delta 18), reused 0 (delta 0)</span><br><span class="line">remote: Resolving deltas: 100% (18/18), completed with 12 <span class="built_in">local</span> objects.</span><br><span class="line">remote: </span><br><span class="line">remote: Create a pull request <span class="keyword">for</span> <span class="string">'hoke'</span> on GitHub by visiting:</span><br><span class="line">remote:      https://github.com/hoke58/hexo-theme-next/pull/new/hoke</span><br><span class="line">remote: </span><br><span class="line">To github.com:hoke58/hexo-theme-next.git</span><br><span class="line"> * [new branch]      hoke -&gt; hoke</span><br><span class="line">Branch <span class="string">'hoke'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'hoke'</span> from <span class="string">'origin'</span>.</span><br></pre></td></tr></table></figure>
<h3 id="Hexo-站点源码管理"><a href="#Hexo-站点源码管理" class="headerlink" title="Hexo 站点源码管理"></a>Hexo 站点源码管理</h3><div class="note success">
            <p>目标： 站点源码和托管在 Github 上的的静态资源同一个仓库，不同分支；站点源码库引用 NexT 源码仓库为子模块</p>
          </div>
</li>
<li><p>进入站点根目录初始化 Git 仓库 <code>git init</code></p>
</li>
<li><p>创建并切换分支 <code>git checkout -b source</code></p>
</li>
<li><p>删除或移走 NexT 主题 <code>mv themes/next /tmp</code></p>
</li>
<li><p>（可选）如果之前已生成 Git 仓库，先删除仓库中的 NexT <code>git -rm themes/next</code></p>
</li>
<li><p>添加子模块，成功后会生成 <code>.gitmodules</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git submodule add -b hoke git@github.com:hoke58/hexo-theme-next.git themes/hexo-theme-next/</span><br></pre></td></tr></table></figure></li>
<li><p>提交本地仓库</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">'新增子模块'</span></span><br></pre></td></tr></table></figure></li>
<li><p>本地 source 分支推送自己远程库 source 分支</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ git push -u origin <span class="built_in">source</span></span><br></pre></td></tr></table></figure></li>
<li><p>Github 网页上查看是否成功</p>
</li>
</ol>
<div class="note info">
            <p><code>git submodule</code> 更多说明移步 <span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9ib29rL3poL3YxL0dpdC0lRTUlQjclQTUlRTUlODUlQjctJUU1JUFEJTkwJUU2JUE4JUExJUU1JTlEJTk3" title="https://git-scm.com/book/zh/v1/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97">Git 工具 - 子模块<i class="fa fa-external-link"></i></span></p>
          </div>

<h1 id="图床"><a href="#图床" class="headerlink" title="图床"></a><span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlOUIlQkUlRTUlQkElOEE=" title="https://baike.baidu.com/item/%E5%9B%BE%E5%BA%8A">图床<i class="fa fa-external-link"></i></span></h1><p>选型之前先做了一波调研，主要就<span class="exturl" data-url="aHR0cHM6Ly9wb3J0YWwucWluaXUuY29tL3NpZ251cD9jb2RlPTFoZXRpajZ3MnpxNnE=" title="https://portal.qiniu.com/signup?code=1hetij6w2zq6q">七牛<i class="fa fa-external-link"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly9jb25zb2xlLnVweXVuLmNvbS9yZWdpc3Rlci8/aW52aXRlPXJ5dUh1MzcyUw==" title="https://console.upyun.com/register/?invite=ryuHu372S">又拍云<i class="fa fa-external-link"></i></span>, 因为需要使用 <code>CDN</code> , 简单说明:</p>
<ul>
<li>又拍云：10G 免费空间, 15G 流量, 支持 https, 需ICP备案</li>
<li>七牛云：10G 免费空间, 10G 流量, 免费版不支持 https, 需ICP、公安备案</li>
</ul>
<p><code>https</code> 已是趋势，<span class="exturl" data-url="aHR0cHM6Ly9jb25zb2xlLnVweXVuLmNvbS9yZWdpc3Rlci8/aW52aXRlPXJ5dUh1MzcyUw==" title="https://console.upyun.com/register/?invite=ryuHu372S">又拍云<i class="fa fa-external-link"></i></span>亦是老牌的 CDN</p>
<h2 id="又拍云"><a href="#又拍云" class="headerlink" title="又拍云"></a>又拍云</h2><ol>
<li>注册<span class="exturl" data-url="aHR0cHM6Ly9jb25zb2xlLnVweXVuLmNvbS9yZWdpc3Rlci8/aW52aXRlPXJ5dUh1MzcyUw==" title="https://console.upyun.com/register/?invite=ryuHu372S">又拍云<i class="fa fa-external-link"></i></span>，个人站点申请个人账号即可</li>
<li>注册成功后进入控台，点击「云存储」- 「立即使用」<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121160122.png" alt="deploy-hexo-next-20191121160122.png"></li>
<li>点击传送门<span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnVweXVuLmNvbS9rbm93bGVkZ2UtYmFzZS9xdWlja19zdGFydC8=" title="https://help.upyun.com/knowledge-base/quick_start/">开始使用又拍云存储<i class="fa fa-external-link"></i></span>，在「云存储」页面点击创建服务。</li>
<li>服务创建后，点击「配置」，根据自己的需求配置，晒一下我修改的部分<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121161742.png" alt="deploy-hexo-next-20191121161742.png"><br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121161831.png" alt="deploy-hexo-next-20191121161831.png"><br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121161910.png" alt="deploy-hexo-next-20191121161910.png"><br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121162031.png" alt="deploy-hexo-next-20191121162031.png"></li>
<li>使用 FTP 工具上传图片，传送门 <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnVweXVuLmNvbS9rbm93bGVkZ2UtYmFzZS9kZXZlbG9wZXJfdG9vbHMvI2Z0cGZ0cHM=" title="https://help.upyun.com/knowledge-base/developer_tools/#ftpftps">FTP/FTPS<i class="fa fa-external-link"></i></span>, 文件上传后可以网页上查看<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121162515.png" alt="deploy-hexo-next-20191121162515.png"></li>
<li>至此，又拍云图床服务就 OK 啦！最后也是最重要的<span class="exturl" data-url="aHR0cHM6Ly93d3cudXB5dW4uY29tL2xlYWd1ZQ==" title="https://www.upyun.com/league">加入又拍云联盟<i class="fa fa-external-link"></i></span>。下载logo，选个适合自己风格的logo把链接和logo加入网站页脚，申请后五个工作日内会有结果。</li>
</ol>
<h3 id="NexT-页脚悬挂又拍云联盟-Logo"><a href="#NexT-页脚悬挂又拍云联盟-Logo" class="headerlink" title="NexT 页脚悬挂又拍云联盟 Logo"></a>NexT 页脚悬挂<span class="exturl" data-url="aHR0cHM6Ly93d3cudXB5dW4uY29tL2xlYWd1ZQ==" title="https://www.upyun.com/league">又拍云联盟<i class="fa fa-external-link"></i></span> Logo</h3><p>先上一下效果图<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121163236.png" alt="deploy-hexo-next-20191121163236.png"></p>
<p>NexT 主题仓库修改：</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">diff --git a/languages/en.yml b/languages/en.yml</span><br><span class="line">index 84e0700..64d61e4 100644</span><br><span class="line"><span class="comment">--- a/languages/en.yml</span></span><br><span class="line"><span class="comment">+++ b/languages/en.yml</span></span><br><span class="line">@@ -49,6 +49,8 @@ footer:</span><br><span class="line">   theme: Theme</span><br><span class="line">   total_views: Total Views</span><br><span class="line">   total_visitors: Total Visitors</span><br><span class="line"><span class="addition">+  cdn: CDN by</span></span><br><span class="line"><span class="addition">+  hosted: Hosted by</span></span><br><span class="line"> </span><br><span class="line"> counter:</span><br><span class="line">   tag_cloud:</span><br><span class="line">diff --git a/languages/zh-CN.yml b/languages/zh-CN.yml</span><br><span class="line">index e816ff2..79bad18 100644</span><br><span class="line"><span class="comment">--- a/languages/zh-CN.yml</span></span><br><span class="line"><span class="comment">+++ b/languages/zh-CN.yml</span></span><br><span class="line">@@ -45,6 +45,8 @@ footer:</span><br><span class="line">   theme: 主题</span><br><span class="line">   total_views: 总访问量</span><br><span class="line">   total_visitors: 总访客量</span><br><span class="line"><span class="addition">+  cdn: CDN 加速</span></span><br><span class="line"><span class="addition">+  hosted: 主机托管于</span></span><br><span class="line"> counter:</span><br><span class="line">   tag_cloud:</span><br><span class="line">     zero: 暂无标签</span><br><span class="line">diff --git a/layout/_partials/footer.swig b/layout/_partials/footer.swig</span><br><span class="line">index 1923d8a..b7fed25 100644</span><br><span class="line"><span class="comment">--- a/layout/_partials/footer.swig</span></span><br><span class="line"><span class="comment">+++ b/layout/_partials/footer.swig</span></span><br><span class="line"><span class="meta">@@ -64,6 +64,17 @@</span></span><br><span class="line">   &lt;/div&gt;</span><br><span class="line"> &#123;%- endif %&#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+&#123;%- if theme.footer.powered.enable and theme.footer.theme.enable and theme.footer.cdn.enable %&#125;</span></span><br><span class="line"><span class="addition">+  &lt;span class="post-meta-divider"&gt;|&lt;/span&gt;</span></span><br><span class="line"><span class="addition">+&#123;%- endif %&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#123;%- if theme.footer.cdn.enable %&#125;</span></span><br><span class="line"><span class="addition">+  &lt;div class="cdn-by"&gt;</span></span><br><span class="line"><span class="addition">+  &lt;span style="display: inline-block;vertical-align: middle;"&gt;&#123;&#123;- __('footer.cdn') &#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="addition">+  &lt;a class="theme-link" href="&#123;&#123; url_for(theme.footer.cdn.link) &#125;&#125;" title="又拍云提供 CDN 服务" rel="external nofollow noopener noreferrer" target="_blank" style="display: inline-block;border: none;vertical-align: middle;"&gt;&lt;img src="&#123;&#123; url_for(theme.footer.cdn.logo) &#125;&#125;" style="width:50px"&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="addition">+  &lt;/div&gt;</span></span><br><span class="line"><span class="addition">+&#123;%- endif %&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> &#123;%- if theme.add_this_id %&#125;</span><br><span class="line">   &lt;div class="addthis_inline_share_toolbox"&gt;</span><br><span class="line">     &lt;script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=&#123;&#123; theme.add_this_id &#125;&#125;" async="async"&gt;&lt;/script&gt;</span><br><span class="line">diff --git a/source/css/_schemes/Mist/_layout.styl b/source/css/_schemes/Mist/_layout.styl</span><br><span class="line">index da82016..99560fe 100755</span><br><span class="line"><span class="comment">--- a/source/css/_schemes/Mist/_layout.styl</span></span><br><span class="line"><span class="comment">+++ b/source/css/_schemes/Mist/_layout.styl</span></span><br><span class="line">@@ -64,6 +64,10 @@ hr &#123;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+.cdn-by &#123;</span></span><br><span class="line"><span class="addition">+  display: inline-block;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // About</span><br><span class="line"> // --------------------------------------------------</span><br><span class="line"> #about-top &#123;</span><br></pre></td></tr></table></figure>

<p><code>/source/_data/next.yml</code> 自定义数据文件增加：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">footer:</span></span><br><span class="line"><span class="attr">  cdn:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    link:</span> <span class="attr">https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral</span></span><br><span class="line"><span class="attr">    logo:</span> <span class="attr">https://upyun.hoke58.cn/upyun/%E5%8F%88%E6%8B%8D%E4%BA%91_logo5.png</span></span><br></pre></td></tr></table></figure>

<h2 id="图床工具"><a href="#图床工具" class="headerlink" title="图床工具"></a>图床工具</h2><blockquote>
<p><code>PicGo</code> 支持微博图床，七牛云，腾讯云 COS，又拍云，GitHub，SM.MS 图床，阿里云 OSS，Ingur。支持 macOS、windows 64 位系统，完全免费。</p>
</blockquote>
<p>我是用<code>VScode</code>作为 markdown 编辑，主要介绍 <code>VScode</code> 插件 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BpY0dvL3ZzLXBpY2dv" title="https://github.com/PicGo/vs-picgo">vs-picgo<i class="fa fa-external-link"></i></span>，在 VSCode 里使用 picgo，实现快速上传图片到远端图床并直接将 URL 写进 Markdown 文件里，极大提升 Markdown 贴图效率与体验。支持 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01vbHVuZXJmaW5uL1BpY0dv" title="https://github.com/Molunerfinn/PicGo">PicGo<i class="fa fa-external-link"></i></span> 原生自带的 8 种图床。</p>
<ul>
<li><p>截图上传<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-vs-picgo-clipboard.gif" alt="deploy-hexo-next-vs-picgo-clipboard.gif"></p>
</li>
<li><p>文件管理器选择上传<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-vs-picgo-explorer.gif" alt="deploy-hexo-next-vs-picgo-explorer.gif"></p>
</li>
<li><p>输入文件路径上传<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-vs-picgo-inputbox.gif" alt="deploy-hexo-next-vs-picgo-inputbox.gif"></p>
</li>
</ul>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>在插件商店中查找<strong>PicGo</strong>，并安装<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121175316.png" alt="deploy-hexo-next-20191121175316.png"></p>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><details>
<summary><b>2.0.0开始, VSCode 设置中可以自定义配置 Picgo</b></summary>
<img src="https://i.loli.net/2019/04/09/5cac1821b6621.png" alt="vscode-setting.png">
</details>

<details>
<summary>首先选择当前图床，我们选择 upyun</summary>
<img src="https://i.loli.net/2019/04/09/5cac1847b5907.png" alt="current-picbed.png">
</details>

<details>
<summary>然后输入 upyun 的参数</summary>
<img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121181100.png" alt="picgo-upyun.png">
</details>

<details>
<summary>自定义上传图片的名字</summary>
<b>Notice: 如果选中文本上传，选中的部分即为上传图片的文件名</b>
<img src="https://i.loli.net/2019/04/09/5cac189446749.png" alt="image-name.png">
</details>

<details>
<summary>上传图片后md输出格式</summary>
<img src="https://i.loli.net/2019/04/09/5cac18a5c9def.png" alt="output-format.png">
</details>

<p><strong>如果你指定的<code>picgo</code>的<code>path</code>为空，那么将使用 VSCode 默认的<code>setting.json</code>作为配置文件。</strong></p>
<p>配置文件内容(usersetting.json 文件中 picgo.path 路径指定的文件)里需要配置的项主要是<code>picBed</code>：<br>详细信息可参看 <span class="exturl" data-url="aHR0cHM6Ly9waWNnby5naXRodWIuaW8vUGljR28tQ29yZS1Eb2MvemgvZ3VpZGUvY29uZmlnLmh0bWwjJUU5JUJCJTk4JUU4JUFFJUE0JUU5JTg1JThEJUU3JUJEJUFFJUU2JTk2JTg3JUU0JUJCJUI2" title="https://picgo.github.io/PicGo-Core-Doc/zh/guide/config.html#%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">PicGo-配置<i class="fa fa-external-link"></i></span></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"picgo.picBed.upyun.bucket"</span>: <span class="string">""</span>,     <span class="comment">// 存储空间名，及你的服务名</span></span><br><span class="line">    <span class="string">"picgo.picBed.upyun.operator"</span>: <span class="string">""</span>,   <span class="comment">// 操作员</span></span><br><span class="line">    <span class="string">"picgo.picBed.upyun.password"</span>: <span class="string">""</span>,   <span class="comment">// 密码</span></span><br><span class="line">    <span class="string">"picgo.picBed.upyun.path"</span>: <span class="string">""</span>,       <span class="comment">// 自定义存储路径，比如img/</span></span><br><span class="line">    <span class="string">"picgo.picBed.upyun.url"</span>: <span class="string">""</span>,        <span class="comment">// 加速域名，注意要加http://或者https://</span></span><br><span class="line">    <span class="string">"picgo.customUploadName"</span>: <span class="string">"$&#123;mdFileName&#125;-$&#123;fileName&#125;$&#123;extName&#125;"</span>,   <span class="comment">// 自定上床图片的名字</span></span><br><span class="line">    <span class="string">"picgo.picBed.current"</span>: <span class="string">"upyun"</span>      <span class="comment">// 代表当前的默认上传图床为upyun</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="键盘快捷键"><a href="#键盘快捷键" class="headerlink" title="键盘快捷键"></a>键盘快捷键</h3><table>
<thead>
<tr>
<th>OS</th>
<th>剪贴板图片上传</th>
<th>打开文件管理器上传</th>
<th>打开输入框输入路径上传</th>
</tr>
</thead>
<tbody><tr>
<td>Windows/Unix</td>
<td><kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>U</kbd></td>
<td><kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>E</kbd></td>
<td><kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>O</kbd></td>
</tr>
<tr>
<td>OsX</td>
<td><kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>U</kbd></td>
<td><kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd></td>
<td><kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>O</kbd></td>
</tr>
</tbody></table>
<p>以上快捷键均可重新自定义。</p>
<div class="note success">
            <p>使用其它编辑器的同学， 可以下载<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01vbHVuZXJmaW5uL1BpY0dvL3JlbGVhc2Vz" title="https://github.com/Molunerfinn/PicGo/releases">PicGo<i class="fa fa-external-link"></i></span>，配合使用，开始优雅地书写 Markdown 吧</p>
          </div>

<h1 id="CDN-加速"><a href="#CDN-加速" class="headerlink" title="CDN 加速"></a>CDN 加速</h1><p>远在海外的 Github，国内访问经常抽风，开始为博客加速吧</p>
<p>有了图床使用的经验，使用 CDN 相对容易上手，先上<span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnVweXVuLmNvbS9rbm93bGVkZ2UtYmFzZS9jZG4tY3JlYXRlLXNlcnZpY2Uv" title="https://help.upyun.com/knowledge-base/cdn-create-service/">官档 针对自主源，如何创建 CDN 服务？<i class="fa fa-external-link"></i></span>了解一下大概。</p>
<p>都是页面操作直接上图吧<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121191234.png" alt="deploy-hexo-next-20191121191234.png"><br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121191338.png" alt="deploy-hexo-next-20191121191338.png"><br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121191416.png" alt="deploy-hexo-next-20191121191416.png"><br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121191439.png" alt="deploy-hexo-next-20191121191439.png"><br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121191734.png" alt="deploy-hexo-next-20191121191734.png"></p>
<p>最后把 HTTPS 开启即可，上一张网站测速看一下效果吧<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-20191121193645.png" alt="deploy-hexo-next-20191121193645.png"></p>
<h1 id="启用评论系统"><a href="#启用评论系统" class="headerlink" title="启用评论系统"></a>启用评论系统</h1><p>NexT 内置了多款评论系统，博主安装了 Valine 和畅言两款评论系统进行比较供大家参考</p>
<h2 id="valine"><a href="#valine" class="headerlink" title="valine"></a>valine</h2><p>Valine 诞生于2017年8月7日，是一款基于 <code>LeanCloud</code> 的快速、简洁且高效的无后端评论系统。</p>
<p>理论上支持但不限于静态博客，目前已有<code>Hexo</code>、<code>Jekyll</code>、<code>Typecho</code>、<code>Hugo</code>、<code>Ghost</code> 等博客程序在使用 <strong>Valine</strong>。</p>
<p>先看一下效果图<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-Valine-2019-12-9" alt="deploy-hexo-next-Valine-2019-12-9"></p>
<p>启用 Valine 只需要三步</p>
<ol>
<li>注册 <span class="exturl" data-url="aHR0cHM6Ly9sZWFuY2xvdWQuY24v" title="https://leancloud.cn/">LeanCloud<i class="fa fa-external-link"></i></span> 账号, 然后再控制台左下角点击<code>创建应用</code> (应用名随意)</li>
<li>选择刚刚创建的<code>应用</code>&gt;<code>设置</code>&gt;选择<code>应用 Key</code>，然后你就能看到你的<code>APP ID</code>和<code>APP KEY</code>了<br><img src="https://upyun.hoke58.cn/img/deploy-hexo-next-Valine-setting-2019-12-9" alt="deploy-hexo-next-Valine-setting-2019-12-9"></li>
<li>拿到<code>APP ID</code>和<code>APP KEY</code>之后，设置Hexo配置文件<code>_config.yml</code><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">valine:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span> <span class="comment"># When enable is set to be true, leancloud_visitors is recommended to be closed for the re-initialization problem within different leancloud adk version</span></span><br><span class="line"><span class="attr">  appid:</span>  <span class="comment"># Your leancloud application appid</span></span><br><span class="line"><span class="attr">  appkey:</span>  <span class="comment"># Your leancloud application appkey</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="literal">true</span> <span class="comment"># Mail notifier. See: https://github.com/xCss/Valine/wiki</span></span><br><span class="line"><span class="attr">  verify:</span> <span class="literal">false</span> <span class="comment"># Verification code</span></span><br><span class="line"><span class="attr">  placeholder:</span> <span class="string">亲，欢迎评论</span> <span class="comment"># Comment box placeholder</span></span><br><span class="line"><span class="attr">  avatar:</span> <span class="string">mm</span> <span class="comment"># Gravatar style</span></span><br><span class="line"><span class="attr">  guest_info:</span> <span class="string">nick,mail</span> <span class="comment"># Custom comment header</span></span><br><span class="line"><span class="attr">  pageSize:</span> <span class="number">10</span> <span class="comment"># Pagination size</span></span><br><span class="line"><span class="attr">  language:</span> <span class="string">zh-cn</span> <span class="comment"># Language, available values: en, zh-cn</span></span><br><span class="line"><span class="attr">  visitor:</span> <span class="literal">false</span> <span class="comment"># leancloud-counter-security is not supported for now. When visitor is set to be true, appid and appkey are recommended to be the same as leancloud_visitors' for counter compatibility. Article reading statistic https://valine.js.org/visitor.html</span></span><br><span class="line"><span class="attr">  comment_count:</span> <span class="literal">true</span> <span class="comment"># If false, comment count will only be displayed in post page, not in home page</span></span><br><span class="line"><span class="attr">  recordIP:</span> <span class="literal">true</span> <span class="comment"># Whether to record the commenter IP</span></span><br><span class="line"><span class="attr">  serverURLs:</span> <span class="attr">https://leancloud.hoke58.cn</span> <span class="comment"># When the custom domain name is enabled, fill it in here (it will be detected automatically by default, no need to fill in)</span></span><br><span class="line">  <span class="comment">#post_meta_order: 0</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>最后！记得在Leancloud -&gt; 设置 -&gt; 安全中心 -&gt; Web 安全域名 把你的域名加进去</p>
<p><code>hexo clean &amp;&amp; hexo g -d &amp;&amp; hexo s</code> 是不是就能看到评论框了</p>
<h2 id="畅言"><a href="#畅言" class="headerlink" title="畅言"></a>畅言</h2><p>搜狐加持，样式美观大方，自带第三方登录系统，后台功能强大，但是需要域名备案，先上张效果图<br><img src="https://upyun.hoke58.cn/img/20191212162034-2019-12-12" alt="20191212162034-2019-12-12"></p>
<p>很遗憾的是在 Thu Dec 12 16:23:50 CST 2019 调试的时候无法登录，试了下官方也无法登录评论，已反馈至官方</p>
<p>以下是启用畅言的步骤</p>
<ol>
<li>进入 <span class="exturl" data-url="aHR0cDovL2NoYW5neWFuLmt1YWl6aGFuLmNvbQ==" title="http://changyan.kuaizhan.com">畅言<i class="fa fa-external-link"></i></span> 官网，注册账号</li>
<li>登录后添加站点信息，等待审核</li>
<li>点击 <code>后台总览</code> 获取 <code>APP ID</code>、<code>APP KEY</code>, 设置 Hexo 配置文件<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">changyan:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  appid:</span> <span class="string">cyuzQEhXS</span></span><br><span class="line"><span class="attr">  appkey:</span> </span><br><span class="line">  <span class="comment">#post_meta_order: 0</span></span><br></pre></td></tr></table></figure>
最后执行 <code>hexo clean &amp;&amp; hexo g -d &amp;&amp; hexo s</code> 查看效果</li>
</ol>
<h1 id="站内搜索"><a href="#站内搜索" class="headerlink" title="站内搜索"></a>站内搜索</h1><p>NexT 主题集成三种站内搜索： Algolia Search, Swiftype Search, Local Search。前两者都需要注册第三方服务，后者是本地搜索。简单易用原则本站采用本地搜索，也是官方推荐的方案<br>安装步骤</p>
<ol>
<li><p>在 hexo 站点根目录安装 <code>hexo-generator-searchdb</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure></li>
<li><p>编辑 hexo 配置文件增加以下内容</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">search.xml</span></span><br><span class="line"><span class="attr">  field:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">  format:</span> <span class="string">html</span></span><br><span class="line"><span class="attr">  limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></li>
<li><p>编辑 NexT 配置文件启用 Local Search</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Dependencies: https://github.com/theme-next/hexo-generator-searchdb</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If auto, trigger search by changing input.</span></span><br><span class="line">  <span class="comment"># If manual, trigger search by pressing enter key or search button.</span></span><br><span class="line"><span class="attr">  trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># Show top n results per article, show all results by setting to -1</span></span><br><span class="line"><span class="attr">  top_n_per_article:</span> <span class="bullet">-1</span></span><br><span class="line">  <span class="comment"># Unescape html strings to the readable one.</span></span><br><span class="line"><span class="attr">  unescape:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Preload the search data when the page loads.</span></span><br><span class="line"><span class="attr">  preload:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h1 id="站点地图-sitemap-xml"><a href="#站点地图-sitemap-xml" class="headerlink" title="站点地图 sitemap.xml"></a>站点地图 sitemap.xml</h1><p>生成站点地图可以提交至搜索引擎收录</p>
</li>
<li><p>在 hexo 根目录安装以下两个插件</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-baidu-sitemap --save</span><br></pre></td></tr></table></figure></li>
<li><p>重新构建网站查看效果</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>public</strong> 目录下自动生成 <strong>sitemap.xml</strong> 和 <strong>baidusitemap.xml</strong></p>
<h1 id="持续集成交付-CI-CD"><a href="#持续集成交付-CI-CD" class="headerlink" title="持续集成交付 CI/CD"></a>持续集成交付 CI/CD</h1><h2 id="达成效果"><a href="#达成效果" class="headerlink" title="达成效果"></a>达成效果</h2><p>原先发布博客流程：</p>
<ol>
<li>搭建hexo环境（一系列软件安装，配置）</li>
<li>hexo new “文章名称”</li>
<li>编写md文档</li>
<li>hexo clean</li>
<li>hexo generate</li>
<li>hexo deploy<br>使用 <span class="exturl" data-url="aHR0cHM6Ly90cmF2aXMtY2kuY29tLw==" title="https://travis-ci.com/">Travis CI<i class="fa fa-external-link"></i></span> 后简化成：</li>
<li>hexo new “文章名称”</li>
<li>编写md文档</li>
<li>git push</li>
</ol>
<p>也就是说以后发布博客只要更新源码库即可， <span class="exturl" data-url="aHR0cHM6Ly90cmF2aXMtY2kuY29tLw==" title="https://travis-ci.com/">Travis CI<i class="fa fa-external-link"></i></span> 会自动生成静态文件推送至 pages 仓库里</p>
<h2 id="配置操作"><a href="#配置操作" class="headerlink" title="配置操作"></a>配置操作</h2><ol>
<li>将 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21hcmtldHBsYWNlL3RyYXZpcy1jaQ==" title="https://github.com/marketplace/travis-ci">Travis CI<i class="fa fa-external-link"></i></span> 添加到你的 GitHub 账户中。</li>
<li>前往 GitHub 的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL2luc3RhbGxhdGlvbnM=" title="https://github.com/settings/installations">Applications settings<i class="fa fa-external-link"></i></span>，配置 Travis CI 权限，使其能够访问你的源码 repository。<br><img src="https://upyun.hoke58.cn/img/Hexo+NexT%E6%89%93%E9%80%A0%E6%9E%81%E7%AE%80%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2-20191225134406.png" alt="Hexo+NexT打造极简个人博客-20191225134406.png"></li>
<li>你应该会被重定向到 Travis CI 的页面。如果没有，请 <span class="exturl" data-url="aHR0cHM6Ly90cmF2aXMtY2kuY29tLw==" title="https://travis-ci.com/">手动前往<i class="fa fa-external-link"></i></span>。</li>
<li>在浏览器新建一个标签页，前往 GitHub <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL3Rva2Vucw==" title="https://github.com/settings/tokens">新建 Personal Access Token<i class="fa fa-external-link"></i></span>，只勾选 repo 的权限并生成一个新的 Token。Token 生成后请复制并保存好。<br><img src="https://upyun.hoke58.cn/img/Hexo+NexT%E6%89%93%E9%80%A0%E6%9E%81%E7%AE%80%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2-20191225134555.png" alt="Hexo+NexT打造极简个人博客-20191225134555.png"></li>
<li>回到 Travis CI，前往你的 repository 的设置页面，在 <strong>Environment Variables</strong> 下新建一个环境变量，<strong>Name</strong> 为 <code>GH_TOKEN</code>，Value 为刚才你在 GitHub 生成的 Token。确保 <strong>DISPLAY VALUE IN BUILD LOG</strong> 保持 不被勾选 避免你的 Token 泄漏。点击 Add 保存。<br><img src="https://upyun.hoke58.cn/img/Hexo+NexT%E6%89%93%E9%80%A0%E6%9E%81%E7%AE%80%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2-20191225114313.png" alt="Hexo+NexT打造极简个人博客-20191225114313.png"></li>
<li>前往 Github 源码库 repository 中添加 <strong>Deploy keys</strong><br><img src="https://upyun.hoke58.cn/img/Hexo+NexT%E6%89%93%E9%80%A0%E6%9E%81%E7%AE%80%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2-20191225144844.png" alt="Hexo+NexT打造极简个人博客-20191225144844.png"></li>
<li><span class="exturl" data-url="aHR0cHM6Ly90cmF2aXMtY2kuY29tLw==" title="https://travis-ci.com/">Travis CI<i class="fa fa-external-link"></i></span> <strong>Settings</strong> 中添加** SSH Key**，使其能有权限读取仓库<br><img src="https://upyun.hoke58.cn/img/Hexo+NexT%E6%89%93%E9%80%A0%E6%9E%81%E7%AE%80%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2-20191225145040.png" alt="Hexo+NexT打造极简个人博客-20191225145040.png"></li>
<li>在你的 Hexo 站点文件夹中新建一个 .travis.yml 文件：<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定构建环境是Node.js，当前版本是稳定版</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">stable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置钩子只检测blog-source分支的push变动</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">source</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置缓存文件</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">  directories:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">node_modules</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在构建之前安装hexo环境</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">install</span> <span class="bullet">-g</span> <span class="string">hexo-cli</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装git插件和搜索功能插件</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 设置git提交名，邮箱；替换真实token到_config.yml文件</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.name</span> <span class="string">$&#123;UserName&#125;</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.email</span> <span class="string">$&#123;UserEmail&#125;</span></span><br><span class="line">  <span class="comment"># 替换同目录下的_config.yml文件中github_token字符串为travis后台刚才配置的变量，注&gt;意此处sed命令用了双引号。单引号无效！</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">sed</span> <span class="bullet">-i</span> <span class="string">"s/github_token/$&#123;GH_TOKEN&#125;/g"</span> <span class="string">_config.yml</span> <span class="string">||</span> <span class="string">exit</span> <span class="number">1</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">sed</span> <span class="bullet">-i</span> <span class="string">"s/coding_token/$&#123;CODING_TOKEN&#125;/g"</span> <span class="string">_config.yml</span> <span class="string">||</span> <span class="string">exit</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行清缓存，生成网页操作</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">init</span>      <span class="comment"># 用于更新主题</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">update</span>  </span><br><span class="line"><span class="bullet">  -</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">hexo</span> <span class="string">generate</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">hexo</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># configure notifications (email, IRC, campfire etc)</span></span><br><span class="line"><span class="comment"># please update this section to your needs!</span></span><br><span class="line"><span class="comment"># https://docs.travis-ci.com/user/notifications/</span></span><br><span class="line"><span class="attr">notifications:</span></span><br><span class="line"><span class="attr">  email:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">$&#123;UserEmail&#125;</span></span><br><span class="line"><span class="attr">  on_success:</span> <span class="string">change</span></span><br><span class="line"><span class="attr">  on_failure:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure></li>
<li>修改下 hexo 站点根目录下 <code>_config.yml</code> 文件的 deploy 节点<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">[hoke@VM-202 ~/Documents/blog]$ git diff 58c6ba815d9893b6c760a6866d09079631ee27b5 d4184026a7ded278509a8b6b88cb5b98fa68c53c _config.yml</span><br><span class="line">diff --git a/_config.yml b/_config.yml</span><br><span class="line">index 6283ffb..8815cce 100644</span><br><span class="line"><span class="comment">--- a/_config.yml</span></span><br><span class="line"><span class="comment">+++ b/_config.yml</span></span><br><span class="line">@@ -108,8 +108,8 @@ symbols_count_time:</span><br><span class="line"> deploy:</span><br><span class="line">   type: git</span><br><span class="line">   repo: </span><br><span class="line"><span class="deletion">-    github: https://github.com/hoke58/hoke58.github.io</span></span><br><span class="line"><span class="deletion">-    coding: https://git.coding.net/hoke58/hoke58.git</span></span><br><span class="line"><span class="addition">+    github: https://github_token@github.com/hoke58/hoke58.github.io</span></span><br><span class="line"><span class="addition">+    coding: https://hoke58:coding_token@git.coding.net/hoke58/hoke58.git</span></span><br><span class="line">   branch: master</span><br><span class="line"> </span><br><span class="line"> search:</span><br></pre></td></tr></table></figure></li>
<li><code>git push</code> 后查看 <span class="exturl" data-url="aHR0cHM6Ly90cmF2aXMtY2kuY29tLw==" title="https://travis-ci.com/">Travis CI<i class="fa fa-external-link"></i></span> 效果<br><img src="https://upyun.hoke58.cn/img/Hexo+NexT%E6%89%93%E9%80%A0%E6%9E%81%E7%AE%80%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2-20191225140635.png" alt="Hexo+NexT打造极简个人博客-20191225140635.png"></li>
</ol>
<h2 id="Travis-的-构建流程"><a href="#Travis-的-构建流程" class="headerlink" title="Travis 的 构建流程"></a>Travis 的 构建流程</h2><ul>
<li><code>before_install</code></li>
<li><code>install</code></li>
<li><code>before_script</code></li>
<li><code>script</code></li>
<li><code>after_success</code> or <code>after_failure</code></li>
<li><code>before_deploy</code>，可选</li>
<li><code>deploy</code>，可选</li>
<li><code>after_deploy</code>，可选</li>
<li><code>after_script</code></li>
</ul>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
        <tag>Github</tag>
        <tag>Coding</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx 反代 frp https 隐藏端口并开启缓存加速</title>
    <url>/web/nginx-frp-https.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>折腾了一次用nginx反代frp https，立帖记录，如果 frp 使用的是 http 相对简单些，本文不介绍啦</p>
<blockquote>
<p>还不知道 frp 的朋友，点击项目地址 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhdGVkaWVyL2ZycA==" title="https://github.com/fatedier/frp">https://github.com/fatedier/frp<i class="fa fa-external-link"></i></span></p>
</blockquote>
<a id="more"></a>
<h2 id="流量走向"><a href="#流量走向" class="headerlink" title="流量走向"></a>流量走向</h2><p>browser client &lt;==&gt; <code>nginx（公网）</code> &lt;==&gt; <code>frps（公网）</code> &lt;==&gt; <code>frpc（内网）</code> &lt;==&gt; nginx &amp; app （内网）</p>
<h1 id="frps"><a href="#frps" class="headerlink" title="frps"></a>frps</h1><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">[common]</span></span><br><span class="line"><span class="comment"># A literal address or host name for IPv6 must be enclosed</span></span><br><span class="line"><span class="comment"># in square brackets, as in "[::1]:80", "[ipv6-host]:http" or "[ipv6-host%zone]:80"</span></span><br><span class="line"><span class="attr">bind_addr</span> = <span class="string">0.0.0.0</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="string">7000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># udp port to help make udp hole to penetrate nat</span></span><br><span class="line"><span class="attr">bind_udp_port</span> = <span class="string">7001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># udp port used for kcp protocol, it can be same with 'bind_port'</span></span><br><span class="line"><span class="comment"># if not set, kcp is disabled in frps</span></span><br><span class="line"><span class="attr">kcp_bind_port</span> = <span class="string">7000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># specify which address proxy will listen for, default value is same with bind_addr</span></span><br><span class="line"><span class="comment"># proxy_bind_addr = 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if you want to support virtual host, you must set the http port for listening (optional)</span></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> http port and https port can be same with bind_port</span></span><br><span class="line"><span class="attr">vhost_http_port</span> = <span class="string">8080</span></span><br><span class="line"><span class="attr">vhost_https_port</span> = <span class="string">8443</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set dashboard_addr and dashboard_port to view dashboard of frps</span></span><br><span class="line"><span class="comment"># dashboard_addr's default value is same with bind_addr</span></span><br><span class="line"><span class="comment"># dashboard is available only if dashboard_port is set</span></span><br><span class="line"><span class="attr">dashboard_addr</span> = <span class="string">0.0.0.0</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="string">7500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dashboard user and passwd for basic auth protect, if not set, both default value is admin</span></span><br><span class="line"><span class="attr">dashboard_user</span> = <span class="string">admin</span></span><br><span class="line"><span class="attr">dashboard_pwd</span> = <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># console or real logFile path like ./frps.log</span></span><br><span class="line"><span class="attr">log_file</span> = <span class="string">./frps.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># trace, debug, info, warn, error</span></span><br><span class="line"><span class="attr">log_level</span> = <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log_max_days</span> = <span class="string">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># auth token</span></span><br><span class="line"><span class="attr">token</span> = <span class="string">12345678</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># only allow frpc to bind ports you list, if you set nothing, there won't be any limit</span></span><br><span class="line"><span class="attr">allow_ports</span> = <span class="string">2000-3000,3001,3003,4000-50000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pool_count in each proxy will change to max_pool_count if they exceed the maximum value</span></span><br><span class="line"><span class="attr">max_pool_count</span> = <span class="string">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># max ports can be used for each client, default value is 0 means no limit</span></span><br><span class="line"><span class="attr">max_ports_per_client</span> = <span class="string">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if subdomain_host is not empty, you can set subdomain when type is http or https in frpc's configure file</span></span><br><span class="line"><span class="comment"># when subdomain is test, the host used by routing is test.frps.com</span></span><br><span class="line"><span class="attr">subdomain_host</span> = <span class="string">frps.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if tcp stream multiplexing is used, default is true</span></span><br><span class="line"><span class="attr">tcp_mux</span> = <span class="string">true</span></span><br></pre></td></tr></table></figure>

<h1 id="frpc"><a href="#frpc" class="headerlink" title="frpc"></a>frpc</h1><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># [common] is integral section</span></span><br><span class="line"><span class="attr">[common]</span></span><br><span class="line"><span class="comment"># A literal address or host name for IPv6 must be enclosed</span></span><br><span class="line"><span class="comment"># in square brackets, as in "[::1]:80", "[ipv6-host]:http" or "[ipv6-host%zone]:80"</span></span><br><span class="line"><span class="attr">server_addr</span> = <span class="string">0.0.0.0 \\frps 公网IP</span></span><br><span class="line"><span class="attr">server_port</span> = <span class="string">7000 \\frps 绑定端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果frpc不能上网还支持代理配置</span></span><br><span class="line"><span class="comment"># if you want to connect frps by http proxy or socks5 proxy, you can set http_proxy here or in global environment variables</span></span><br><span class="line"><span class="comment"># it only works when protocol is tcp</span></span><br><span class="line"><span class="comment"># http_proxy = http://user:passwd@192.168.1.128:8080</span></span><br><span class="line"><span class="comment"># http_proxy = socks5://user:passwd@192.168.1.128:1080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># console or real logFile path like ./frpc.log</span></span><br><span class="line"><span class="attr">log_file</span> = <span class="string">./frpc.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># trace, debug, info, warn, error</span></span><br><span class="line"><span class="attr">log_level</span> = <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log_max_days</span> = <span class="string">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># disable log colors when log_file is console, default is false</span></span><br><span class="line"><span class="attr">disable_log_color</span> = <span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for authentication</span></span><br><span class="line"><span class="attr">token</span> = <span class="string">12345678 \\要和 frps 值一样</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set admin address for control frpc's action by http api such as reload</span></span><br><span class="line"><span class="attr">admin_addr</span> = <span class="string">0.0.0.0</span></span><br><span class="line"><span class="attr">admin_port</span> = <span class="string">7400</span></span><br><span class="line"><span class="attr">admin_user</span> = <span class="string">admin</span></span><br><span class="line"><span class="attr">admin_pwd</span> = <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># connections will be established in advance, default value is zero</span></span><br><span class="line"><span class="attr">pool_count</span> = <span class="string">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if tcp stream multiplexing is used, default is true, it must be same with frps</span></span><br><span class="line"><span class="attr">tcp_mux</span> = <span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># your proxy name will be changed to &#123;user&#125;.&#123;proxy&#125;</span></span><br><span class="line"><span class="attr">user</span> = <span class="string">your_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># decide if exit program when first login failed, otherwise continuous relogin to frps</span></span><br><span class="line"><span class="comment"># default is true</span></span><br><span class="line"><span class="attr">login_fail_exit</span> = <span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># communication protocol used to connect to server</span></span><br><span class="line"><span class="comment"># now it supports tcp and kcp and websocket, default is tcp</span></span><br><span class="line"><span class="attr">protocol</span> = <span class="string">tcp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if tls_enable is true, frpc will connect frps by tls</span></span><br><span class="line"><span class="attr">tls_enable</span> = <span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[web02]</span></span><br><span class="line"><span class="attr">type</span> = <span class="string">https</span></span><br><span class="line"><span class="attr">local_ip</span> = <span class="string">127.0.0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="string">443</span></span><br><span class="line"><span class="attr">use_encryption</span> = <span class="string">false</span></span><br><span class="line"><span class="attr">use_compression</span> = <span class="string">false</span></span><br><span class="line"><span class="attr">subdomain</span> = <span class="string">web02</span></span><br><span class="line"><span class="comment">#custom_domains = web02.frps.com</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果 frps 设置 <code>subdomain_host</code>，在 frpc http/https 类型中可以结合 <code>subdomain</code> 使用。</p>
</blockquote>
<p>例: <code>subdomain_host = frps.com</code> , <code>subdomain = web02</code> DNS 配置泛域名 <code>*.frps.com</code> 至公网主机上， 即可直接访问 <code>https://web02.frps.com:8843</code></p>
<h1 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">	listen <span class="number">443</span> ssl http2;</span><br><span class="line">    server_name pan.hoke58.cn;</span><br><span class="line">    index index.php index.html index.htm <span class="keyword">default</span>.php <span class="keyword">default</span>.htm <span class="keyword">default</span>.html;</span><br><span class="line">    </span><br><span class="line">    #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则</span><br><span class="line">    #error_page 404/404.html;</span><br><span class="line">    #HTTP_TO_HTTPS_START</span><br><span class="line">    <span class="keyword">if</span> ($server_port !~ <span class="number">443</span>)&#123;</span><br><span class="line">        rewrite ^(<span class="regexp">/.*)$ https:/</span><span class="regexp">/$host$1 permanent;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    #HTTP_TO_HTTPS_END</span></span><br><span class="line"><span class="regexp">    ssl_certificate    /</span>www/server/panel/vhost/cert/pan.hoke58.cn/fullchain.pem;</span><br><span class="line">    ssl_certificate_key    /www/server/panel/vhost/cert/pan.hoke58.cn/privkey.pem;</span><br><span class="line">    ssl_protocols TLSv1 TLSv1<span class="number">.1</span> TLSv1<span class="number">.2</span> TLSv1<span class="number">.3</span>;</span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    ssl_session_cache shared:SSL:<span class="number">10</span>m;</span><br><span class="line">    ssl_session_timeout <span class="number">10</span>m;</span><br><span class="line">    error_page <span class="number">497</span>  https:<span class="comment">//$host$request_uri;</span></span><br><span class="line">    #SSL-END</span><br><span class="line">    </span><br><span class="line">    #ERROR-PAGE-START  错误页配置，可以注释、删除或修改</span><br><span class="line">    #error_page 404 /404.html;</span><br><span class="line">    #error_page 502 /502.html;</span><br><span class="line">    #ERROR-PAGE-END</span><br><span class="line">    </span><br><span class="line">    location ~ ^\/(?:build|tests|config|lib|<span class="number">3</span>rdparty|templates|data)\/ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^\/(?:\.|autotest|occ|issue|indie|db_|<span class="built_in">console</span>) &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location = <span class="regexp">/.well-known/</span>carddav &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">301</span> $scheme:<span class="comment">//$host:$server_port/remote.php/dav;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location = <span class="regexp">/.well-known/</span>caldav &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">301</span> $scheme:<span class="comment">//$host:$server_port/remote.php/dav;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #PROXY-START/</span><br><span class="line">    location /</span><br><span class="line">    &#123;</span><br><span class="line">    resolver <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span> ipv6=off;</span><br><span class="line">    expires <span class="number">12</span>h;</span><br><span class="line">    <span class="keyword">if</span> ($request_uri ~* <span class="string">"(php|jsp|cgi|asp|aspx)"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         expires <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    # Add headers to serve security related headers</span><br><span class="line">    # Before enabling Strict-Transport-Security headers please read into this topic first.</span><br><span class="line">    add_header Strict-Transport-Security <span class="string">"max-age=15768000; includeSubDomains; preload;"</span>;    </span><br><span class="line">    </span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass https:<span class="comment">//$host:8443; # frps https 的端口</span></span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_ssl_server_name on;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;    </span><br><span class="line">    </span><br><span class="line">    #持久化连接相关配置</span><br><span class="line">    proxy_connect_timeout <span class="number">60</span>s;</span><br><span class="line">    proxy_read_timeout <span class="number">86400</span>s;</span><br><span class="line">    proxy_send_timeout <span class="number">30</span>s;</span><br><span class="line">    proxy_http_version <span class="number">1.1</span>;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection <span class="string">"upgrade"</span>;</span><br><span class="line">    add_header X-Cache $upstream_cache_status;</span><br><span class="line">    </span><br><span class="line">    #Set Nginx Cache</span><br><span class="line">    proxy_cache cache_one;</span><br><span class="line">    proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">    proxy_cache_valid <span class="number">200</span> <span class="number">304</span> <span class="number">30</span>m;</span><br><span class="line">    proxy_cache_valid  <span class="number">301</span> <span class="number">302</span> <span class="number">24</span>h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* \.(jpg|jpeg|gif|png|svg|css|scss|js|ico|xml|woff|woff2|ttf|otf|eot)$</span><br><span class="line">    &#123;</span><br><span class="line">    resolver <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span> ipv6=off;</span><br><span class="line">    expires <span class="number">30</span>d;</span><br><span class="line">    # Add headers to serve security related headers</span><br><span class="line">    # Before enabling Strict-Transport-Security headers please read into this topic first.</span><br><span class="line">    add_header Strict-Transport-Security <span class="string">"max-age=15768000; includeSubDomains; preload;"</span>;    </span><br><span class="line">    </span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass https:<span class="comment">//$host:8443; # frps https 的端口</span></span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_ssl_server_name on;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;    </span><br><span class="line">    </span><br><span class="line">    #持久化连接相关配置</span><br><span class="line">    proxy_connect_timeout <span class="number">60</span>s;</span><br><span class="line">    proxy_read_timeout <span class="number">86400</span>s;</span><br><span class="line">    proxy_send_timeout <span class="number">30</span>s;</span><br><span class="line">    proxy_http_version <span class="number">1.1</span>;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection <span class="string">"upgrade"</span>;</span><br><span class="line">    add_header X-Cache $upstream_cache_status;</span><br><span class="line">    </span><br><span class="line">    #Set Nginx Cache</span><br><span class="line">    proxy_cache cache_one;</span><br><span class="line">    proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">    proxy_cache_valid <span class="number">200</span> <span class="number">304</span> <span class="number">301</span> <span class="number">302</span> <span class="number">3</span>d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #PROXY-END/</span><br><span class="line">    </span><br><span class="line">    #禁止访问的文件或目录</span><br><span class="line">    location ~ ^<span class="regexp">/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)</span></span><br><span class="line"><span class="regexp">    &#123;</span></span><br><span class="line"><span class="regexp">        return 404;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    </span></span><br><span class="line"><span class="regexp">    #一键申请SSL证书验证目录相关设置</span></span><br><span class="line"><span class="regexp">    location ~ \.well-known&#123;</span></span><br><span class="line"><span class="regexp">        allow all;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    </span></span><br><span class="line"><span class="regexp">	access_log  /</span>www/wwwlogs/access.log;</span><br><span class="line">    error_log  /www/wwwlogs/error.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p><code>openssl s_client -connect 127.0.0.1:443 -tls1</code></p>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>frp</tag>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx解决跨域问题</title>
    <url>/web/nginx-cors.html</url>
    <content><![CDATA[<h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>当我们当前的域名与请求接口的域名不在同一个域名下时，在浏览器Console下会看到，跨域的错误提示<br><img src="https://upyun.hoke58.cn/img/Nginx%E5%AE%8C%E7%BE%8E%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98-79cc58b1cd98dd1d7ecf836a4011fd4.png" alt="Nginx完美解决跨域问题-79cc58b1cd98dd1d7ecf836a4011fd4.png"></p>
<a id="more"></a>

<ul>
<li>当前域名<span class="exturl" data-url="aHR0cDovL2xvZy5kZW1vLmZpbnJ1bmNoYWluLmNvbTo4MDAw" title="http://log.demo.finrunchain.com:8000">http://log.demo.finrunchain.com:8000<i class="fa fa-external-link"></i></span></li>
<li>请求接口域名：<span class="exturl" data-url="aHR0cDovL2hiY2MuZGVtby5maW5ydW5jaGFpbi5jb206ODAwMA==" title="http://hbcc.demo.finrunchain.com:8000">http://hbcc.demo.finrunchain.com:8000<i class="fa fa-external-link"></i></span></li>
</ul>
<p>当在前端页面通过angularjs请求接口域名的数据时，会报跨域错误</p>
<h1 id="解决跨域方法"><a href="#解决跨域方法" class="headerlink" title="解决跨域方法"></a>解决跨域方法</h1><h2 id="nginx配置跨域"><a href="#nginx配置跨域" class="headerlink" title="nginx配置跨域"></a>nginx配置跨域</h2><ol>
<li>方法一<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">add_header <span class="keyword">Access</span>-Control-Allow-Origin * <span class="keyword">always</span>;</span><br><span class="line">add_header <span class="keyword">Access</span>-Control-Allow-Methods <span class="keyword">GET</span>,POST,PUT,<span class="keyword">DELETE</span>,<span class="keyword">OPTIONS</span> <span class="keyword">always</span>;</span><br><span class="line">add_header <span class="keyword">Access</span>-Control-Allow-Credentials <span class="keyword">true</span> <span class="keyword">always</span>;</span><br><span class="line">add_header <span class="keyword">Access</span>-Control-Allow-Headers DNT,X-CustomHeader,Keep-Alive,<span class="keyword">User</span>-Agent,X-Requested-<span class="keyword">With</span>,<span class="keyword">If</span>-Modified-Since,<span class="keyword">Cache</span>-Control,Content-Type,Authorization,x-auth-token always;</span><br><span class="line">add_header Access-Control-Max-Age <span class="number">1728000</span> <span class="keyword">always</span>;</span><br></pre></td></tr></table></figure></li>
<li>方法二<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">add_header 'Access-Control-Allow-Origin' $http_origin;</span><br><span class="line">add_header 'Access-Control-Allow-Credentials' 'true';</span><br><span class="line">add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,<span class="keyword">DELETE</span>,OPTIONS<span class="string">';</span></span><br><span class="line"><span class="string">add_header '</span><span class="keyword">Access</span>-Control-<span class="keyword">Allow</span>-Headers<span class="string">' '</span>DNT,web-token,app-token,Authorization,<span class="keyword">Accept</span>,Origin,<span class="keyword">Keep</span>-Alive,<span class="keyword">User</span>-<span class="keyword">Agent</span>,X-Mx-ReqToken,X-<span class="keyword">Data</span>-<span class="keyword">Type</span>,X-Auth-Token,X-Requested-<span class="keyword">With</span>,<span class="keyword">If</span>-Modified-Since,<span class="keyword">Cache</span>-Control,<span class="keyword">Content</span>-<span class="keyword">Type</span>,<span class="keyword">Range</span><span class="string">';</span></span><br><span class="line"><span class="string">add_header '</span><span class="keyword">Access</span>-Control-Expose-Headers<span class="string">' '</span><span class="keyword">Content</span>-<span class="keyword">Length</span>,<span class="keyword">Content</span>-<span class="keyword">Range</span><span class="string">';</span></span><br><span class="line"><span class="string">#    if ($request_method = '</span>OPTIONS<span class="string">') &#123;</span></span><br><span class="line"><span class="string">#       add_header '</span><span class="keyword">Access</span>-Control-<span class="keyword">Max</span>-Age<span class="string">' 1728000;</span></span><br><span class="line"><span class="string">#       add_header '</span><span class="keyword">Content</span>-<span class="keyword">Type</span><span class="string">' '</span><span class="built_in">text</span>/plain; charset=utf-8';</span><br><span class="line"><span class="comment">#       add_header 'Content-Length' 0;</span></span><br><span class="line"><span class="comment">#       return 204;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br></pre></td></tr></table></figure>
以上两种方法都无效</li>
<li>方法三<br>在本域名下增加接口，例如：<span class="exturl" data-url="aHR0cDovL2xvZy5kZW1vLmZpbnJ1bmNoYWluLmNvbTo4MDAwL2hiY2M=" title="http://log.demo.finrunchain.com:8000/hbcc">http://log.demo.finrunchain.com:8000/hbcc<i class="fa fa-external-link"></i></span></li>
</ol>
<p>修改nginx配置文件：</p>
<pre><code>location /hbcc {
   rewrite ^/getCat/(.*)$ /$1 break;
   proxy_pass http://localhost:4040/;
}</code></pre><p>重启nginx，跨域问题解决</p>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL语法</title>
    <url>/databases/sql.html</url>
    <content><![CDATA[<h1 id="一、基础"><a href="#一、基础" class="headerlink" title="一、基础"></a>一、基础</h1><p>模式定义了数据如何存储、存储什么样的数据以及数据如何分解等信息，数据库和表都有模式。</p>
<a id="more"></a>
<p>主键的值不允许修改，也不允许复用（不能将已经删除的主键值赋给新数据行的主键）。</p>
<p>SQL（Structured Query Language)，标准 SQL 由 ANSI 标准委员会管理，从而称为 ANSI SQL。各个 DBMS 都有自己的实现，如 PL/SQL、Transact-SQL 等。</p>
<p>SQL 语句不区分大小写，但是数据库表名、列名和值是否区分依赖于具体的 DBMS 以及配置。</p>
<p>SQL 支持以下三种注释：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 注释</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable; <span class="comment">-- 注释</span></span><br><span class="line"><span class="comment">/* 注释1</span></span><br><span class="line"><span class="comment">   注释2 */</span></span><br></pre></td></tr></table></figure>

<p>数据库创建与使用：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">USE</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>

<h1 id="二、创建表"><a href="#二、创建表" class="headerlink" title="二、创建表"></a>二、创建表</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mytable (</span><br><span class="line">  <span class="comment"># int 类型，不为空，自增</span></span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="comment"># int 类型，不可为空，默认值为 1，不为空</span></span><br><span class="line">  col1 <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">  <span class="comment"># 变长字符串类型，最长为 45 个字符，可以为空</span></span><br><span class="line">  col2 <span class="built_in">VARCHAR</span>(<span class="number">45</span>) <span class="literal">NULL</span>,</span><br><span class="line">  <span class="comment"># 日期类型，可为空</span></span><br><span class="line">  col3 <span class="built_in">DATE</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="comment"># 设置主键为 id</span></span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>));</span><br></pre></td></tr></table></figure>

<h1 id="三、修改表"><a href="#三、修改表" class="headerlink" title="三、修改表"></a>三、修改表</h1><p>添加列</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">col</span> <span class="built_in">CHAR</span>(<span class="number">20</span>);</span><br></pre></td></tr></table></figure>

<p>删除列</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> <span class="keyword">col</span>;</span><br></pre></td></tr></table></figure>

<p>删除表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> mytable;</span><br></pre></td></tr></table></figure>

<h1 id="四、插入"><a href="#四、插入" class="headerlink" title="四、插入"></a>四、插入</h1><p>普通插入</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mytable(col1, col2)</span><br><span class="line"><span class="keyword">VALUES</span>(val1, val2);</span><br></pre></td></tr></table></figure>

<p>插入检索出来的数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mytable1(col1, col2)</span><br><span class="line"><span class="keyword">SELECT</span> col1, col2</span><br><span class="line"><span class="keyword">FROM</span> mytable2;</span><br></pre></td></tr></table></figure>

<p>将一个表的内容插入到一个新表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> newtable <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>

<h1 id="五、更新"><a href="#五、更新" class="headerlink" title="五、更新"></a>五、更新</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> mytable</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">col</span> = val</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h1 id="六、删除"><a href="#六、删除" class="headerlink" title="六、删除"></a>六、删除</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><strong>TRUNCATE TABLE</strong>   可以清空表，也就是删除所有行。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> mytable;</span><br></pre></td></tr></table></figure>

<p>使用更新和删除操作时一定要用 WHERE 子句，不然会把整张表的数据都破坏。可以先用 SELECT 语句进行测试，防止错误删除。</p>
<h1 id="七、查询"><a href="#七、查询" class="headerlink" title="七、查询"></a>七、查询</h1><h2 id="DISTINCT"><a href="#DISTINCT" class="headerlink" title="DISTINCT"></a>DISTINCT</h2><p>相同值只会出现一次。它作用于所有列，也就是说所有列的值都相同才算相同。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> col1, col2</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>

<h2 id="LIMIT"><a href="#LIMIT" class="headerlink" title="LIMIT"></a>LIMIT</h2><p>限制返回的行数。可以有两个参数，第一个参数为起始行，从 0 开始；第二个参数为返回的总行数。</p>
<p>返回前 5 行：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">0</span>, <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>返回第 3 ~ 5 行：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">2</span>, <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h1 id="八、排序"><a href="#八、排序" class="headerlink" title="八、排序"></a>八、排序</h1><ul>
<li><strong>ASC</strong>  ：升序（默认）</li>
<li><strong>DESC</strong>  ：降序</li>
</ul>
<p>可以按多个列进行排序，并且为每个列指定不同的排序方式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> col1 <span class="keyword">DESC</span>, col2 <span class="keyword">ASC</span>;</span><br></pre></td></tr></table></figure>

<h1 id="九、过滤"><a href="#九、过滤" class="headerlink" title="九、过滤"></a>九、过滤</h1><p>不进行过滤的数据非常大，导致通过网络传输了多余的数据，从而浪费了网络带宽。因此尽量使用 SQL 语句来过滤不必要的数据，而不是传输所有的数据到客户端中然后由客户端进行过滤。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>下表显示了 WHERE 子句可用的操作符</p>
<table>
<thead>
<tr>
<th align="center">操作符</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">=</td>
<td align="center">等于</td>
</tr>
<tr>
<td align="center">&lt;</td>
<td align="center">小于</td>
</tr>
<tr>
<td align="center">&gt;</td>
<td align="center">大于</td>
</tr>
<tr>
<td align="center">&lt;&gt; !=</td>
<td align="center">不等于</td>
</tr>
<tr>
<td align="center">&lt;= !&gt;</td>
<td align="center">小于等于</td>
</tr>
<tr>
<td align="center">&gt;= !&lt;</td>
<td align="center">大于等于</td>
</tr>
<tr>
<td align="center">BETWEEN</td>
<td align="center">在两个值之间</td>
</tr>
<tr>
<td align="center">IS NULL</td>
<td align="center">为 NULL 值</td>
</tr>
</tbody></table>
<p>应该注意到，NULL 与 0、空字符串都不同。</p>
<p><strong>AND 和 OR</strong>   用于连接多个过滤条件。优先处理 AND，当一个过滤表达式涉及到多个 AND 和 OR 时，可以使用 () 来决定优先级，使得优先级关系更清晰。</p>
<p><strong>IN</strong>   操作符用于匹配一组值，其后也可以接一个 SELECT 子句，从而匹配子查询得到的一组值。</p>
<p><strong>NOT</strong>   操作符用于否定一个条件。</p>
<h1 id="十、通配符"><a href="#十、通配符" class="headerlink" title="十、通配符"></a>十、通配符</h1><p>通配符也是用在过滤语句中，但它只能用于文本字段。</p>
<ul>
<li><p><strong>%</strong>   匹配 &gt;=0 个任意字符；</p>
</li>
<li><p><strong>_</strong>   匹配 ==1 个任意字符；</p>
</li>
<li><p><strong>[ ]</strong>   可以匹配集合内的字符，例如 [ab] 将匹配字符 a 或者 b。用脱字符 ^ 可以对其进行否定，也就是不匹配集合内的字符。</p>
</li>
</ul>
<p>使用 Like 来进行通配符匹配。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> <span class="keyword">LIKE</span> <span class="string">'[^AB]%'</span>; <span class="comment">-- 不以 A 和 B 开头的任意文本</span></span><br></pre></td></tr></table></figure>

<p>不要滥用通配符，通配符位于开头处匹配会非常慢。</p>
<h1 id="十一、计算字段"><a href="#十一、计算字段" class="headerlink" title="十一、计算字段"></a>十一、计算字段</h1><p>在数据库服务器上完成数据的转换和格式化的工作往往比客户端上快得多，并且转换和格式化后的数据量更少的话可以减少网络通信量。</p>
<p>计算字段通常需要使用   <strong>AS</strong>   来取别名，否则输出的时候字段名为计算表达式。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col1 * col2 <span class="keyword">AS</span> <span class="keyword">alias</span></span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>

<p><strong>CONCAT()</strong>   用于连接两个字段。许多数据库会使用空格把一个值填充为列宽，因此连接的结果会出现一些不必要的空格，使用 <strong>TRIM()</strong> 可以去除首尾空格。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(<span class="keyword">TRIM</span>(col1), <span class="string">'('</span>, <span class="keyword">TRIM</span>(col2), <span class="string">')'</span>) <span class="keyword">AS</span> concat_col</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>

<h1 id="十二、函数"><a href="#十二、函数" class="headerlink" title="十二、函数"></a>十二、函数</h1><p>各个 DBMS 的函数都是不相同的，因此不可移植，以下主要是 MySQL 的函数。</p>
<h2 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h2><table>
<thead>
<tr>
<th align="center">函 数</th>
<th align="center">说 明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">AVG()</td>
<td align="center">返回某列的平均值</td>
</tr>
<tr>
<td align="center">COUNT()</td>
<td align="center">返回某列的行数</td>
</tr>
<tr>
<td align="center">MAX()</td>
<td align="center">返回某列的最大值</td>
</tr>
<tr>
<td align="center">MIN()</td>
<td align="center">返回某列的最小值</td>
</tr>
<tr>
<td align="center">SUM()</td>
<td align="center">返回某列值之和</td>
</tr>
</tbody></table>
<p>AVG() 会忽略 NULL 行。</p>
<p>使用 DISTINCT 可以汇总不同的值。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">AVG</span>(<span class="keyword">DISTINCT</span> col1) <span class="keyword">AS</span> avg_col</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>

<h2 id="文本处理"><a href="#文本处理" class="headerlink" title="文本处理"></a>文本处理</h2><table>
<thead>
<tr>
<th align="center">函数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">LEFT()</td>
<td align="center">左边的字符</td>
</tr>
<tr>
<td align="center">RIGHT()</td>
<td align="center">右边的字符</td>
</tr>
<tr>
<td align="center">LOWER()</td>
<td align="center">转换为小写字符</td>
</tr>
<tr>
<td align="center">UPPER()</td>
<td align="center">转换为大写字符</td>
</tr>
<tr>
<td align="center">LTRIM()</td>
<td align="center">去除左边的空格</td>
</tr>
<tr>
<td align="center">RTRIM()</td>
<td align="center">去除右边的空格</td>
</tr>
<tr>
<td align="center">LENGTH()</td>
<td align="center">长度</td>
</tr>
<tr>
<td align="center">SOUNDEX()</td>
<td align="center">转换为语音值</td>
</tr>
</tbody></table>
<p>其中，  <strong>SOUNDEX()</strong>   可以将一个字符串转换为描述其语音表示的字母数字模式。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">SOUNDEX</span>(col1) = <span class="keyword">SOUNDEX</span>(<span class="string">'apple'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="日期和时间处理"><a href="#日期和时间处理" class="headerlink" title="日期和时间处理"></a>日期和时间处理</h2><ul>
<li>日期格式：YYYY-MM-DD</li>
<li>时间格式：HH:<zero-width space>MM:SS</li>
</ul>
<table>
<thead>
<tr>
<th align="center">函 数</th>
<th align="center">说 明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ADDDATE()</td>
<td align="center">增加一个日期（天、周等）</td>
</tr>
<tr>
<td align="center">ADDTIME()</td>
<td align="center">增加一个时间（时、分等）</td>
</tr>
<tr>
<td align="center">CURDATE()</td>
<td align="center">返回当前日期</td>
</tr>
<tr>
<td align="center">CURTIME()</td>
<td align="center">返回当前时间</td>
</tr>
<tr>
<td align="center">DATE()</td>
<td align="center">返回日期时间的日期部分</td>
</tr>
<tr>
<td align="center">DATEDIFF()</td>
<td align="center">计算两个日期之差</td>
</tr>
<tr>
<td align="center">DATE_ADD()</td>
<td align="center">高度灵活的日期运算函数</td>
</tr>
<tr>
<td align="center">DATE_FORMAT()</td>
<td align="center">返回一个格式化的日期或时间串</td>
</tr>
<tr>
<td align="center">DAY()</td>
<td align="center">返回一个日期的天数部分</td>
</tr>
<tr>
<td align="center">DAYOFWEEK()</td>
<td align="center">对于一个日期，返回对应的星期几</td>
</tr>
<tr>
<td align="center">HOUR()</td>
<td align="center">返回一个时间的小时部分</td>
</tr>
<tr>
<td align="center">MINUTE()</td>
<td align="center">返回一个时间的分钟部分</td>
</tr>
<tr>
<td align="center">MONTH()</td>
<td align="center">返回一个日期的月份部分</td>
</tr>
<tr>
<td align="center">NOW()</td>
<td align="center">返回当前日期和时间</td>
</tr>
<tr>
<td align="center">SECOND()</td>
<td align="center">返回一个时间的秒部分</td>
</tr>
<tr>
<td align="center">TIME()</td>
<td align="center">返回一个日期时间的时间部分</td>
</tr>
<tr>
<td align="center">YEAR()</td>
<td align="center">返回一个日期的年份部分</td>
</tr>
</tbody></table>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT NOW();</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-4</span><span class="number">-14</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">11</span></span><br></pre></td></tr></table></figure>

<h2 id="数值处理"><a href="#数值处理" class="headerlink" title="数值处理"></a>数值处理</h2><table>
<thead>
<tr>
<th align="center">函数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SIN()</td>
<td align="center">正弦</td>
</tr>
<tr>
<td align="center">COS()</td>
<td align="center">余弦</td>
</tr>
<tr>
<td align="center">TAN()</td>
<td align="center">正切</td>
</tr>
<tr>
<td align="center">ABS()</td>
<td align="center">绝对值</td>
</tr>
<tr>
<td align="center">SQRT()</td>
<td align="center">平方根</td>
</tr>
<tr>
<td align="center">MOD()</td>
<td align="center">余数</td>
</tr>
<tr>
<td align="center">EXP()</td>
<td align="center">指数</td>
</tr>
<tr>
<td align="center">PI()</td>
<td align="center">圆周率</td>
</tr>
<tr>
<td align="center">RAND()</td>
<td align="center">随机数</td>
</tr>
</tbody></table>
<h1 id="十三、分组"><a href="#十三、分组" class="headerlink" title="十三、分组"></a>十三、分组</h1><p>把具有相同的数据值的行放在同一组中。</p>
<p>可以对同一分组数据使用汇总函数进行处理，例如求分组数据的平均值等。</p>
<p>指定的分组字段除了能按该字段进行分组，也会自动按该字段进行排序。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span>, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">col</span>;</span><br></pre></td></tr></table></figure>

<p>GROUP BY 自动按分组字段进行排序，ORDER BY 也可以按汇总字段来进行排序。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span>, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">num</span>;</span><br></pre></td></tr></table></figure>

<p>WHERE 过滤行，HAVING 过滤分组，行过滤应当先于分组过滤。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span>, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> &gt; <span class="number">2</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">HAVING</span> <span class="keyword">num</span> &gt;= <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>分组规定：</p>
<ul>
<li>GROUP BY 子句出现在 WHERE 子句之后，ORDER BY 子句之前；</li>
<li>除了汇总字段外，SELECT 语句中的每一字段都必须在 GROUP BY 子句中给出；</li>
<li>NULL 的行会单独分为一组；</li>
<li>大多数 SQL 实现不支持 GROUP BY 列具有可变长度的数据类型。</li>
</ul>
<h1 id="十四、子查询"><a href="#十四、子查询" class="headerlink" title="十四、子查询"></a>十四、子查询</h1><p>子查询中只能返回一个字段的数据。</p>
<p>可以将子查询的结果作为 WHRER 语句的过滤条件：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable1</span><br><span class="line"><span class="keyword">WHERE</span> col1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> col2</span><br><span class="line">               <span class="keyword">FROM</span> mytable2);</span><br></pre></td></tr></table></figure>

<p>下面的语句可以检索出客户的订单数量，子查询语句会对第一个查询检索出的每个客户执行一次：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_name, (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*)</span><br><span class="line">                   <span class="keyword">FROM</span> Orders</span><br><span class="line">                   <span class="keyword">WHERE</span> Orders.cust_id = Customers.cust_id)</span><br><span class="line">                   <span class="keyword">AS</span> orders_num</span><br><span class="line"><span class="keyword">FROM</span> Customers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> cust_name;</span><br></pre></td></tr></table></figure>

<h1 id="十五、连接"><a href="#十五、连接" class="headerlink" title="十五、连接"></a>十五、连接</h1><p>连接用于连接多个表，使用 JOIN 关键字，并且条件语句使用 ON 而不是 WHERE。</p>
<p>连接可以替换子查询，并且比子查询的效率一般会更快。</p>
<p>可以用 AS 给列名、计算字段和表名取别名，给表名取别名是为了简化 SQL 语句以及连接相同表。</p>
<h2 id="内连接"><a href="#内连接" class="headerlink" title="内连接"></a>内连接</h2><p>内连接又称等值连接，使用 INNER JOIN 关键字。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A.value, B.value</span><br><span class="line"><span class="keyword">FROM</span> tablea <span class="keyword">AS</span> A <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tableb <span class="keyword">AS</span> B</span><br><span class="line"><span class="keyword">ON</span> A.key = B.key;</span><br></pre></td></tr></table></figure>

<p>可以不明确使用 INNER JOIN，而使用普通查询并在 WHERE 中将两个表中要连接的列用等值方法连接起来。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A.value, B.value</span><br><span class="line"><span class="keyword">FROM</span> tablea <span class="keyword">AS</span> A, tableb <span class="keyword">AS</span> B</span><br><span class="line"><span class="keyword">WHERE</span> A.key = B.key;</span><br></pre></td></tr></table></figure>

<h2 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h2><p>自连接可以看成内连接的一种，只是连接的表是自身而已。</p>
<p>一张员工表，包含员工姓名和员工所属部门，要找出与 Jim 处在同一部门的所有员工姓名。</p>
<p>子查询版本</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">WHERE</span> department = (</span><br><span class="line">      <span class="keyword">SELECT</span> department</span><br><span class="line">      <span class="keyword">FROM</span> employee</span><br><span class="line">      <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">"Jim"</span>);</span><br></pre></td></tr></table></figure>

<p>自连接版本</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.name</span><br><span class="line"><span class="keyword">FROM</span> employee <span class="keyword">AS</span> e1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e2</span><br><span class="line"><span class="keyword">ON</span> e1.department = e2.department</span><br><span class="line">      <span class="keyword">AND</span> e2.name = <span class="string">"Jim"</span>;</span><br></pre></td></tr></table></figure>

<h2 id="自然连接"><a href="#自然连接" class="headerlink" title="自然连接"></a>自然连接</h2><p>自然连接是把同名列通过等值测试连接起来的，同名列可以有多个。</p>
<p>内连接和自然连接的区别：内连接提供连接的列，而自然连接自动连接所有同名列。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A.value, B.value</span><br><span class="line"><span class="keyword">FROM</span> tablea <span class="keyword">AS</span> A <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> tableb <span class="keyword">AS</span> B;</span><br></pre></td></tr></table></figure>

<h2 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h2><p>外连接保留了没有关联的那些行。分为左外连接，右外连接以及全外连接，左外连接就是保留左表没有关联的行。</p>
<p>检索所有顾客的订单信息，包括还没有订单信息的顾客。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Customers.cust_id, Orders.order_num</span><br><span class="line"><span class="keyword">FROM</span> Customers <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> Orders</span><br><span class="line"><span class="keyword">ON</span> Customers.cust_id = Orders.cust_id;</span><br></pre></td></tr></table></figure>

<p>customers 表：</p>
<table>
<thead>
<tr>
<th align="center">cust_id</th>
<th align="center">cust_name</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">a</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">b</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">c</td>
</tr>
</tbody></table>
<p>orders 表：</p>
<table>
<thead>
<tr>
<th align="center">order_id</th>
<th align="center">cust_id</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">3</td>
</tr>
</tbody></table>
<p>结果：</p>
<table>
<thead>
<tr>
<th align="center">cust_id</th>
<th align="center">cust_name</th>
<th align="center">order_id</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">a</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">a</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">c</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">c</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">b</td>
<td align="center">Null</td>
</tr>
</tbody></table>
<h1 id="十六、组合查询"><a href="#十六、组合查询" class="headerlink" title="十六、组合查询"></a>十六、组合查询</h1><p>使用   <strong>UNION</strong>   来组合两个查询，如果第一个查询返回 M 行，第二个查询返回 N 行，那么组合查询的结果一般为 M+N 行。</p>
<p>每个查询必须包含相同的列、表达式和聚集函数。</p>
<p>默认会去除相同行，如果需要保留相同行，使用 UNION ALL。</p>
<p>只能包含一个 ORDER BY 子句，并且必须位于语句的最后。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> =<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h1 id="十七、视图"><a href="#十七、视图" class="headerlink" title="十七、视图"></a>十七、视图</h1><p>视图是虚拟的表，本身不包含数据，也就不能对其进行索引操作。</p>
<p>对视图的操作和对普通表的操作一样。</p>
<p>视图具有如下好处：</p>
<ul>
<li>简化复杂的 SQL 操作，比如复杂的连接；</li>
<li>只使用实际表的一部分数据；</li>
<li>通过只给用户访问视图的权限，保证数据的安全性；</li>
<li>更改数据格式和表示。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> myview <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Concat</span>(col1, col2) <span class="keyword">AS</span> concat_col, col3*col4 <span class="keyword">AS</span> compute_col</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col5 = val;</span><br></pre></td></tr></table></figure>

<h1 id="十八、存储过程"><a href="#十八、存储过程" class="headerlink" title="十八、存储过程"></a>十八、存储过程</h1><p>存储过程可以看成是对一系列 SQL 操作的批处理。</p>
<p>使用存储过程的好处：</p>
<ul>
<li>代码封装，保证了一定的安全性；</li>
<li>代码复用；</li>
<li>由于是预先编译，因此具有很高的性能。</li>
</ul>
<p>命令行中创建存储过程需要自定义分隔符，因为命令行是以 ; 为结束符，而存储过程中也包含了分号，因此会错误把这部分分号当成是结束符，造成语法错误。</p>
<p>包含 in、out 和 inout 三种参数。</p>
<p>给变量赋值都需要用 select into 语句。</p>
<p>每次只能给一个变量赋值，不支持集合的操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">delimiter //</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> myprocedure( <span class="keyword">out</span> ret <span class="built_in">int</span> )</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">declare</span> y <span class="built_in">int</span>;</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">sum</span>(col1)</span><br><span class="line">        <span class="keyword">from</span> mytable</span><br><span class="line">        <span class="keyword">into</span> y;</span><br><span class="line">        <span class="keyword">select</span> y*y <span class="keyword">into</span> ret;</span><br><span class="line">    <span class="keyword">end</span> //</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">call</span> myprocedure(@ret);</span><br><span class="line"><span class="keyword">select</span> @ret;</span><br></pre></td></tr></table></figure>

<h1 id="十九、游标"><a href="#十九、游标" class="headerlink" title="十九、游标"></a>十九、游标</h1><p>在存储过程中使用游标可以对一个结果集进行移动遍历。</p>
<p>游标主要用于交互式应用，其中用户需要对数据集中的任意行进行浏览和修改。</p>
<p>使用游标的四个步骤：</p>
<ol>
<li>声明游标，这个过程没有实际检索出数据；</li>
<li>打开游标；</li>
<li>取出数据；</li>
<li>关闭游标；</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">delimiter //</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> myprocedure(<span class="keyword">out</span> ret <span class="built_in">int</span>)</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">declare</span> done <span class="built_in">boolean</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">declare</span> mycursor <span class="keyword">cursor</span> <span class="keyword">for</span></span><br><span class="line">        <span class="keyword">select</span> col1 <span class="keyword">from</span> mytable;</span><br><span class="line">        <span class="comment"># 定义了一个 continue handler，当 sqlstate '02000' 这个条件出现时，会执行 set done = 1</span></span><br><span class="line">        <span class="keyword">declare</span> continue <span class="keyword">handler</span> <span class="keyword">for</span> <span class="keyword">sqlstate</span> <span class="string">'02000'</span> <span class="keyword">set</span> done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        open mycursor;</span><br><span class="line"></span><br><span class="line">        repeat</span><br><span class="line">            fetch mycursor into ret;</span><br><span class="line">            <span class="keyword">select</span> ret;</span><br><span class="line">        until done <span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line"></span><br><span class="line">        close mycursor;</span><br><span class="line">    <span class="keyword">end</span> //</span><br><span class="line"> delimiter ;</span><br></pre></td></tr></table></figure>

<h1 id="二十、触发器"><a href="#二十、触发器" class="headerlink" title="二十、触发器"></a>二十、触发器</h1><p>触发器会在某个表执行以下语句时而自动执行：DELETE、INSERT、UPDATE。</p>
<p>触发器必须指定在语句执行之前还是之后自动执行，之前执行使用 BEFORE 关键字，之后执行使用 AFTER 关键字。BEFORE 用于数据验证和净化，AFTER 用于审计跟踪，将修改记录到另外一张表中。</p>
<p>INSERT 触发器包含一个名为 NEW 的虚拟表。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> mytrigger <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> mytable</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SELECT</span> NEW.col <span class="keyword">into</span> @<span class="keyword">result</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">result</span>; <span class="comment">-- 获取结果</span></span><br></pre></td></tr></table></figure>

<p>DELETE 触发器包含一个名为 OLD 的虚拟表，并且是只读的。</p>
<p>UPDATE 触发器包含一个名为 NEW 和一个名为 OLD 的虚拟表，其中 NEW 是可以被修改的，而 OLD 是只读的。</p>
<p>MySQL 不允许在触发器中使用 CALL 语句，也就是不能调用存储过程。</p>
<h1 id="二十一、事务管理"><a href="#二十一、事务管理" class="headerlink" title="二十一、事务管理"></a>二十一、事务管理</h1><p>基本术语：</p>
<ul>
<li>事务（transaction）指一组 SQL 语句；</li>
<li>回退（rollback）指撤销指定 SQL 语句的过程；</li>
<li>提交（commit）指将未存储的 SQL 语句结果写入数据库表；</li>
<li>保留点（savepoint）指事务处理中设置的临时占位符（placeholder），你可以对它发布回退（与回退整个事务处理不同）。</li>
</ul>
<p>不能回退 SELECT 语句，回退 SELECT 语句也没意义；也不能回退 CREATE 和 DROP 语句。</p>
<p>MySQL 的事务提交默认是隐式提交，每执行一条语句就把这条语句当成一个事务然后进行提交。当出现 START TRANSACTION 语句时，会关闭隐式提交；当 COMMIT 或 ROLLBACK 语句执行后，事务会自动关闭，重新恢复隐式提交。</p>
<p>设置 autocommit 为 0 可以取消自动提交；autocommit 标记是针对每个连接而不是针对服务器的。</p>
<p>如果没有设置保留点，ROLLBACK 会回退到 START TRANSACTION 语句处；如果设置了保留点，并且在 ROLLBACK 中指定该保留点，则会回退到该保留点。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line">// ...</span><br><span class="line"><span class="keyword">SAVEPOINT</span> delete1</span><br><span class="line">// ...</span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> delete1</span><br><span class="line">// ...</span><br><span class="line"><span class="keyword">COMMIT</span></span><br></pre></td></tr></table></figure>

<h1 id="二十二、字符集"><a href="#二十二、字符集" class="headerlink" title="二十二、字符集"></a>二十二、字符集</h1><p>基本术语：</p>
<ul>
<li>字符集为字母和符号的集合；</li>
<li>编码为某个字符集成员的内部表示；</li>
<li>校对字符指定如何比较，主要用于排序和分组。</li>
</ul>
<p>除了给表指定字符集和校对外，也可以给列指定：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line">(<span class="keyword">col</span> <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> latin <span class="keyword">COLLATE</span> latin1_general_ci )</span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> hebrew <span class="keyword">COLLATE</span> hebrew_general_ci;</span><br></pre></td></tr></table></figure>

<p>可以在排序、分组时指定校对：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">col</span> <span class="keyword">COLLATE</span> latin1_general_ci;</span><br></pre></td></tr></table></figure>

<h1 id="二十三、权限管理"><a href="#二十三、权限管理" class="headerlink" title="二十三、权限管理"></a>二十三、权限管理</h1><p>MySQL 的账户信息保存在 mysql 这个数据库中。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">USE</span> mysql;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span> <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>

<p><strong>创建账户</strong>  </p>
<p>新创建的账户没有任何权限。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> myuser <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'mypassword'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>修改账户名</strong>  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RENAME</span> <span class="keyword">USER</span> myuser <span class="keyword">TO</span> newuser;</span><br></pre></td></tr></table></figure>

<p><strong>删除账户</strong>  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> myuser;</span><br></pre></td></tr></table></figure>

<p><strong>查看权限</strong>  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GRANTS</span> <span class="keyword">FOR</span> myuser;</span><br></pre></td></tr></table></figure>

<p><strong>授予权限</strong>  </p>
<p>账户用 username@host 的形式定义，username@% 使用的是默认主机名。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span> <span class="keyword">ON</span> mydatabase.* <span class="keyword">TO</span> myuser;</span><br></pre></td></tr></table></figure>

<p><strong>删除权限</strong>  </p>
<p>GRANT 和 REVOKE 可在几个层次上控制访问权限：</p>
<ul>
<li>整个服务器，使用 GRANT ALL 和 REVOKE ALL；</li>
<li>整个数据库，使用 ON database.*；</li>
<li>特定的表，使用 ON database.table；</li>
<li>特定的列；</li>
<li>特定的存储过程。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span> <span class="keyword">ON</span> mydatabase.* <span class="keyword">FROM</span> myuser;</span><br></pre></td></tr></table></figure>

<p><strong>更改密码</strong>  </p>
<p>必须使用 Password() 函数进行加密。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> PASSWROD <span class="keyword">FOR</span> myuser = <span class="keyword">Password</span>(<span class="string">'new_password'</span>);</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>BenForta. SQL 必知必会 [M]. 人民邮电出版社, 2013.</li>
</ul>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>sql</tag>
      </tags>
  </entry>
  <entry>
    <title>Youku 路由器刷 Padavan</title>
    <url>/systemops/youku-breed-padavan.html</url>
    <content><![CDATA[<div class="note warning">
            <p>警告：刷机有风险，由此产生的一切后果请自行承担！！！</p>
          </div>
<a id="more"></a>
<h2 id="require"><a href="#require" class="headerlink" title="require"></a>require</h2><ol>
<li>官改固件：YKL1_2.1.0613.8617_root_telnet.bin</li>
<li>Breed：breed-mt7620-youku-yk1.bin</li>
<li>Padavan 固件：RT-N14U-GPIO-1-youku1-128M_3.4.3.9-099.trx (2019-11-13版本)</li>
</ol>
<p>所需文件下载链接： <span class="exturl" data-url="aHR0cDovL3Bhbi5ob2tlNTguY24vaW5kZXgucGhwL3MvNUdOTkprd3J0SkRQZTRm" title="http://pan.hoke58.cn/index.php/s/5GNNJkwrtJDPe4f">http://pan.hoke58.cn/index.php/s/5GNNJkwrtJDPe4f<i class="fa fa-external-link"></i></span></p>
<h2 id="升级官改固件"><a href="#升级官改固件" class="headerlink" title="升级官改固件"></a>升级官改固件</h2><p>Breed 是必备，但是要刷 Breed 就得先刷已 root 和开启 Telnet 的固件。</p>
<ol>
<li><p>登录路由器管理界面，<code>「更多设置」</code> -&gt; <code>「系统升级」</code> -&gt; <code>「手动升级」</code>，选择前面下载的 <code>YKL1_2.1.0613.8617_root_telnet.bin</code>，点击 <code>「上传文件」</code>，等待升级包验证通过，点击<code>「立即升级」</code>，然后就等待路由器重启，这个过程中不要断开网线也不要断开电源。</p>
</li>
<li><p>重启完成后，按住路由器上 <code>RESET</code> 按键重置路由器。</p>
</li>
</ol>
<blockquote>
<p>第2步必须，否则还是无法 <code>Telnet</code> 连接路由器</p>
</blockquote>
<h2 id="刷入-Breed"><a href="#刷入-Breed" class="headerlink" title="刷入 Breed"></a>刷入 Breed</h2><ol>
<li><p>使用 shell 客户端 <code>telnet 192.168.11.1</code> 登录路由器, 如果有登录身份验证，用户名和密码都是 admin ，或者试试 root/admin 组合</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[c:\~]$ telnet 192.168.11.1</span><br><span class="line">Connecting to 192.168.11.1:23...</span><br><span class="line">Connection established.</span><br><span class="line">To escape to <span class="built_in">local</span> shell, press <span class="string">'Ctrl+Alt+]'</span>.</span><br><span class="line"> === IMPORTANT ============================</span><br><span class="line">  Use <span class="string">'passwd'</span> to <span class="built_in">set</span> your login password</span><br><span class="line">  this will <span class="built_in">disable</span> telnet and <span class="built_in">enable</span> SSH</span><br><span class="line"> ------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.22.1 (2016-05-31 09:37:31 CST) built-in shell (ash)</span><br><span class="line">Enter <span class="string">'help'</span> <span class="keyword">for</span> a list of built-in commands.</span><br><span class="line"></span><br><span class="line">  _______                     ________        __              </span><br><span class="line"> |       |.-----.-----.-----.|  |  |  |.----.|  |_      </span><br><span class="line"> |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|        </span><br><span class="line"> |_______||   __|_____|__|__||________||__|  |____|       </span><br><span class="line">          |__| W I R E L E S S   F R E E D O M  </span><br><span class="line"></span><br><span class="line"> -----------------------------------------------------</span><br><span class="line"> BARRIER BREAKER (Barrier Breaker, unknown)</span><br><span class="line"> -----------------------------------------------------</span><br><span class="line">  * 1/2 oz Galliano         Pour all ingredients into</span><br><span class="line">  * 4 oz cold Coffee        an irish coffee mug filled</span><br><span class="line">  * 1 1/2 oz Dark Rum       with crushed ice. Stir.</span><br><span class="line">  * 2 tsp. Creme de Cacao</span><br><span class="line"> -----------------------------------------------------</span><br><span class="line"> customized by youku, </span><br><span class="line"> copyright (c) youku, 2015. all rights reserved.</span><br></pre></td></tr></table></figure>
</li>
<li><p>导入 breed-mt7620-youku-yk1.bin 文件至路由器</p>
</li>
</ol>
<p align="center">以上步骤之后有 <b>两种选择</b>，请<b>任选其一</b>然后<b>继续后面的步骤</b>。</p>

<ul>
<li><p><strong>选择 1：U盘拷入</strong>：</p>
<ol>
<li>将 breed-mt7620-youku-yk1.bin 文件复制到U盘，U盘插上路由器</li>
<li><code>ls /mnt/sda1</code> 查看U盘里 breed-mt7620-youku-yk1.bin 文件是否存在</li>
</ol>
</li>
</ul>
<p><strong>注意：</strong>U盘未必能挂载成功。可以执行 df -h 看看有没有类似「/dev/sda1」这样的设备，然后挂载U盘：<code>mount /dev/sda1 /mnt/sda1</code> ，若挂载成功，在检查一下U盘是否有 Breed 文件。</p>
<ul>
<li><p><strong>选择 2：<code>wget</code> 下载</strong>：</p>
<ol>
<li>确保路由器能访问外网</li>
<li>执行以下命令，下载 Breed 至 <code>/tmp</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp &amp;&amp; wget --user-agent=<span class="string">"Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.16 (KHTML, like Gecko) Chrome/10.0.648.204 Safari/534.16"</span> -O breed-mt7620-youku-yk1.bin <span class="string">'http://pan.hoke58.cn/index.php/s/5GNNJkwrtJDPe4f/download?path=%2F&amp;files=breed-mt7620-youku-yk1.bin'</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">3. 检查 Breed 的 MD5</span><br><span class="line">```shell</span><br><span class="line">[root@Youku-router]md5sum breed-mt7620-youku-yk1.bin </span><br><span class="line">44379c40f77d3d75bcba97ce136a880d  breed-mt7620-youku-yk1.bin</span><br></pre></td></tr></table></figure>
如 MD5 不一致就重新下载！</li>
</ol>
</li>
</ul>
<ol start="4">
<li><p>解锁 Bootloader</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@Youku-router]mtd unlock Bootloader</span><br><span class="line">Unlocking Bootloader ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>刷 Breed</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@Youku-router]mtd -r write /tmp/breed-mt7620-youku-yk1.bin Bootloader</span><br><span class="line">Unlocking Bootloader ...</span><br><span class="line"></span><br><span class="line">Writing from /tmp/breed-mt7620-youku-yk1.bin to Bootloader ...     </span><br><span class="line">Rebooting ...</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>然后路由器会自动重启, 至此 Breed 成功刷入，恭喜变成不死路由</p>
<h2 id="刷入-Padavan-固件"><a href="#刷入-Padavan-固件" class="headerlink" title="刷入 Padavan 固件"></a>刷入 Padavan 固件</h2><ol>
<li>需要有线电脑，IP设为<code>192.168.1.2</code>（新版本 Breed 设自动获取就行）</li>
<li>路由器断电，按住复位键，上电，10来秒后松手</li>
<li>电脑浏览器访问 <code>192.168.1.1</code> 进入 Breed 页面</li>
<li>固件更新，刷入老毛子固件 RT-N14U-GPIO-1-youku1-128M_3.4.3.9-099.trx 即可</li>
<li>刷好固件以后，手动断电，等待几秒，再通电开机！(路由可能无法自动开机重启)</li>
</ol>
<h2 id="Enjoy-it"><a href="#Enjoy-it" class="headerlink" title="Enjoy it"></a>Enjoy it</h2><p>Padavan 默认管理地址: <code>http://192.168.123.1</code><br>默认密码: <code>admin / admin</code><br>默认 SSID: <code>PDCN / 1234567890</code></p>
]]></content>
      <categories>
        <category>系统运维</category>
      </categories>
      <tags>
        <tag>router</tag>
        <tag>padavan</tag>
        <tag>youku</tag>
      </tags>
  </entry>
  <entry>
    <title>ERROR network conf_default id has active endpoints</title>
    <url>/docker/docker-network-error.html</url>
    <content><![CDATA[<h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p>表象是容器无法 stop, restart, rm , 登录主机后执行</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@orderer0 /home/blockchain/peer0.org1/conf]<span class="comment"># docker-compose down</span></span><br><span class="line">Stopping peer0.org1 ... <span class="keyword">done</span></span><br><span class="line">Removing network conf_default</span><br><span class="line">ERROR: network conf_default id a3a2c67620436cc49e406a52ad724df3cbe93f965b7e4427b36ed811075d2e06 has active endpoints</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="临时处理"><a href="#临时处理" class="headerlink" title="临时处理"></a>临时处理</h1><ol>
<li><p>检查 network </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@orderer0 /home/blockchain]<span class="comment"># docker network inspect conf_default</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"conf_default"</span>,</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"412177b0cf14414b191fc99ab4411d65c201e52424217476eb6b5cc861a5b603"</span>,</span><br><span class="line">        <span class="string">"Created"</span>: <span class="string">"2019-11-21T22:08:45.523133411+08:00"</span>,</span><br><span class="line">        <span class="string">"Scope"</span>: <span class="string">"local"</span>,</span><br><span class="line">        <span class="string">"Driver"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">        <span class="string">"EnableIPv6"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"IPAM"</span>: &#123;</span><br><span class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="string">"Options"</span>: null,</span><br><span class="line">            <span class="string">"Config"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"172.21.0.0/16"</span>,</span><br><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.21.0.1"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Internal"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Attachable"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Ingress"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"ConfigFrom"</span>: &#123;</span><br><span class="line">            <span class="string">"Network"</span>: <span class="string">""</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"ConfigOnly"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Containers"</span>: &#123;</span><br><span class="line">            <span class="string">"19ffaa8a2c03891c1883f962e0076a04ec9461bfc8364d60052e34e5464e9762"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"peer0.org1"</span>, <span class="comment"># 关联的 Containers name</span></span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"1f82857982ba62ce6003e15bb140686a24859ca7374bca110ab7e481af56c855"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:ac:15:00:02"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"172.21.0.2/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"9c7dd8270317bb09aac306a9aa952b05fff5fa0a65ef3f4f7c4e1a5d8c03bf1e"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"dev-peer0.org1.finblockchain.cn-fft-2.0.0"</span>, <span class="comment"># 关联的 Containers name</span></span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"33dbba6e9cc513d4e0b293fa7f2d4415bb1c13aa4d1c0c87f86d2063409b7bd1"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:ac:15:00:03"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"172.21.0.3/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Options"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"Labels"</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>断开关联的 Containers name 网络</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker network disconnect -f net_default peer0.org1</span></span><br><span class="line"><span class="comment"># docker network disconnect -f net_default dev-peer0.org1.finblockchain.cn-fft-2.0.0</span></span><br></pre></td></tr></table></figure></li>
<li><p>然后就可以正常执行</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker-compose down</span></span><br></pre></td></tr></table></figure>
<h1 id="根本解决"><a href="#根本解决" class="headerlink" title="根本解决"></a>根本解决</h1><p>在 <code>docker.service</code>中加上：</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">[Service]</span><br><span class="line">MountFlags=slave</span><br><span class="line">```  </span><br><span class="line">来保证 docker 及 container 运行在 私有 的 **mount namespace** 上。当 docker 以这种方式启动时，可以使用 `<span class="keyword">grep</span> /mnt /proc/self/mountinfo` 来检测以这种方式启动的容器确实看不到 **mount point** 了，而之前遗留的挂载点仍然可以看到。</span><br><span class="line"></span><br><span class="line">很多线上机器已经跑着业务容器不能重启 **docker daemon** 怎么办？</span><br><span class="line"></span><br><span class="line">在生产中，需要尽可能保证所有的操作 不影响正在运行的业务容器。</span><br><span class="line"></span><br><span class="line">所以，在已有条件下，既不能停止 nginx，又不能重启 **docker daemon**，唯一的方法只有在 `docker-compose down` 出错的情况下通过执行</span><br><span class="line">```<span class="keyword">sh</span></span><br><span class="line"># docker rm -<span class="keyword">f</span> $(docker <span class="keyword">ps</span> -<span class="keyword">a</span> -q -<span class="keyword">f</span> status=dead)</span><br></pre></td></tr></table></figure>
<p>来强制删除 <strong>dead container</strong> 了。虽然仍然会有错误信息提示，但是可以看到 <strong>Dead container</strong> 确实被删除了。之后可以正常运行 <code>docker-compose up -d</code></p>
</li>
</ol>
<p>有没有方法可以在不影响业务容器的前提下重新配置 <strong>docker daemon</strong> 呢？</p>
<p>docker 从 1.12.0 开始支持在 不重启 container 的情况下重启 <strong>docker daemon</strong>，只需要在 <strong>docker daemon</strong> 启动时增加 <code>--live-restore=true</code> 这个参数。可惜的是，该参数直到目前仍不支持 <strong>daemon reload</strong>（类似 nginx 的 reload 和 restart），只能重启 dockerd 后生效</p>
<h1 id="本质"><a href="#本质" class="headerlink" title="本质"></a>本质</h1><p>挂载点泄露实际上是 RHEL/CentOS 内核的一个 bug，目前预计会在 RHEL7.4 kernel 中修复</p>
<p>目前在 RHEL/CentOS 下需要在 <strong>docker.service</strong> 中增加 <code>MountFlags=slave</code> 来保证 <strong>mount namespace</strong> 是私有的，不会造成挂载点泄露。</p>
<p>另外，挂载点泄露在各种 storage driver 中都存在，比如最常见的 <code>devicemeppaer</code> 和 <code>overlay</code>。</p>
<p>但是，目前 RHEL/CentOS 版本下 <code>MountFlags=slave</code> 和 <code>--live-restore</code> 两个给力的参数不能同时存在。因为 <code>MountFlags=slave</code> 会导致 <strong>docker daemon</strong> 每次重启时私有挂载命名空间都会发生变化，而 <code>--live-restore</code> 又相当于使得容器持有了变化之前的旧的挂载点信息，因此，当重启 <strong>docker daemon</strong> 之后，执行 <code>docker exec</code> 试图进入容器时会报错：</p>
<pre><code class="sh">rpc error: code = 13 desc = invalid header field value <span class="string">"oci runtime error: exec failed: container_linux.go:247: starting container process caused \"process_linux.go:75: starting setns process caused \\\"fork/exec /proc/self/exe: no such file or directory\\\"\"\n"</span></code></pre>
<p>值得一提的是，虽然无法进入容器，但是容器依旧工作正常并且 docker logs 也没问题。</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Dnsmasq 超好用DNS服务</title>
    <url>/systemops/dnsmasq.html</url>
    <content><![CDATA[<p><img src="https://upyun.hoke58.cn/img/dnsmasq-Dnsmasq.png" alt="dnsmasq-Dnsmasq.png"></p>
<a id="more"></a>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Dnsmasq： 轻量级的 DNS，DHCP 服务器，适用于资源受限的路由器和防火墙。它还已广泛用于智能手机和便携式热点的网络共享，并在虚拟化框架中支持虚拟网络。受支持的平台包括Linux（带有glibc和uclibc），Android, BSD 和 Mac OSX。Dnsmasq包含在大多数Linux发行版以及FreeBSD，OpenBSD和NetBSD的端口系统中。Dnsmasq提供完整的IPv6支持。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ul>
<li><p>CentOS</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install -y dnsmasq</span><br></pre></td></tr></table></figure></li>
<li><p>Ubuntu/Debian/Deepin</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">apt-get install -y dnsmasq</span><br></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>DNSmasq 的配置文件位于 <code>/etc/dnsmasq.conf</code>，均有注释说明，记录我的 <code>dnsmasq.conf</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@repo ~]<span class="comment"># egrep -v '^#|^$' /etc/dnsmasq.conf </span></span><br><span class="line"><span class="comment"># 以下两个参数告诉Dnsmasq过滤一些查询：1.哪些公共DNS没有回答 2.哪些root根域不可达。</span></span><br><span class="line">domain-needed <span class="comment"># 从不转发格式错误的域名</span></span><br><span class="line">bogus-priv <span class="comment"># 从不转发不在路由地址中的域名</span></span><br><span class="line"></span><br><span class="line">resolv-file=/home/hoke/dnsmasq/upstream.conf <span class="comment"># 上游地址</span></span><br><span class="line"><span class="built_in">local</span>=/runchain.com/ <span class="comment"># 增加一个本地域名，会在/etc/hosts中进行查询</span></span><br><span class="line">addn-hosts=/home/hoke/dnsmasq/add_hosts  <span class="comment"># 自定义 hosts </span></span><br><span class="line"></span><br><span class="line">cache-size=10000 <span class="comment"># 设置dns缓存大小,默认为150条</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For debugging purposes, log each DNS query as it passes through</span></span><br><span class="line"><span class="comment"># dnsmasq.</span></span><br><span class="line"><span class="built_in">log</span>-queries</span><br><span class="line"><span class="built_in">log</span>-facility=/var/<span class="built_in">log</span>/dnsmasq.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include all files in a directory which end in .conf</span></span><br><span class="line">conf-dir=/home/hoke/dnsmasq/dnsmasq.d/,*.conf</span><br><span class="line"></span><br><span class="line">no-negcache <span class="comment"># 不缓存未知域名缓存，默认情况下dnsmasq缓存未知域名并直接返回为客户端。</span></span><br><span class="line">clear-on-reload <span class="comment"># 重启后清空缓存</span></span><br></pre></td></tr></table></figure>
<p><code>upstream.conf</code> 上游地址配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@repo ~]<span class="comment"># cat /home/hoke/dnsmasq/upstream.conf</span></span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure>
<p>以上仅开启 DNS，需要开启 DHCP 的朋友参看配置文件注释，配置修改后启动生效即可</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl start dnsmasq</span><br></pre></td></tr></table></figure>
<h1 id="高阶技能"><a href="#高阶技能" class="headerlink" title="高阶技能"></a>高阶技能</h1><h2 id="dnsmasq-china-list"><a href="#dnsmasq-china-list" class="headerlink" title="dnsmasq-china-list"></a>dnsmasq-china-list</h2><p>特定于中文的配置可改善您喜欢的DNS服务器。chnroutes的最佳合作伙伴。</p>
</li>
<li><p>提高中文域名的解析速度。</p>
</li>
<li><p>尽可能获取最佳的CDN节点，但不要妥协外来CDN的结果，因此您同时也可以获得VPN的最佳CDN节点。</p>
</li>
<li><p>在NXDOMAIN上阻止ISP广告（例如114so）。</p>
</li>
</ul>
<p>项目地址: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZlbGl4b25tYXJzL2Ruc21hc3EtY2hpbmEtbGlzdA==" title="https://github.com/felixonmars/dnsmasq-china-list">https://github.com/felixonmars/dnsmasq-china-list<i class="fa fa-external-link"></i></span></p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><ol>
<li>clone 项目<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/felixonmars/dnsmasq-china-list.git</span><br></pre></td></tr></table></figure></li>
<li>把 <code>*.conf</code> 拷贝至 <code>conf-dir=/home/hoke/dnsmasq/dnsmasq.d/</code> 目录中</li>
<li>重启 DNSmasq <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl restart dnsmasq</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="conf-说明"><a href="#conf-说明" class="headerlink" title="conf 说明"></a>conf 说明</h3><ul>
<li><p><code>accelerated-domains.china.conf</code>：一般域加速。<br/><br>使用中文DNS服务器时，这些域的解析速度和/或结果更好。要确定某个域是否符合条件，必须满足以下条件之一：</p>
<ul>
<li>域的NS服务器位于中国大陆。</li>
<li>使用中国的DNS服务器时，该域将解析为位于中国大陆的IP，但使用外国的DNS服务器（例如，在中国具有节点的CDN加速站点）时，该域并非总是如此。但是，这不包括在中国大陆附近有节点的节点，例如日本，香港，台湾等。</li>
<li>如果顶级域名已经在列表中，请不要添加子域名。这包括该/cn/规则已匹配的所有.cn域。</li>
</ul>
</li>
<li><p><code>google.china.conf</code>：加速Google域。<br/><br>使用中文DNS时，会将这些域解析到Google中国服务器。在大多数情况下，这将为使用Google网络服务（例如Google Web Fonts和AdSense）的网站缩短页面加载时间。</p>
<blockquote>
<p>请记住，它们不被认为是稳定的。使用风险自负。</p>
</blockquote>
</li>
<li><p><code>apple.china.conf</code>：Apple域名将加速发展。<br/><br>一些ISP（通常是较小的ISP）在使用其中国大陆CDN服务器访问Apple资产时遇到问题。如果发生这种情况，请考虑删除此文件。</p>
</li>
<li><p><code>bogus-nxdomain.china.conf</code>：反劫持，一般某域名如果不存在 dns 解析结果，会返回 nxdomain ，但是有些运营商会无良重定向至 114 导航等广告页面，dnsmasq-china-list 项目收集了一些这种污染 IP</p>
</li>
</ul>
<h2 id="定时检测-hosts-自动刷新-Dnsmasq"><a href="#定时检测-hosts-自动刷新-Dnsmasq" class="headerlink" title="定时检测 hosts , 自动刷新 Dnsmasq"></a>定时检测 hosts , 自动刷新 Dnsmasq</h2><p>每次改动 hosts , 都需要手动 restart Dnsmasq ,整了个自动化脚本放到定时任务里，实现自动刷新<br>新增定时脚本<code>dnsmasq_crontab.sh</code>, 作用是检测 add_hosts 文件1分钟内有没有修改，如有修改执行 restart dnsmqsq 命令 </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment">######################脚本注释#############################</span></span><br><span class="line"><span class="comment"># 功  能： Dnsmasq自动刷新                                #</span></span><br><span class="line"><span class="comment"># 作  者： hoke                                           #</span></span><br><span class="line"><span class="comment"># 时  间： 20191126                                       #</span></span><br><span class="line"><span class="comment">###########################################################</span></span><br><span class="line">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/<span class="built_in">local</span>/bin:/usr/<span class="built_in">local</span>/sbin:~/bin</span><br><span class="line"><span class="built_in">export</span> PATH</span><br><span class="line"><span class="comment">#Current folder</span></span><br><span class="line">CUR_DIR=`<span class="built_in">pwd</span>`</span><br><span class="line">DNSMASQ_PATH=/home/hoke/dnsmasq/</span><br><span class="line">DNSMASQ_HOSTS=add_hosts</span><br><span class="line">DNSMASQ_CHECK=`find <span class="variable">$&#123;DNSMASQ_PATH&#125;</span> -name <span class="variable">$&#123;DNSMASQ_HOSTS&#125;</span> -mmin -2`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="variable">$DNSMASQ_CHECK</span> ];<span class="keyword">then</span></span><br><span class="line">  systemctl restart dnsmasq</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>加入 crontab</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">*/1 * * * * /home/hoke/dnsmasq/dnsmasq_crontab.sh</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>系统运维</category>
      </categories>
      <tags>
        <tag>Dnsmasq</tag>
        <tag>DNS</tag>
        <tag>DHCP</tag>
      </tags>
  </entry>
  <entry>
    <title>Hyperledger Fabric 扫盲之私有数据</title>
    <url>/blockchain/hyperledger-fabric-privatedata.html</url>
    <content><![CDATA[<p><img src="https://upyun.hoke58.cn/img/CHFA-hyperledger-fabric.png" alt="CHFA-hyperledger-fabric.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>从 <strong>Hyperledger Fabric v1.2</strong> 开始引入了 <strong>Private Data</strong>，对于该特性一直处于空白阶段，现把落下的安排啦，并将知识点整理成文，欢迎交流讨论</p>
<a id="more"></a>

<div class="note info">
            <p>本文中的实验环境为 <strong>Hyperledger Fabric v1.4</strong></p>
          </div>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在 v1.2 之前，一个通道内账本数据对所有组织成员是公开的，当对手交易方不想让交易数据对其它成员可见，则必须为对手交易方创建一个新的通道，这会产生额外的管理开销，例如：大量的通道配置，链码管理，背书策略，成员服务管理等。另外，即使为每类对手交易创建不同的通道仍无法解决敏感数据的保密，因此 <strong>Hyperledger Fabric v1.2</strong> 开始引入了 <strong>private data</strong> 特性，解决通道内数据保密性问题。</p>
<h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><h2 id="private-data"><a href="#private-data" class="headerlink" title="private data"></a>private data</h2><p><strong><code>private data</code></strong> （私有数据）实际场景中多指商业机密数据（客户，金额，折扣等）和用户隐私数据（账户信息，交易信息，个人身份信息，财产信息等）。私有数据不会存储在排序节点和分类账本中，仅保存在被授权 <strong>peer</strong> 的 私有数据库（<strong>private state database</strong> 也叫 <strong>SideDB</strong> ）或 瞬态存储库（<strong>transient store</strong>），并且私有数据只能通过 <span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvZ29zc2lwLmh0bWw=" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/gossip.html">gossip<i class="fa fa-external-link"></i></span> 协议分发至被授权的 <strong>peer</strong>，因此每个 <strong>peer</strong> 需要配置<code>CORE_PEER_GOSSIP_EXTERNALENDPOINT</code> 保证跨组织通讯。</p>
<h2 id="private-data-hash"><a href="#private-data-hash" class="headerlink" title="private data hash"></a>private data hash</h2><p><strong><code>private data hash</code></strong> （私有数据哈希）由背书节点生成，经过排序服务写入每个账本数据中。<strong>Hash</strong> 用于状态验证及私有交易的证明（可用于审计），是<a href="https://www.jinse.com/blockchain/472935.html" target="_blank" rel="noopener">零知积证明（<strong>zero-knowledge proof</strong>）</a>技术应用。</p>
<p>如果私有交易成员间发生分歧又或者他们想出让资产给第三方，则他们可以决定与第三方共享数据，然后第三方可以计算私有数据的哈希，并查看它是否与账上的状态匹配，从而证明在某个时间点上交易成员之间存在状态。</p>
<p>即使私有数据的哈希将公开存储在通道中，也无法将哈希反转为原始内容</p>
<h2 id="private-data-collection"><a href="#private-data-collection" class="headerlink" title="private data collection"></a>private data collection</h2><p><strong><code>private data collection</code></strong> （私有数据集）由 <code>private data</code> 和 <code>private data hash</code> 两个元素组成，用于控制哪些组织或用户有权访问私有数据。</p>
<h1 id="私有数据集存储"><a href="#私有数据集存储" class="headerlink" title="私有数据集存储"></a>私有数据集存储</h1><p><img src="https://upyun.hoke58.cn/img/Untitled-1-Fabric-private-data-peer.png" alt="Untitled-1-Fabric-private-data-peer.png"></p>
<p>上图是 <strong>peer</strong> 开启私有数据的示意图，由两部分组织，第一部分为公共数据就是我们平常指的的区块链和世界状态，第二部分就是私有数据，它包含以下三块：</p>
<ol>
<li><code>Private Writeset Storage</code> （私有写集库）保存每一个私有数据集的所有交易的历史，每个 peer 中可以配置有多个 <code>Private Writeset Storage</code>实例。注意，这种存储不是区块链，而是一种典型的日志持久化数据库。</li>
<li><code>Private State Database</code> （私有数据库）类似于公共部分的世界状态，保存私有集合的当前状态。与私有写集库一样可以配置多个私有数据库实例。</li>
<li><code>Transient Store</code> （瞬态存储库）私有数据暂存库，属于过程态的临时库。</li>
</ol>
<p><img src="https://upyun.hoke58.cn/img/fabric-private-data-collection-Fabric-Explained-7-sharp-2.png" alt="fabric-private-data-collection-Fabric-Explained-7-sharp-2.png"></p>
<p>上图显示了同一个通道内来自不同组织的三个 <strong>peer</strong>，存储了<code>#1</code> 和 <code>#2</code> 两个私有数据集实例。<code>#1</code> 对三个 <strong>peer</strong> 可见，<code>#2</code> 仅对 <strong>Org1-peer</strong> 和 <strong>Org2-peer</strong> 开放。</p>
<h1 id="交易流程"><a href="#交易流程" class="headerlink" title="交易流程"></a>交易流程</h1><p><img src="https://upyun.hoke58.cn/img/fabric-private-data-collection-%E4%BA%A4%E6%98%93%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="fabric-private-data-collection-交易流程图.png"></p>
<ol>
<li>客户端应用程序提交一个调用链码函数(读或写私有数据)的提案请求，私有数据被发送到提案的 <code>transient</code> 字段中</li>
<li>背书节点仿真执行交易，并把私有数据存储至瞬态存储库，然后根据私有数据集策略，私有数据通过 <span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvZ29zc2lwLmh0bWw=" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/gossip.html">gossip<i class="fa fa-external-link"></i></span> 协议分发至被授权的记账节点，这些记账节点同样将私有数据存储到瞬态存储库</li>
<li>只有当传完指定数量的记账节点后，背书节点将结果进行签名，返回给客户端的数据不包含私有数据，只会返回签名和私有数据 <strong>key</strong> 和 <strong>value</strong> 的哈希值</li>
<li>客户端将提案的响应发送给排序节点，排序节点无法看到私有数据的内容，只能看到一串哈希值</li>
<li>排序节点出块将交易区块广播给记账节点</li>
<li>对于公共数据记账节点会验证背书策略，验证成功会新增区块，更新世界状态，对于私有数据首先判断是否有为私有数据授权节点，如果是授权节点，检查本地瞬态存储库是否收到私有数据，如果没有收到则尝试从其他授权节点拉取，然后根据公共区块中的哈希验证私有数据，以上过程验证成功后，记账节点就会将瞬态存储库中的数据正式存储到私有数据库，最后删除瞬态存储库</li>
<li>记账节点存储完成后会通知客户端记账的情况</li>
</ol>
<h1 id="私有数据集配置"><a href="#私有数据集配置" class="headerlink" title="私有数据集配置"></a>私有数据集配置</h1><p>私有数据集只有在链码实例化或升级时才能配置，可以使用命令行 <code>peer chaincode instantiate --collections-config</code> 引用集合配置文件即可；如果是客户端SDK，请查看<span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci5naXRodWIuaW8vZmFicmljLXNkay1ub2RlL3JlbGVhc2UtMS40L3R1dG9yaWFsLXByaXZhdGUtZGF0YS5odG1s" title="https://hyperledger.github.io/fabric-sdk-node/release-1.4/tutorial-private-data.html">SDK文档<i class="fa fa-external-link"></i></span>。</p>
<p>私有数据集配置包含一个或多个集合定义，每个集合由以下参数构成：</p>
<ul>
<li><code>name</code>: 集合名字</li>
<li><code>policy</code>: 私有数据策略，定义了哪些组织可以存储私有数据，使用 <code>OR</code> / <code>AND</code> 签名语法列表。因为 <code>peer</code> 得有私有数据才能给提案背书，所以私有数据策略得比背书策略更宽泛</li>
<li><code>requiredPeerCount</code>: 背书 <code>peer</code> 返回执行结果前必须分发私有数据给提交记账 <code>peer</code> 的节点最小数量，如果值为<code>0</code>，则不分发，不建议设 <code>0</code>，因为没有冗余数据，一旦 <code>peer</code> 不可用，可能造成私有数据丢失</li>
<li><code>maxPeerCount</code>: 最大要分发的节点数量，如果值为<code>0</code>，则在背书阶段不会分发私有数据，强制在提交记账阶段拉取私有数据</li>
<li><code>blockToLive</code>: 私有数据的保存期限（以区块为单位），超过这个期限私有数据会自动销毁。如果值为<code>0</code>，则永不销毁</li>
<li><code>memberOnlyRead</code>: 仅集合成员访问权限，布尔值。不允许非集合成员访问设值 <code>true</code> ，如果需要颗粒度更细的权限控制设值为 <code>false</code>，并在链码函数中定义集合成员权限。</li>
</ul>
<p>接下来写个配置样例，就以<a href="#私有数据集存储">私有数据集存储</a>图二所示，同一个通道内来自不同组织的三个 <strong>peer</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"collection#1"</span>,</span><br><span class="line">    <span class="attr">"policy"</span>: <span class="string">"OR('Org1MSP.member', 'Org2MSP.member', 'Org3MSP.member')"</span>,</span><br><span class="line">    <span class="attr">"requiredPeerCount"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"maxPeerCount"</span>: <span class="number">3</span>,</span><br><span class="line">    "blockToLive":50, // 第50个区块链后数据删除</span><br><span class="line">    "memberOnlyRead": true</span><br><span class="line"> &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"collection#2"</span>,</span><br><span class="line">    <span class="attr">"policy"</span>: <span class="string">"OR('Org1MSP.member', 'Org2MSP.member')"</span>,</span><br><span class="line">    <span class="attr">"requiredPeerCount"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"maxPeerCount"</span>: <span class="number">2</span>,</span><br><span class="line">    "blockToLive":20, // 第20个区块链后数据删除</span><br><span class="line">    "memberOnlyRead": true</span><br><span class="line"> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>前文说过私有数据集只有在链码实例化或升级时才能配置，所以如果需要更新私有数据集配置，只能升级链码版本，使用命令行 <code>peer chaincode upgrade --collections-config</code> ，升级时原有的集合配置必须包含在内</p>
<div class="note warning">
            <ol><li>私有数据升级时 <code>name</code> 和 <code>blockToLive</code> 值必须保持一致</li><li>集合更新生效后，集合不能被删除，因为区块链上可能有先前私有数据的哈希，而区块链数据无法删除</li></ol>
          </div>

<h1 id="Peer-间私有数据的同步"><a href="#Peer-间私有数据的同步" class="headerlink" title="Peer 间私有数据的同步"></a>Peer 间私有数据的同步</h1><p>有关私有数据 Peer 配置项可查看 <code>core.yaml</code> 文件的 <code>peer.gossip.pvtData</code> 部分，以下我们将其截图出来解析</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">pvtData:</span></span><br><span class="line">    <span class="comment"># 记账阶段 peer 拉取私有数据的最大时间阈值，如果未在阈值内拉取完成则不会存值私有数据</span></span><br><span class="line"><span class="attr">    pullRetryThreshold:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line">    <span class="comment"># 前面我们学习了当私有交易提交记账后，私有数据会从瞬态存储库中删除，但如果这条交易永不提交呢，transientstoreMaxBlockRetention 就发挥作用了，表示瞬态存储库保留时间</span></span><br><span class="line">    <span class="comment"># 当前区块高度开始计算至设定值以及设定值倍数的提交区块，将触发删除瞬态存储库存储的私有数据</span></span><br><span class="line"><span class="attr">    transientstoreMaxBlockRetention:</span> <span class="number">1000</span></span><br><span class="line">    <span class="comment"># 在背书阶段，私有数据推送到其他 peer 的等待超时时间</span></span><br><span class="line"><span class="attr">    pushAckTimeout:</span> <span class="number">3</span><span class="string">s</span></span><br><span class="line">    <span class="comment"># BTL缓冲器，防止 peer 拉取即将清除的私有数据</span></span><br><span class="line">    <span class="comment"># 新增 peer 时，当 peer 解析到私有数据的公共信息时，会得到私有数据所在区块的编号，这时会去判断 ((区块高度 + btlPullMargin) &gt; (私有数据所在区块高度+ BTL))，如果 true ，不会去拉取私密数据</span></span><br><span class="line">    <span class="comment"># btlPullMargin 默认值是 10</span></span><br><span class="line"><span class="attr">    btlPullMargin:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 为了保障私有数据一致性，v1.4 版后新增补偿机制，它会无限循环拉取带有私有数据的最近丢失的区块， reconcileBatchSize 表示在每次迭代补偿中丢失数据最大批大小，默认为 10</span></span><br><span class="line"><span class="attr">    reconcileBatchSize:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 每次补偿迭代的间隔时间</span></span><br><span class="line"><span class="attr">    reconcileSleepInterval:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line">    <span class="comment"># 补偿器是否启用</span></span><br><span class="line"><span class="attr">    reconciliationEnabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h1 id="为私有数据集合建立索引"><a href="#为私有数据集合建立索引" class="headerlink" title="为私有数据集合建立索引"></a>为私有数据集合建立索引</h1><p>在<span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY291Y2hkYl9hc19zdGF0ZV9kYXRhYmFzZS5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/couchdb_as_state_database.html">使用CouchDB作为状态数据库<i class="fa fa-external-link"></i></span>时，可以使用 <code>json</code> 格式的文件配置数据库的索引，索引文件放到<code>META-INF/statedb/couchdb/indexes</code>目录下。同样的私有数据也可以使用索引，方法如下：</p>
<ul>
<li>文件路径<br><code>META-INF/statedb/couchdb/collections/&lt;collection_name&gt;/indexes</code></li>
<li>索引文件<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"fields"</span>:[<span class="string">"docType"</span>,<span class="string">"owner"</span>]&#125;,<span class="attr">"ddoc"</span>:<span class="string">"indexOwnerDoc"</span>, <span class="attr">"name"</span>:<span class="string">"indexOwner"</span>,<span class="attr">"type"</span>:<span class="string">"json"</span>&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="链码引用私有数据"><a href="#链码引用私有数据" class="headerlink" title="链码引用私有数据"></a>链码引用私有数据</h1><p>任何一个链码都可以引用多个私有数据集合。链码的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h5cGVybGVkZ2VyL2ZhYnJpYy9ibG9iL3YxLjQuMS9jb3JlL2NoYWluY29kZS9zaGltL2ludGVyZmFjZXMuZ28=" title="https://github.com/hyperledger/fabric/blob/v1.4.1/core/chaincode/shim/interfaces.go">shim APIs<i class="fa fa-external-link"></i></span> 接口可用设置和检索私有数据，以下提供常用方法：</p>
<ul>
<li><code>PutPrivateData(collection string, key string, value []byte) error</code></li>
<li><code>GetPrivateData(collection, key string) ([]byte, error)</code></li>
<li><code>GetPrivateDataByRange(collection, startKey, endKey string) (StateQueryIteratorInterface, error)</code></li>
<li><code>GetPrivateDataByPartialCompositeKey(collection, objectType string, keys []string) (StateQueryIteratorInterface, error)</code></li>
<li><code>GetPrivateDataQueryResult(collection, query string) (StateQueryIteratorInterface, error)</code>  //只有使用couchdb才能使用富查询语句</li>
<li><code>GetTransient() (map[string][]byte, error)</code></li>
</ul>
<p>有关 <code>shim</code> 包文档也可以至<span class="exturl" data-url="aHR0cHM6Ly9wa2cuZ28uZGV2L2dpdGh1Yi5jb20vaHlwZXJsZWRnZXIvZmFicmljL2NvcmUvY2hhaW5jb2RlL3NoaW0/dGFiPWRvYyNwa2ctY29uc3RhbnRz" title="https://pkg.go.dev/github.com/hyperledger/fabric/core/chaincode/shim?tab=doc#pkg-constants">Golang文档<i class="fa fa-external-link"></i></span>了解（需翻墙）</p>
<ol>
<li><strong>SDK</strong> 调用 <strong>chaincode</strong> 执行范围查询或富查询时，如果查询的 <strong>peer</strong> 缺少私有数据，可能会返回结果集的一个子集，有些 <strong>Peer</strong> 可能不包含私有数据，<strong>SDK</strong> 可以查询多个 <strong>Peer</strong> 并比较结果，以确定是否丢失了私有数据。</li>
<li>不支持同一个事务中执行范围查询或富查询时，执行数据更新，因为无法判断 <strong>peer</strong> 是否有权限拥有私密数据权限，或是否丢失私密数据。如果在同一事务中同时包含查询和更新私密数据操作，提案将返回 <code>Error</code>。建议分为两个交易执行。但是一个 <strong>chaincode</strong> 方法中既包含 <code>GetPrivateData()</code> 和 <code>PutPrivateData()</code> 是可以的，因为所有 <strong>peer</strong> 都可以基于 <code>key</code> 的哈希校验 <code>key</code></li>
</ol>
<h1 id="私有数据内容保护"><a href="#私有数据内容保护" class="headerlink" title="私有数据内容保护"></a>私有数据内容保护</h1><p>如果私有数据相对简单且可预测（例如交易金额），未授权的组织成员可能暴力哈希作用域内的私数据内容，以期匹配区块链上私有数据哈希。因此，可预计的私有数据内容可以混入随机数，比如安全的伪随机源，然后再调用链码时将私有数据传递到 <code>transient</code> 字段中。</p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>纸上得来终觉浅 绝知此事要躬行，正好最近在学习 Go，撸一遍加深印象吧！</p>
<div class="note info">
            <ul><li>开发环境： <code>go version go1.14 windows/amd64</code></li><li>参考教程： <span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvcHJpdmF0ZV9kYXRhX3R1dG9yaWFsLmh0bWw=" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/private_data_tutorial.html">fabric-samples<i class="fa fa-external-link"></i></span></li></ul>
          </div>
<p>开撸之前咱得先设计一下应用场景，考虑一下实现功能。我简单想了个供应商场景</p>
<ol>
<li>供应商数据属于机密数据</li>
<li>数据分两类，供应商基本资料和报价</li>
<li>成员之间访问权限不同</li>
</ol>
<p>有了场景，私有数据配置就出来了</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">       "name": "vendor", //供应商基本信息</span><br><span class="line">       "policy": "OR('Org1MSP.member', 'Org2MSP.member')", // 供应商基本信息org1和org2个有权限访问</span><br><span class="line">       "requiredPeerCount": 1,</span><br><span class="line">       "maxPeerCount": 3,</span><br><span class="line">       "blockToLive":10, </span><br><span class="line">       "memberOnlyRead": true</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">       "name": "vendorPrice", //供应商报价</span><br><span class="line">       "policy": "OR('Org1MSP.member')", // 供应商报价只有Org1有权限</span><br><span class="line">       "requiredPeerCount": 1,</span><br><span class="line">       "maxPeerCount": 3,</span><br><span class="line">       "blockToLive":10, </span><br><span class="line">       "memberOnlyRead": true</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>接下来就是撸代码了，尽量把 <code>chaincode</code> 中引用私有数据的常用方法试一下，代码就不放了，有兴趣可以去我的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hva2U1OC9mYWJyaWMtY2hhaW5jb2Rl" title="https://github.com/hoke58/fabric-chaincode">github<i class="fa fa-external-link"></i></span> 参考</p>
<h2 id="供应商链码使用"><a href="#供应商链码使用" class="headerlink" title="供应商链码使用"></a>供应商链码使用</h2><p>利用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h5cGVybGVkZ2VyL2ZhYnJpYy1zYW1wbGVz" title="https://github.com/hyperledger/fabric-samples">fabric-samples<i class="fa fa-external-link"></i></span> 样例快速拉套环境 <code>./byfn.sh up</code> ，把项目代码挂载到 <code>chaincode</code> 目录下</p>
<ol>
<li>安装链码，记得安装 Org2MSP 链码时得切换环境变量<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">peer chaincode install -n vendor -v 1.0 -p github.com/github.com/hoke58/fabric-chaincode/vendorPDC/</span><br></pre></td></tr></table></figure></li>
<li>实例化<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">peer chaincode instantiate -o orderer.example.com:7050 --tls --cafile <span class="variable">$ORDERER_CA</span> -C mychannel -n vendor -v 1.0 -c <span class="string">'&#123;"Args":["init"]&#125;'</span> -P <span class="string">"OR('Org1MSP.member','Org2MSP.member')"</span> --collections-config <span class="variable">$GOPATH</span>/src/github.com/github.com/hoke58/fabric-chaincode/vendorPDC/collections_config.json</span><br></pre></td></tr></table></figure></li>
<li>创建供应商<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> VENDOR=$(<span class="built_in">echo</span> -n <span class="string">"&#123;\"Name\":\"test0\",\"Project\":\"supplychain\",\"Status\":\"yes\",\"Expiry\":\"2020-05-01\",\"Price\":6666&#125;"</span> | base64 | tr -d \\n)</span><br><span class="line">peer chaincode invoke -o orderer.example.com:7050 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n vendor -c <span class="string">'&#123;"Args":["putVendor"]&#125;'</span>  --transient <span class="string">"&#123;\"vendor\":\"<span class="variable">$VENDOR</span>\"&#125;"</span></span><br></pre></td></tr></table></figure></li>
<li>查询供应商基本信息<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n vendor -c <span class="string">'&#123;"Args":["getVendor","test0"]&#125;'</span></span><br></pre></td></tr></table></figure></li>
<li>查核供应商报价，<strong>Org2MSP</strong> 是看不到报价的<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n vendor -c <span class="string">'&#123;"Args":["getVendorPrice","test0"]&#125;'</span></span><br></pre></td></tr></table></figure></li>
<li>再创建几个供应商，试一下范围查询<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 供应商test1</span></span><br><span class="line"><span class="built_in">export</span> VENDOR=$(<span class="built_in">echo</span> -n <span class="string">"&#123;\"Name\":\"test1\",\"Project\":\"supplychain\",\"Status\":\"yes\",\"Expiry\":\"2020-05-01\",\"Price\":7777&#125;"</span> | base64 | tr -d \\n)</span><br><span class="line">peer chaincode invoke -o orderer.example.com:7050 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n vendor -c <span class="string">'&#123;"Args":["putVendor"]&#125;'</span>  --transient <span class="string">"&#123;\"vendor\":\"<span class="variable">$VENDOR</span>\"&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 供应商test2</span></span><br><span class="line"><span class="built_in">export</span> VENDOR=$(<span class="built_in">echo</span> -n <span class="string">"&#123;\"Name\":\"test2\",\"Project\":\"supplychain\",\"Status\":\"yes\",\"Expiry\":\"2020-05-01\",\"Price\":8888&#125;"</span> | base64 | tr -d \\n)</span><br><span class="line">peer chaincode invoke -o orderer.example.com:7050 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n vendor -c <span class="string">'&#123;"Args":["putVendor"]&#125;'</span>  --transient <span class="string">"&#123;\"vendor\":\"<span class="variable">$VENDOR</span>\"&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#供应商test3</span></span><br><span class="line"><span class="built_in">export</span> VENDOR=$(<span class="built_in">echo</span> -n <span class="string">"&#123;\"Name\":\"test3\",\"Project\":\"supplychain\",\"Status\":\"no\",\"Expiry\":\"2020-05-01\",\"Price\":9999&#125;"</span> | base64 | tr -d \\n)</span><br><span class="line">peer chaincode invoke -o orderer.example.com:7050 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n vendor -c <span class="string">'&#123;"Args":["putVendor"]&#125;'</span>  --transient <span class="string">"&#123;\"vendor\":\"<span class="variable">$VENDOR</span>\"&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 范围查询</span></span><br><span class="line">peer chaincode query -C mychannel -n vendor -c <span class="string">'&#123;"Args":["getVendorByRange","test0","test3"]&#125;'</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvcHJpdmF0ZS1kYXRhL3ByaXZhdGUtZGF0YS5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/private-data/private-data.html">https://hyperledger-fabric.readthedocs.io/en/release-1.4/private-data/private-data.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvcHJpdmF0ZS1kYXRhLWFyY2guaHRtbA==" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/private-data-arch.html">https://hyperledger-fabric.readthedocs.io/en/release-1.4/private-data-arch.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0lCTS9wcml2YXRlLWRhdGEtY29sbGVjdGlvbnMtb24tZmFicmlj" title="https://github.com/IBM/private-data-collections-on-fabric">https://github.com/IBM/private-data-collections-on-fabric<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY2hhaW5jb2RlNGFkZS5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/chaincode4ade.html">https://hyperledger-fabric.readthedocs.io/en/release-1.4/chaincode4ade.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MTIyODE5Ng==" title="https://zhuanlan.zhihu.com/p/41228196">P2P 网络核心技术：Gossip 协议<i class="fa fa-external-link"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>区块链</category>
      </categories>
      <tags>
        <tag>fabric</tag>
        <tag>Hyperledger</tag>
        <tag>Private Data</tag>
      </tags>
  </entry>
  <entry>
    <title>mongod start failed</title>
    <url>/databases/mongod-start-failed.html</url>
    <content><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>遇到一例mongod无法启动，记录一下解决方案</p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>I was using mongodb after unusual shutdown my mongodb is failing to start. Here I am using wiredTiger Storage Engine, I think the wiredTiger.wt file got corrupted but I dont know what to do</p>
<a id="more"></a>
<p>on doing sevice mongod start it gave me this error log</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"> 2015-05-12T16:54:35.442+0530 I CONTROL ***** SERVER RESTARTED *****</span><br><span class="line">2015-05-12T16:54:35.465+0530 I STORAGE [initandlisten] wiredtiger_open config: create,cache_size=7G,session_max=20000,eviction=(threads_max=4),statistics=(fast),<span class="built_in">log</span>=(enabled=<span class="literal">true</span>,archive=<span class="literal">true</span>,path=journal,compressor=snappy),checkpoint=(<span class="built_in">wait</span>=60,log_size=2GB),statistics_log=(<span class="built_in">wait</span>=0),</span><br><span class="line">2015-05-12T16:54:35.469+0530 E STORAGE [initandlisten] WiredTiger (0) [1431429875:469521][10501:0x7f1a672e3c20], file:WiredTiger.wt, connection: <span class="built_in">read</span> checksum error [4096B @ 32768, 3884066602 != 1841814112]</span><br><span class="line">2015-05-12T16:54:35.469+0530 E STORAGE [initandlisten] WiredTiger (0) [1431429875:469550][10501:0x7f1a672e3c20], file:WiredTiger.wt, connection: WiredTiger.wt: encountered an illegal file format or internal value</span><br><span class="line">2015-05-12T16:54:35.469+0530 E STORAGE [initandlisten] WiredTiger (-31804) [1431429875:469563][10501:0x7f1a672e3c20], file:WiredTiger.wt, connection: the process must <span class="built_in">exit</span> and restart: WT_PANIC: WiredTiger library panic</span><br><span class="line">2015-05-12T16:54:35.469+0530 I - [initandlisten] Fatal Assertion 28558</span><br><span class="line">2015-05-12T16:54:35.478+0530 I CONTROL [initandlisten] </span><br><span class="line">0xf68719 0xf06c91 0xeeaad1 0xd8761a 0x1399239 0x13993f5 0x1399894 0x12f0e52 0x130955c 0x1307358 0x13081d2 0x133014b 0x139877d 0x13669eb 0x132d937 0xd7150b 0xd6f3a8 0xa8033d 0x7f36a2 0x7f8c14 0x3bf4a1ed5d 0x7f1435</span><br><span class="line">----- BEGIN BACKTRACE -----</span><br><span class="line">&#123;<span class="string">"backtrace"</span>:[&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"B68719"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"B06C91"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"AEAAD1"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"98761A"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F99239"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F993F5"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F99894"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"EF0E52"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F0955C"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F07358"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F081D2"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F3014B"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F9877D"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F669EB"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F2D937"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"97150B"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"96F3A8"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"68033D"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"3F36A2"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"3F8C14"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"3BF4A00000"</span>,<span class="string">"o"</span>:<span class="string">"1ED5D"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"3F1435"</span>&#125;],<span class="string">"processInfo"</span>:&#123; <span class="string">"mongodbVersion"</span> : <span class="string">"3.0.2"</span>, <span class="string">"gitVersion"</span> : <span class="string">"6201872043ecbbc0a4cc169b5482dcf385fc464f"</span>, <span class="string">"uname"</span> : &#123; <span class="string">"sysname"</span> : <span class="string">"Linux"</span>, <span class="string">"release"</span> : <span class="string">"2.6.32-504.12.2.el6.x86_64"</span>, <span class="string">"version"</span> : <span class="string">"#1 SMP Wed Mar 11 22:03:14 UTC 2015"</span>, <span class="string">"machine"</span> : <span class="string">"x86_64"</span> &#125;, <span class="string">"somap"</span> : [ &#123; <span class="string">"elfType"</span> : 2, <span class="string">"b"</span> : <span class="string">"400000"</span>, <span class="string">"buildId"</span> : <span class="string">"528324F7E7422ECA899108CA2A12B5AAAA2A5569"</span> &#125;, &#123; <span class="string">"b"</span> : <span class="string">"7FFFB0EFE000"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"4B8E1260CCD7C3D8CC131E84001F7220651617EC"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libpthread.so.0"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"B8DFF8E53D9F2B80C3C382E83EC17C828B536A39"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/usr/lib64/libssl.so.10"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"934508308DAF0D5C61E9997463F0D8B0A3F096BA"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/usr/lib64/libcrypto.so.10"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"A4329A30669C783FA8DEEB7D1EA83749A8FA14E1"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/librt.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"583411D8786F86A1D6B8741C502831E6122445A7"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libdl.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"454F8FC6CC6502C6401E5F9E221564D80665D277"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/usr/lib64/libstdc++.so.6"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"F07F2E7CF4BFB393CC9BBE8CDC6463652E14DB07"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libm.so.6"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"7D8E9374F4A4EA38A7C1E763F32240EA113E4208"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libgcc_s.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"246C3BAB0AB093AFD59D34C8CBF29E786DE4BE97"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libc.so.6"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"E4EAB3C200B7D8444FF95AB01F6466924A6A5F5F"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/ld-linux-x86-64.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"6F8E59B70E469F3A924A268911FF8FD0C37E7460"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libgssapi_krb5.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"54BA6B78A9220344E77463947215E42F0EABCC62"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libkrb5.so.3"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"6797403AA5F8FAD8ADFF683478B45F528CE4FB0E"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libcom_err.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"8CE28F280150E62296240E70ECAC64E4A57AB826"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libk5crypto.so.3"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"05733977F4E41652B86070B27A0CFC2C1EA7719D"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libz.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"5FA8E5038EC04A774AF72A9BB62DC86E1049C4D6"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libkrb5support.so.0"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"E3FA235F3BA3F776A01A18ECA737C9890F445923"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libkeyutils.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"AF374BAFB7F5B139A0B431D3F06D82014AFF3251"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libresolv.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"F8B68F301C19BF06AF56B4B06E0A69F89D2C1F8D"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libselinux.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"E6798A06BEE17CF102BBA44FD512FF8B805CEAF1"</span> &#125; ] &#125;&#125;</span><br><span class="line">mongod(_ZN5mongo15printStackTraceERSo+0x29) [0xf68719]</span><br><span class="line">mongod(_ZN5mongo10logContextEPKc+0xE1) [0xf06c91]</span><br><span class="line">mongod(_ZN5mongo13fassertFailedEi+0x61) [0xeeaad1]</span><br><span class="line">mongod(+0x98761A) [0xd8761a]</span><br><span class="line">mongod(__wt_eventv+0x489) [0x1399239]</span><br><span class="line">mongod(__wt_err+0x95) [0x13993f5]</span><br><span class="line">mongod(__wt_panic+0x24) [0x1399894]</span><br><span class="line">mongod(__wt_bm_read+0x72) [0x12f0e52]</span><br><span class="line">mongod(__wt_bt_read+0x1AC) [0x130955c]</span><br><span class="line">mongod(__wt_btree_tree_open+0x58) [0x1307358]</span><br><span class="line">mongod(__wt_btree_open+0xD02) [0x13081d2]</span><br><span class="line">mongod(__wt_conn_btree_get+0x19B) [0x133014b]</span><br><span class="line">mongod(__wt_session_get_btree+0x31D) [0x139877d]</span><br><span class="line">mongod(__wt_metadata_open+0x2B) [0x13669eb]</span><br><span class="line">mongod(wiredtiger_open+0xCD7) [0x132d937]</span><br><span class="line">mongod(_ZN5mongo18WiredTigerKVEngineC1ERKSsS2_bb+0x2EB) [0xd7150b]</span><br><span class="line">mongod(+0x96F3A8) [0xd6f3a8]</span><br><span class="line">mongod(_ZN5mongo23GlobalEnvironmentMongoD22setGlobalStorageEngineERKSs+0x30D) [0xa8033d]</span><br><span class="line">mongod(_ZN5mongo13initAndListenEi+0x422) [0x7f36a2]</span><br><span class="line">mongod(main+0x134) [0x7f8c14]</span><br><span class="line">libc.so.6(__libc_start_main+0xFD) [0x3bf4a1ed5d]</span><br><span class="line">mongod(+0x3F1435) [0x7f1435]</span><br><span class="line">----- END BACKTRACE -----</span><br><span class="line">2015-05-12T16:54:35.478+0530 I - [initandlisten]</span><br><span class="line"></span><br><span class="line">***aborting after fassert() failure</span><br></pre></td></tr></table></figure>
<p>and even unable to repair it, giving similar type of error when I try to repair it.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@host name wiredTiger]<span class="comment"># mongod --dbpath /home/mongodbProject/database/wiredTiger --repair --repairpath /home/mongodbProject/repairData/rep --storageEngine wiredTiger</span></span><br><span class="line">2015-05-13T16:30:15.206+0530 I STORAGE  [initandlisten] wiredtiger_open config: create,cache_size=7G,session_max=20000,eviction=(threads_max=4),statistics=(fast),checkpoint=(<span class="built_in">wait</span>=60,log_size=2GB),statistics_log=(<span class="built_in">wait</span>=0),</span><br><span class="line">2015-05-13T16:30:15.546+0530 I STORAGE  [initandlisten] Repairing size cache</span><br><span class="line">2015-05-13T16:30:15.554+0530 E STORAGE  [initandlisten] WiredTiger (0) [1431514815:554248][5946:0x7fcb2c444c20], file:sizeStorer.wt, session.verify: <span class="built_in">read</span> checksum error [4096B @ 40960, 2019257843 != 0]</span><br><span class="line">2015-05-13T16:30:15.554+0530 E STORAGE  [initandlisten] WiredTiger (0) [1431514815:554309][5946:0x7fcb2c444c20], file:sizeStorer.wt, session.verify: sizeStorer.wt: encountered an illegal file format or internal value</span><br><span class="line">2015-05-13T16:30:15.554+0530 E STORAGE  [initandlisten] WiredTiger (-31804) [1431514815:554334][5946:0x7fcb2c444c20], file:sizeStorer.wt, session.verify: the process must <span class="built_in">exit</span> and restart: WT_PANIC: WiredTiger library panic</span><br><span class="line">2015-05-13T16:30:15.554+0530 I -        [initandlisten] Fatal Assertion 28558</span><br><span class="line">2015-05-13T16:30:15.571+0530 I CONTROL  [initandlisten] </span><br><span class="line"> 0xf68719 0xf06c91 0xeeaad1 0xd8761a 0x1399239 0x13993f5 0x1399894 0x12eeb3e 0x12eefd8 0x12f1bff 0x12f1d78 0x131b32a 0x139489e 0x1394ad8 0x1394f66 0xd6fc85 0xd71846 0xd6f3a8 0xa8033d 0x7f36a2 0x7f8c14 0x3bf4a1ed5d 0x7f1435</span><br><span class="line">----- BEGIN BACKTRACE -----</span><br><span class="line">&#123;<span class="string">"backtrace"</span>:[&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"B68719"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"B06C91"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"AEAAD1"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"98761A"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F99239"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F993F5"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F99894"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"EEEB3E"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"EEEFD8"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"EF1BFF"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"EF1D78"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F1B32A"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F9489E"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F94AD8"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"F94F66"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"96FC85"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"971846"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"96F3A8"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"68033D"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"3F36A2"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"3F8C14"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"3BF4A00000"</span>,<span class="string">"o"</span>:<span class="string">"1ED5D"</span>&#125;,&#123;<span class="string">"b"</span>:<span class="string">"400000"</span>,<span class="string">"o"</span>:<span class="string">"3F1435"</span>&#125;],<span class="string">"processInfo"</span>:&#123; <span class="string">"mongodbVersion"</span> : <span class="string">"3.0.2"</span>, <span class="string">"gitVersion"</span> : <span class="string">"6201872043ecbbc0a4cc169b5482dcf385fc464f"</span>, <span class="string">"uname"</span> : &#123; <span class="string">"sysname"</span> : <span class="string">"Linux"</span>, <span class="string">"release"</span> : <span class="string">"2.6.32-504.12.2.el6.x86_64"</span>, <span class="string">"version"</span> : <span class="string">"#1 SMP Wed Mar 11 22:03:14 UTC 2015"</span>, <span class="string">"machine"</span> : <span class="string">"x86_64"</span> &#125;, <span class="string">"somap"</span> : [ &#123; <span class="string">"elfType"</span> : 2, <span class="string">"b"</span> : <span class="string">"400000"</span>, <span class="string">"buildId"</span> : <span class="string">"528324F7E7422ECA899108CA2A12B5AAAA2A5569"</span> &#125;, &#123; <span class="string">"b"</span> : <span class="string">"7FFF982F7000"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"4B8E1260CCD7C3D8CC131E84001F7220651617EC"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libpthread.so.0"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"B8DFF8E53D9F2B80C3C382E83EC17C828B536A39"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/usr/lib64/libssl.so.10"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"934508308DAF0D5C61E9997463F0D8B0A3F096BA"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/usr/lib64/libcrypto.so.10"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"A4329A30669C783FA8DEEB7D1EA83749A8FA14E1"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/librt.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"583411D8786F86A1D6B8741C502831E6122445A7"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libdl.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"454F8FC6CC6502C6401E5F9E221564D80665D277"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/usr/lib64/libstdc++.so.6"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"F07F2E7CF4BFB393CC9BBE8CDC6463652E14DB07"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libm.so.6"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"7D8E9374F4A4EA38A7C1E763F32240EA113E4208"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libgcc_s.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"246C3BAB0AB093AFD59D34C8CBF29E786DE4BE97"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libc.so.6"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"E4EAB3C200B7D8444FF95AB01F6466924A6A5F5F"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/ld-linux-x86-64.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"6F8E59B70E469F3A924A268911FF8FD0C37E7460"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libgssapi_krb5.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"54BA6B78A9220344E77463947215E42F0EABCC62"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libkrb5.so.3"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"6797403AA5F8FAD8ADFF683478B45F528CE4FB0E"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libcom_err.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"8CE28F280150E62296240E70ECAC64E4A57AB826"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libk5crypto.so.3"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"05733977F4E41652B86070B27A0CFC2C1EA7719D"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libz.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"5FA8E5038EC04A774AF72A9BB62DC86E1049C4D6"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libkrb5support.so.0"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"E3FA235F3BA3F776A01A18ECA737C9890F445923"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libkeyutils.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"AF374BAFB7F5B139A0B431D3F06D82014AFF3251"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libresolv.so.2"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"F8B68F301C19BF06AF56B4B06E0A69F89D2C1F8D"</span> &#125;, &#123; <span class="string">"path"</span> : <span class="string">"/lib64/libselinux.so.1"</span>, <span class="string">"elfType"</span> : 3, <span class="string">"buildId"</span> : <span class="string">"E6798A06BEE17CF102BBA44FD512FF8B805CEAF1"</span> &#125; ] &#125;&#125;</span><br><span class="line"> mongod(_ZN5mongo15printStackTraceERSo+0x29) [0xf68719]</span><br><span class="line"> mongod(_ZN5mongo10logContextEPKc+0xE1) [0xf06c91]</span><br><span class="line"> mongod(_ZN5mongo13fassertFailedEi+0x61) [0xeeaad1]</span><br><span class="line"> mongod(+0x98761A) [0xd8761a]</span><br><span class="line"> mongod(__wt_eventv+0x489) [0x1399239]</span><br><span class="line"> mongod(__wt_err+0x95) [0x13993f5]</span><br><span class="line"> mongod(__wt_panic+0x24) [0x1399894]</span><br><span class="line"> mongod(__wt_block_extlist_read+0x6E) [0x12eeb3e]</span><br><span class="line"> mongod(__wt_block_extlist_read_avail+0x28) [0x12eefd8]</span><br><span class="line"> mongod(+0xEF1BFF) [0x12f1bff]</span><br><span class="line"> mongod(__wt_block_verify_start+0x108) [0x12f1d78]</span><br><span class="line"> mongod(__wt_verify+0x4AA) [0x131b32a]</span><br><span class="line"> mongod(__wt_schema_worker+0x35E) [0x139489e]</span><br><span class="line"> mongod(__wt_schema_worker+0x598) [0x1394ad8]</span><br><span class="line"> mongod(+0xF94F66) [0x1394f66]</span><br><span class="line"> mongod(_ZN5mongo18WiredTigerKVEngine16_salvageIfNeededEPKc+0x45) [0xd6fc85]</span><br><span class="line"> mongod(_ZN5mongo18WiredTigerKVEngineC1ERKSsS2_bb+0x626) [0xd71846]</span><br><span class="line"> mongod(+0x96F3A8) [0xd6f3a8]</span><br><span class="line"> mongod(_ZN5mongo23GlobalEnvironmentMongoD22setGlobalStorageEngineERKSs+0x30D) [0xa8033d]</span><br><span class="line"> mongod(_ZN5mongo13initAndListenEi+0x422) [0x7f36a2]</span><br><span class="line"> mongod(main+0x134) [0x7f8c14]</span><br><span class="line"> libc.so.6(__libc_start_main+0xFD) [0x3bf4a1ed5d]</span><br><span class="line"> mongod(+0x3F1435) [0x7f1435]</span><br><span class="line">-----  END BACKTRACE  -----</span><br><span class="line">2015-05-13T16:30:15.571+0530 I -        [initandlisten] </span><br><span class="line"></span><br><span class="line">***aborting after fassert() failure</span><br></pre></td></tr></table></figure>
<p>I have tried searching for similar and tried most of it but dint work in my case.Please help</p>
<p>Any help would be appreciated</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Issue solved : <span class="exturl" data-url="aHR0cHM6Ly9qaXJhLm1vbmdvZGIub3JnL2Jyb3dzZS9TRVJWRVItMTg0NDg=" title="https://jira.mongodb.org/browse/SERVER-18448">https://jira.mongodb.org/browse/SERVER-18448<i class="fa fa-external-link"></i></span></p>
<p>there were some files corrupted after updating those files <strong>sizeStorer.wt</strong>, <strong>WiredTiger.turtle</strong>, <strong>WiredTiger.wt</strong> able to repair database using<br><code>sudo mongod --repair --dbpath /database/db --storageEngine wiredTiger</code></p>
<p>before restart check permissions of all files present in database and after updating their permissions restart server.<br><code>sudo service mongod restart</code></p>
<p>there may be some issues regarding lock files. So, delete <strong>mongod.lock</strong>, <strong>wiredTiger.lock</strong> and <strong>mongodb.sock</strong> file present in <strong>/tmp</strong> folder.</p>
<p>now, restart server.</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql 基础知识（转）</title>
    <url>/databases/mysql.html</url>
    <content><![CDATA[<h1 id="一、索引"><a href="#一、索引" class="headerlink" title="一、索引"></a>一、索引</h1><h2 id="B-Tree-原理"><a href="#B-Tree-原理" class="headerlink" title="B+ Tree 原理"></a>B+ Tree 原理</h2><h3 id="1-数据结构"><a href="#1-数据结构" class="headerlink" title="1. 数据结构"></a>1. 数据结构</h3><p>B Tree 指的是 Balance Tree，也就是平衡树。平衡树是一颗查找树，并且所有叶子节点位于同一层。</p>
<p>B+ Tree 是基于 B Tree 和叶子节点顺序访问指针进行实现，它具有 B Tree 的平衡性，并且通过顺序访问指针来提高区间查询的性能。</p>
<p>在 B+ Tree 中，一个节点中的 key 从左到右非递减排列，如果某个指针的左右相邻 key 分别是 key<sub>i</sub> 和 key<sub>i+1</sub>，且不为 null，则该指针指向节点的所有 key 大于等于 key<sub>i</sub> 且小于等于 key<sub>i+1</sub>。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/mysql/33576849-9275-47bb-ada7-8ded5f5e7c73.png" width="350px"> </div><br>
<a id="more"></a>

<h3 id="2-操作"><a href="#2-操作" class="headerlink" title="2. 操作"></a>2. 操作</h3><p>进行查找操作时，首先在根节点进行二分查找，找到一个 key 所在的指针，然后递归地在指针所指向的节点进行查找。直到查找到叶子节点，然后在叶子节点上进行二分查找，找出 key 所对应的 data。</p>
<p>插入删除操作会破坏平衡树的平衡性，因此在插入删除操作之后，需要对树进行一个分裂、合并、旋转等操作来维护平衡性。</p>
<h3 id="3-与红黑树的比较"><a href="#3-与红黑树的比较" class="headerlink" title="3. 与红黑树的比较"></a>3. 与红黑树的比较</h3><p>红黑树等平衡树也可以用来实现索引，但是文件系统及数据库系统普遍采用 B+ Tree 作为索引结构，主要有以下两个原因：</p>
<p>（一）更少的查找次数</p>
<p>平衡树查找操作的时间复杂度和树高 h 相关，O(h)=O(log<sub>d</sub>N)，其中 d 为每个节点的出度。</p>
<p>红黑树的出度为 2，而 B+ Tree 的出度一般都非常大，所以红黑树的树高 h 很明显比 B+ Tree 大非常多，查找的次数也就更多。</p>
<p>（二）利用磁盘预读特性</p>
<p>为了减少磁盘 I/O 操作，磁盘往往不是严格按需读取，而是每次都会预读。预读过程中，磁盘进行顺序读取，顺序读取不需要进行磁盘寻道，并且只需要很短的磁盘旋转时间，速度会非常快。</p>
<p>操作系统一般将内存和磁盘分割成固定大小的块，每一块称为一页，内存与磁盘以页为单位交换数据。数据库系统将索引的一个节点的大小设置为页的大小，使得一次 I/O 就能完全载入一个节点。并且可以利用预读特性，相邻的节点也能够被预先载入。</p>
<h2 id="MySQL-索引"><a href="#MySQL-索引" class="headerlink" title="MySQL 索引"></a>MySQL 索引</h2><p>索引是在存储引擎层实现的，而不是在服务器层实现的，所以不同存储引擎具有不同的索引类型和实现。</p>
<h3 id="1-B-Tree-索引"><a href="#1-B-Tree-索引" class="headerlink" title="1. B+Tree 索引"></a>1. B+Tree 索引</h3><p>是大多数 MySQL 存储引擎的默认索引类型。</p>
<p>因为不再需要进行全表扫描，只需要对树进行搜索即可，所以查找速度快很多。</p>
<p>因为 B+ Tree 的有序性，所以除了用于查找，还可以用于排序和分组。</p>
<p>可以指定多个列作为索引列，多个索引列共同组成键。</p>
<p>适用于全键值、键值范围和键前缀查找，其中键前缀查找只适用于最左前缀查找。如果不是按照索引列的顺序进行查找，则无法使用索引。</p>
<p>InnoDB 的 B+Tree 索引分为主索引和辅助索引。主索引的叶子节点 data 域记录着完整的数据记录，这种索引方式被称为聚簇索引。因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/mysql/45016e98-6879-4709-8569-262b2d6d60b9.png" width="350px"> </div><br>

<p>辅助索引的叶子节点的 data 域记录着主键的值，因此在使用辅助索引进行查找时，需要先查找到主键值，然后再到主索引中进行查找。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/mysql/7c349b91-050b-4d72-a7f8-ec86320307ea.png" width="350px"> </div><br>

<h3 id="2-哈希索引"><a href="#2-哈希索引" class="headerlink" title="2. 哈希索引"></a>2. 哈希索引</h3><p>哈希索引能以 O(1) 时间进行查找，但是失去了有序性：</p>
<ul>
<li>无法用于排序与分组；</li>
<li>只支持精确查找，无法用于部分查找和范围查找。</li>
</ul>
<p>InnoDB 存储引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用的非常频繁时，会在 B+Tree 索引之上再创建一个哈希索引，这样就让 B+Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。</p>
<h3 id="3-全文索引"><a href="#3-全文索引" class="headerlink" title="3. 全文索引"></a>3. 全文索引</h3><p>MyISAM 存储引擎支持全文索引，用于查找文本中的关键词，而不是直接比较是否相等。</p>
<p>查找条件使用 MATCH AGAINST，而不是普通的 WHERE。</p>
<p>全文索引使用倒排索引实现，它记录着关键词到其所在文档的映射。</p>
<p>InnoDB 存储引擎在 MySQL 5.6.4 版本中也开始支持全文索引。</p>
<h3 id="4-空间数据索引"><a href="#4-空间数据索引" class="headerlink" title="4. 空间数据索引"></a>4. 空间数据索引</h3><p>MyISAM 存储引擎支持空间数据索引（R-Tree），可以用于地理数据存储。空间数据索引会从所有维度来索引数据，可以有效地使用任意维度来进行组合查询。</p>
<p>必须使用 GIS 相关的函数来维护数据。</p>
<h2 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h2><h3 id="1-独立的列"><a href="#1-独立的列" class="headerlink" title="1. 独立的列"></a>1. 独立的列</h3><p>在进行查询时，索引列不能是表达式的一部分，也不能是函数的参数，否则无法使用索引。</p>
<p>例如下面的查询不能使用 actor_id 列的索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> sakila.actor <span class="keyword">WHERE</span> actor_id + <span class="number">1</span> = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-多列索引"><a href="#2-多列索引" class="headerlink" title="2. 多列索引"></a>2. 多列索引</h3><p>在需要使用多个列作为条件进行查询时，使用多列索引比使用多个单列索引性能更好。例如下面的语句中，最好把 actor_id 和 film_id 设置为多列索引。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> film_id, actor_ <span class="keyword">id</span> <span class="keyword">FROM</span> sakila.film_actor</span><br><span class="line"><span class="keyword">WHERE</span> actor_id = <span class="number">1</span> <span class="keyword">AND</span> film_id = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-索引列的顺序"><a href="#3-索引列的顺序" class="headerlink" title="3. 索引列的顺序"></a>3. 索引列的顺序</h3><p>让选择性最强的索引列放在前面。</p>
<p>索引的选择性是指：不重复的索引值和记录总数的比值。最大值为 1，此时每个记录都有唯一的索引与其对应。选择性越高，每个记录的区分度越高，查询效率也越高。</p>
<p>例如下面显示的结果中 customer_id 的选择性比 staff_id 更高，因此最好把 customer_id 列放在多列索引的前面。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> staff_id)/<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> staff_id_selectivity,</span><br><span class="line"><span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> customer_id)/<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> customer_id_selectivity,</span><br><span class="line"><span class="keyword">COUNT</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> payment;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">   staff_id_selectivity: 0.0001</span><br><span class="line">customer_id_selectivity: 0.0373</span><br><span class="line">               COUNT(*): 16049</span><br></pre></td></tr></table></figure>

<h3 id="4-前缀索引"><a href="#4-前缀索引" class="headerlink" title="4. 前缀索引"></a>4. 前缀索引</h3><p>对于 BLOB、TEXT 和 VARCHAR 类型的列，必须使用前缀索引，只索引开始的部分字符。</p>
<p>前缀长度的选取需要根据索引选择性来确定。</p>
<h3 id="5-覆盖索引"><a href="#5-覆盖索引" class="headerlink" title="5. 覆盖索引"></a>5. 覆盖索引</h3><p>索引包含所有需要查询的字段的值。</p>
<p>具有以下优点：</p>
<ul>
<li>索引通常远小于数据行的大小，只读取索引能大大减少数据访问量。</li>
<li>一些存储引擎（例如 MyISAM）在内存中只缓存索引，而数据依赖于操作系统来缓存。因此，只访问索引可以不使用系统调用（通常比较费时）。</li>
<li>对于 InnoDB 引擎，若辅助索引能够覆盖查询，则无需访问主索引。</li>
</ul>
<h2 id="索引的优点"><a href="#索引的优点" class="headerlink" title="索引的优点"></a>索引的优点</h2><ul>
<li><p>大大减少了服务器需要扫描的数据行数。</p>
</li>
<li><p>帮助服务器避免进行排序和分组，以及避免创建临时表（B+Tree 索引是有序的，可以用于 ORDER BY 和 GROUP BY 操作。临时表主要是在排序和分组过程中创建，不需要排序和分组，也就不需要创建临时表）。</p>
</li>
<li><p>将随机 I/O 变为顺序 I/O（B+Tree 索引是有序的，会将相邻的数据都存储在一起）。</p>
</li>
</ul>
<h2 id="索引的使用条件"><a href="#索引的使用条件" class="headerlink" title="索引的使用条件"></a>索引的使用条件</h2><ul>
<li><p>对于非常小的表、大部分情况下简单的全表扫描比建立索引更高效；</p>
</li>
<li><p>对于中到大型的表，索引就非常有效；</p>
</li>
<li><p>但是对于特大型的表，建立和维护索引的代价将会随之增长。这种情况下，需要用到一种技术可以直接区分出需要查询的一组数据，而不是一条记录一条记录地匹配，例如可以使用分区技术。</p>
</li>
</ul>
<h1 id="二、查询性能优化"><a href="#二、查询性能优化" class="headerlink" title="二、查询性能优化"></a>二、查询性能优化</h1><h2 id="使用-Explain-进行分析"><a href="#使用-Explain-进行分析" class="headerlink" title="使用 Explain 进行分析"></a>使用 Explain 进行分析</h2><p>Explain 用来分析 SELECT 查询语句，开发人员可以通过分析 Explain 结果来优化查询语句。</p>
<p>比较重要的字段有：</p>
<ul>
<li>select_type : 查询类型，有简单查询、联合查询、子查询等</li>
<li>key : 使用的索引</li>
<li>rows : 扫描的行数</li>
</ul>
<h2 id="优化数据访问"><a href="#优化数据访问" class="headerlink" title="优化数据访问"></a>优化数据访问</h2><h3 id="1-减少请求的数据量"><a href="#1-减少请求的数据量" class="headerlink" title="1. 减少请求的数据量"></a>1. 减少请求的数据量</h3><ul>
<li>只返回必要的列：最好不要使用 SELECT * 语句。</li>
<li>只返回必要的行：使用 LIMIT 语句来限制返回的数据。</li>
<li>缓存重复查询的数据：使用缓存可以避免在数据库中进行查询，特别在要查询的数据经常被重复查询时，缓存带来的查询性能提升将会是非常明显的。</li>
</ul>
<h3 id="2-减少服务器端扫描的行数"><a href="#2-减少服务器端扫描的行数" class="headerlink" title="2. 减少服务器端扫描的行数"></a>2. 减少服务器端扫描的行数</h3><p>最有效的方式是使用索引来覆盖查询。</p>
<h2 id="重构查询方式"><a href="#重构查询方式" class="headerlink" title="重构查询方式"></a>重构查询方式</h2><h3 id="1-切分大查询"><a href="#1-切分大查询" class="headerlink" title="1. 切分大查询"></a>1. 切分大查询</h3><p>一个大查询如果一次性执行的话，可能一次锁住很多数据、占满整个事务日志、耗尽系统资源、阻塞很多小的但重要的查询。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> messages <span class="keyword">WHERE</span> <span class="keyword">create</span> &lt; <span class="keyword">DATE_SUB</span>(<span class="keyword">NOW</span>(), <span class="built_in">INTERVAL</span> <span class="number">3</span> <span class="keyword">MONTH</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">rows_affected = 0</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    rows_affected = do_query(</span><br><span class="line">    <span class="string">"DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000"</span>)</span><br><span class="line">&#125; <span class="keyword">while</span> rows_affected &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="2-分解大连接查询"><a href="#2-分解大连接查询" class="headerlink" title="2. 分解大连接查询"></a>2. 分解大连接查询</h3><p>将一个大连接查询分解成对每一个表进行一次单表查询，然后在应用程序中进行关联，这样做的好处有：</p>
<ul>
<li>让缓存更高效。对于连接查询，如果其中一个表发生变化，那么整个查询缓存就无法使用。而分解后的多个查询，即使其中一个表发生变化，对其它表的查询缓存依然可以使用。</li>
<li>分解成多个单表查询，这些单表查询的缓存结果更可能被其它查询使用到，从而减少冗余记录的查询。</li>
<li>减少锁竞争；</li>
<li>在应用层进行连接，可以更容易对数据库进行拆分，从而更容易做到高性能和可伸缩。</li>
<li>查询本身效率也可能会有所提升。例如下面的例子中，使用 IN() 代替连接查询，可以让 MySQL 按照 ID 顺序进行查询，这可能比随机的连接要更高效。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tag</span><br><span class="line"><span class="keyword">JOIN</span> tag_post <span class="keyword">ON</span> tag_post.tag_id=tag.id</span><br><span class="line"><span class="keyword">JOIN</span> post <span class="keyword">ON</span> tag_post.post_id=post.id</span><br><span class="line"><span class="keyword">WHERE</span> tag.tag=<span class="string">'mysql'</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tag <span class="keyword">WHERE</span> tag=<span class="string">'mysql'</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tag_post <span class="keyword">WHERE</span> tag_id=<span class="number">1234</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> post <span class="keyword">WHERE</span> post.id <span class="keyword">IN</span> (<span class="number">123</span>,<span class="number">456</span>,<span class="number">567</span>,<span class="number">9098</span>,<span class="number">8904</span>);</span><br></pre></td></tr></table></figure>

<h1 id="三、存储引擎"><a href="#三、存储引擎" class="headerlink" title="三、存储引擎"></a>三、存储引擎</h1><h2 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h2><p>是 MySQL 默认的事务型存储引擎，只有在需要它不支持的特性时，才考虑使用其它存储引擎。</p>
<p>实现了四个标准的隔离级别，默认级别是可重复读（REPEATABLE READ）。在可重复读隔离级别下，通过多版本并发控制（MVCC）+ Next-Key Locking 防止幻影读。</p>
<p>主索引是聚簇索引，在索引中保存了数据，从而避免直接读取磁盘，因此对查询性能有很大的提升。</p>
<p>内部做了很多优化，包括从磁盘读取数据时采用的可预测性读、能够加快读操作并且自动创建的自适应哈希索引、能够加速插入操作的插入缓冲区等。</p>
<p>支持真正的在线热备份。其它存储引擎不支持在线热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合场景中，停止写入可能也意味着停止读取。</p>
<h2 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h2><p>设计简单，数据以紧密格式存储。对于只读数据，或者表比较小、可以容忍修复操作，则依然可以使用它。</p>
<p>提供了大量的特性，包括压缩表、空间数据索引等。</p>
<p>不支持事务。</p>
<p>不支持行级锁，只能对整张表加锁，读取时会对需要读到的所有表加共享锁，写入时则对表加排它锁。但在表有读取操作的同时，也可以往表中插入新的记录，这被称为并发插入（CONCURRENT INSERT）。</p>
<p>可以手工或者自动执行检查和修复操作，但是和事务恢复以及崩溃恢复不同，可能导致一些数据丢失，而且修复操作是非常慢的。</p>
<p>如果指定了 DELAY_KEY_WRITE 选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。</p>
<h2 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h2><ul>
<li><p>事务：InnoDB 是事务型的，可以使用 Commit 和 Rollback 语句。</p>
</li>
<li><p>并发：MyISAM 只支持表级锁，而 InnoDB 还支持行级锁。</p>
</li>
<li><p>外键：InnoDB 支持外键。</p>
</li>
<li><p>备份：InnoDB 支持在线热备份。</p>
</li>
<li><p>崩溃恢复：MyISAM 崩溃后发生损坏的概率比 InnoDB 高很多，而且恢复的速度也更慢。</p>
</li>
<li><p>其它特性：MyISAM 支持压缩表和空间数据索引。</p>
</li>
</ul>
<h1 id="四、数据类型"><a href="#四、数据类型" class="headerlink" title="四、数据类型"></a>四、数据类型</h1><h2 id="整型"><a href="#整型" class="headerlink" title="整型"></a>整型</h2><p>TINYINT, SMALLINT, MEDIUMINT, INT, BIGINT 分别使用 8, 16, 24, 32, 64 位存储空间，一般情况下越小的列越好。</p>
<p>INT(11) 中的数字只是规定了交互工具显示字符的个数，对于存储和计算来说是没有意义的。</p>
<h2 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h2><p>FLOAT 和 DOUBLE 为浮点类型，DECIMAL 为高精度小数类型。CPU 原生支持浮点运算，但是不支持 DECIMAl 类型的计算，因此 DECIMAL 的计算比浮点类型需要更高的代价。</p>
<p>FLOAT、DOUBLE 和 DECIMAL 都可以指定列宽，例如 DECIMAL(18, 9) 表示总共 18 位，取 9 位存储小数部分，剩下 9 位存储整数部分。</p>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>主要有 CHAR 和 VARCHAR 两种类型，一种是定长的，一种是变长的。</p>
<p>VARCHAR 这种变长类型能够节省空间，因为只需要存储必要的内容。但是在执行 UPDATE 时可能会使行变得比原来长，当超出一个页所能容纳的大小时，就要执行额外的操作。MyISAM 会将行拆成不同的片段存储，而 InnoDB 则需要分裂页来使行放进页内。</p>
<p>在进行存储和检索时，会保留 VARCHAR 末尾的空格，而会删除 CHAR 末尾的空格。</p>
<h2 id="时间和日期"><a href="#时间和日期" class="headerlink" title="时间和日期"></a>时间和日期</h2><p>MySQL 提供了两种相似的日期时间类型：DATETIME 和 TIMESTAMP。</p>
<h3 id="1-DATETIME"><a href="#1-DATETIME" class="headerlink" title="1. DATETIME"></a>1. DATETIME</h3><p>能够保存从 1000 年到 9999 年的日期和时间，精度为秒，使用 8 字节的存储空间。</p>
<p>它与时区无关。</p>
<p>默认情况下，MySQL 以一种可排序的、无歧义的格式显示 DATETIME 值，例如“2008-01-16 22<span>:</span>37<span>:</span>08”，这是 ANSI 标准定义的日期和时间表示方法。</p>
<h3 id="2-TIMESTAMP"><a href="#2-TIMESTAMP" class="headerlink" title="2. TIMESTAMP"></a>2. TIMESTAMP</h3><p>和 UNIX 时间戳相同，保存从 1970 年 1 月 1 日午夜（格林威治时间）以来的秒数，使用 4 个字节，只能表示从 1970 年到 2038 年。</p>
<p>它和时区有关，也就是说一个时间戳在不同的时区所代表的具体时间是不同的。</p>
<p>MySQL 提供了 FROM_UNIXTIME() 函数把 UNIX 时间戳转换为日期，并提供了 UNIX_TIMESTAMP() 函数把日期转换为 UNIX 时间戳。</p>
<p>默认情况下，如果插入时没有指定 TIMESTAMP 列的值，会将这个值设置为当前时间。</p>
<p>应该尽量使用 TIMESTAMP，因为它比 DATETIME 空间效率更高。</p>
<h1 id="五、切分"><a href="#五、切分" class="headerlink" title="五、切分"></a>五、切分</h1><h2 id="水平切分"><a href="#水平切分" class="headerlink" title="水平切分"></a>水平切分</h2><p>水平切分又称为 Sharding，它是将同一个表中的记录拆分到多个结构相同的表中。</p>
<p>当一个表的数据不断增多时，Sharding 是必然的选择，它可以将数据分布到集群的不同节点上，从而缓存单个数据库的压力。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/mysql/63c2909f-0c5f-496f-9fe5-ee9176b31aba.jpg" width=""> </div><br>

<h2 id="垂直切分"><a href="#垂直切分" class="headerlink" title="垂直切分"></a>垂直切分</h2><p>垂直切分是将一张表按列切分成多个表，通常是按照列的关系密集程度进行切分，也可以利用垂直切分将经常被使用的列和不经常被使用的列切分到不同的表中。</p>
<p>在数据库的层面使用垂直切分将按数据库中表的密集程度部署到不同的库中，例如将原来的电商数据库垂直切分成商品数据库、用户数据库等。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/mysql/e130e5b8-b19a-4f1e-b860-223040525cf6.jpg" width=""> </div><br>

<h2 id="Sharding-策略"><a href="#Sharding-策略" class="headerlink" title="Sharding 策略"></a>Sharding 策略</h2><ul>
<li>哈希取模：hash(key) % N；</li>
<li>范围：可以是 ID 范围也可以是时间范围；</li>
<li>映射表：使用单独的一个数据库来存储映射关系。</li>
</ul>
<h2 id="Sharding-存在的问题"><a href="#Sharding-存在的问题" class="headerlink" title="Sharding 存在的问题"></a>Sharding 存在的问题</h2><h3 id="1-事务问题"><a href="#1-事务问题" class="headerlink" title="1. 事务问题"></a>1. 事务问题</h3><p>使用分布式事务来解决，比如 XA 接口。</p>
<h3 id="2-连接"><a href="#2-连接" class="headerlink" title="2. 连接"></a>2. 连接</h3><p>可以将原来的连接分解成多个单表查询，然后在用户程序中进行连接。</p>
<h3 id="3-ID-唯一性"><a href="#3-ID-唯一性" class="headerlink" title="3. ID 唯一性"></a>3. ID 唯一性</h3><ul>
<li>使用全局唯一 ID（GUID）</li>
<li>为每个分片指定一个 ID 范围</li>
<li>分布式 ID 生成器 (如 Twitter 的 Snowflake 算法)</li>
</ul>
<h1 id="六、复制"><a href="#六、复制" class="headerlink" title="六、复制"></a>六、复制</h1><h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>主要涉及三个线程：binlog 线程、I/O 线程和 SQL 线程。</p>
<ul>
<li><strong>binlog 线程</strong>  ：负责将主服务器上的数据更改写入二进制日志（Binary log）中。</li>
<li><strong>I/O 线程</strong>  ：负责从主服务器上读取二进制日志，并写入从服务器的中继日志（Relay log）。</li>
<li><strong>SQL 线程</strong>  ：负责读取中继日志，解析出主服务器已经执行的数据更改并在从服务器中重放（Replay）。</li>
</ul>
<div align="center"> <img src="https://upyun.hoke58.cn/img/mysql/master-slave.png" width=""> </div><br>

<h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p>主服务器处理写操作以及实时性要求比较高的读操作，而从服务器处理读操作。</p>
<p>读写分离能提高性能的原因在于：</p>
<ul>
<li>主从服务器负责各自的读和写，极大程度缓解了锁的争用；</li>
<li>从服务器可以使用 MyISAM，提升查询性能以及节约系统开销；</li>
<li>增加冗余，提高可用性。</li>
</ul>
<p>读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/mysql/master-slave-proxy.png" width=""> </div><br>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>BaronScbwartz, PeterZaitsev, VadimTkacbenko, 等. 高性能 MySQL[M]. 电子工业出版社, 2013.</li>
<li>姜承尧. MySQL 技术内幕: InnoDB 存储引擎 [M]. 机械工业出版社, 2011.</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuamZveC5pbmZvLzIwLXRpYW8tbXlzcWwteGluZy1uZW4teW91LWh1YS1kZS16dWktamlhLWppbmcteWFuLmh0bWw=" title="https://www.jfox.info/20-tiao-mysql-xing-nen-you-hua-de-zui-jia-jing-yan.html">20+ 条 MySQL 性能优化的最佳经验<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2Jsb2cuNzIwdWkuY29tLzIwMTcvbXlzcWxfY29yZV8wOV9tdWx0aV9kYl90YWJsZTIv" title="http://blog.720ui.com/2017/mysql_core_09_multi_db_table2/">服务端指南 数据存储篇 | MySQL（09） 分库与分表带来的分布式困境与应对之策<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNzg4ODI5L2hvdy10by1jcmVhdGUtdW5pcXVlLXJvdy1pZC1pbi1zaGFyZGVkLWRhdGFiYXNlcw==" title="https://stackoverflow.com/questions/788829/how-to-create-unique-row-id-in-sharded-databases">How to create unique row ID in sharded databases?<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2dlZWtzd2l0aGJsb2dzLm5ldC9zaGF1bnh1L2FyY2hpdmUvMjAxMi8wMS8wNy9zcWwtYXp1cmUtZmVkZXJhdGlvbi1uZGFzaC1pbnRyb2R1Y3Rpb24uYXNweA==" title="http://geekswithblogs.net/shaunxu/archive/2012/01/07/sql-azure-federation-ndash-introduction.aspx">SQL Azure Federation – Introduction<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2Jsb2cuY29kaW5nbGFicy5vcmcvYXJ0aWNsZXMvdGhlb3J5LW9mLW15c3FsLWluZGV4Lmh0bWw=" title="http://blog.codinglabs.org/articles/theory-of-mysql-index.html">MySQL 索引背后的数据结构及算法原理<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAwODEzMTczNQ==" title="https://segmentfault.com/a/1190000008131735">MySQL 性能优化神器 Explain 使用分析<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL0BqZWV5b3VuZ2svaG93LXNoYXJkaW5nLXdvcmtzLWI0ZGVjNDZiM2Y2" title="https://medium.com/@jeeyoungk/how-sharding-works-b4dec46b3f6">How Sharding Works<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly90ZWNoLm1laXR1YW4uY29tL2RpYW5waW5nX29yZGVyX2RiX3NoYXJkaW5nLmh0bWw=" title="https://tech.meituan.com/dianping_order_db_sharding.html">大众点评订单系统分库分表实践<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvQiUyQiVFNiVBMCU5MQ==" title="https://zh.wikipedia.org/wiki/B%2B%E6%A0%91">B + 树<i class="fa fa-external-link"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql数据库查看库大小、表大小</title>
    <url>/databases/mysql-check-sizes.html</url>
    <content><![CDATA[<h1 id="查看所有数据库容量大小"><a href="#查看所有数据库容量大小" class="headerlink" title="查看所有数据库容量大小"></a>查看所有数据库容量大小</h1><a id="more"></a>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">'数据库'</span>,</span><br><span class="line"><span class="keyword">sum</span>(table_rows) <span class="keyword">as</span> <span class="string">'记录数'</span>,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> table_schema</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">sum</span>(data_length) <span class="keyword">desc</span>, <span class="keyword">sum</span>(index_length) <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h1 id="查看所有数据库各表容量大小"><a href="#查看所有数据库各表容量大小" class="headerlink" title="查看所有数据库各表容量大小"></a>查看所有数据库各表容量大小</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">'数据库'</span>,</span><br><span class="line">table_name <span class="keyword">as</span> <span class="string">'表名'</span>,</span><br><span class="line">table_rows <span class="keyword">as</span> <span class="string">'记录数'</span>,</span><br><span class="line"><span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line"><span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> data_length <span class="keyword">desc</span>, index_length <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h1 id="查看指定数据库容量大小"><a href="#查看指定数据库容量大小" class="headerlink" title="查看指定数据库容量大小"></a>查看指定数据库容量大小</h1><blockquote>
<p>例：查看mysql库容量大小</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">'数据库'</span>,</span><br><span class="line"><span class="keyword">sum</span>(table_rows) <span class="keyword">as</span> <span class="string">'记录数'</span>,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">where</span> table_schema=<span class="string">'mysql'</span>;</span><br></pre></td></tr></table></figure>

<h1 id="查看指定数据库各表容量大小"><a href="#查看指定数据库各表容量大小" class="headerlink" title="查看指定数据库各表容量大小"></a>查看指定数据库各表容量大小</h1><blockquote>
<p>例：查看mysql库各表容量大小</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">'数据库'</span>,</span><br><span class="line">table_name <span class="keyword">as</span> <span class="string">'表名'</span>,</span><br><span class="line">table_rows <span class="keyword">as</span> <span class="string">'记录数'</span>,</span><br><span class="line"><span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line"><span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">where</span> table_schema=<span class="string">'mysql'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> data_length <span class="keyword">desc</span>, index_length <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>sql</tag>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo Next 升级</title>
    <url>/web/hexo-next-upgrade.html</url>
    <content><![CDATA[<h1 id="Hexo-amp-Next-升级"><a href="#Hexo-amp-Next-升级" class="headerlink" title="Hexo &amp; Next 升级"></a>Hexo &amp; Next 升级</h1><p>github 博客的源码库惊现风险漏洞，去官网看了下现行版本，着手更新一版</p>
<a id="more"></a>

<p><img src="https://upyun.hoke58.cn/img/Untitled-1-20200228141917.png" alt="Untitled-1-20200228141917.png"></p>
<h2 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h2><ul>
<li>使用npm 命令查看已经过期的安装包<figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> outdated</span><br></pre></td></tr></table></figure></li>
<li>安装npm升级插件<figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> install -g <span class="built_in">npm</span>-check-updates</span><br></pre></td></tr></table></figure></li>
<li>查看最新的版本命令<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ncu</span></span><br></pre></td></tr></table></figure></li>
<li>升级低版本的npm包文件<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ncu -u</span></span><br></pre></td></tr></table></figure></li>
<li>更新生产依赖包<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">npm <span class="keyword">install</span> <span class="comment">--save</span></span><br></pre></td></tr></table></figure></li>
<li>查看依赖版本已更新了<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">[root@VM-202 /home/hoke/Documents/blog]# git diff package.json</span><br><span class="line">diff --git a/package.json b/package.json</span><br><span class="line">index a473667..54ad330 100644</span><br><span class="line"><span class="comment">--- a/package.json</span></span><br><span class="line"><span class="comment">+++ b/package.json</span></span><br><span class="line"><span class="meta">@@ -9,11 +9,11 @@</span></span><br><span class="line">     "server": "hexo server"</span><br><span class="line">   &#125;,</span><br><span class="line">   "hexo": &#123;</span><br><span class="line"><span class="deletion">-    "version": "4.0.0"</span></span><br><span class="line"><span class="addition">+    "version": "4.2.0"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   "dependencies": &#123;</span><br><span class="line"><span class="deletion">-    "hexo": "^4.0.0",</span></span><br><span class="line"><span class="deletion">-    "hexo-deployer-git": "^2.0.0",</span></span><br><span class="line"><span class="addition">+    "hexo": "^4.2.0",</span></span><br><span class="line"><span class="addition">+    "hexo-deployer-git": "^2.1.0",</span></span><br><span class="line">     "hexo-generator-archive": "^1.0.0",</span><br><span class="line">     "hexo-generator-baidu-sitemap": "^0.1.6",</span><br><span class="line">     "hexo-generator-category": "^1.0.0",</span><br><span class="line"><span class="meta">@@ -21,11 +21,11 @@</span></span><br><span class="line">     "hexo-generator-searchdb": "^1.2.0",</span><br><span class="line">     "hexo-generator-sitemap": "^2.0.0",</span><br><span class="line">     "hexo-generator-tag": "^1.0.0",</span><br><span class="line"><span class="deletion">-    "hexo-related-popular-posts": "^3.0.6",</span></span><br><span class="line"><span class="addition">+    "hexo-related-popular-posts": "^4.0.0",</span></span><br><span class="line">     "hexo-renderer-ejs": "^1.0.0",</span><br><span class="line">     "hexo-renderer-marked": "^2.0.0",</span><br><span class="line">     "hexo-renderer-stylus": "^1.1.0",</span><br><span class="line">     "hexo-server": "^1.0.0",</span><br><span class="line"><span class="deletion">-    "hexo-symbols-count-time": "^0.6.3"</span></span><br><span class="line"><span class="addition">+    "hexo-symbols-count-time": "^0.7.0"</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="deletion">-&#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line">\ No newline at end of file</span><br></pre></td></tr></table></figure>
升级完成后记得 <code>commit</code> 至仓库</li>
</ul>
<h2 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM-202 /home/hoke/Documents/blog/themes/hexo-theme-next]<span class="comment"># git remote -v</span></span><br><span class="line">next	https://github.com/theme-next/hexo-theme-next.git (fetch)</span><br><span class="line">next	https://github.com/theme-next/hexo-theme-next.git (push)</span><br><span class="line">origin	git@github.com:hoke58/hexo-theme-next.git (fetch)</span><br><span class="line">origin	git@github.com:hoke58/hexo-theme-next.git (push)</span><br><span class="line">[root@VM-202 /home/hoke/Documents/blog/themes/hexo-theme-next]<span class="comment"># git pull next</span></span><br><span class="line">remote: Enumerating objects: 354, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (354/354), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (36/36), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 715 (delta 322), reused 327 (delta 318), pack-reused 361</span><br><span class="line">Receiving objects: 100% (715/715), 124.12 KiB | 19.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (462/462), completed with 147 <span class="built_in">local</span> objects.</span><br><span class="line">From https://github.com/theme-next/hexo-theme-next</span><br><span class="line"> * [new branch]      cdn        -&gt; next/cdn</span><br><span class="line"> * [new branch]      funding    -&gt; next/funding</span><br><span class="line"> * [new branch]      i18n       -&gt; next/i18n</span><br><span class="line">   982d243..97230d1  master     -&gt; next/master</span><br><span class="line"> * [new tag]         v7.6.0     -&gt; v7.6.0</span><br><span class="line"> * [new tag]         v7.7.0     -&gt; v7.7.0</span><br><span class="line"> * [new tag]         v7.7.1     -&gt; v7.7.1</span><br><span class="line">You asked to pull from the remote <span class="string">'next'</span>, but did not specify</span><br><span class="line">a branch. Because this is not the default configured remote</span><br><span class="line"><span class="keyword">for</span> your current branch, you must specify a branch on the <span class="built_in">command</span> line.</span><br></pre></td></tr></table></figure>
<p>有冲突的文件修改一下，然后 <code>merge</code> 至自己仓库</p>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>Next</tag>
      </tags>
  </entry>
  <entry>
    <title>【MySQL】TokuDB引擎安装及数据迁移</title>
    <url>/databases/mysql-tokudb-install.html</url>
    <content><![CDATA[<div align="center"> <img src="https://upyun.hoke58.cn/img/【MySQL】TokuDB引擎安装教程-20191223155418.png"> </div><br>

<a id="more"></a>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>zabbix 数据库由阿里云 RDS 迁移至自建 DB，迁移过程中发现 RDS 为 tokudb 引擎</p>
<h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><h2 id="libjemalloc-library"><a href="#libjemalloc-library" class="headerlink" title="libjemalloc library"></a>libjemalloc library</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install jemalloc -y</span><br></pre></td></tr></table></figure>
<p>通过 yum 安装，生成的库文件为<code>/usr/lib64/libjemalloc.so.1</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@yunwei /www/server/data]<span class="comment"># rpm -qa |grep jemalloc</span></span><br><span class="line">jemalloc-3.6.0-1.el7.x86_64</span><br><span class="line">[root@yunwei /www/server/data]<span class="comment"># rpm -ql jemalloc-3.6.0-1.el7.x86_64</span></span><br><span class="line">/usr/bin/jemalloc.sh</span><br><span class="line">/usr/lib64/libjemalloc.so.1</span><br><span class="line">/usr/share/doc/jemalloc-3.6.0</span><br><span class="line">/usr/share/doc/jemalloc-3.6.0/COPYING</span><br><span class="line">/usr/share/doc/jemalloc-3.6.0/README</span><br><span class="line">/usr/share/doc/jemalloc-3.6.0/VERSION</span><br><span class="line">/usr/share/doc/jemalloc-3.6.0/jemalloc.html</span><br></pre></td></tr></table></figure>
<h2 id="Transparent-huge-pages"><a href="#Transparent-huge-pages" class="headerlink" title="Transparent huge pages"></a>Transparent huge pages</h2><p>关闭内存大页</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>
<p>查看下</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@ptest:~<span class="comment"># cat /sys/kernel/mm/transparent_hugepage/enabled</span></span><br><span class="line">always madvise [never]</span><br><span class="line">root@ptest:~<span class="comment"># cat /sys/kernel/mm/transparent_hugepage/defrag</span></span><br><span class="line">always madvise [never]</span><br></pre></td></tr></table></figure>

<h2 id="Installing-Percona-Server-for-MySQL-from-Percona-yum-repository"><a href="#Installing-Percona-Server-for-MySQL-from-Percona-yum-repository" class="headerlink" title="Installing Percona Server for MySQL from Percona yum repository"></a>Installing Percona Server for MySQL from Percona yum repository</h2><ol>
<li>Install the Percona repository</li>
</ol>
<p>You can install Percona yum repository by running the following command as a root user or with sudo:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>Output example</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Retrieving https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br><span class="line">Preparing...                <span class="comment">########################################### [100%]</span></span><br><span class="line">1:percona-release        <span class="comment">########################################### [100%]</span></span><br></pre></td></tr></table></figure>
<p>To install Percona Server for MySQL with SELinux policies, you also need the Percona-Server-selinux-*.noarch.rpm package:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ yum install http://repo.percona.com/centos/7/RPMS/x86_64/Percona-Server-selinux-56-5.6.42-rel84.2.el7.noarch.rpm</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Testing the repository</li>
</ol>
<p>Make sure packages are now available from the repository, by executing the following command:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum list | grep percona</span><br></pre></td></tr></table></figure>
<p>You should see output similar to the following:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Percona-Server-56-debuginfo.x86_64          5.6.25-rel73.1.el6           @percona-release-x86_64</span><br><span class="line">Percona-Server-client-56.x86_64             5.6.25-rel73.1.el6           @percona-release-x86_64</span><br><span class="line">Percona-Server-devel-56.x86_64              5.6.25-rel73.1.el6           @percona-release-x86_64</span><br><span class="line">Percona-Server-server-56.x86_64             5.6.25-rel73.1.el6           @percona-release-x86_64</span><br><span class="line">Percona-Server-shared-56.x86_64             5.6.25-rel73.1.el6           @percona-release-x86_64</span><br><span class="line">Percona-Server-test-56.x86_64               5.6.25-rel73.1.el6           @percona-release-x86_64</span><br><span class="line">Percona-Server-shared-compat.x86_64         5.1.68-rel14.6.551.rhel6     percona-release-x86_64</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Install the packages</li>
</ol>
<p>You can now install Percona Server for MySQL by running:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install Percona-Server-server-56</span><br></pre></td></tr></table></figure>

<h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><p>You can install the Percona Server for MySQL with TokuDB engine by using the apt/yum commands:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@centos ~]<span class="comment"># yum install Percona-Server-tokudb-56.x86_64</span></span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@wheezy:~<span class="comment"># apt-get install percona-server-tokudb-5.6</span></span><br></pre></td></tr></table></figure>
<h1 id="Enabling-the-TokuDB-Storage-Engine"><a href="#Enabling-the-TokuDB-Storage-Engine" class="headerlink" title="Enabling the TokuDB Storage Engine"></a>Enabling the TokuDB Storage Engine</h1><p>Once the TokuDB server package has been installed following output will be shown:</p>
<div class="note default">
            <ul><li><p>This release of Percona Server is distributed with TokuDB storage engine.</p><ul><li><p>Run the following script to enable the TokuDB storage engine in Percona Server:</p><p>ps_tokudb_admin –enable -u <mysql_admin_user> -p[mysql_admin_pass] [-S <socket>] [-h <host> -P <port>]</p></li><li><p>See <span class="exturl" data-url="aHR0cDovL3d3dy5wZXJjb25hLmNvbS9kb2MvcGVyY29uYS1zZXJ2ZXIvNS42L3Rva3VkYi90b2t1ZGJfaW5zdGFsbGF0aW9uLmh0bWw=" title="http://www.percona.com/doc/percona-server/5.6/tokudb/tokudb_installation.html">http://www.percona.com/doc/percona-server/5.6/tokudb/tokudb_installation.html<i class="fa fa-external-link"></i></span> for more installation details</p></li><li><p>See <span class="exturl" data-url="aHR0cDovL3d3dy5wZXJjb25hLmNvbS9kb2MvcGVyY29uYS1zZXJ2ZXIvNS42L3Rva3VkYi90b2t1ZGJfaW50cm8uaHRtbA==" title="http://www.percona.com/doc/percona-server/5.6/tokudb/tokudb_intro.html">http://www.percona.com/doc/percona-server/5.6/tokudb/tokudb_intro.html<i class="fa fa-external-link"></i></span> for an introduction to TokuDB</p></li></ul></li></ul>
          </div>
<p>Percona Server for MySQL 5.6.22-72.0 has implemented ps_tokudb_admin script to make the enabling the TokuDB storage engine easier. This script will automatically disable Transparent huge pages, if they’re enabled, and install and enable the TokuDB storage engine with all the required plugins. You need to run this script as root or with sudo. After you run the script with required parameters:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ps_tokudb_admin --<span class="built_in">enable</span> -uroot -pPassw0rd</span><br></pre></td></tr></table></figure>
<p>Following output will be displayed:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Checking <span class="keyword">if</span> Percona server is running with jemalloc enabled...</span><br><span class="line">&gt;&gt; Percona server is running with jemalloc enabled.</span><br><span class="line"></span><br><span class="line">Checking transparent huge pages status on the system...</span><br><span class="line">&gt;&gt; Transparent huge pages are currently disabled on the system.</span><br><span class="line"></span><br><span class="line">Checking <span class="keyword">if</span> thp-setting=never option is already <span class="built_in">set</span> <span class="keyword">in</span> config file...</span><br><span class="line">&gt;&gt; Option thp-setting=never is not <span class="built_in">set</span> <span class="keyword">in</span> the config file.</span><br><span class="line">&gt;&gt; (needed only <span class="keyword">if</span> THP is not disabled permanently on the system)</span><br><span class="line"></span><br><span class="line">Checking TokuDB plugin status...</span><br><span class="line">&gt;&gt; TokuDB plugin is not installed.</span><br><span class="line"></span><br><span class="line">Adding thp-setting=never option into /etc/mysql/my.cnf</span><br><span class="line">&gt;&gt; Successfuly added thp-setting=never option into /etc/mysql/my.cnf</span><br><span class="line"></span><br><span class="line">Installing TokuDB engine...</span><br><span class="line">&gt;&gt; Successfuly installed TokuDB plugin.</span><br></pre></td></tr></table></figure>
<p>If the script returns no errors, TokuDB storage engine should be successfully enabled on your server. You can check it out by running:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW ENGINES;</span><br><span class="line">...</span><br><span class="line"> | TokuDB | YES | Tokutek TokuDB Storage Engine <span class="keyword">with</span> Fractal Tree(tm) Technology | YES | YES | YES |</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>To check if all the TokuDB plugins have been installed correctly you should run:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW PLUGINS;</span><br><span class="line">...</span><br><span class="line">| TokuDB                        | ACTIVE   | STORAGE ENGINE     | ha_tokudb.so | GPL     |</span><br><span class="line">| TokuDB_file_map               | ACTIVE   | INFORMATION SCHEMA | ha_tokudb.so | GPL     |</span><br><span class="line">| TokuDB_fractal_tree_info      | ACTIVE   | INFORMATION SCHEMA | ha_tokudb.so | GPL     |</span><br><span class="line">| TokuDB_fractal_tree_block_map | ACTIVE   | INFORMATION SCHEMA | ha_tokudb.so | GPL     |</span><br><span class="line">| TokuDB_trx                    | ACTIVE   | INFORMATION SCHEMA | ha_tokudb.so | GPL     |</span><br><span class="line">| TokuDB_locks                  | ACTIVE   | INFORMATION SCHEMA | ha_tokudb.so | GPL     |</span><br><span class="line">| TokuDB_lock_waits             | ACTIVE   | INFORMATION SCHEMA | ha_tokudb.so | GPL     |</span><br><span class="line">| TokuDB_background_job_status  | ACTIVE   | INFORMATION SCHEMA | ha_tokudb.so | GPL     |</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>TokuDB Version<br>TokuDB storage engine version can be checked with:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT @@tokudb_version;</span><br><span class="line">+<span class="comment">------------------+</span></span><br><span class="line">| @@tokudb_version |</span><br><span class="line">+<span class="comment">------------------+</span></span><br><span class="line">| 5.6.27-76.0      |</span><br><span class="line">+<span class="comment">------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<div class="note info">
            <p>TokuDB storage engine has the same version as Percona Server for MySQL after <code>5.6.26-74.0</code> release.</p>
          </div>

<h1 id="my-cnf"><a href="#my-cnf" class="headerlink" title="my.cnf"></a>my.cnf</h1><figure class="highlight profile"><table><tr><td class="code"><pre><span class="line"># Percona<span class="number">-5.6</span><span class="number">.17</span>, TokuDB<span class="number">-7.1</span><span class="number">.6</span>，用于Zabbix数据库参考配置</span><br><span class="line"># 我的服务器配置：E5<span class="number">-2620</span> * <span class="number">2</span>，<span class="number">64</span>G内存，<span class="number">1</span>T可用磁盘空间（建议datadir所在分区设置为xfs文件系统）</span><br><span class="line"># TokuDB版本：Percona<span class="number">-5.6</span><span class="number">.17</span>, TokuDB<span class="number">-7.1</span><span class="number">.6</span>(<span class="string">插件加载模式</span>)</span><br><span class="line"># </span><br><span class="line"># created by yejr(<span class="string">http://imysql.com), 2014/06/24</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">[client]</span></span><br><span class="line"><span class="string">port            = 3306</span></span><br><span class="line"><span class="string">socket          = mysql.sock</span></span><br><span class="line"><span class="string">#default-character-set=utf8</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[mysql]</span></span><br><span class="line"><span class="string">prompt="\\u@\\h \\D \\R:\\m:\\s [\\d]&gt;</span></span><br><span class="line"><span class="string">#pager="less -i -n -S"</span></span><br><span class="line"><span class="string">tee=/home/mysql/query.log</span></span><br><span class="line"><span class="string">no-auto-rehash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[mysqld]</span></span><br><span class="line"><span class="string">open_files_limit = 8192</span></span><br><span class="line"><span class="string">max_connect_errors = 100000</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">#buffer &amp; cache</span></span><br><span class="line"><span class="string">table_open_cache = 2048</span></span><br><span class="line"><span class="string">table_definition_cache = 2048</span></span><br><span class="line"><span class="string">max_heap_table_size = 96M</span></span><br><span class="line"><span class="string">sort_buffer_size = 2M</span></span><br><span class="line"><span class="string">join_buffer_size = 2M</span></span><br><span class="line"><span class="string">tmp_table_size = 96M</span></span><br><span class="line"><span class="string">key_buffer_size = 8M</span></span><br><span class="line"><span class="string">read_buffer_size = 2M</span></span><br><span class="line"><span class="string">read_rnd_buffer_size = 16M</span></span><br><span class="line"><span class="string">bulk_insert_buffer_size = 32M</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">#innodb</span></span><br><span class="line"><span class="string">#只有部分小表保留InnoDB引擎，因此InnoDB Buffer Pool设置为1G基本上够了</span></span><br><span class="line"><span class="string">innodb_buffer_pool_size = 1G</span></span><br><span class="line"><span class="string">innodb_buffer_pool_instances = 1</span></span><br><span class="line"><span class="string">innodb_data_file_path = ibdata1:1G:autoextend</span></span><br><span class="line"><span class="string">innodb_flush_log_at_trx_commit = 1</span></span><br><span class="line"><span class="string">innodb_log_buffer_size = 64M</span></span><br><span class="line"><span class="string">innodb_log_file_size = 256M</span></span><br><span class="line"><span class="string">innodb_log_files_in_group = 2</span></span><br><span class="line"><span class="string">innodb_file_per_table = 1</span></span><br><span class="line"><span class="string">innodb_status_file = 1</span></span><br><span class="line"><span class="string">transaction_isolation = READ-COMMITTED</span></span><br><span class="line"><span class="string">innodb_flush_method = O_DIRECT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#tokudb</span></span><br><span class="line"><span class="string">malloc-lib= /usr/local/mysql/lib/mysql/libjemalloc.so</span></span><br><span class="line"><span class="string">plugin-dir = /usr/local/mysql/lib/mysql/plugin/</span></span><br><span class="line"><span class="string">plugin-load=ha_tokudb.so</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">#把TokuDB datadir以及logdir和MySQL的datadir分开，美观点，也可以不分开，注释掉本行以及下面2行即可</span></span><br><span class="line"><span class="string">tokudb-data-dir = /data/mysql/zabbix_3306/tokudbData</span></span><br><span class="line"><span class="string">tokudb-log-dir = /data/mysql/zabbix_3306/tokudbLog</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">#TokuDB的行模式，建议用 FAST 就足够了，如果磁盘空间很紧张，建议用 SMALL</span></span><br><span class="line"><span class="string">#tokudb_row_format = tokudb_small</span></span><br><span class="line"><span class="string">tokudb_row_format = tokudb_fast</span></span><br><span class="line"><span class="string">tokudb_cache_size = 44G</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">#其他大部分配置其实可以不用修改的，只需要几个关键配置即可</span></span><br><span class="line"><span class="string">tokudb_commit_sync = 0</span></span><br><span class="line"><span class="string">tokudb_directio = 1</span></span><br><span class="line"><span class="string">tokudb_read_block_size = 128K</span></span><br><span class="line"><span class="string">tokudb_read_buf_size = 128K</span></span><br></pre></td></tr></table></figure>

<h1 id="innobackupex-数据迁移"><a href="#innobackupex-数据迁移" class="headerlink" title="innobackupex 数据迁移"></a>innobackupex 数据迁移</h1><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><ul>
<li>部署 mysql</li>
<li>下载 RDS 物理备份文件</li>
</ul>
<h2 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h2><ol>
<li>执行如下命令，解压已下载的数据备份文件。<div class="note info">
            <p><strong>说明</strong></p><ul><li>本文以自定义路径<code>/home/mysql/data</code>为例，您可以根据实际情况将其替换成实际路径。</li><li><code>innobackupex</code>解压命令需要安装<code>qpress</code>，您可以使用命令<code>yum install qpress -y</code>安装。</li></ul>
          </div>
目前物理备份集文件有3种格式：</li>
</ol>
<ul>
<li>tar 压缩包 （.tar.gz 后缀）</li>
<li>xbstream 压缩包 （.xb.gz 后缀）</li>
<li>xbstream 文件包（_qp.xb 后缀）<div class="note info">
            <p><strong>说明</strong></p><p>2019年2月20日后创建的<code>MySQL 5.6</code>实例，数据备份文件的格式为xbstream文件包（_qp.xb 后缀）。</p>
          </div>
对于tar 压缩包 （.tar.gz 后缀），使用命令：<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">tar -izxvf &lt;数据备份文件名&gt;.tar.gz -C /home/mysql/data</span><br></pre></td></tr></table></figure>
对于xbstream 压缩包 （.xb.gz 后缀），使用命令：<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">gzip -d -c &lt;数据备份文件名&gt;.xb.gz | xbstream -x -v -C /home/mysql/data</span><br></pre></td></tr></table></figure>
对于xbstream 文件包（_qp.xb 后缀），使用命令：<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 解包</span></span><br><span class="line">cat &lt;数据备份文件名&gt;_qp.xb | xbstream -x -v -C /home/mysql/data</span><br><span class="line"><span class="comment">## 解压</span></span><br><span class="line">innobackupex --decompress --remove-original /home/mysql/data</span><br></pre></td></tr></table></figure>
<div class="note info">
            <p><strong>说明</strong> <code>-C</code>：指定文件要解压到的目录。可选参数，若不指定就解压到当前目录。</p>
          </div>
</li>
</ul>
<ol start="2">
<li><p>为避免版本问题，需修改<code>backup-my.cnf</code>参数，具体操作步骤如下。</p>
<ol>
<li>执行如下命令，以文本方式编辑<code>backup-my.cnf</code>文件。<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /home/mysql/data/backup-my.cnf</span><br></pre></td></tr></table></figure></li>
<li>自建数据库不支持如下参数，需要注释掉。<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#innodb_log_checksum_algorithm</span></span><br><span class="line"><span class="comment">#innodb_fast_checksum</span></span><br><span class="line"><span class="comment">#innodb_log_block_size</span></span><br><span class="line"><span class="comment">#innodb_doublewrite_file</span></span><br><span class="line"><span class="comment">#rds_encrypt_data</span></span><br><span class="line"><span class="comment">#innodb_encrypt_algorithm</span></span><br><span class="line"><span class="comment">#redo_log_version</span></span><br><span class="line"><span class="comment">#master_key_id</span></span><br></pre></td></tr></table></figure>
<div class="note info">
            <ul><li>如果自建数据库使用的是MyISAM引擎，和阿里云的InnoDB不兼容，需要多注释掉如下参数并增加skip-grant-tables参数：<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#innodb_log_checksum_algorithm=strict_crc32</span></span><br><span class="line"><span class="comment">#redo_log_version=1</span></span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure></li><li>如果自建数据库使用的是MyIAM引擎，且对系统表进行操作时报错（存储引擎相关），请按如下操作进行存储引擎的转换：<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">engine</span> &lt;表名&gt; <span class="keyword">engine</span>=myisam;</span><br></pre></td></tr></table></figure></li></ul>
          </div>
</li>
</ol>
</li>
<li><p>执行如下命令，恢复解压好的备份文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@yunwei /www/server/data]<span class="comment"># innobackupex --defaults-file=/www/server/data/backup-my.cnf --apply-log /www/server/data/</span></span><br><span class="line">191226 13:42:51 innobackupex: Starting the apply-log operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the apply-log run completes successfully.</span><br><span class="line">           At the end of a successful apply-log run innobackupex</span><br><span class="line">           prints <span class="string">"completed OK!"</span>.</span><br><span class="line"></span><br><span class="line">innobackupex version 2.3.10 based on MySQL server 5.6.24 Linux (x86_64) (revision id: bd0d4403f36)</span><br><span class="line">xtrabackup: <span class="built_in">cd</span> to /www/server/data/</span><br><span class="line">xtrabackup: This target seems to be not prepared yet.</span><br><span class="line">xtrabackup: xtrabackup_logfile detected: size=2097152, start_lsn=(276623660719)</span><br><span class="line">xtrabackup: using the following InnoDB configuration <span class="keyword">for</span> recovery:</span><br><span class="line">xtrabackup:   innodb_data_home_dir = ./</span><br><span class="line">xtrabackup:   innodb_data_file_path = ibdata1:200M:autoextend</span><br><span class="line">xtrabackup:   innodb_log_group_home_dir = ./</span><br><span class="line">xtrabackup:   innodb_log_files_in_group = 1</span><br><span class="line">xtrabackup:   innodb_log_file_size = 2097152</span><br><span class="line">xtrabackup: using the following InnoDB configuration <span class="keyword">for</span> recovery:</span><br><span class="line">xtrabackup:   innodb_data_home_dir = ./</span><br><span class="line">xtrabackup:   innodb_data_file_path = ibdata1:200M:autoextend</span><br><span class="line">xtrabackup:   innodb_log_group_home_dir = ./</span><br><span class="line">xtrabackup:   innodb_log_files_in_group = 1</span><br><span class="line">xtrabackup:   innodb_log_file_size = 2097152</span><br><span class="line">xtrabackup: Starting InnoDB instance <span class="keyword">for</span> recovery.</span><br><span class="line">xtrabackup: Using 104857600 bytes <span class="keyword">for</span> buffer pool (<span class="built_in">set</span> by --use-memory parameter)</span><br><span class="line">InnoDB: Using atomics to ref count buffer pool pages</span><br><span class="line">InnoDB: The InnoDB memory heap is disabled</span><br><span class="line">InnoDB: Mutexes and rw_locks use GCC atomic builtins</span><br><span class="line">InnoDB: Memory barrier is not used</span><br><span class="line">InnoDB: Compressed tables use zlib 1.2.7</span><br><span class="line">InnoDB: Using CPU crc32 instructions</span><br><span class="line">InnoDB: Initializing buffer pool, size = 100.0M</span><br><span class="line">InnoDB: Completed initialization of buffer pool</span><br><span class="line">InnoDB: Highest supported file format is Barracuda.</span><br><span class="line">InnoDB: Log scan progressed past the checkpoint lsn 276623660719</span><br><span class="line">InnoDB: Database was not shutdown normally!</span><br><span class="line">InnoDB: Starting crash recovery.</span><br><span class="line">InnoDB: Reading tablespace information from the .ibd files...</span><br><span class="line">InnoDB: Restoring possible half-written data pages </span><br><span class="line">InnoDB: from the doublewrite buffer...</span><br><span class="line">InnoDB: Doing recovery: scanned up to <span class="built_in">log</span> sequence number 276625422981 (94%)</span><br><span class="line">InnoDB: Starting an apply batch of <span class="built_in">log</span> records to the database...</span><br><span class="line">InnoDB: Progress <span class="keyword">in</span> percent: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 </span><br><span class="line">InnoDB: Apply batch completed</span><br><span class="line">InnoDB: 128 rollback segment(s) are active.</span><br><span class="line">InnoDB: Waiting <span class="keyword">for</span> purge to start</span><br><span class="line">InnoDB: 5.6.24 started; <span class="built_in">log</span> sequence number 276625422981</span><br><span class="line"></span><br><span class="line">xtrabackup: starting shutdown with innodb_fast_shutdown = 1</span><br><span class="line">InnoDB: FTS optimize thread exiting.</span><br><span class="line">InnoDB: Starting shutdown...</span><br><span class="line">InnoDB: Shutdown completed; <span class="built_in">log</span> sequence number 276625423497</span><br><span class="line">xtrabackup: using the following InnoDB configuration <span class="keyword">for</span> recovery:</span><br><span class="line">xtrabackup:   innodb_data_home_dir = ./</span><br><span class="line">xtrabackup:   innodb_data_file_path = ibdata1:200M:autoextend</span><br><span class="line">xtrabackup:   innodb_log_group_home_dir = ./</span><br><span class="line">xtrabackup:   innodb_log_files_in_group = 2</span><br><span class="line">xtrabackup:   innodb_log_file_size = 1048576000</span><br><span class="line">InnoDB: Using atomics to ref count buffer pool pages</span><br><span class="line">InnoDB: The InnoDB memory heap is disabled</span><br><span class="line">InnoDB: Mutexes and rw_locks use GCC atomic builtins</span><br><span class="line">InnoDB: Memory barrier is not used</span><br><span class="line">InnoDB: Compressed tables use zlib 1.2.7</span><br><span class="line">InnoDB: Using CPU crc32 instructions</span><br><span class="line">InnoDB: Initializing buffer pool, size = 100.0M</span><br><span class="line">InnoDB: Completed initialization of buffer pool</span><br><span class="line">InnoDB: Setting <span class="built_in">log</span> file ./ib_logfile101 size to 1000 MB</span><br><span class="line">InnoDB: Progress <span class="keyword">in</span> MB: 100 200 300 400 500 600 700 800 900 1000</span><br><span class="line">InnoDB: Setting <span class="built_in">log</span> file ./ib_logfile1 size to 1000 MB</span><br><span class="line">InnoDB: Progress <span class="keyword">in</span> MB: 100 200 300 400 500 600 700 800 900 1000</span><br><span class="line">InnoDB: Renaming <span class="built_in">log</span> file ./ib_logfile101 to ./ib_logfile0</span><br><span class="line">InnoDB: New <span class="built_in">log</span> files created, LSN=276625423497</span><br><span class="line">InnoDB: Highest supported file format is Barracuda.</span><br><span class="line">InnoDB: 128 rollback segment(s) are active.</span><br><span class="line">InnoDB: Waiting <span class="keyword">for</span> purge to start</span><br><span class="line">InnoDB: 5.6.24 started; <span class="built_in">log</span> sequence number 276625423884</span><br><span class="line">xtrabackup: starting shutdown with innodb_fast_shutdown = 1</span><br><span class="line">InnoDB: FTS optimize thread exiting.</span><br><span class="line">InnoDB: Starting shutdown...</span><br><span class="line">InnoDB: Shutdown completed; <span class="built_in">log</span> sequence number 276625427858</span><br><span class="line">191226 13:43:28 completed OK!</span><br></pre></td></tr></table></figure>
<div class="note info">
            <p><strong>说明</strong> 请确保您的Percona XtraBackup版本正确：<br>MySQL 5.6及之前的版本需要安装 Percona XtraBackup 2.3，安装指导请参见官方文档<span class="exturl" data-url="aHR0cHM6Ly93d3cucGVyY29uYS5jb20vZG9jL3BlcmNvbmEteHRyYWJhY2t1cC8yLjMvaW5zdGFsbGF0aW9uLmh0bWw/c3BtPWEyYzRnLjExMTg2NjIzLjIuMjUuM2Y0ZDFlMmY1VUNMSzM=" title="https://www.percona.com/doc/percona-xtrabackup/2.3/installation.html?spm=a2c4g.11186623.2.25.3f4d1e2f5UCLK3">Percona XtraBackup 2.3<i class="fa fa-external-link"></i></span>。<br>MySQL 5.7版本需要安装 Percona XtraBackup 2.4，安装指导请参见官方文档<span class="exturl" data-url="aHR0cHM6Ly93d3cucGVyY29uYS5jb20vZG9jL3BlcmNvbmEteHRyYWJhY2t1cC8yLjQvaW5zdGFsbGF0aW9uLmh0bWw/c3BtPWEyYzRnLjExMTg2NjIzLjIuMjYuM2Y0ZDFlMmY1VUNMSzM=" title="https://www.percona.com/doc/percona-xtrabackup/2.4/installation.html?spm=a2c4g.11186623.2.26.3f4d1e2f5UCLK3">Percona XtraBackup 2.4<i class="fa fa-external-link"></i></span>。<br>MySQL 8.0版本需要安装 Percona XtraBackup 8.0，安装指导请参见官方文档<span class="exturl" data-url="aHR0cHM6Ly93d3cucGVyY29uYS5jb20vZG9jL3BlcmNvbmEteHRyYWJhY2t1cC84LjAvaW5zdGFsbGF0aW9uLmh0bWw/c3BtPWEyYzRnLjExMTg2NjIzLjIuMjcuM2Y0ZDFlMmY1VUNMSzM=" title="https://www.percona.com/doc/percona-xtrabackup/8.0/installation.html?spm=a2c4g.11186623.2.27.3f4d1e2f5UCLK3">Percona XtraBackup 8.0<i class="fa fa-external-link"></i></span>。</p>
          </div>

</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucGVyY29uYS5jb20vZG9jL3BlcmNvbmEtc2VydmVyLzUuNi90b2t1ZGIvdG9rdWRiX2luc3RhbGxhdGlvbi5odG1s" title="https://www.percona.com/doc/percona-server/5.6/tokudb/tokudb_installation.html">TokuDB Installation<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucGVyY29uYS5jb20vZG9jL3BlcmNvbmEtc2VydmVyLzUuNi9pbnN0YWxsYXRpb24veXVtX3JlcG8uaHRtbCN5dW0tcmVwbw==" title="https://www.percona.com/doc/percona-server/5.6/installation/yum_repo.html#yum-repo">Installing Percona Server for MySQL on Red Hat Enterprise Linux and CentOS<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly95cS5hbGl5dW4uY29tL2FydGljbGVzLzY2Nzk2OQ==" title="https://yq.aliyun.com/articles/667969">自建Percona5.7.23同步阿里云RDS(MySQL5.6)TokuDB数据库<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmFsaXl1bi5jb20va25vd2xlZGdlX2RldGFpbC80MTgxNy5odG1s" title="https://help.aliyun.com/knowledge_detail/41817.html">RDS MySQL 物理备份文件恢复到自建数据库<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>关于RDS迁移后自动备份，请参考<span class="exturl" data-url="aHR0cHM6Ly93d3cuaG9rZTU4LmNuL2RldmVsb3BtZW50L3B5dGhvbi1pbm5vYmFja3VwLmh0bWw=" title="https://www.hoke58.cn/development/python-innobackup.html">使用python实现innobackup自动化备份、清理、通知<i class="fa fa-external-link"></i></span></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>tokudb</tag>
      </tags>
  </entry>
  <entry>
    <title>使用python实现innobackup自动化备份、清理、通知</title>
    <url>/development/python-innobackup.html</url>
    <content><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>上篇博客<span class="exturl" data-url="aHR0cHM6Ly93d3cuaG9rZTU4LmNuL2RhdGFiYXNlcy9teXNxbC10b2t1ZGItaW5zdGFsbC5odG1s" title="https://www.hoke58.cn/databases/mysql-tokudb-install.html">【MySQL】TokuDB引擎安装及数据迁移<i class="fa fa-external-link"></i></span>迁移后拓展，解决自动备份。</p>
<a id="more"></a>

<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><ul>
<li>安装 python3.6</li>
<li>安装 Percona XtraBackup</li>
</ul>
<h2 id="依赖模块"><a href="#依赖模块" class="headerlink" title="依赖模块"></a>依赖模块</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pip3 install jinja2 MarkupSafe</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ol>
<li>编辑配置文件 <code>vim xb_back.cnf</code></li>
<li>运行<code>xb_back.py</code>脚本<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">python3.6 ./xb_back.py -f ./xb_back.cnf</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="xb-back-py"><a href="#xb-back-py" class="headerlink" title="xb_back.py"></a>xb_back.py</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># edit by hoke</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> jinja2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> isfile</span><br><span class="line"><span class="keyword">from</span> tempfile <span class="keyword">import</span> TemporaryFile</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set logger</span></span><br><span class="line">LOG_FORMAT = <span class="string">"%(asctime)s - %(levelname)s - %(message)s"</span></span><br><span class="line">DATE_FORMAT = <span class="string">"%Y-%m-%d %H:%M:%S"</span></span><br><span class="line">logging.basicConfig(level=logging.DEBUG, format=LOG_FORMAT, datefmt=DATE_FORMAT)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get HOSTNAME</span></span><br><span class="line">HOSTNAME = socket.gethostname()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get os time</span></span><br><span class="line">CURRENT_TIME = time.strftime(<span class="string">"%Y-%m-%d_%H:%M:%S"</span>, time.localtime())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set statistics info</span></span><br><span class="line">STATISTICS_INFO = &#123;<span class="string">'备份主机'</span>: HOSTNAME&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set render html template</span></span><br><span class="line">module_path = os.path.dirname(__file__)</span><br><span class="line">html_template = os.path.join(module_path + <span class="string">'/table_template.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_to_template</span><span class="params">(html_path, html_context)</span>:</span></span><br><span class="line">    path, filename = os.path.split(html_path)</span><br><span class="line">    env = jinja2.Environment(</span><br><span class="line">        loader=jinja2.FileSystemLoader(path)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> isinstance(html_context, dict):</span><br><span class="line">        <span class="keyword">return</span> env.get_template(filename).render(&#123;<span class="string">'data'</span>: html_context&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> env.get_template(filename).render(&#123;<span class="string">'err_msg'</span>: html_context&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_arguments</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Get user input </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'This a backup help document.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-f'</span>, <span class="string">'--file'</span>, type=str, help=<span class="string">'xtrabackup read config file'</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">return</span> args.file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_config_valid</span><span class="params">(file)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Check config file content valid</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    config = configparser.ConfigParser()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        config.read(file)</span><br><span class="line">    <span class="keyword">except</span> configparser.MissingSectionHeaderError:</span><br><span class="line">        logger.warning(<span class="string">'WARN: this first line must contains section headers'</span>)</span><br><span class="line"></span><br><span class="line">    config_items = [x <span class="keyword">for</span> x <span class="keyword">in</span> config.keys()]</span><br><span class="line"></span><br><span class="line">    config_keys = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> [config.items(x) <span class="keyword">for</span> x <span class="keyword">in</span> config.keys()]:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">            config_keys.append(j[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    keep_items = [<span class="string">'mysql'</span>, <span class="string">'xtrabackup'</span>, <span class="string">'compress'</span>, <span class="string">'mail'</span>, <span class="string">'expired'</span>]</span><br><span class="line">    keep_keys = [</span><br><span class="line">        <span class="string">'user'</span>,</span><br><span class="line">        <span class="string">'host'</span>,</span><br><span class="line">        <span class="string">'password'</span>,</span><br><span class="line">        <span class="string">'port'</span>,</span><br><span class="line">        <span class="string">'backup_tool'</span>,</span><br><span class="line">        <span class="string">'defaults-file'</span>,</span><br><span class="line">        <span class="string">'backupdir'</span>,</span><br><span class="line">        <span class="string">'title'</span>,</span><br><span class="line">        <span class="string">'mail_sender'</span>,</span><br><span class="line">        <span class="string">'mail_receiver'</span>,</span><br><span class="line">        <span class="string">'mail_host'</span>,</span><br><span class="line">        <span class="string">'mail_port'</span>,</span><br><span class="line">        <span class="string">'mail_user'</span>,</span><br><span class="line">        <span class="string">'mail_pass'</span>,</span><br><span class="line">        <span class="string">'expire_day'</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> header <span class="keyword">in</span> keep_items:</span><br><span class="line">        <span class="keyword">if</span> header <span class="keyword">not</span> <span class="keyword">in</span> config_items:</span><br><span class="line">            logger.error(<span class="string">f'FAILED: this section header [<span class="subst">&#123;header&#125;</span>] not found.'</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> keep_keys:</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> config_keys:</span><br><span class="line">            logger.error(<span class="string">f'FAILED: this argument [<span class="subst">&#123;key&#125;</span>] not found.'</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">General</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Process the config file and Generate variables</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isfile(file):</span><br><span class="line">            config = configparser.ConfigParser(allow_no_value=<span class="literal">True</span>)</span><br><span class="line">            config.read(file)</span><br><span class="line"></span><br><span class="line">            Mysql = config[<span class="string">'mysql'</span>]</span><br><span class="line">            self.user = Mysql[<span class="string">'user'</span>]</span><br><span class="line">            self.host = Mysql[<span class="string">'host'</span>]</span><br><span class="line">            self.password = Mysql[<span class="string">'password'</span>]</span><br><span class="line">            self.port = Mysql[<span class="string">'port'</span>]</span><br><span class="line"></span><br><span class="line">            Xtrabackup = config[<span class="string">'xtrabackup'</span>]</span><br><span class="line">            self.backup_tool = Xtrabackup[<span class="string">'backup_tool'</span>]</span><br><span class="line">            self.defaults_file = Xtrabackup[<span class="string">'defaults-file'</span>]</span><br><span class="line">            self.backupdir = Xtrabackup[<span class="string">'backupdir'</span>]</span><br><span class="line">            self.fmt_backupdir = <span class="string">'/'</span>.join((Xtrabackup[<span class="string">'backupdir'</span>], CURRENT_TIME))</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'xtra_options'</span> <span class="keyword">in</span> Xtrabackup:</span><br><span class="line">                self.xtra_options = Xtrabackup[<span class="string">'xtra_options'</span>]</span><br><span class="line"></span><br><span class="line">            Compress = config[<span class="string">'compress'</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'compress'</span> <span class="keyword">in</span> Compress:</span><br><span class="line">                self.compress = Compress[<span class="string">'compress'</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'compress_chunk_size'</span> <span class="keyword">in</span> Compress:</span><br><span class="line">                self.compress_chunk_size = Compress[<span class="string">'compress_chunk_size'</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'compress_threads'</span> <span class="keyword">in</span> Compress:</span><br><span class="line">                self.compress_threads = Compress[<span class="string">'compress_threads'</span>]</span><br><span class="line"></span><br><span class="line">            Mail = config[<span class="string">'mail'</span>]</span><br><span class="line">            self.title = Mail[<span class="string">'title'</span>]</span><br><span class="line">            self.mail_sender = Mail[<span class="string">'mail_sender'</span>]</span><br><span class="line">            self.mail_receiver = Mail[<span class="string">'mail_receiver'</span>]</span><br><span class="line">            self.mail_host = Mail[<span class="string">'mail_host'</span>]</span><br><span class="line">            self.mail_port = Mail[<span class="string">'mail_port'</span>]</span><br><span class="line">            self.mail_user = Mail[<span class="string">'mail_user'</span>]</span><br><span class="line">            self.mail_pass = Mail[<span class="string">'mail_pass'</span>]</span><br><span class="line"></span><br><span class="line">            Expired = config[<span class="string">'expired'</span>]</span><br><span class="line">            self.expire_day = Expired[<span class="string">'expire_day'</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ToolsUtils</span><span class="params">(General)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Define some tools</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file)</span>:</span></span><br><span class="line">        self.file = file</span><br><span class="line">        General.__init__(self, self.file)</span><br><span class="line"></span><br><span class="line">        self.xb_output_log = <span class="string">'/'</span>.join((self.fmt_backupdir, <span class="string">'xb_output.log'</span>))</span><br><span class="line"></span><br><span class="line">        STATISTICS_INFO[<span class="string">'备份目录'</span>] = self.fmt_backupdir</span><br><span class="line">        STATISTICS_INFO[<span class="string">'备份工具'</span>] = self.backup_tool</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_backup_dir</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""" create backup directory """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.fmt_backupdir):</span><br><span class="line">            os.makedirs(self.fmt_backupdir)</span><br><span class="line">            logger.info(<span class="string">f'OK: the backup dir not exisit, create <span class="subst">&#123;self.fmt_backupdir&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    FMT_INFO = <span class="string">'&#123;:.2f&#125;GB'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_backup_file_size</span><span class="params">(self)</span>:</span></span><br><span class="line">        size = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(self.fmt_backupdir):</span><br><span class="line">            size += sum([os.path.getsize(os.path.join(root, name))</span><br><span class="line">                         <span class="keyword">for</span> name <span class="keyword">in</span> files])</span><br><span class="line">        logger.info(<span class="string">f'OK: get backup file size'</span>)</span><br><span class="line">        STATISTICS_INFO[<span class="string">'备份大小'</span>] = self.FMT_INFO.format(float(size / <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_partition_size</span><span class="params">(self)</span>:</span></span><br><span class="line">        vfs = os.statvfs(self.fmt_backupdir)</span><br><span class="line">        free = (vfs.f_bavail * vfs.f_bsize) / (<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">        total = (vfs.f_blocks * vfs.f_bsize) / (<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">        partition_free_size = self.FMT_INFO.format(free)</span><br><span class="line">        partition_total_size = self.FMT_INFO.format(total)</span><br><span class="line">        logger.info(<span class="string">f'OK: get disk partition usage'</span>)</span><br><span class="line">        STATISTICS_INFO[<span class="string">'可用空间'</span>] = partition_free_size</span><br><span class="line">        STATISTICS_INFO[<span class="string">'总空间'</span>] = partition_total_size</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="string">""" </span></span><br><span class="line"><span class="string">        Send mail notice </span></span><br><span class="line"><span class="string">        Read TemporaryFile content</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        msg = MIMEText(data, _subtype=<span class="string">'html'</span>, _charset=<span class="string">'utf-8'</span>)</span><br><span class="line">        msg[<span class="string">'Subject'</span>] = <span class="string">'&#123;&#125; from &#123;&#125;'</span>.format(self.title, HOSTNAME)</span><br><span class="line">        msg[<span class="string">'From'</span>] = self.mail_sender</span><br><span class="line">        msg[<span class="string">'To'</span>] = <span class="string">";"</span>.join(list(self.mail_receiver.split(<span class="string">','</span>)))</span><br><span class="line">        mail_receiver = list(self.mail_receiver.split(<span class="string">','</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            server = smtplib.SMTP()</span><br><span class="line">            server.connect(self.mail_host, self.mail_port)</span><br><span class="line">            <span class="comment"># server.ehlo()</span></span><br><span class="line">            <span class="comment"># enable tls encrypt</span></span><br><span class="line">            server.starttls()</span><br><span class="line">            server.set_debuglevel(<span class="number">1</span>)</span><br><span class="line">            server.login(self.mail_user, self.mail_pass)</span><br><span class="line">            server.sendmail(self.mail_sender, mail_receiver, msg.as_string())</span><br><span class="line">            server.close()</span><br><span class="line">            logger.info(<span class="string">f'OK: send mail success'</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">            logger.error(<span class="string">f'FAILED: send mail fail'</span>)</span><br><span class="line">            logger.error(err)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_expired_directory</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#当前时间</span></span><br><span class="line">        today = datetime.datetime.now()</span><br><span class="line">        today_init = int(today.strftime(<span class="string">'%Y%m%d'</span>))</span><br><span class="line">        print(<span class="string">"today_init:"</span>, today_init)</span><br><span class="line">        <span class="comment"># #n天前时间</span></span><br><span class="line">        <span class="comment"># n_days = datetime.timedelta(days=int(expire_time))</span></span><br><span class="line">        <span class="comment"># n_days_agos = today - n_days</span></span><br><span class="line">        <span class="comment"># n_days_agos_init = int(n_days_agos.strftime('%Y%m%d'))</span></span><br><span class="line">        remove_dir = []</span><br><span class="line">        print(<span class="string">"backupdir"</span>, self.backupdir)</span><br><span class="line">        list = os.listdir(self.backupdir)</span><br><span class="line">        print(<span class="string">"list:"</span>, list)</span><br><span class="line">        <span class="keyword">for</span> directory_name <span class="keyword">in</span> list:</span><br><span class="line">            abs_dir = os.path.join(self.backupdir, directory_name)</span><br><span class="line">            print(<span class="string">"abs_dir:"</span>, abs_dir)</span><br><span class="line">            dir_timestamp = os.path.getctime(abs_dir)</span><br><span class="line">            dir_init = int(datetime.datetime.fromtimestamp(dir_timestamp).strftime(<span class="string">'%Y%m%d'</span>))</span><br><span class="line">            print(<span class="string">"dir_init:"</span>, dir_init)</span><br><span class="line">            print(<span class="string">"expire_day:"</span>, int(self.expire_day))</span><br><span class="line">            print(today_init - dir_init)</span><br><span class="line">            <span class="keyword">if</span> today_init - dir_init &gt;= int(self.expire_day):</span><br><span class="line">                print(<span class="string">"remove:"</span>, os.path.join(self.backupdir, directory_name))</span><br><span class="line">                shutil.rmtree(os.path.join(self.backupdir, directory_name))</span><br><span class="line">                logger.info(<span class="string">f"OK: the directory <span class="subst">&#123;directory_name&#125;</span> remove success"</span>)</span><br><span class="line">                remove_dir.append(directory_name)</span><br><span class="line">                </span><br><span class="line">            STATISTICS_INFO[<span class="string">'过期备份'</span>] = remove_dir</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Prepare</span><span class="params">(General)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Generate command</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file)</span>:</span></span><br><span class="line">        self.file = file</span><br><span class="line">        General.__init__(self, self.file)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_xb_cmd</span><span class="params">(self)</span>:</span></span><br><span class="line">        mysql_cmd = <span class="string">f"--user=<span class="subst">&#123;self.user&#125;</span> --password=<span class="subst">&#123;self.password&#125;</span> --host=<span class="subst">&#123;self.host&#125;</span> --port=<span class="subst">&#123;self.port&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">        cmd_list = []</span><br><span class="line">        <span class="keyword">if</span> hasattr(self, <span class="string">'compress'</span>) <span class="keyword">and</span> hasattr(self, <span class="string">'compress_chunk_size'</span>) <span class="keyword">and</span> hasattr(self, <span class="string">'compress_threads'</span>):</span><br><span class="line">            compress_cmd = <span class="string">f"--compress=<span class="subst">&#123;self.compress&#125;</span> --compress-chunk-size=<span class="subst">&#123;self.compress_chunk_size&#125;</span> --compress-threads=<span class="subst">&#123;self.compress_threads&#125;</span>"</span></span><br><span class="line">            cmd_list.append(compress_cmd)</span><br><span class="line">            STATISTICS_INFO[<span class="string">'是否压缩'</span>] = <span class="string">'Yes'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            STATISTICS_INFO[<span class="string">'是否压缩'</span>] = <span class="string">'No'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hasattr(self, <span class="string">'xtra_options'</span>):</span><br><span class="line">            xtra_options = self.xtra_options</span><br><span class="line">            cmd_list.append(xtra_options)</span><br><span class="line"></span><br><span class="line">        xb_cmd = <span class="string">f"<span class="subst">&#123;self.backup_tool&#125;</span> --defaults-file=<span class="subst">&#123;self.defaults_file&#125;</span>"</span> </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">' '</span>.join((xb_cmd, mysql_cmd, <span class="string">' '</span>.join(cmd_list), self.fmt_backupdir)) </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RunCommand</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, command)</span>:</span></span><br><span class="line">        self.command = command</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner</span><span class="params">(self)</span>:</span></span><br><span class="line">        status, output = subprocess.getstatusoutput(self.command)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'status'</span>: status, <span class="string">'output'</span>: output&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line"></span><br><span class="line">    config_file = get_arguments()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check whether the config file is valid</span></span><br><span class="line">    check_config_valid(config_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># instance Prepare and Toolskit</span></span><br><span class="line">    prepare = Prepare(config_file)</span><br><span class="line">    tools = ToolsUtils(config_file)</span><br><span class="line"></span><br><span class="line">    xb_cmd = prepare.generate_xb_cmd</span><br><span class="line">    logger.info(<span class="string">f'OK: generate xtrabackup command \n <span class="subst">&#123;xb_cmd&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># exec backup</span></span><br><span class="line">    backup_result = RunCommand(xb_cmd).runner</span><br><span class="line">    logger.info(<span class="string">f'OK: perform backup process, please waiting.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> TemporaryFile(<span class="string">'w+t'</span>, encoding=<span class="string">'gbk'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">if</span> backup_result[<span class="string">'status'</span>] == <span class="number">0</span>:</span><br><span class="line">            logger.info(<span class="string">f'OK: xtrabackup backup success'</span>)</span><br><span class="line">            tools.get_backup_file_size()</span><br><span class="line">            tools.get_partition_size()</span><br><span class="line">            tools.remove_expired_directory()</span><br><span class="line"></span><br><span class="line">            end_time = time.time()</span><br><span class="line">            STATISTICS_INFO[<span class="string">'备份耗时'</span>] = <span class="string">'&#123;:0.2f&#125;s'</span>.format(end_time - start_time)</span><br><span class="line"></span><br><span class="line">            result = render_to_template(html_template, STATISTICS_INFO)</span><br><span class="line">            f.write(result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.error(<span class="string">f"ERROR: <span class="subst">&#123;backup_result[<span class="string">'output'</span>]&#125;</span>"</span>)</span><br><span class="line">            f.write(backup_result[<span class="string">'output'</span>])</span><br><span class="line"></span><br><span class="line">        f.seek(<span class="number">0</span>)</span><br><span class="line">        TEXT_DATA = f.read()</span><br><span class="line"></span><br><span class="line">        tools.send_mail(TEXT_DATA)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h1 id="xb-back-cnf"><a href="#xb-back-cnf" class="headerlink" title="xb_back.cnf"></a>xb_back.cnf</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[mysql]</span><br><span class="line"><span class="comment"># mysql backup user</span></span><br><span class="line">user = root</span><br><span class="line">password = langke121</span><br><span class="line">host = 127.0.0.1</span><br><span class="line">port = 3306</span><br><span class="line"></span><br><span class="line">[xtrabackup]</span><br><span class="line">backup_tool = /usr/bin/innobackupex</span><br><span class="line">defaults-file = /etc/my.cnf</span><br><span class="line">backupdir = /home/hoke/zabbixDB-backup/AutoBackup</span><br><span class="line">xtra_options = --no-version-check --rsync</span><br><span class="line"></span><br><span class="line">[compress]</span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment"># Enable only if you want to use compression.</span></span><br><span class="line">compress = quicklz</span><br><span class="line">compress_chunk_size = 64k</span><br><span class="line">compress_threads = 4</span><br><span class="line"></span><br><span class="line">[mail]</span><br><span class="line"><span class="comment"># mail setting</span></span><br><span class="line">title = [ZabbixDB AutoBackup]</span><br><span class="line">mail_sender = rd_sys@xxx.xxx</span><br><span class="line">mail_receiver = runchain_ops@xxx.xxx,hoke58@qq.com</span><br><span class="line">mail_host = smtp.263.net</span><br><span class="line">mail_port = 25</span><br><span class="line">mail_user = rd_sys@xxx.xxx</span><br><span class="line">mail_pass = password</span><br><span class="line"></span><br><span class="line">[expired]</span><br><span class="line"><span class="comment"># Enable only if you want to clean expired backup.</span></span><br><span class="line">expire_day = 5</span><br></pre></td></tr></table></figure>

<h1 id="table-template-html"><a href="#table-template-html" class="headerlink" title="table_template.html"></a>table_template.html</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"gbk"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        body &#123;</span><br><span class="line">            font-size: 14px;</span><br><span class="line"><span class="css">            <span class="selector-tag">line-height</span>: 1<span class="selector-class">.42857143</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#333</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.row</span> &#123;</span></span><br><span class="line">            margin-right: -15px;</span><br><span class="line">            margin-left: -15px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.col-sm-10</span> &#123;</span></span><br><span class="line">            width: 85%;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.col-sm-2</span> &#123;</span></span><br><span class="line">            width: 15%;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.table</span> &#123;</span></span><br><span class="line">            width: 85%;</span><br><span class="line">            max-width: 85%;</span><br><span class="line">            margin-bottom: 1rem;</span><br><span class="line">            background-color: transparent;</span><br><span class="line">            border-collapse: collapse;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.table</span> <span class="selector-tag">td</span>, <span class="selector-class">.table</span> <span class="selector-tag">th</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">padding</span>: <span class="selector-class">.65rem</span>;</span></span><br><span class="line">            vertical-align: top;</span><br><span class="line"><span class="css">            <span class="selector-tag">border-top</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#dee2e6</span>;</span></span><br><span class="line">            word-wrap: break-word;</span><br><span class="line">            word-break: break-all;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% if data %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">        &#123;% for key in data %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"col-sm-2"</span>&gt;</span>&#123;&#123; key &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span>&#123;&#123; data[key] &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    &#123;% elif err_msg %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>err_msg<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>开发</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>开启 Google-BBR 网络加速</title>
    <url>/systemops/google-bbr.html</url>
    <content><![CDATA[<p><img src="https://upyun.hoke58.cn/img/google-bbr-bbr.png" alt="google-bbr-bbr.png"></p>
<a id="more"></a>
<h1 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h1><p>BBR (Bottleneck Bandwidth and RTT) 是 Google 出品的 TCP 拥塞控制算法，BBR 目的是要尽量跑满带宽，并且尽量不要有排队的情况。BBR 可以起到单边加速 TCP 连接的效果。</p>
<p>BBR解决了两个问题：</p>
<ul>
<li>一定丢包率的网络链路上充分利用带宽。非常适合高延迟，高带宽的网络链路。</li>
<li>降低网络链路上的 buffer 占用率，从而降低延迟。非常适合慢速接入网络的用户。</li>
</ul>
<p>网络链路上的包比较少时，道路很通畅，这个阶段，对于一个 TCP 连接来说，它的速度由这个连接两端之间的距离决定，也可以说是由 RTT 决定。当发包速率变大，把道路基本上填满了之后，这个阶段，带宽的大小决定了这个连接的速度，这时两端之间可能就会有包要排队，延迟时间除了 RTT 还有排队时间。</p>
<p><code>cwnd</code> 是普通的拥塞控制算法里最终要求得的一个值，用来控制发包速率。BBR 也要求到这个值，但是它不是最主要的控制发包速率的变量，主要的变量是 <code>pacing_rate</code>。</p>
<p>这两个变量都由探测到的带宽值和 RTT 值得到，整个过程都围绕着这两个值。在 BBR 算法中，有四种状态，几种状态可能会有如下的转换：</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">         |</span><br><span class="line"><span class="string">         V</span></span><br><span class="line"><span class="string">+---&gt; STARTUP  ----+</span></span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">        V         </span>|</span><br><span class="line">|<span class="string">      DRAIN   ----+</span></span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">        V         </span>|</span><br><span class="line">+---&gt; PROBE_BW ----+</span><br><span class="line">|<span class="string">      ^    </span>|<span class="string">      </span>|</span><br><span class="line">|<span class="string">      </span>|<span class="string">    </span>|<span class="string">      </span>|</span><br><span class="line">|<span class="string">      +----+      </span>|</span><br><span class="line">|<span class="string">                  </span>|</span><br><span class="line">+---- PROBE_RTT <span class="variable">&lt;--+</span></span><br></pre></td></tr></table></figure>
<p>另外还有一个重要变量，是在不同状态，不同阶段取的不同增益系数，比如有时需要多发包探测到最大瓶颈带宽，有时需要把发包量降下来探测较为准确的 RTT。</p>
<p><code>STARTUP</code> 类似与普通拥塞控制里的慢启动，增益系数是 <code>2ln2</code>，每一个来回都以这个系数增大发包速率，估测到带宽满了就进入 <code>DRAIN</code> 状态 —— 连续三个来回，测得的最大瓶颈带宽没有比上一轮增大 25% 以上，就算做带宽满了。</p>
<p>进入 <code>DRAIN</code> 状态，增益系数小于 1，也就降速了。一个包来回，把 <code>STARTUP</code> 状态中产生的队列“抽干”，怎么样测算到队列空了？发出去还没有 ACK 的包量 <code>inflight</code>，与 BDP （带宽延迟积）进行比较，<code>inflight &lt; BDP</code> 说明空了，道路不那么满了，如果 <code>inflght &gt; BDP</code> 说明还不能到下一个状态，继续 <code>DRAIN</code>。</p>
<p><code>PROBE_BW</code> 是稳定状态，这时已经测出来一个最大瓶颈带宽，而且尽量不会产生排队现象。之后的每个来回，在 <code>PROBE_BW</code> 状态循环（除非要进入下面提到的 <code>PROBE_RTT</code> 状态），轮询下面这些增益系数，5/4, 3/4, 1, 1, 1, 1, 1, 1，如此，最大瓶颈带宽就会在其停止增长的地方上下徘徊。大部分时间都应该处于 <code>PROBE_BW</code> 状态。</p>
<p>前面三种状态，都可能进入 <code>PROBE_RTT</code> 状态。超过十秒没有估测到更小的 RTT 值，这时进入 <code>PROBE_RTT</code> 状态，把发包量降低，空出道路来比较准确得测一个 RTT 值，至少 200ms 或一个包的来回之后退出这个状态。检查带宽是否是满的，进入不同的状态：如果不满，进入 <code>STARTUP</code> 状态，如果满，进入 <code>PROBE_BW</code> 状态。</p>
<h1 id="启用-BBR"><a href="#启用-BBR" class="headerlink" title="启用 BBR"></a>启用 BBR</h1><p>先甩一下 Google BBR 项目地址： <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9iYnI=" title="https://github.com/google/bbr">https://github.com/google/bbr<i class="fa fa-external-link"></i></span></p>
<p>目前已有 BBR v2 Alpha/Preview 版本</p>
<h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><p>Linux 内核 4.9 版本以上，请使用以下命令查看内核</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># uname -sr</span></span><br></pre></td></tr></table></figure>
<p>如果你是 Centos 系统可参照 <a href="/systemops/centos-upgrade-kernel.html">Centos 升级内核的正确姿势</a> ，升级内核</p>
<blockquote>
<p>Linux 内核从 4.9 开始已经支持 BBR 算法</p>
</blockquote>
<h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><ol>
<li>执行以下命令，sysctl.conf 增加 BBR 配置<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"# google bbr"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.core.default_qdisc=fq"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.ipv4.tcp_congestion_control=bbr"</span> &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure></li>
<li>保存生效<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></li>
<li>验证<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@yunwei ~]<span class="comment"># sysctl net.ipv4.tcp_available_congestion_control</span></span><br><span class="line">net.ipv4.tcp_available_congestion_control = reno cubic bbr</span><br><span class="line"></span><br><span class="line">[root@yunwei ~]<span class="comment"># lsmod | grep bbr</span></span><br><span class="line">tcp_bbr                20480  1</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>系统运维</category>
      </categories>
      <tags>
        <tag>bbr</tag>
        <tag>google</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库系统原理（转）</title>
    <url>/databases/database-principles.html</url>
    <content><![CDATA[<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>事务指的是满足 ACID 特性的一组操作，可以通过 Commit 提交一个事务，也可以使用 Rollback 进行回滚。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207222237925.png"/> </div><br>
<a id="more"></a>

<h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><h3 id="原子性（Atomicity）"><a href="#原子性（Atomicity）" class="headerlink" title="原子性（Atomicity）"></a>原子性（Atomicity）</h3><p>事务被视为不可分割的最小单元，事务的所有操作要么全部提交成功，要么全部失败回滚。</p>
<p>回滚可以用回滚日志（Undo Log）来实现，回滚日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</p>
<h3 id="一致性（Consistency）"><a href="#一致性（Consistency）" class="headerlink" title="一致性（Consistency）"></a>一致性（Consistency）</h3><p>数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对同一个数据的读取结果都是相同的。</p>
<h3 id="隔离性（Isolation）"><a href="#隔离性（Isolation）" class="headerlink" title="隔离性（Isolation）"></a>隔离性（Isolation）</h3><p>一个事务所做的修改在最终提交以前，对其它事务是不可见的。</p>
<h3 id="持久性（Durability）"><a href="#持久性（Durability）" class="headerlink" title="持久性（Durability）"></a>持久性（Durability）</h3><p>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</p>
<p>系统发生奔溃可以用重做日志（Redo Log）进行恢复，从而实现持久性。与回滚日志记录数据的逻辑修改不同，重做日志记录的是数据页的物理修改。</p>
<hr>
<p>事务的 ACID 特性概念简单，但不是很好理解，主要是因为这几个特性不是一种平级关系：</p>
<ul>
<li>只有满足一致性，事务的执行结果才是正确的。</li>
<li>在无并发的情况下，事务串行执行，隔离性一定能够满足。此时只要能满足原子性，就一定能满足一致性。</li>
<li>在并发的情况下，多个事务并行执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。</li>
<li>事务满足持久化是为了能应对系统崩溃的情况。</li>
</ul>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207210437023.png"/> </div><br>

<h2 id="AUTOCOMMIT"><a href="#AUTOCOMMIT" class="headerlink" title="AUTOCOMMIT"></a>AUTOCOMMIT</h2><p>MySQL 默认采用自动提交模式。也就是说，如果不显式使用<code>START TRANSACTION</code>语句来开始一个事务，那么每个查询操作都会被当做一个事务并自动提交。</p>
<h1 id="并发一致性问题"><a href="#并发一致性问题" class="headerlink" title="并发一致性问题"></a>并发一致性问题</h1><p>在并发环境下，事务的隔离性很难保证，因此会出现很多并发一致性问题。</p>
<h2 id="丢失修改"><a href="#丢失修改" class="headerlink" title="丢失修改"></a>丢失修改</h2><p>T<sub>1</sub> 和 T<sub>2</sub> 两个事务都对一个数据进行修改，T<sub>1</sub> 先修改，T<sub>2</sub> 随后修改，T<sub>2</sub> 的修改覆盖了 T<sub>1</sub> 的修改。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207221744244.png"/> </div><br>

<h2 id="读脏数据"><a href="#读脏数据" class="headerlink" title="读脏数据"></a>读脏数据</h2><p>T<sub>1</sub> 修改一个数据，T<sub>2</sub> 随后读取这个数据。如果 T<sub>1</sub> 撤销了这次修改，那么 T<sub>2</sub> 读取的数据是脏数据。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207221920368.png"/> </div><br>

<h2 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h2><p>T<sub>2</sub> 读取一个数据，T<sub>1</sub> 对该数据做了修改。如果 T<sub>2</sub> 再次读取这个数据，此时读取的结果和第一次读取的结果不同。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207222102010.png"/> </div><br>

<h2 id="幻影读"><a href="#幻影读" class="headerlink" title="幻影读"></a>幻影读</h2><p>T<sub>1</sub> 读取某个范围的数据，T<sub>2</sub> 在这个范围内插入新的数据，T<sub>1</sub> 再次读取这个范围的数据，此时读取的结果和和第一次读取的结果不同。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207222134306.png"/> </div><br>

<hr>
<p>产生并发不一致性问题的主要原因是破坏了事务的隔离性，解决方法是通过并发控制来保证隔离性。并发控制可以通过封锁来实现，但是封锁操作需要用户自己控制，相当复杂。数据库管理系统提供了事务的隔离级别，让用户以一种更轻松的方式处理并发一致性问题。</p>
<h1 id="封锁"><a href="#封锁" class="headerlink" title="封锁"></a>封锁</h1><h2 id="封锁粒度"><a href="#封锁粒度" class="headerlink" title="封锁粒度"></a>封锁粒度</h2><p>MySQL 中提供了两种封锁粒度：行级锁以及表级锁。</p>
<p>应该尽量只锁定需要修改的那部分数据，而不是所有的资源。锁定的数据量越少，发生锁争用的可能就越小，系统的并发程度就越高。</p>
<p>但是加锁需要消耗资源，锁的各种操作（包括获取锁、释放锁、以及检查锁状态）都会增加系统开销。因此封锁粒度越小，系统开销就越大。</p>
<p>在选择封锁粒度时，需要在锁开销和并发程度之间做一个权衡。</p>
<h2 id="封锁类型"><a href="#封锁类型" class="headerlink" title="封锁类型"></a>封锁类型</h2><h3 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h3><ul>
<li>互斥锁（Exclusive），简写为 X 锁，又称写锁。</li>
<li>共享锁（Shared），简写为 S 锁，又称读锁。</li>
</ul>
<p>有以下两个规定：</p>
<ul>
<li>一个事务对数据对象 A 加了 X 锁，就可以对 A 进行读取和更新。加锁期间其它事务不能对 A 加任何锁。</li>
<li>一个事务对数据对象 A 加了 S 锁，可以对 A 进行读取操作，但是不能进行更新操作。加锁期间其它事务能对 A 加 S 锁，但是不能加 X 锁。</li>
</ul>
<p>锁的兼容关系如下：</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207213523777.png"/> </div><br>

<h3 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h3><p>使用意向锁（Intention Locks）可以更容易地支持多粒度封锁。</p>
<p>在存在行级锁和表级锁的情况下，事务 T 想要对表 A 加 X 锁，就需要先检测是否有其它事务对表 A 或者表 A 中的任意一行加了锁，那么就需要对表 A 的每一行都检测一次，这是非常耗时的。</p>
<p>意向锁在原来的 X/S 锁之上引入了 IX/IS，IX/IS 都是表锁，用来表示一个事务想要在表中的某个数据行上加 X 锁或 S 锁。有以下两个规定：</p>
<ul>
<li>一个事务在获得某个数据行对象的 S 锁之前，必须先获得表的 IS 锁或者更强的锁；</li>
<li>一个事务在获得某个数据行对象的 X 锁之前，必须先获得表的 IX 锁。</li>
</ul>
<p>通过引入意向锁，事务 T 想要对表 A 加 X 锁，只需要先检测是否有其它事务对表 A 加了 X/IX/S/IS 锁，如果加了就表示有其它事务正在使用这个表或者表中某一行的锁，因此事务 T 加 X 锁失败。</p>
<p>各种锁的兼容关系如下：</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207214442687.png"/> </div><br>

<p>解释如下：</p>
<ul>
<li>任意 IS/IX 锁之间都是兼容的，因为它们只表示想要对表加锁，而不是真正加锁；</li>
<li>这里兼容关系针对的是表级锁，而表级的 IX 锁和行级的 X 锁兼容，两个事务可以对两个数据行加 X 锁。（事务 T<sub>1</sub> 想要对数据行 R<sub>1</sub> 加 X 锁，事务 T<sub>2</sub> 想要对同一个表的数据行 R<sub>2</sub> 加 X 锁，两个事务都需要对该表加 IX 锁，但是 IX 锁是兼容的，并且 IX 锁与行级的 X 锁也是兼容的，因此两个事务都能加锁成功，对同一个表中的两个数据行做修改。）</li>
</ul>
<h2 id="封锁协议"><a href="#封锁协议" class="headerlink" title="封锁协议"></a>封锁协议</h2><h3 id="三级封锁协议"><a href="#三级封锁协议" class="headerlink" title="三级封锁协议"></a>三级封锁协议</h3><p><strong>一级封锁协议</strong>  </p>
<p>事务 T 要修改数据 A 时必须加 X 锁，直到 T 结束才释放锁。</p>
<p>可以解决丢失修改问题，因为不能同时有两个事务对同一个数据进行修改，那么事务的修改就不会被覆盖。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207220440451.png"/> </div><br>

<p><strong>二级封锁协议</strong>  </p>
<p>在一级的基础上，要求读取数据 A 时必须加 S 锁，读取完马上释放 S 锁。</p>
<p>可以解决读脏数据问题，因为如果一个事务在对数据 A 进行修改，根据 1 级封锁协议，会加 X 锁，那么就不能再加 S 锁了，也就是不会读入数据。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207220831843.png"/> </div><br>

<p><strong>三级封锁协议</strong>  </p>
<p>在二级的基础上，要求读取数据 A 时必须加 S 锁，直到事务结束了才能释放 S 锁。</p>
<p>可以解决不可重复读的问题，因为读 A 时，其它事务不能对 A 加 X 锁，从而避免了在读的期间数据发生改变。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207221313819.png"/> </div><br>

<h3 id="两段锁协议"><a href="#两段锁协议" class="headerlink" title="两段锁协议"></a>两段锁协议</h3><p>加锁和解锁分为两个阶段进行。</p>
<p>可串行化调度是指，通过并发控制，使得并发执行的事务结果与某个串行执行的事务结果相同。串行执行的事务互不干扰，不会出现并发一致性问题。</p>
<p>事务遵循两段锁协议是保证可串行化调度的充分条件。例如以下操作满足两段锁协议，它是可串行化调度。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">lock-x(A)...lock-s(B)...lock-s(C)...unlock(A)...unlock(C)...unlock(B)</span><br></pre></td></tr></table></figure>

<p>但不是必要条件，例如以下操作不满足两段锁协议，但它还是可串行化调度。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">lock-x(A)...unlock(A)...lock-s(B)...unlock(B)...lock-s(C)...unlock(C)</span><br></pre></td></tr></table></figure>

<h2 id="MySQL-隐式与显示锁定"><a href="#MySQL-隐式与显示锁定" class="headerlink" title="MySQL 隐式与显示锁定"></a>MySQL 隐式与显示锁定</h2><p>MySQL 的 InnoDB 存储引擎采用两段锁协议，会根据隔离级别在需要的时候自动加锁，并且所有的锁都是在同一时刻被释放，这被称为隐式锁定。</p>
<p>InnoDB 也可以使用特定的语句进行显示锁定：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">LOCK</span> <span class="keyword">In</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span>;</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<h1 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h1><h2 id="未提交读（READ-UNCOMMITTED）"><a href="#未提交读（READ-UNCOMMITTED）" class="headerlink" title="未提交读（READ UNCOMMITTED）"></a>未提交读（READ UNCOMMITTED）</h2><p>事务中的修改，即使没有提交，对其它事务也是可见的。</p>
<h2 id="提交读（READ-COMMITTED）"><a href="#提交读（READ-COMMITTED）" class="headerlink" title="提交读（READ COMMITTED）"></a>提交读（READ COMMITTED）</h2><p>一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。</p>
<h2 id="可重复读（REPEATABLE-READ）"><a href="#可重复读（REPEATABLE-READ）" class="headerlink" title="可重复读（REPEATABLE READ）"></a>可重复读（REPEATABLE READ）</h2><p>保证在同一个事务中多次读取同一数据的结果是一样的。</p>
<h2 id="可串行化（SERIALIZABLE）"><a href="#可串行化（SERIALIZABLE）" class="headerlink" title="可串行化（SERIALIZABLE）"></a>可串行化（SERIALIZABLE）</h2><p>强制事务串行执行，这样多个事务互不干扰，不会出现并发一致性问题。</p>
<p>该隔离级别需要加锁实现，因为要使用加锁机制保证同一时间只有一个事务执行，也就是保证事务串行执行。</p>
<hr>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191207223400787.png"/> </div><br>

<h1 id="多版本并发控制"><a href="#多版本并发控制" class="headerlink" title="多版本并发控制"></a>多版本并发控制</h1><p>多版本并发控制（Multi-Version Concurrency Control, MVCC）是 MySQL 的 InnoDB 存储引擎实现隔离级别的一种具体方式，用于实现提交读和可重复读这两种隔离级别。而未提交读隔离级别总是读取最新的数据行，要求很低，无需使用 MVCC。可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。</p>
<h2 id="基本思想"><a href="#基本思想" class="headerlink" title="基本思想"></a>基本思想</h2><p>在封锁一节中提到，加锁能解决多个事务同时执行时出现的并发一致性问题。在实际场景中读操作往往多于写操作，因此又引入了读写锁来避免不必要的加锁操作，例如读和读没有互斥关系。读写锁中读和写操作仍然是互斥的，而 MVCC 利用了多版本的思想，写操作更新最新的版本快照，而读操作去读旧版本快照，没有互斥关系，这一点和 CopyOnWrite 类似。</p>
<p>在 MVCC 中事务的修改操作（DELETE、INSERT、UPDATE）会为数据行新增一个版本快照。</p>
<p>脏读和不可重复读最根本的原因是事务读取到其它事务未提交的修改。在事务进行读取操作时，为了解决脏读和不可重复读问题，MVCC 规定只能读取已经提交的快照。当然一个事务可以读取自身未提交的快照，这不算是脏读。</p>
<h2 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h2><ul>
<li>系统版本号 SYS_ID：是一个递增的数字，每开始一个新的事务，系统版本号就会自动递增。</li>
<li>事务版本号 TRX_ID ：事务开始时的系统版本号。</li>
</ul>
<h2 id="Undo-日志"><a href="#Undo-日志" class="headerlink" title="Undo 日志"></a>Undo 日志</h2><p>MVCC 的多版本指的是多个版本的快照，快照存储在 Undo 日志中，该日志通过回滚指针 ROLL_PTR 把一个数据行的所有快照连接起来。</p>
<p>例如在 MySQL 创建一个表 t，包含主键 id 和一个字段 x。我们先插入一个数据行，然后对该数据行执行两次更新操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t(<span class="keyword">id</span>, x) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">"a"</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> t <span class="keyword">SET</span> x=<span class="string">"b"</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> t <span class="keyword">SET</span> x=<span class="string">"c"</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>因为没有使用 <code>START TRANSACTION</code> 将上面的操作当成一个事务来执行，根据 MySQL 的 AUTOCOMMIT 机制，每个操作都会被当成一个事务来执行，所以上面的操作总共涉及到三个事务。快照中除了记录事务版本号 TRX_ID 和操作之外，还记录了一个 bit 的 DEL 字段，用于标记是否被删除。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191208164808217.png"/> </div><br>

<p>INSERT、UPDATE、DELETE 操作会创建一个日志，并将事务版本号 TRX_ID  写入。DELETE 可以看成是一个特殊的 UPDATE，还会额外将 DEL 字段设置为 1。</p>
<h2 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h2><p>MVCC 维护了一个 ReadView 结构，主要包含了当前系统未提交的事务列表 TRX_IDs {TRX_ID_1, TRX_ID_2, …}，还有该列表的最小值 TRX_ID_MIN 和 TRX_ID_MAX。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/image-20191208171445674.png"/> </div><br>

<p>在进行 SELECT 操作时，根据数据行快照的 TRX_ID 与 TRX_ID_MIN 和 TRX_ID_MAX 之间的关系，从而判断数据行快照是否可以使用：</p>
<ul>
<li><p>TRX_ID &lt; TRX_ID_MIN，表示该数据行快照时在当前所有未提交事务之前进行更改的，因此可以使用。</p>
</li>
<li><p>TRX_ID &gt; TRX_ID_MAX，表示该数据行快照是在事务启动之后被更改的，因此不可使用。</p>
</li>
<li><p>TRX_ID_MIN &lt;= TRX_ID &lt;= TRX_ID_MAX，需要根据隔离级别再进行判断：</p>
<ul>
<li>提交读：如果 TRX_ID  在 TRX_IDs  列表中，表示该数据行快照对应的事务还未提交，则该快照不可使用。否则表示已经提交，可以使用。</li>
<li>可重复读：都不可以使用。因为如果可以使用的话，那么其它事务也可以读到这个数据行快照并进行修改，那么当前事务再去读这个数据行得到的值就会发生改变，也就是出现了不可重复读问题。</li>
</ul>
</li>
</ul>
<p>在数据行快照不可使用的情况下，需要沿着 Undo Log 的回滚指针 ROLL_PTR  找到下一个快照，再进行上面的判断。</p>
<h2 id="快照读与当前读"><a href="#快照读与当前读" class="headerlink" title="快照读与当前读"></a>快照读与当前读</h2><h3 id="快照读"><a href="#快照读" class="headerlink" title="快照读"></a>快照读</h3><p>MVCC 的 SELECT 操作是快照中的数据，不需要进行加锁操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> ...;</span><br></pre></td></tr></table></figure>

<h3 id="当前读"><a href="#当前读" class="headerlink" title="当前读"></a>当前读</h3><p>MVCC 其它会对数据库进行修改的操作（INSERT、UPDATE、DELETE）需要进行加锁操作，从而读取最新的数据。可以看到 MVCC 并不是完全不用加锁，而只是避免了 SELECT 的加锁操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span>;</span><br><span class="line"><span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="keyword">DELETE</span>;</span><br></pre></td></tr></table></figure>

<p>在进行 SELECT 操作时，可以强制指定进行加锁操作。以下第一个语句需要加 S 锁，第二个需要加 X 锁。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> ? <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> ? <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<h1 id="Next-Key-Locks"><a href="#Next-Key-Locks" class="headerlink" title="Next-Key Locks"></a>Next-Key Locks</h1><p>Next-Key Locks 是 MySQL 的 InnoDB 存储引擎的一种锁实现。</p>
<p>MVCC 不能解决幻影读问题，Next-Key Locks 就是为了解决这个问题而存在的。在可重复读（REPEATABLE READ）隔离级别下，使用 MVCC + Next-Key Locks 可以解决幻读问题。</p>
<h2 id="Record-Locks"><a href="#Record-Locks" class="headerlink" title="Record Locks"></a>Record Locks</h2><p>锁定一个记录上的索引，而不是记录本身。</p>
<p>如果表没有设置索引，InnoDB 会自动在主键上创建隐藏的聚簇索引，因此 Record Locks 依然可以使用。</p>
<h2 id="Gap-Locks"><a href="#Gap-Locks" class="headerlink" title="Gap Locks"></a>Gap Locks</h2><p>锁定索引之间的间隙，但是不包含索引本身。例如当一个事务执行以下语句，其它事务就不能在 t.c 中插入 15。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> c <span class="keyword">BETWEEN</span> <span class="number">10</span> <span class="keyword">and</span> <span class="number">20</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Next-Key-Locks-1"><a href="#Next-Key-Locks-1" class="headerlink" title="Next-Key Locks"></a>Next-Key Locks</h2><p>它是 Record Locks 和 Gap Locks 的结合，不仅锁定一个记录上的索引，也锁定索引之间的间隙。它锁定一个前开后闭区间，例如一个索引包含以下值：10, 11, 13, and 20，那么就需要锁定以下区间：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">(-∞, 10]</span><br><span class="line">(10, 11]</span><br><span class="line">(11, 13]</span><br><span class="line">(13, 20]</span><br><span class="line">(20, +∞)</span><br></pre></td></tr></table></figure>

<h1 id="关系数据库设计理论"><a href="#关系数据库设计理论" class="headerlink" title="关系数据库设计理论"></a>关系数据库设计理论</h1><h2 id="函数依赖"><a href="#函数依赖" class="headerlink" title="函数依赖"></a>函数依赖</h2><p>记 A-&gt;B 表示 A 函数决定 B，也可以说 B 函数依赖于 A。</p>
<p>如果 {A1，A2，… ，An} 是关系的一个或多个属性的集合，该集合函数决定了关系的其它所有属性并且是最小的，那么该集合就称为键码。</p>
<p>对于 A-&gt;B，如果能找到 A 的真子集 A’，使得 A’-&gt; B，那么 A-&gt;B 就是部分函数依赖，否则就是完全函数依赖。</p>
<p>对于 A-&gt;B，B-&gt;C，则 A-&gt;C 是一个传递函数依赖。</p>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><p>以下的学生课程关系的函数依赖为 {Sno, Cname} -&gt; {Sname, Sdept, Mname, Grade}，键码为 {Sno, Cname}。也就是说，确定学生和课程之后，就能确定其它信息。</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
<th align="center">Mname</th>
<th align="center">Cname</th>
<th align="center">Grade</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
<td align="center">课程-1</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-1</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">95</td>
</tr>
</tbody></table>
<p>不符合范式的关系，会产生很多异常，主要有以下四种异常：</p>
<ul>
<li>冗余数据：例如 <code>学生-2</code> 出现了两次。</li>
<li>修改异常：修改了一个记录中的信息，但是另一个记录中相同的信息却没有被修改。</li>
<li>删除异常：删除一个信息，那么也会丢失其它信息。例如删除了 <code>课程-1</code> 需要删除第一行和第三行，那么 <code>学生-1</code> 的信息就会丢失。</li>
<li>插入异常：例如想要插入一个学生的信息，如果这个学生还没选课，那么就无法插入。</li>
</ul>
<h2 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h2><p>范式理论是为了解决以上提到四种异常。</p>
<p>高级别范式的依赖于低级别的范式，1NF 是最低级别的范式。</p>
<h3 id="第一范式-1NF"><a href="#第一范式-1NF" class="headerlink" title="第一范式 (1NF)"></a>第一范式 (1NF)</h3><p>属性不可分。</p>
<h3 id="第二范式-2NF"><a href="#第二范式-2NF" class="headerlink" title="第二范式 (2NF)"></a>第二范式 (2NF)</h3><p>每个非主属性完全函数依赖于键码。</p>
<p>可以通过分解来满足。</p>
<p><font size=4>  <strong>分解前</strong>  </font><br></p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
<th align="center">Mname</th>
<th align="center">Cname</th>
<th align="center">Grade</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
<td align="center">课程-1</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-1</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">95</td>
</tr>
</tbody></table>
<p>以上学生课程关系中，{Sno, Cname} 为键码，有如下函数依赖：</p>
<ul>
<li>Sno -&gt; Sname, Sdept</li>
<li>Sdept -&gt; Mname</li>
<li>Sno, Cname-&gt; Grade</li>
</ul>
<p>Grade 完全函数依赖于键码，它没有任何冗余数据，每个学生的每门课都有特定的成绩。</p>
<p>Sname, Sdept 和 Mname 都部分依赖于键码，当一个学生选修了多门课时，这些数据就会出现多次，造成大量冗余数据。</p>
<p><font size=4>  <strong>分解后</strong>  </font><br></p>
<p>关系-1</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
<th align="center">Mname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
</tr>
</tbody></table>
<p>有以下函数依赖：</p>
<ul>
<li>Sno -&gt; Sname, Sdept</li>
<li>Sdept -&gt; Mname</li>
</ul>
<p>关系-2</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Cname</th>
<th align="center">Grade</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">课程-1</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">课程-2</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">课程-1</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">课程-2</td>
<td align="center">95</td>
</tr>
</tbody></table>
<p>有以下函数依赖：</p>
<ul>
<li>Sno, Cname -&gt;  Grade</li>
</ul>
<h3 id="第三范式-3NF"><a href="#第三范式-3NF" class="headerlink" title="第三范式 (3NF)"></a>第三范式 (3NF)</h3><p>非主属性不传递函数依赖于键码。</p>
<p>上面的 关系-1 中存在以下传递函数依赖：</p>
<ul>
<li>Sno -&gt; Sdept -&gt; Mname</li>
</ul>
<p>可以进行以下分解：</p>
<p>关系-11</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
</tr>
</tbody></table>
<p>关系-12</p>
<table>
<thead>
<tr>
<th align="center">Sdept</th>
<th align="center">Mname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
</tr>
<tr>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
</tr>
</tbody></table>
<h1 id="ER-图"><a href="#ER-图" class="headerlink" title="ER 图"></a>ER 图</h1><p>Entity-Relationship，有三个组成部分：实体、属性、联系。</p>
<p>用来进行关系型数据库系统的概念设计。</p>
<h2 id="实体的三种联系"><a href="#实体的三种联系" class="headerlink" title="实体的三种联系"></a>实体的三种联系</h2><p>包含一对一，一对多，多对多三种。</p>
<ul>
<li>如果 A 到 B 是一对多关系，那么画个带箭头的线段指向 B；</li>
<li>如果是一对一，画两个带箭头的线段；</li>
<li>如果是多对多，画两个不带箭头的线段。</li>
</ul>
<p>下图的 Course 和 Student 是一对多的关系。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/1d28ad05-39e5-49a2-a6a1-a6f496adba6a.png" width="380px"/> </div><br>

<h2 id="表示出现多次的关系"><a href="#表示出现多次的关系" class="headerlink" title="表示出现多次的关系"></a>表示出现多次的关系</h2><p>一个实体在联系出现几次，就要用几条线连接。</p>
<p>下图表示一个课程的先修关系，先修关系出现两个 Course 实体，第一个是先修课程，后一个是后修课程，因此需要用两条线来表示这种关系。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/ac929ea3-daca-40ec-9e95-4b2fa6678243.png" width="250px"/> </div><br>

<h2 id="联系的多向性"><a href="#联系的多向性" class="headerlink" title="联系的多向性"></a>联系的多向性</h2><p>虽然老师可以开设多门课，并且可以教授多名学生，但是对于特定的学生和课程，只有一个老师教授，这就构成了一个三元联系。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/5bb1b38a-527e-4802-a385-267dadbd30ba.png" width="350px"/> </div><br>

<h2 id="表示子类"><a href="#表示子类" class="headerlink" title="表示子类"></a>表示子类</h2><p>用一个三角形和两条线来连接类和子类，与子类有关的属性和联系都连到子类上，而与父类和子类都有关的连到父类上。</p>
<div align="center"> <img src="https://upyun.hoke58.cn/img/数据库系统原理/14389ea4-8d96-4e96-9f76-564ca3324c1e.png" width="450px"/> </div><br>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>AbrahamSilberschatz, HenryF.Korth, S.Sudarshan, 等. 数据库系统概念 [M]. 机械工业出版社, 2006.</li>
<li>施瓦茨. 高性能 MYSQL(第3版)[M]. 电子工业出版社, 2013.</li>
<li>史嘉权. 数据库系统概论[M]. 清华大学出版社有限公司, 2006.</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9yZWZtYW4vNS43L2VuL2lubm9kYi1zdG9yYWdlLWVuZ2luZS5odG1s" title="https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html">The InnoDB Storage Engine<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2xpZGVzaGFyZS5uZXQvRXJuZXN0b0hlcm5hbmRlelJvZHJpZ3Vlei90cmFuc2FjdGlvbi1pc29sYXRpb24tbGV2ZWxz" title="https://www.slideshare.net/ErnestoHernandezRodriguez/transaction-isolation-levels">Transaction isolation levels<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3NjYW5mdHJlZS5jb20vZGJtcy8yLXBoYXNlLWxvY2tpbmctcHJvdG9jb2w=" title="http://scanftree.com/dbms/2-phase-locking-protocol">Concurrency Control<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2xpZGVzaGFyZS5uZXQvYnJzaHJpc3Rvdi90aGUtbmlnaHRtYXJlLW9mLWxvY2tpbmctYmxvY2tpbmctYW5kLWlzb2xhdGlvbi1sZXZlbHMtNDYzOTE2NjY=" title="https://www.slideshare.net/brshristov/the-nightmare-of-locking-blocking-and-isolation-levels-46391666">The Nightmare of Locking, Blocking and Isolation Levels!<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ha3Nha2FsbGkuZ2l0aHViLmlvLzIwMTIvMDMvMTIvZGF0YWJhc2Utbm9ybWFsaXphdGlvbi1hbmQtbm9ybWFsLWZvcm1zLXdpdGgtYW4tZXhhbXBsZS5odG1s" title="https://aksakalli.github.io/2012/03/12/database-normalization-and-normal-forms-with-an-example.html">Database Normalization and Normal Forms with an Example<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmpjb2xlLnVzLzIwMTQvMDQvMTYvdGhlLWJhc2ljcy1vZi10aGUtaW5ub2RiLXVuZG8tbG9nZ2luZy1hbmQtaGlzdG9yeS1zeXN0ZW0v" title="https://blog.jcole.us/2014/04/16/the-basics-of-the-innodb-undo-logging-and-history-system/">The basics of the InnoDB undo logging and history system<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuYnJpZ2h0Ym94LmNvbS9ibG9nLzIwMTMvMTAvMzEvb24tbXlzcWwtbG9ja3Mv" title="https://www.brightbox.com/blog/2013/10/31/on-mysql-locks/">MySQL locking for the busy web developer<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kcmF2ZW5lc3MubWUvbXlzcWwtaW5ub2Ri" title="https://draveness.me/mysql-innodb">浅入浅出 MySQL 和 InnoDB<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly90ZWNoLm1laXR1YW4uY29tLzIwMTQvMDgvMjAvaW5ub2RiLWxvY2suaHRtbA==" title="https://tech.meituan.com/2014/08/20/innodb-lock.html">Innodb 中的事务隔离级别和锁的关系<i class="fa fa-external-link"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>浅析灰度发布</title>
    <url>/devops/canary-release.html</url>
    <content><![CDATA[<h1 id="什么是灰度发布"><a href="#什么是灰度发布" class="headerlink" title="什么是灰度发布"></a>什么是灰度发布</h1><p>灰度发布，又名金丝雀发布，或者灰度测试，是指在黑与白之间能够平滑过渡的一种发布方式。在其上可以进行<strong>A/B testing</strong>，即让一部分用户继续用产品特性<strong>A</strong>，一部分用户开始用产品特性<strong>B</strong>，如果用户对<strong>B</strong>没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到<strong>B</strong>上面来。</p>
<p>灰度发布是对某一产品的发布逐步扩大使用群体范围，也叫灰度放量。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。</p>
<p><strong>灰度期：</strong>灰度发布开始到结束期间的这一段时间，称为灰度期。</p>
<a id="more"></a>
<h1 id="灰度发布的意义"><a href="#灰度发布的意义" class="headerlink" title="灰度发布的意义"></a>灰度发布的意义</h1><p>灰度发布能及早获得用户的意见反馈，完善产品功能，提升产品质量，让用户参与产品测试，加强与用户互动，降低产品升级所影响的用户范围。</p>
<p>灰度系统的使用场景，无非是为了配合高节奏的产品上限频率，没有时间进行传统的穷尽式测试，所兴起的测试方法。所以，灰度系统的灵活性，对现有系统的很小的侵入性，是其最重要的特征。</p>
<h1 id="灰度发布步骤"><a href="#灰度发布步骤" class="headerlink" title="灰度发布步骤"></a>灰度发布步骤</h1><ol>
<li>定义目标</li>
<li>选定策略：包括用户规模、发布频率、功能覆盖度、回滚策略、运营策略、新旧系统部署策略等</li>
<li>筛选用户：包括用户特征、用户数量、用户常用功能、用户范围等</li>
<li>部署系统：部署新系统、部署用户行为分析系统（web analytics）、设定分流规则、运营数据分析、分流规则微调</li>
<li>发布总结：用户行为分析报告、用户问卷调查、社会化媒体意见收集、形成产品功能改进列表</li>
<li>产品完善</li>
<li>新一轮灰度发布或完整发布</li>
</ol>
<h1 id="实现一套灰度发布系统需要考虑哪些问题"><a href="#实现一套灰度发布系统需要考虑哪些问题" class="headerlink" title="实现一套灰度发布系统需要考虑哪些问题"></a>实现一套灰度发布系统需要考虑哪些问题</h1><p>仔细考虑一下灰度发布系统要达到哪些目的，基本就能有答案了。需要注意的是，客户端应用（无论PC端还是移动端）的灰度发布要比Web应用的灰度发布更为复杂，因为应用运行在用户持有的终端上，数据采集和回滚都更为困难（但可采集的数据类型要更加丰富）。</p>
<p>我所理解的灰度发布系统，主要任务是从产品用户群中按照一定策略选取部分用户，让他们先行体验新版本的应用，通过收集这部分用户对新版本应用的显式反馈（论坛、微博）或隐式反馈（应用自身统计数据），对新版本应用的功能、性能、稳定性等指标进行评判，进而决定继续放大新版本投放范围直至全量升级或回滚至老版本。</p>
<p>从上述描述可以得出灰度发布系统需要具备的一些要素：</p>
<h2 id="用户标识"><a href="#用户标识" class="headerlink" title="用户标识"></a>用户标识</h2><p>用于区分用户，辅助数据统计，保证灰度发布过程中用户体验的连贯性（避免用户在新旧版本中跳变，匿名Web应用比较容易有这个问题）。匿名Web应用可采用IP、Cookie等，需登录的应用可直接采用应用的帐号体系。</p>
<h2 id="目标用户选取策略"><a href="#目标用户选取策略" class="headerlink" title="目标用户选取策略"></a>目标用户选取策略</h2><p>即选取哪些用户先行体验新版本，是强制升级还是让用户自主选择等。可考虑的因素很多，包括但不限于地理位置、用户终端特性（如分辨率、性能）、用户自身特点（性别、年龄、忠诚度等）。对于细微修改（如文案、少量控件位置调整）可直接强制升级，对于类似新浪微博改版这样的大型升级，应让用户自主选择，最好能够提供让用户自主回滚至旧版本的渠道。对于客户端应用，可以考虑类似<strong>Chrome</strong>的多<strong>channel</strong>升级策略，让用户自主选择采用<strong>stable</strong>、<strong>beta</strong>、<strong>unstable channel</strong>的版本。在用户有明确预期的情况下自行承担试用风险。</p>
<h2 id="数据反馈"><a href="#数据反馈" class="headerlink" title="数据反馈"></a>数据反馈</h2><p>用户数据反馈：在得到用户允许的前提下，收集用户的使用新版本应用的情况。如客户端性能、客户端稳定性、使用次数、使用频率等。用于与旧版本进行对比，决策后续是继续扩大新版本投放范围还是回滚。服务端数据反馈：新版本服务端性能、服务端稳定性等，作用与用户数据反馈类似。</p>
<h2 id="新版本回滚策略"><a href="#新版本回滚策略" class="headerlink" title="新版本回滚策略"></a>新版本回滚策略</h2><p>当新版本灰度发布表现不佳时，应回滚至旧版本。对于纯粹的<strong>Web</strong>应用而言，回滚相对简单。主要难点在于用户数据的无缝切换。对于客户端应用，如果期待用户自行卸载新版本另行安装旧版本，成本和流失率都太高。可以考虑通过快速另行发布新版本，利用升级来“<span style="border-bottom:1px dashed yellow;">回滚</span>”，覆盖上次灰度发布的修改。对于移动客户端，新版本发布成本较高，需要<strong>Appstore</strong>、<strong>Market</strong>审核。</p>
<h2 id="新版本公关运营支持"><a href="#新版本公关运营支持" class="headerlink" title="新版本公关运营支持"></a>新版本公关运营支持</h2><p>对于改版级别的大型升级，需要配合公关运营支持，用于及时处理用户在微博、博客等渠道给出的“显式反馈”。对比通过隐式数据反馈得到的结论后，综合考虑应对策略。</p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>灰度发布</tag>
      </tags>
  </entry>
  <entry>
    <title>博主的收藏夹</title>
    <url>/web/hoke-favorites.html</url>
    <content><![CDATA[<div class="note success">
            <p>博主的网络收藏夹，站点导航</p>
          </div>
<a id="more"></a>
<h1 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h1><ul>
<li>windows： <span class="exturl" data-url="aHR0cHM6Ly9tc2RuLml0ZWxseW91LmNuLw==" title="https://msdn.itellyou.cn/">https://msdn.itellyou.cn/<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><ul>
<li>超级hash工具： <span class="exturl" data-url="aHR0cHM6Ly9tZDVoYXNoaW5nLm5ldA==" title="https://md5hashing.net">https://md5hashing.net<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h1><ul>
<li>张大妈工资计算器： <span class="exturl" data-url="aHR0cHM6Ly9oaXpkbS5jbg==" title="https://hizdm.cn">https://hizdm.cn<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="白嫖"><a href="#白嫖" class="headerlink" title="白嫖"></a>白嫖</h1><ul>
<li>SMS Receive Free: <span class="exturl" data-url="aHR0cHM6Ly9zbXNyZWNlaXZlZnJlZS5jb20=" title="https://smsreceivefree.com">https://smsreceivefree.com<i class="fa fa-external-link"></i></span></li>
<li>Free ss: <span class="exturl" data-url="aHR0cHM6Ly9mcmVlLXNzLnNpdGU=" title="https://free-ss.site">https://free-ss.site<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="影视"><a href="#影视" class="headerlink" title="影视"></a>影视</h1><ul>
<li>四海影院： <span class="exturl" data-url="aHR0cDovL3d3dy5zaWhhaWthbi5jb20=" title="http://www.sihaikan.com">http://www.sihaikan.com<i class="fa fa-external-link"></i></span></li>
<li>酷绘视频： <span class="exturl" data-url="aHR0cHM6Ly93d3cua3VodWl2LmNvbQ==" title="https://www.kuhuiv.com">https://www.kuhuiv.com<i class="fa fa-external-link"></i></span></li>
<li>电视直播： <span class="exturl" data-url="aHR0cDovL2l2aS5idXB0LmVkdS5jbg==" title="http://ivi.bupt.edu.cn">http://ivi.bupt.edu.cn<i class="fa fa-external-link"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Website</tag>
        <tag>sitemap</tag>
      </tags>
  </entry>
  <entry>
    <title>如何收集DELL M1000E CMC日志</title>
    <url>/systemops/dell-cmc-log.html</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>近日遇到个怪异的case: 刀箱显示刀片1橙色告警，但刀片上检查无异常（该刀片之前网卡异常），录求 DELL 技术支持后，判断为 <strong>CMC</strong> 检查到旧的刀片日志而引起的，清楚日志后，无异常告警。现将判断过程中 <strong>CMC</strong> 日志收集整理成文</p>
<a id="more"></a>

<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="//player.bilibili.com/player.html?aid=94854582&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"></iframe></div>

<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><ol>
<li><p>开启 <strong>CMC</strong> 的 <strong>SSH</strong> 或 <strong>Telnet</strong><br><img src="https://upyun.hoke58.cn/img/%E5%A6%82%E4%BD%95%E6%94%B6%E9%9B%86M1000ECMC%E6%97%A5%E5%BF%97-20200309114328.png" alt="如何收集M1000E CMC日志-20200309114328.png"></p>
</li>
<li><p><strong>SSH</strong> 客户端登录 <strong>CMC</strong> 输入如下命令</p>
</li>
<li><p><code>getversion -b</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ getversion -b</span><br><span class="line">&lt;Server&gt;    &lt;BIOS Version&gt;         &lt;Blade Type&gt;</span><br><span class="line">server-1    1.4.5                  PowerEdge M630 </span><br><span class="line">server-2    1.4.5                  PowerEdge M630 </span><br><span class="line">server-3    1.4.5                  PowerEdge M630 </span><br><span class="line">server-4    1.4.5                  PowerEdge M630 </span><br><span class="line">server-5    1.4.5                  PowerEdge M630 </span><br><span class="line">server-6    1.4.5                  PowerEdge M630 </span><br><span class="line">server-7    1.4.5                  PowerEdge M630 </span><br><span class="line">server-8    2.4.2                  PowerEdge M630 </span><br><span class="line">server-9    1.4.5                  PowerEdge M630 </span><br><span class="line">server-10   1.4.5                  PowerEdge M630 </span><br><span class="line">server-11   2.1.7                  PowerEdge M630 </span><br><span class="line">server-12   2.1.7                  PowerEdge M630 </span><br><span class="line">server-13   2.1.7                  PowerEdge M630 </span><br><span class="line">server-14   2.2.5                  PowerEdge M630 </span><br><span class="line">server-15   2.2.5                  PowerEdge M630 </span><br><span class="line">server-16   2.2.5                  PowerEdge M630 </span><br><span class="line"></span><br><span class="line">&lt;Switch&gt;   &lt;Model Name&gt;                       &lt;HW Version&gt;     &lt;FW Version&gt;   </span><br><span class="line">switch-1    MXL 10/40GbE                       A06              9.5(0.1)       </span><br><span class="line">switch-2    MXL 10/40GbE                       A06              9.5(0.1)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>getversion -l</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ getversion -l</span><br><span class="line">&lt;Server&gt;   &lt;Component&gt;                                                   &lt;Version&gt;                  &lt;Install Date&gt;</span><br><span class="line">server-1   iDRAC                                                         2.21.21.21                 NA        </span><br><span class="line">           iDRAC                                                         2.40.40.40                 2019-10-12</span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                7.12.19                    Rollback  </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   Reinstall </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   2019-10-12</span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                7.12.19                    Rollback  </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   Reinstall </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   2019-10-12</span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                7.12.19                    Rollback  </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   Reinstall </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   2019-10-12</span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                7.12.19                    Rollback  </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   Reinstall </span><br><span class="line">           NIC-QLogic 577xx/578xx 10 Gb Ethernet BCM57840                15.00.14                   2019-10-12</span><br><span class="line">           BIOS                                                          1.4.5                      Reinstall </span><br><span class="line">           BIOS                                                          1.4.5                      Reinstall </span><br><span class="line">           BIOS                                                          1.4.5                      2016-01-16</span><br><span class="line">           RAID-PERC H330 Mini                                           25.3.0.0016                Reinstall </span><br><span class="line">           RAID-PERC H330 Mini                                           25.3.0.0016                2016-01-16</span><br><span class="line">           Disk 0 <span class="keyword">in</span> Backplane 1 of Integrated RAID Controller 1         TT31                       2019-10-12</span><br><span class="line">           Disk 1 <span class="keyword">in</span> Backplane 1 of Integrated RAID Controller 1         TT31                       2019-10-12</span><br><span class="line">           BP13G+ 0:1                                                    2.23                       Reinstall </span><br><span class="line">           BP13G+ 0:1                                                    2.23                       Reinstall </span><br><span class="line">           BP13G+ 0:1                                                    2.23                       2019-10-12</span><br><span class="line">           USC                                                           2.40.40.40                 2019-10-12</span><br><span class="line">           Diagnostics                                                   4239A27                    2016-01-16</span><br><span class="line">           OS Drivers                                                    15.10.02                   2016-01-16</span><br><span class="line">           OS COLLECTOR 1.1                                              OSC_1.1                    2016-01-16</span><br><span class="line">           System CPLD                                                   1.0.5                      2016-01-16</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>racdump</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ racdump</span><br><span class="line">===============================================================================</span><br><span class="line"> General System/RAC Information</span><br><span class="line">===============================================================================</span><br><span class="line">CMC Information:</span><br><span class="line">CMC Date/Time             = Fri Mar 06 2020 16:22</span><br><span class="line">Primary CMC Location      = CMC-1</span><br><span class="line">Primary CMC Version       = 5.00</span><br><span class="line">Standby CMC Version       = N/A</span><br><span class="line">Last Firmware Update      = N/A</span><br><span class="line">Hardware Version          = A09</span><br><span class="line"></span><br><span class="line">CMC Network Information:</span><br><span class="line">NIC Enabled               = 1</span><br><span class="line">MAC Address               = 44:A8:42:21:17:90</span><br><span class="line">Register DNS CMC Name     = 0</span><br><span class="line">DNS CMC Name              = cmc-2YW6C52</span><br><span class="line">Current DNS Domain        = </span><br><span class="line">VLAN ID                   = 1</span><br><span class="line">VLAN Priority             = 0</span><br><span class="line">VLAN Enabled              = 0</span><br><span class="line"></span><br><span class="line">CMC IPv4 Information:</span><br><span class="line">IPv4 Enabled              = 1</span><br><span class="line">Current IP Address        = 10.10.100.3</span><br><span class="line">Current IP Gateway        = 10.10.100.254</span><br><span class="line">Current IP Netmask        = 255.255.255.0</span><br><span class="line">DHCP Enabled              = 0</span><br><span class="line">Current DNS Server 1      = 0.0.0.0</span><br><span class="line">Current DNS Server 2      = 0.0.0.0</span><br><span class="line">DNS Servers from DHCP     = 1</span><br><span class="line"></span><br><span class="line">CMC IPv6 Information:</span><br><span class="line">IPv6 Enabled              = 0</span><br><span class="line">Autoconfiguration Enabled = 1</span><br><span class="line">Link Local Address        = ::</span><br><span class="line">Current IPv6 Address 1    = ::</span><br><span class="line">Current IPv6 Gateway      = ::</span><br><span class="line">Current IPv6 DNS Server 1 = ::</span><br><span class="line">Current IPv6 DNS Server 2 = ::</span><br><span class="line">DNS Servers from DHCPv6   = 1</span><br><span class="line"></span><br><span class="line">Chassis Information:</span><br><span class="line">System Model              = PowerEdge M1000e</span><br><span class="line">System AssetTag           = 00000</span><br><span class="line">Service Tag               = 2YW6C52</span><br><span class="line">Chassis Name              = CMC-2YW6C52</span><br><span class="line">Chassis Location          = [UNDEFINED]</span><br><span class="line">Chassis Midplane Version  = 1.1</span><br><span class="line">Power Status              = ON</span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Session Information</span><br><span class="line">===============================================================================</span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Sensor Information</span><br><span class="line">===============================================================================</span><br><span class="line"></span><br><span class="line">&lt;senType&gt;       &lt;Num&gt;           &lt;sensorName&gt;    &lt;status&gt;        &lt;reading&gt;       &lt;units&gt;         &lt;LC&gt;            &lt;UC&gt;            </span><br><span class="line">FanSpeed        1               Fan-1           OK              5413            rpm             3251            10390           </span><br><span class="line">FanSpeed        2               Fan-2           OK              5421            rpm             3251            10390           </span><br><span class="line">FanSpeed        3               Fan-3           OK              5390            rpm             3251            10390           </span><br><span class="line">FanSpeed        4               Fan-4           OK              5400            rpm             3251            10390           </span><br><span class="line">FanSpeed        5               Fan-5           OK              5410            rpm             3251            10390           </span><br><span class="line">FanSpeed        6               Fan-6           OK              5402            rpm             3251            10390           </span><br><span class="line">FanSpeed        7               Fan-7           OK              5393            rpm             3251            10390           </span><br><span class="line">FanSpeed        8               Fan-8           OK              5385            rpm             3251            10390           </span><br><span class="line">FanSpeed        9               Fan-9           OK              5403            rpm             3251            10390           </span><br><span class="line"></span><br><span class="line">&lt;senType&gt;       &lt;Num&gt;           &lt;sensorName&gt;    &lt;status&gt;        &lt;reading&gt;       &lt;units&gt;         &lt;LC&gt;            &lt;UC&gt;            </span><br><span class="line">Temp            1               Ambient_Temp    OK              19              Celsius         N/A             40              </span><br><span class="line"></span><br><span class="line">&lt;senType&gt;       &lt;Num&gt;           &lt;sensorName&gt;    &lt;status&gt;        &lt;health&gt;        </span><br><span class="line">PWR             1               PS-1            Online          OK              </span><br><span class="line">PWR             2               PS-2            Online          OK              </span><br><span class="line">PWR             3               PS-3            Online          OK              </span><br><span class="line">PWR             4               PS-4            Online          OK              </span><br><span class="line">PWR             5               PS-5            Online          OK              </span><br><span class="line">PWR             6               PS-6            Online          OK              </span><br><span class="line"></span><br><span class="line">&lt;senType&gt;       &lt;Num&gt;           &lt;sensorName&gt;    &lt;status&gt;        </span><br><span class="line">Cable           1               IO-Cable        OK              </span><br><span class="line">Cable           2               FPC-Cable       OK              </span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Switches Information</span><br><span class="line">===============================================================================</span><br><span class="line">&lt;IO&gt;      &lt;Name&gt;                         &lt;Type&gt;             &lt;Presence&gt;   &lt;POST&gt;       &lt;Power&gt;     &lt;Role&gt;  </span><br><span class="line">Switch-1  MXL 10/40GbE                   10 GbE KR          Present      OK           ON          Master  </span><br><span class="line">Switch-2  MXL 10/40GbE                   10 GbE KR          Present      OK           ON          Master  </span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Daughter Card Information</span><br><span class="line">===============================================================================</span><br><span class="line">Group A I/O Type : 10 GbE KR</span><br><span class="line">Group B I/O Type : None</span><br><span class="line">Group C I/O Type : None</span><br><span class="line"></span><br><span class="line">&lt;IO<span class="comment">#&gt;      &lt;Type&gt;                  &lt;State&gt;     &lt;Role&gt;      </span></span><br><span class="line">switch-1   10 GbE KR               OK          Master      </span><br><span class="line">switch-2   10 GbE KR               OK          Master      </span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> All Modules Information</span><br><span class="line">===============================================================================</span><br><span class="line">&lt;module&gt;        &lt;presence&gt;      &lt;pwrState&gt;      &lt;health&gt;        &lt;svcTag&gt;        &lt;nodeId&gt;        </span><br><span class="line">Chassis         Present         ON              OK              2YW6C52         N/A             </span><br><span class="line">Fan-1           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-2           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-3           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-4           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-5           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-6           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-7           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-8           Present         ON              OK              N/A             N/A             </span><br><span class="line">Fan-9           Present         ON              OK              N/A             N/A             </span><br><span class="line">PS-1            Present         Online          OK              N/A             N/A             </span><br><span class="line">PS-2            Present         Online          OK              N/A             N/A             </span><br><span class="line">PS-3            Present         Online          OK              N/A             N/A             </span><br><span class="line">PS-4            Present         Online          OK              N/A             N/A             </span><br><span class="line">PS-5            Present         Online          OK              N/A             N/A             </span><br><span class="line">PS-6            Present         Online          OK              N/A             N/A             </span><br><span class="line">CMC-1           Present         Primary         OK              N/A             N/A             </span><br><span class="line">CMC-2           Not Present     N/A             N/A             N/A             N/A             </span><br><span class="line">Switch-1        Present         ON              OK              8PRYX42         N/A             </span><br><span class="line">Switch-2        Present         ON              OK              FSRYX42         N/A             </span><br><span class="line">Switch-3        Not Present     N/A             N/A             N/A             N/A             </span><br><span class="line">Switch-4        Not Present     N/A             N/A             N/A             N/A             </span><br><span class="line">Switch-5        Not Present     N/A             N/A             N/A             N/A             </span><br><span class="line">Switch-6        Not Present     N/A             N/A             N/A             N/A             </span><br><span class="line">Server-1        Present         ON              OK              74NKT92         74NKT92         </span><br><span class="line">Server-2        Present         ON              OK              74QBT92         74QBT92         </span><br><span class="line">Server-3        Present         ON              OK              74QGT92         74QGT92         </span><br><span class="line">Server-4        Present         ON              OK              74PFT92         74PFT92         </span><br><span class="line">Server-5        Present         ON              OK              74R9T92         74R9T92         </span><br><span class="line">Server-6        Present         ON              OK              74SBT92         74SBT92         </span><br><span class="line">Server-7        Present         ON              OK              74NBT92         74NBT92         </span><br><span class="line">Server-8        Present         ON              OK              74PCT92         74PCT92         </span><br><span class="line">Server-9        Present         ON              OK              74RGT92         74RGT92         </span><br><span class="line">Server-10       Present         ON              OK              74PHT92         74PHT92         </span><br><span class="line">Server-11       Present         ON              OK              46R5DF2         46R5DF2         </span><br><span class="line">Server-12       Present         ON              OK              46N5DF2         46N5DF2         </span><br><span class="line">Server-13       Present         ON              OK              46Q6DF2         46Q6DF2         </span><br><span class="line">Server-14       Present         ON              OK              DJYRRG2         DJYRRG2         </span><br><span class="line">Server-15       Present         ON              OK              DJZVRG2         DJZVRG2         </span><br><span class="line">Server-16       Present         ON              OK              DK1RRG2         DK1RRG2         </span><br><span class="line">KVM             Present         ON              OK              N/A             N/A             </span><br><span class="line">IO-Cable        Present         ON              OK              2YW6C52         N/A             </span><br><span class="line">FPC-Cable       Present         ON              OK              2YW6C52         N/A             </span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Power Budget Information</span><br><span class="line">===============================================================================</span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> KVM Information</span><br><span class="line">===============================================================================</span><br><span class="line">&lt;module&gt;              &lt;presence&gt;            &lt;model&gt;               &lt;FW Version&gt;          &lt;status&gt;              </span><br><span class="line">KVM                   Present               Avocent iKVM Switch   01.00.01.01           Ready                 </span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Nic Information</span><br><span class="line">===============================================================================</span><br><span class="line">NIC Enabled               = 1</span><br><span class="line">IPv4 Enabled              = 1</span><br><span class="line">DHCP Enabled              = 0</span><br><span class="line">Static IP Address         = 10.10.100.3</span><br><span class="line">Static Subnet Mask        = 255.255.255.0</span><br><span class="line">Static Gateway            = 10.10.100.254</span><br><span class="line">Current IP Address        = 10.10.100.3</span><br><span class="line">Current Subnet Mask       = 255.255.255.0</span><br><span class="line">Current Gateway           = 10.10.100.254</span><br><span class="line">IPv6 Enabled              = 0</span><br><span class="line">Autoconfiguration Enabled = 1</span><br><span class="line">Static IPv6 Address       = ::/64</span><br><span class="line">Static IPv6 Gateway       = ::</span><br><span class="line">Link Local Address        = ::</span><br><span class="line">Current IPv6 Address 1    = ::</span><br><span class="line">Current IPv6 Gateway      = ::</span><br><span class="line">Speed                     = Autonegotiate</span><br><span class="line">Duplex                    = Autonegotiate</span><br><span class="line">Redundant mode            = 0</span><br><span class="line">VLAN Enable               = 0</span><br><span class="line">VLAN ID                   = 1</span><br><span class="line">VLAN priority             = 0</span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Redundancy Information</span><br><span class="line">===============================================================================</span><br><span class="line"> Non-Redundant</span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Tracelog Information</span><br><span class="line">===============================================================================</span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> Raclog Information</span><br><span class="line">===============================================================================</span><br><span class="line"></span><br><span class="line">===============================================================================</span><br><span class="line"> sel Information</span><br><span class="line">===============================================================================</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>dumplogs</code><br>该命令会自动执行以下命令</p>
</li>
</ol>
<ul>
<li>date</li>
<li>uptime</li>
<li>racadm getversion -v</li>
<li>racadm getversion -b</li>
<li>racadm getversion -c</li>
<li>racadm getsysinfo</li>
<li>racadm getssninfo</li>
<li>racadm getmodinfo</li>
<li>df -h</li>
<li>ls -alt /tmp</li>
<li>ls -alt /var/</li>
<li>ls -alt /var/log/</li>
<li>ls -alt /var/log/mms</li>
<li>ls -alt /graphics</li>
<li>ps</li>
<li>cat /proc/mtd</li>
<li>cat /proc/meminfo</li>
<li>uname -a</li>
<li>cat /etc/buildlog.txt</li>
<li>cat /tmp/d5netd.enable</li>
<li>cat /tmp/d5netd.name</li>
<li>cat /tmp/d5netd.port</li>
<li>cat /tmp/d5netd.start</li>
<li>cat /tmp/d5netd.dns_setup</li>
<li>cat /tmp/slot.start</li>
<li>cat /tmp/snmpd.start</li>
<li>cat /tmp/snmpd.restart</li>
<li>cat /tmp/httpd.dnsmod</li>
<li>cat /tmp/sfcbd.start</li>
<li>cat /tmp/net.conf</li>
<li>cat /tmp/slot.conf</li>
<li>cat /tmp/daemon.conf</li>
<li>cat /tmp/resolv.conf</li>
<li>cat /tmp/serial.conf</li>
<li>netstat -lnp</li>
<li>netstat -np -A inet</li>
<li>cmccmcli -G CHASSIS_POWER</li>
<li>dmesg</li>
<li>mcmtest -l</li>
<li>cat /tmp/mcmd.log</li>
<li>cat /var/log/fupmuxd.log</li>
<li>cat /var/log/slamd.log</li>
<li>nvxcli -s</li>
<li>racadm feature -s</li>
<li>racadm featurecard -s</li>
<li>fcmgr -pv2</li>
<li>cmccmcli -G SDCARD</li>
<li>cmccmcli -G WWN_</li>
<li>peerdtest -d d 2</li>
<li>racadm gettracelog</li>
<li>cat /var/log/racbootlog</li>
<li>powertest -s</li>
<li>powertest -a</li>
<li>powertest -G</li>
<li>powertest -M</li>
<li>powertest -n</li>
<li>cmc-test -s</li>
<li>cmc-test -b</li>
<li>powertest -ax</li>
<li>powertest -T</li>
<li>epp -s</li>
<li>uutil reg –dump fpga</li>
<li>cat /tmp/dupfwup.log</li>
<li>racadm getfanreqinfo</li>
<li>iomtest 1</li>
<li>iomtest 2</li>
<li>iomtest 3</li>
<li>iomtest 4</li>
<li>iomtest 5</li>
<li>iomtest 6</li>
<li>ls -alt /var/lm</li>
<li>ls -alt /var/eeprom/lm</li>
<li>cat /var/log/lm.log</li>
<li>racadm getdcinfo</li>
<li>racadm getdcinfo -n</li>
<li>racadm getioinfo</li>
<li>racadm getmacaddress -a</li>
<li>racadm getmacaddress -c all</li>
<li>racadm getflexaddr</li>
<li>racadm getpminfo</li>
<li>racadm getpbinfo</li>
<li>racadm chassislog view -n all</li>
<li>racadm getsel</li>
<li>bmdtest -m</li>
<li>systemctl status populate-keys-and-certs</li>
<li>/usr/sbin/failoverlogs -p</li>
<li>local log archive - README</li>
<li>local log archive - messages/messages</li>
<li>local log archive - fwupd/ps.output</li>
<li>local log archive - fwupd/getmem.output</li>
<li>local log archive - fwupd/files.output</li>
<li>local log archive - fwupd/df.output</li>
<li>local log archive - fwupd/free.output</li>
<li>local log archive - fwupd/date.output</li>
<li>local log archive - fwupd/cmdline.output</li>
<li>local log archive - fwupd/mtd.output</li>
<li>local log archive - fwupd/meminfo.output</li>
<li>local log archive - fwupd/uname.output</li>
<li>local log archive - fwupd/ethtool_eth0.output</li>
<li>local log archive - fwupd/ethtool_eth1.output</li>
<li>local log archive - fwupd/ethtool_eth2.output</li>
<li>local log archive - fwupd/fdisk.output</li>
<li>local log archive - fwupd/netstat.output</li>
<li>local log archive - fwupd/dmesg.output</li>
<li>local log archive - var/volatile/log/peerd.log</li>
<li>local log archive - var/volatile/log/mond.log</li>
<li>local log archive - var/volatile/log/d5netd.log</li>
<li>local log archive - var/volatile/log/nvextd.log</li>
</ul>
]]></content>
      <categories>
        <category>系统运维</category>
      </categories>
      <tags>
        <tag>DELL</tag>
        <tag>CMC</tag>
      </tags>
  </entry>
  <entry>
    <title>Hyperledger Fabric 升级路线</title>
    <url>/blockchain/hyperledger-fabric-upgrade.html</url>
    <content><![CDATA[<p><img src="https://upyun.hoke58.cn/img/CHFA-hyperledger-fabric.png" alt="CHFA-hyperledger-fabric.png"></p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>hyperledger fabric v1.x 升级至 v2.x</p>
<a id="more"></a>
<h1 id="风险"><a href="#风险" class="headerlink" title="风险"></a>风险</h1><ol>
<li>版本跨度较大，升级步骤及组件多而杂</li>
<li>技术特性发生重大变化，从而带来系统架构变化（是否需要重新评估架构）</li>
<li>升级是单向的，一旦服务启用则无法降级，仅允许回退至备份时间点，意味着新版本启用后的数据将丢失。</li>
<li>2.x 版本于 2020 年 1 月 30 日发布，缺少经过验证的案例</li>
<li>2.x 版本对于 Java 应用改造量尚未评估</li>
<li>2.x 版本对于国密改造量尚未评估</li>
</ol>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><div class="note info">
            <p>分三个阶段实施，每个阶段依次滚动升级节点（每次升级一个节点）</p>
          </div>

<ol>
<li><strong>阶段一：</strong> v1.x to v1.4.2(kafka)</li>
<li><strong>阶段二：</strong> v1.4.2(kafka) to v1.4.2(raft)</li>
<li><strong>阶段三：</strong> v1.4.2(raft) to v2.x</li>
</ol>
<h2 id="阶段一-v1-x-to-v1-4-2-kafka"><a href="#阶段一-v1-x-to-v1-4-2-kafka" class="headerlink" title="阶段一 v1.x to v1.4.2(kafka)"></a>阶段一 v1.x to v1.4.2(kafka)</h2><p>适用任何低于 v1.4 的升级</p>
<p>主要过程如下：</p>
<ol>
<li>依次停止 SDK, peer, orderer, kafka, zookeeper</li>
<li>备份 MSP, artifacts 文件及 zookeeper, kafka, orderer, peer 的持久化数据</li>
<li>kafka 集群升级</li>
<li>Orderer 升级</li>
<li>Peer 升级</li>
<li>capability 更新</li>
<li>chaincode 升级</li>
<li>SDK 升级</li>
</ol>
<h2 id="阶段二-v1-4-2-kafka-to-v1-4-2-raft"><a href="#阶段二-v1-4-2-kafka-to-v1-4-2-raft" class="headerlink" title="阶段二 v1.4.2(kafka) to v1.4.2(raft)"></a>阶段二 v1.4.2(kafka) to v1.4.2(raft)</h2><p>主要过程如下：</p>
<ol>
<li>备份 zookeeper, kafka, orderer, peer 的持久化数据</li>
<li>备份应用版本及配置文件</li>
<li>动态增加 Orderer 节点（生产环境建议 5 或 7 个节点）</li>
<li>备份文件及持久化数据</li>
<li>更新通道配置 <code>ConsensusType.State</code> 打开维护模式</li>
<li>更新通道配置 <code>ConsensusType.type</code> 切换至 raft</li>
<li>依次停止 orderer, kafka, zookeeper 后，仅重启 orderer</li>
<li>切出维护模式</li>
</ol>
<h2 id="阶段三-v1-4-2-raft-to-v2-x"><a href="#阶段三-v1-4-2-raft-to-v2-x" class="headerlink" title="阶段三 v1.4.2(raft) to v2.x"></a>阶段三 v1.4.2(raft) to v2.x</h2><p>主要过程如下：</p>
<ol>
<li>备份 orderer, peer 的持久化数据</li>
<li>备份应用版本及配置文件</li>
<li>Orderer 升级</li>
<li>Peer 升级</li>
<li>capability 更新</li>
<li>chaincode 升级</li>
<li>SDK 升级</li>
</ol>
]]></content>
      <categories>
        <category>区块链</category>
      </categories>
      <tags>
        <tag>fabric</tag>
        <tag>Hyperledger</tag>
      </tags>
  </entry>
  <entry>
    <title>Hyperledger Fabric 扫盲之 Service Discovery CLI</title>
    <url>/blockchain/hyperledger-fabric-discover.html</url>
    <content><![CDATA[<p><img src="https://upyun.hoke58.cn/img/CHFA-hyperledger-fabric.png" alt="CHFA-hyperledger-fabric.png"></p>
<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>the usage of the command is shown below:</p>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">usage: discover [&lt;flags&gt;] &lt;<span class="built_in">command</span>&gt; [&lt;args&gt; ...]</span><br><span class="line"></span><br><span class="line">Command line client <span class="keyword">for</span> fabric discovery service</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  --<span class="built_in">help</span>                   Show context-sensitive <span class="built_in">help</span> (also try --<span class="built_in">help</span>-long and --<span class="built_in">help</span>-man).</span><br><span class="line">  --configFile=CONFIGFILE  Specifies the config file to load the configuration from</span><br><span class="line">  --peerTLSCA=PEERTLSCA    Sets the TLS CA certificate file path that verifies the TLS peer<span class="string">'s certificate</span></span><br><span class="line"><span class="string">  --tlsCert=TLSCERT        (Optional) Sets the client TLS certificate file path that is used when the peer enforces client authentication</span></span><br><span class="line"><span class="string">  --tlsKey=TLSKEY          (Optional) Sets the client TLS key file path that is used when the peer enforces client authentication</span></span><br><span class="line"><span class="string">  --userKey=USERKEY        Sets the user'</span>s key file path that is used to sign messages sent to the peer</span><br><span class="line">  --userCert=USERCERT      Sets the user<span class="string">'s certificate file path that is used to authenticate the messages sent to the peer</span></span><br><span class="line"><span class="string">  --MSP=MSP                Sets the MSP ID of the user, which represents the CA(s) that issued its user certificate</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Commands:</span></span><br><span class="line"><span class="string">  help [&lt;command&gt;...]</span></span><br><span class="line"><span class="string">    Show help.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  peers [&lt;flags&gt;]</span></span><br><span class="line"><span class="string">    Discover peers</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  config [&lt;flags&gt;]</span></span><br><span class="line"><span class="string">    Discover channel config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  endorsers [&lt;flags&gt;]</span></span><br><span class="line"><span class="string">    Discover chaincode endorsers</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  saveConfig</span></span><br><span class="line"><span class="string">    Save the config passed by flags into the file specified by --configFile</span></span><br></pre></td></tr></table></figure>

<h2 id="Configuring-external-endpoints"><a href="#Configuring-external-endpoints" class="headerlink" title="Configuring external endpoints"></a>Configuring external endpoints</h2><p>Currently, to see peers in service discovery they need to have <code>EXTERNAL_ENDPOINT</code> to be configured for them. Otherwise, <strong>Fabric assumes the peer should not be disclosed</strong>.</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:8051</span></span><br></pre></td></tr></table></figure>

<h1 id="Persisting-configuration"><a href="#Persisting-configuration" class="headerlink" title="Persisting configuration"></a>Persisting configuration</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">/opt/bin/discover --configFile discoverconfig.yaml --peerTLSCA peerOrganizations/org1.example.com/users/User1\@org1.example.com/tls/ca.crt --userKey peerOrganizations/org1.example.com/users/User1\@org1.example.com/msp/keystore/b2899b9d6443b062d736fdf4b5fa73db0ca9ffc0aaf45c9dac9049b345ab436c_sk --userCert peerOrganizations/org1.example.com/users/User1\@org1.example.com/msp/signcerts/User1\@org1.example.com-cert.pem --MSP Org1MSP saveConfig</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">tlsconfig:</span></span><br><span class="line"><span class="attr">  certpath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  keypath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  peercacertpath:</span> <span class="string">/etc/hyperledger/fabric/crypto-config/peerOrganizations/org1.finblockchain.cn/users/User1@org1.finblockchain.cn/tls/ca.crt</span></span><br><span class="line"><span class="attr">  timeout:</span> <span class="number">0</span><span class="string">s</span></span><br><span class="line"><span class="attr">signerconfig:</span></span><br><span class="line"><span class="attr">  mspid:</span> <span class="string">Org1MSP</span></span><br><span class="line"><span class="attr">  identitypath:</span> <span class="string">/etc/hyperledger/fabric/crypto-config/peerOrganizations/org1.finblockchain.cn/users/User1@org1.finblockchain.cn/msp/signcerts/User1@org1.finblockchain.cn-cert.pem</span></span><br><span class="line"><span class="attr">  keypath:</span> <span class="string">/etc/hyperledger/fabric/crypto-config/peerOrganizations/org1.finblockchain.cn/users/User1@org1.finblockchain.cn/msp/keystore/3392dfa8ac1e956ca918690f60a460a0e8e6d880b1d9d0a03947fbd8730e9820_sk</span></span><br></pre></td></tr></table></figure>

<h2 id="Peer-membership-query"><a href="#Peer-membership-query" class="headerlink" title="Peer membership query:"></a>Peer membership query:</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@6673a941ffd5:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto<span class="comment"># /opt/bin/discover --configFile discoverconfig.yaml peers --channel mychannel --server peer0.org1.example.com:7051</span></span><br></pre></td></tr></table></figure>
<p>Below is the command output of peers query</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">                <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer0.org1.example.com:7051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICKTCCAc+gAwIBAgIRALDIidAvFqocYnZt5hdAeRMwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjAwMzExMDkxNDAwWhcNMzAwMzA5MDkxNDAw\nWjBqMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzENMAsGA1UECxMEcGVlcjEfMB0GA1UEAxMWcGVlcjAub3Jn\nMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABEqdiEuoEOXy\nwWQrQZcSgnkfT3uCun9BcIvKW0DUnNJDs4PQOV2Iu3NyMUCL78nmAF3Nhag54hZQ\npagAj1TKBC+jTTBLMA4GA1UdDwEB/wQEAwIHgDAMBgNVHRMBAf8EAjAAMCsGA1Ud\nIwQkMCKAIMdNxOMdQqEkx5wxkbcrf3JeXo6acV9gJCHfXJphc/TtMAoGCCqGSM49\nBAMCA0gAMEUCIQCmdmAHNccAdXEDw8C/lV38dBv9G2gAiesRFjbApOLqKwIgFcdB\nQDotyW+eRXxltEaeghx0+yR8ySzxuY8uncpeAgo=\n-----END CERTIFICATE-----\n"</span>,</span><br><span class="line">                <span class="attr">"Chaincodes"</span>: [</span><br><span class="line">                        <span class="string">"mycc"</span>,</span><br><span class="line">                        <span class="string">"vendor"</span></span><br><span class="line">                ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">                <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer1.org1.example.com:8051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQJ0DXZSYmZfm26oFKtBoDdjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMS5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcx\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEnIatOWiCBfbc\nLUr4JlkdctBmZJ41YGca9kbz+CNBJRPx3CjH1pTJADfaojsZfpMWgTdXcaTQF8eR\nYbzIde3fBqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAgx03E4x1CoSTHnDGRtyt/cl5ejppxX2AkId9cmmFz9O0wCgYIKoZIzj0E\nAwIDRwAwRAIgYtxo1gBHQW0dVvn6jc4tOiq3Nyz/aOXFf6VibeCpWKoCIDKYk/92\nbFk/jE3yHeQHKSxOC1eNk0ak2gudrReKVlwJ\n-----END CERTIFICATE-----\n"</span>,</span><br><span class="line">                <span class="attr">"Chaincodes"</span>: [</span><br><span class="line">                        <span class="string">"vendor"</span></span><br><span class="line">                ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">                <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer1.org2.example.com:10051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQEmktqnZ/zc3HJxBZfOanHTAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE8EGkRYAk0/uW\nBHUfxhI0GosdtTCSKaBIQxPWn4so7ONZxsf2s6Yst1SjOfiN8aG520oSvdCjtCvT\nPozgvQrnTqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgeDjPXKB3pohEI5nhdMtBEZDCEJBfGpQfiROlOBl0TngCIFX4D6E0\nphnDqHSRVPAI6Xt+mkJvDOq/P5qMIfy0rRns\n-----END CERTIFICATE-----\n"</span>,</span><br><span class="line">                <span class="attr">"Chaincodes"</span>: [</span><br><span class="line">                        <span class="string">"mycc"</span>,</span><br><span class="line">                        <span class="string">"vendor"</span></span><br><span class="line">                ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">                <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer0.org2.example.com:9051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQV9z6OE+mj/L1ez8wq6gcvjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMC5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEs3Zh2dODw9Ii\n731lgxDfzKDlfam9dhRHeK6eKTJxwM6C516apuBSqbdPFu9Gr1exM/UgNb79z1xS\nKTGwfc4wwqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgfC9075LAovdOm4mvUvZlUTQvZFiY362fBeIn8fGwjG0CID+Zb6Fn\n4hJkQyo3lHSy6tkH8yaXYGSffrYjG1AovwGt\n-----END CERTIFICATE-----\n"</span>,</span><br><span class="line">                <span class="attr">"Chaincodes"</span>: [</span><br><span class="line">                        <span class="string">"mycc"</span>,</span><br><span class="line">                        <span class="string">"vendor"</span></span><br><span class="line">                ]</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>The <code>Identity</code> that is returned is the enrollment certificate of the peer, and it can be parsed with a combination of <code>jq</code> and <code>openssl</code>:</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="symbol">root@</span><span class="number">6673</span>a941ffd5:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto# discover --configFile discoverconfig.yaml peers --channel mychannel  --server peer0.org1.example.com:<span class="number">7051</span>  | jq .[<span class="number">0</span>].Identity | sed <span class="string">"s/\\\n/\n/g"</span> | sed <span class="string">"s/\"//g"</span>  | openssl x509 -text -noout</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: <span class="number">3</span> (<span class="number">0x2</span>)</span><br><span class="line">        Serial Number:</span><br><span class="line">            <span class="number">27</span>:<span class="number">40</span>:d7:<span class="number">65</span>:<span class="number">26</span>:<span class="number">26</span>:<span class="number">65</span>:f9:b6:ea:<span class="number">81</span>:<span class="number">4</span>a:b4:<span class="number">1</span>a:<span class="number">03</span>:<span class="number">76</span></span><br><span class="line">    Signature Algorithm: ecdsa-with-SHA256</span><br><span class="line">        Issuer: C=US, ST=California, L=San Francisco, O=org1.example.com, CN=ca.org1.example.com</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Mar <span class="number">11</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">00</span> <span class="number">2020</span> GMT</span><br><span class="line">            Not After : Mar  <span class="number">9</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">00</span> <span class="number">2030</span> GMT</span><br><span class="line">        Subject: C=US, ST=California, L=San Francisco, OU=peer, CN=peer1.org1.example.com</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: id-ecPublicKey</span><br><span class="line">                Public-Key: (<span class="number">256</span> bit)</span><br><span class="line">                pub: </span><br><span class="line">                    <span class="number">04</span>:<span class="number">9</span>c:<span class="number">86</span>:ad:<span class="number">39</span>:<span class="number">68</span>:<span class="number">82</span>:<span class="number">05</span>:f6:dc:<span class="number">2</span>d:<span class="number">4</span>a:f8:<span class="number">26</span>:<span class="number">59</span>:</span><br><span class="line">                    <span class="number">1</span>d:<span class="number">72</span>:d0:<span class="number">66</span>:<span class="number">64</span>:<span class="number">9</span>e:<span class="number">35</span>:<span class="number">60</span>:<span class="number">67</span>:<span class="number">1</span>a:f6:<span class="number">46</span>:f3:f8:<span class="number">23</span>:</span><br><span class="line">                    <span class="number">41</span>:<span class="number">25</span>:<span class="number">13</span>:f1:dc:<span class="number">28</span>:c7:d6:<span class="number">94</span>:c9:<span class="number">00</span>:<span class="number">37</span>:da:a2:<span class="number">3</span>b:</span><br><span class="line">                    <span class="number">19</span>:<span class="number">7</span>e:<span class="number">93</span>:<span class="number">16</span>:<span class="number">81</span>:<span class="number">37</span>:<span class="number">57</span>:<span class="number">71</span>:a4:d0:<span class="number">17</span>:c7:<span class="number">91</span>:<span class="number">61</span>:bc:</span><br><span class="line">                    c8:<span class="number">75</span>:ed:df:<span class="number">06</span></span><br><span class="line">                ASN1 OID: prime256v1</span><br><span class="line">                NIST CURVE: P<span class="number">-256</span></span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:C7:<span class="number">4</span>D:C4:E3:<span class="number">1</span>D:<span class="number">42</span>:A1:<span class="number">24</span>:C7:<span class="number">9</span>C:<span class="number">31</span>:<span class="number">91</span>:B7:<span class="number">2</span>B:<span class="number">7</span>F:<span class="number">72</span>:<span class="number">5</span>E:<span class="number">5</span>E:<span class="number">8</span>E:<span class="number">9</span>A:<span class="number">71</span>:<span class="number">5</span>F:<span class="number">60</span>:<span class="number">24</span>:<span class="number">21</span>:DF:<span class="number">5</span>C:<span class="number">9</span>A:<span class="number">61</span>:<span class="number">73</span>:F4:ED</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: ecdsa-with-SHA256</span><br><span class="line">         <span class="number">30</span>:<span class="number">44</span>:<span class="number">02</span>:<span class="number">20</span>:<span class="number">62</span>:dc:<span class="number">68</span>:d6:<span class="number">00</span>:<span class="number">47</span>:<span class="number">41</span>:<span class="number">6</span>d:<span class="number">1</span>d:<span class="number">56</span>:f9:fa:<span class="number">8</span>d:ce:</span><br><span class="line">         <span class="number">2</span>d:<span class="number">3</span>a:<span class="number">2</span>a:b7:<span class="number">37</span>:<span class="number">2</span>c:ff:<span class="number">68</span>:e5:c5:<span class="number">7f</span>:a5:<span class="number">62</span>:<span class="number">6</span>d:e0:a9:<span class="number">58</span>:aa:</span><br><span class="line">         <span class="number">02</span>:<span class="number">20</span>:<span class="number">32</span>:<span class="number">98</span>:<span class="number">93</span>:ff:<span class="number">76</span>:<span class="number">6</span>c:<span class="number">59</span>:<span class="number">3f</span>:<span class="number">8</span>c:<span class="number">4</span>d:f2:<span class="number">1</span>d:e4:<span class="number">07</span>:<span class="number">29</span>:<span class="number">2</span>c:</span><br><span class="line">         <span class="number">4</span>e:<span class="number">0</span>b:<span class="number">57</span>:<span class="number">8</span>d:<span class="number">93</span>:<span class="number">46</span>:a4:da:<span class="number">0</span>b:<span class="number">9</span>d:ad:<span class="number">17</span>:<span class="number">8</span>a:<span class="number">56</span>:<span class="number">5</span>c:<span class="number">09</span></span><br></pre></td></tr></table></figure>

<h1 id="Configuration-query"><a href="#Configuration-query" class="headerlink" title="Configuration query"></a>Configuration query</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./discover --configFile config.yaml config --channel channelfft --server peer1.org1.finblockchain.cn:7051</span><br></pre></td></tr></table></figure>
<p>Below is command output of config query</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"msps"</span>: &#123;</span><br><span class="line">		<span class="attr">"Orderer11MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"Orderer11MSP"</span>,</span><br><span class="line">			<span class="attr">"root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNXakNDQWdHZ0F3SUJBZ0lRSGhRM0U4TFY0c25CWWwvQjhYRVcyekFLQmdncWhrak9QUVFEQWpCL01Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWZNQjBHQTFVRUNoTVdiM0prTVRFdVptbHVZbXh2WTJ0amFHRnBiaTVqYmpFaU1DQUdBMVVFCkF4TVpZMkV1YjNKa01URXVabWx1WW14dlkydGphR0ZwYmk1amJqQWVGdzB4TnpFeE1URXdORFV6TVROYUZ3MHkKTnpFeE1Ea3dORFV6TVROYU1IOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJRXdwRFlXeHBabTl5Ym1saApNUll3RkFZRFZRUUhFdzFUWVc0Z1JuSmhibU5wYzJOdk1SOHdIUVlEVlFRS0V4WnZjbVF4TVM1bWFXNWliRzlqCmEyTm9ZV2x1TG1OdU1TSXdJQVlEVlFRREV4bGpZUzV2Y21ReE1TNW1hVzVpYkc5amEyTm9ZV2x1TG1OdU1Ga3cKRXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUUwc0kzaUR0SWRuSWFaL0I2RXZBZEduaWtFQ2NnR2U4aApKM2xtOHhBZVFZcDdJNEJlako2dTVKMTJDcXhjMDNNcDFuc1I4Rm84RnlPSHl4RlhJWVNkZGFOZk1GMHdEZ1lEClZSMFBBUUgvQkFRREFnR21NQThHQTFVZEpRUUlNQVlHQkZVZEpRQXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QXAKQmdOVkhRNEVJZ1FnRllSRkkrUkp0UUJraU12VFVHaldSbFRTTWVnSUl1cGlVeHlUYWN3ZXRzMHdDZ1lJS29aSQp6ajBFQXdJRFJ3QXdSQUlnRWpWaEszditGUGtWem81K1BwbloxY0lDekNTRlZmb1pnbkxNY041VHpSVUNJQ2dxCjhtZ243UlhzWVpuaEtyYml0S1EyODdTNzFJLzA2azU4ak5vVm1FS08KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"admins"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNLekNDQWRLZ0F3SUJBZ0lSQUpTSmVidzFFOC85MS93bVpqOWYyUjB3Q2dZSUtvWkl6ajBFQXdJd2Z6RUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhIekFkQmdOVkJBb1RGbTl5WkRFeExtWnBibUpzYjJOclkyaGhhVzR1WTI0eElqQWdCZ05WCkJBTVRHV05oTG05eVpERXhMbVpwYm1Kc2IyTnJZMmhoYVc0dVkyNHdIaGNOTVRjeE1URXhNRFExTXpFeldoY04KTWpjeE1UQTVNRFExTXpFeldqQmhNUXN3Q1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cApZVEVXTUJRR0ExVUVCeE1OVTJGdUlFWnlZVzVqYVhOamJ6RWxNQ01HQTFVRUF3d2NRV1J0YVc1QWIzSmtNVEV1ClptbHVZbXh2WTJ0amFHRnBiaTVqYmpCWk1CTUdCeXFHU000OUFnRUdDQ3FHU000OUF3RUhBMElBQkg2QkxCa2YKZ1ZXSkhzcFRoS1hjYmJ0OEZJTUsyR2hYZXNNWmw5VHFpVWovRmZiUTdDMlhwVldiWnBXempHUEVZcUN4ZzhIdgphRHdJazdUMGtrQWV3Y3VqVFRCTE1BNEdBMVVkRHdFQi93UUVBd0lIZ0RBTUJnTlZIUk1CQWY4RUFqQUFNQ3NHCkExVWRJd1FrTUNLQUlCV0VSU1BrU2JVQVpJakwwMUJvMWtaVTBqSG9DQ0xxWWxNY2sybk1IcmJOTUFvR0NDcUcKU000OUJBTUNBMGNBTUVRQ0lCUE9lWTJncThDT2cwYkdqdGlWbk9xdnYrQmFyVEc2ZUZoWDNYdmhhTGlQQWlCRQphSzFGN0ZFSVgwbExsd0JNSHdOR1E0S0s2YmtnRGNWQk41ZUJzWjNMekE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"crypto_config"</span>: &#123;</span><br><span class="line">				<span class="attr">"signature_hash_family"</span>: <span class="string">"SHA2"</span>,</span><br><span class="line">				<span class="attr">"identity_identifier_hash_function"</span>: <span class="string">"SHA256"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tls_root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNZekNDQWdxZ0F3SUJBZ0lSQUl2RVBWeGZtR2lGSUpmbitlUWRZL013Q2dZSUtvWkl6ajBFQXdJd2dZSXgKQ3pBSkJnTlZCQVlUQWxWVE1STXdFUVlEVlFRSUV3cERZV3hwWm05eWJtbGhNUll3RkFZRFZRUUhFdzFUWVc0ZwpSbkpoYm1OcGMyTnZNUjh3SFFZRFZRUUtFeFp2Y21ReE1TNW1hVzVpYkc5amEyTm9ZV2x1TG1OdU1TVXdJd1lEClZRUURFeHgwYkhOallTNXZjbVF4TVM1bWFXNWliRzlqYTJOb1lXbHVMbU51TUI0WERURTNNVEV4TVRBME5UTXgKTTFvWERUSTNNVEV3T1RBME5UTXhNMW93Z1lJeEN6QUpCZ05WQkFZVEFsVlRNUk13RVFZRFZRUUlFd3BEWVd4cApabTl5Ym1saE1SWXdGQVlEVlFRSEV3MVRZVzRnUm5KaGJtTnBjMk52TVI4d0hRWURWUVFLRXhadmNtUXhNUzVtCmFXNWliRzlqYTJOb1lXbHVMbU51TVNVd0l3WURWUVFERXh4MGJITmpZUzV2Y21ReE1TNW1hVzVpYkc5amEyTm8KWVdsdUxtTnVNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVPMGxLZW9keUEwVjM0ZjN5WXJuYwp5SFNxc1pIazE1WEhZOTFlMUNBVzJNdGV1VnBpQ0x6anZmeDZXb00wWVp2aWtXeWZrNkdadEtJN1FZUGw5Vk5kCklhTmZNRjB3RGdZRFZSMFBBUUgvQkFRREFnR21NQThHQTFVZEpRUUlNQVlHQkZVZEpRQXdEd1lEVlIwVEFRSC8KQkFVd0F3RUIvekFwQmdOVkhRNEVJZ1FnZk0wOU5LNkVkVzNNU1dNN3pNMndJSitQMHZjQTRaKzVBcVpTc3BJSQpDMjR3Q2dZSUtvWkl6ajBFQXdJRFJ3QXdSQUlnY1AzN1V0OTVvUkJPdVkyOXFHTkl4dHQ3ZmlIZGViWHlLdnVkClBta014QmNDSUJVVWMrdVFHdHBySW4xbjk0NUt1b2JyRDBoN1k2NXc2RUxwNDgwT1Q5L20KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Orderer12MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"Orderer12MSP"</span>,</span><br><span class="line">			<span class="attr">"root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNXekNDQWdHZ0F3SUJBZ0lRSU12OVZwNDRVSDdnV3NHL01lSnByREFLQmdncWhrak9QUVFEQWpCL01Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWZNQjBHQTFVRUNoTVdiM0prTVRJdVptbHVZbXh2WTJ0amFHRnBiaTVqYmpFaU1DQUdBMVVFCkF4TVpZMkV1YjNKa01USXVabWx1WW14dlkydGphR0ZwYmk1amJqQWVGdzB4TnpFeU1EZ3dNalUzTXpaYUZ3MHkKTnpFeU1EWXdNalUzTXpaYU1IOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJRXdwRFlXeHBabTl5Ym1saApNUll3RkFZRFZRUUhFdzFUWVc0Z1JuSmhibU5wYzJOdk1SOHdIUVlEVlFRS0V4WnZjbVF4TWk1bWFXNWliRzlqCmEyTm9ZV2x1TG1OdU1TSXdJQVlEVlFRREV4bGpZUzV2Y21ReE1pNW1hVzVpYkc5amEyTm9ZV2x1TG1OdU1Ga3cKRXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVpMVpLRXR5V29tN3BiM1dJYkRwTy8yMWxHdlFVSVpDUApiRXNiZ2puTkx6YnBmaDdzMm1WVkRjejBicUlYcnVsUnZZMm53VTBERmNBdVlNWHB5ZS9IYjZOZk1GMHdEZ1lEClZSMFBBUUgvQkFRREFnR21NQThHQTFVZEpRUUlNQVlHQkZVZEpRQXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QXAKQmdOVkhRNEVJZ1FnM3MzeCtPS3RSNEtkdjB0T3o4TVlrYzdTSjh3eWdEZEZNQldaL3JqdTJiZ3dDZ1lJS29aSQp6ajBFQXdJRFNBQXdSUUloQU82NUZJN01UV2tqRXdyY2xya0FNczFiakE5VmQxMkNVV0szeGUvYTVMY3lBaUJrCkxwa3Q4S29Pbk04SytXZmNUc0ZoYVoyMmcwVVp2ZEFZZE1SNGFOVVNHZz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"admins"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNMRENDQWRLZ0F3SUJBZ0lSQU9ieGQxY2pGSGhQVjdNalBBM0hncWt3Q2dZSUtvWkl6ajBFQXdJd2Z6RUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhIekFkQmdOVkJBb1RGbTl5WkRFeUxtWnBibUpzYjJOclkyaGhhVzR1WTI0eElqQWdCZ05WCkJBTVRHV05oTG05eVpERXlMbVpwYm1Kc2IyTnJZMmhoYVc0dVkyNHdIaGNOTVRjeE1qQTRNREkxTnpNMldoY04KTWpjeE1qQTJNREkxTnpNMldqQmhNUXN3Q1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cApZVEVXTUJRR0ExVUVCeE1OVTJGdUlFWnlZVzVqYVhOamJ6RWxNQ01HQTFVRUF3d2NRV1J0YVc1QWIzSmtNVEl1ClptbHVZbXh2WTJ0amFHRnBiaTVqYmpCWk1CTUdCeXFHU000OUFnRUdDQ3FHU000OUF3RUhBMElBQlBVRnNYaWUKMjNUeFJGMnJvMU5BclNkalpuRUtQRDBRM05aWHZpQy9DK0x3UmxQZXFNOHdQcVVydjRsZDJ4RzFiVFpKTExQQwo2dUFUekNrc0pLTk14dWVqVFRCTE1BNEdBMVVkRHdFQi93UUVBd0lIZ0RBTUJnTlZIUk1CQWY4RUFqQUFNQ3NHCkExVWRJd1FrTUNLQUlON044ZmppclVlQ25iOUxUcy9ER0pITzBpZk1Nb0EzUlRBVm1mNjQ3dG00TUFvR0NDcUcKU000OUJBTUNBMGdBTUVVQ0lRRCtVSUZnN1l2VUY2NWVldFZsTm5nTnF2Zm1VVWtyczFHMVFkMU9oeUFXUHdJZwpUaG1KYktLOFJIbVYrcStKa3hGc0hRekxldzBHZjZabkJCa2MrYTNTaDhRPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"crypto_config"</span>: &#123;</span><br><span class="line">				<span class="attr">"signature_hash_family"</span>: <span class="string">"SHA2"</span>,</span><br><span class="line">				<span class="attr">"identity_identifier_hash_function"</span>: <span class="string">"SHA256"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tls_root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNZekNDQWdxZ0F3SUJBZ0lSQUp3UmlVeUpvYnFVMHgraGNQd1BKb2t3Q2dZSUtvWkl6ajBFQXdJd2dZSXgKQ3pBSkJnTlZCQVlUQWxWVE1STXdFUVlEVlFRSUV3cERZV3hwWm05eWJtbGhNUll3RkFZRFZRUUhFdzFUWVc0ZwpSbkpoYm1OcGMyTnZNUjh3SFFZRFZRUUtFeFp2Y21ReE1pNW1hVzVpYkc5amEyTm9ZV2x1TG1OdU1TVXdJd1lEClZRUURFeHgwYkhOallTNXZjbVF4TWk1bWFXNWliRzlqYTJOb1lXbHVMbU51TUI0WERURTNNVEl3T0RBeU5UY3oKTmxvWERUSTNNVEl3TmpBeU5UY3pObG93Z1lJeEN6QUpCZ05WQkFZVEFsVlRNUk13RVFZRFZRUUlFd3BEWVd4cApabTl5Ym1saE1SWXdGQVlEVlFRSEV3MVRZVzRnUm5KaGJtTnBjMk52TVI4d0hRWURWUVFLRXhadmNtUXhNaTVtCmFXNWliRzlqYTJOb1lXbHVMbU51TVNVd0l3WURWUVFERXh4MGJITmpZUzV2Y21ReE1pNW1hVzVpYkc5amEyTm8KWVdsdUxtTnVNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVtNFVoVGd2cmdGSFZ5RUhNRDlQUgp0djhuTGU1dS9NZU13WVBHSTZyN08xZHc4Si9STXVSalFPRkVwMEVxcHcweUF2d2pDczJTOG4zdExnMmtnb0tECnBxTmZNRjB3RGdZRFZSMFBBUUgvQkFRREFnR21NQThHQTFVZEpRUUlNQVlHQkZVZEpRQXdEd1lEVlIwVEFRSC8KQkFVd0F3RUIvekFwQmdOVkhRNEVJZ1FnWU80T2E5emoxNWk1T09jMWFsOEl2L3g4TzlYbGhSTmE2N1E5K1ZtcwpmWnN3Q2dZSUtvWkl6ajBFQXdJRFJ3QXdSQUlnUkdtMC8rdHNac1BSUmthakJuSHk4cERtR2tNRjBUK2s2Qi9IClRjcFVtZTBDSUV6dTAyTTc2aXZLdHpJZkZXVDB5RzVWbmRpbGZhNEFYQ3E5RFNLV2RzNm8KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Orderer1MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"Orderer1MSP"</span>,</span><br><span class="line">			<span class="attr">"root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNWekNDQWY2Z0F3SUJBZ0lSQUpWOXdQRHgzcWY4YTdFeGlpZytYWUl3Q2dZSUtvWkl6ajBFQXdJd2ZURUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhIakFjQmdOVkJBb1RGVzl5WkRFdVptbHVZbXh2WTJ0amFHRnBiaTVqYmpFaE1COEdBMVVFCkF4TVlZMkV1YjNKa01TNW1hVzVpYkc5amEyTm9ZV2x1TG1OdU1CNFhEVEUzTVRFeE1UQTBOVE14TTFvWERUSTMKTVRFd09UQTBOVE14TTFvd2ZURUxNQWtHQTFVRUJoTUNWVk14RXpBUkJnTlZCQWdUQ2tOaGJHbG1iM0p1YVdFeApGakFVQmdOVkJBY1REVk5oYmlCR2NtRnVZMmx6WTI4eEhqQWNCZ05WQkFvVEZXOXlaREV1Wm1sdVlteHZZMnRqCmFHRnBiaTVqYmpFaE1COEdBMVVFQXhNWVkyRXViM0prTVM1bWFXNWliRzlqYTJOb1lXbHVMbU51TUZrd0V3WUgKS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXdmUngzclpTTEhlaDEvMHpYdEVUYTlsaXJ0dVBiSDdiTnRHKwozd0kyMXhIa2tqSWxGS0t1blVTTWxTV2VpbEp1KzZIdUw2enkzN3g2R3hWQnlvVWlmNk5mTUYwd0RnWURWUjBQCkFRSC9CQVFEQWdHbU1BOEdBMVVkSlFRSU1BWUdCRlVkSlFBd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBcEJnTlYKSFE0RUlnUWdHS3pkNHhsd2cybnh0SHhldFprWkdZRXc1WjN0SmhKQVVEUkxFQmZuK3NJd0NnWUlLb1pJemowRQpBd0lEUndBd1JBSWdMTEFvaVVabXp2bURDb2dxOXBZd0RaSExraU82MnlkY0c1Q0U3ZVFmWkRBQ0lFQk9GQWJ5Cm9jeTNiVTFFRDMyNnhTM1JBSHphMXRpeG5MMUcyYnE4clEzegotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"admins"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNKekNDQWM2Z0F3SUJBZ0lRR3VySXJsOFNtdGxnVXhSV2ZGVG0rREFLQmdncWhrak9QUVFEQWpCOU1Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWVNQndHQTFVRUNoTVZiM0prTVM1bWFXNWliRzlqYTJOb1lXbHVMbU51TVNFd0h3WURWUVFECkV4aGpZUzV2Y21ReExtWnBibUpzYjJOclkyaGhhVzR1WTI0d0hoY05NVGN4TVRFeE1EUTFNekV6V2hjTk1qY3gKTVRBNU1EUTFNekV6V2pCZ01Rc3dDUVlEVlFRR0V3SlZVekVUTUJFR0ExVUVDQk1LUTJGc2FXWnZjbTVwWVRFVwpNQlFHQTFVRUJ4TU5VMkZ1SUVaeVlXNWphWE5qYnpFa01DSUdBMVVFQXd3YlFXUnRhVzVBYjNKa01TNW1hVzVpCmJHOWphMk5vWVdsdUxtTnVNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVRWkh0eXFvRFVrWWMKSVhnY3BzTmdNeFNvWUFvWUFyQlJiWmhyVXdqMlpBQnRwRUtKUHFhVm1PM0hQRGl0S09ic1lud04yNkZqV0ZRQwpHVFlZelgzTXNxTk5NRXN3RGdZRFZSMFBBUUgvQkFRREFnZUFNQXdHQTFVZEV3RUIvd1FDTUFBd0t3WURWUjBqCkJDUXdJb0FnR0t6ZDR4bHdnMm54dEh4ZXRaa1pHWUV3NVozdEpoSkFVRFJMRUJmbitzSXdDZ1lJS29aSXpqMEUKQXdJRFJ3QXdSQUlnVGg5OERZcjAxSloxblB4aHVJaCtnZUpONkg4QzhsditVSEQwSjRzTFRWVUNJRk54N24vSAppZERuMStBUkh4UUFiTnl1dk02M2ZhZjBEMGhBNjNRWW9xMFoKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"crypto_config"</span>: &#123;</span><br><span class="line">				<span class="attr">"signature_hash_family"</span>: <span class="string">"SHA2"</span>,</span><br><span class="line">				<span class="attr">"identity_identifier_hash_function"</span>: <span class="string">"SHA256"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tls_root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNYekNDQWdhZ0F3SUJBZ0lSQUlaTGptS1YzYzlYd2t3UnFXSUpPdEF3Q2dZSUtvWkl6ajBFQXdJd2dZQXgKQ3pBSkJnTlZCQVlUQWxWVE1STXdFUVlEVlFRSUV3cERZV3hwWm05eWJtbGhNUll3RkFZRFZRUUhFdzFUWVc0ZwpSbkpoYm1OcGMyTnZNUjR3SEFZRFZRUUtFeFZ2Y21ReExtWnBibUpzYjJOclkyaGhhVzR1WTI0eEpEQWlCZ05WCkJBTVRHM1JzYzJOaExtOXlaREV1Wm1sdVlteHZZMnRqYUdGcGJpNWpiakFlRncweE56RXhNVEV3TkRVek1UTmEKRncweU56RXhNRGt3TkRVek1UTmFNSUdBTVFzd0NRWURWUVFHRXdKVlV6RVRNQkVHQTFVRUNCTUtRMkZzYVdadgpjbTVwWVRFV01CUUdBMVVFQnhNTlUyRnVJRVp5WVc1amFYTmpiekVlTUJ3R0ExVUVDaE1WYjNKa01TNW1hVzVpCmJHOWphMk5vWVdsdUxtTnVNU1F3SWdZRFZRUURFeHQwYkhOallTNXZjbVF4TG1acGJtSnNiMk5yWTJoaGFXNHUKWTI0d1dUQVRCZ2NxaGtqT1BRSUJCZ2dxaGtqT1BRTUJCd05DQUFSRlVuVkljM1VyNXVkeUZHMDFOR0M4ak9LRQpyL3J1YnJlMFY4TW9Oa0NXc0Z5RTRJSlp0UmsvSXdnUmxOY0E5bU9FbDE4M2ErZkFsdGdyc0ZvM1BoN3RvMTh3ClhUQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBsQkFnd0JnWUVWUjBsQURBUEJnTlZIUk1CQWY4RUJUQUQKQVFIL01Da0dBMVVkRGdRaUJDQ0srbjdtQ2VzQWZSSDJBNVg3R3pXd3VUeEZJTGFla21ZUlpaeVlrc2ZtY2pBSwpCZ2dxaGtqT1BRUURBZ05IQURCRUFpQjYwaVBhMVJvK3NQZlo3MUlJTVJ6bE9xcUFGeXZjQVhydmgwQzZhbEhGCjl3SWdJMmtEUFJ3SEVORVRZYUF5bmlLZnppa005K3l6VmpwUmZSZ2xGWEtNc2cwPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Org11MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"Org11MSP"</span>,</span><br><span class="line">			<span class="attr">"root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNXekNDQWdHZ0F3SUJBZ0lRYXpBeEJpTzc0T2ZpTmlyUzU5YlVvVEFLQmdncWhrak9QUVFEQWpCL01Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWZNQjBHQTFVRUNoTVdiM0puTVRFdVptbHVZbXh2WTJ0amFHRnBiaTVqYmpFaU1DQUdBMVVFCkF4TVpZMkV1YjNKbk1URXVabWx1WW14dlkydGphR0ZwYmk1amJqQWVGdzB4TnpFeE1URXdORFV6TVROYUZ3MHkKTnpFeE1Ea3dORFV6TVROYU1IOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJRXdwRFlXeHBabTl5Ym1saApNUll3RkFZRFZRUUhFdzFUWVc0Z1JuSmhibU5wYzJOdk1SOHdIUVlEVlFRS0V4WnZjbWN4TVM1bWFXNWliRzlqCmEyTm9ZV2x1TG1OdU1TSXdJQVlEVlFRREV4bGpZUzV2Y21jeE1TNW1hVzVpYkc5amEyTm9ZV2x1TG1OdU1Ga3cKRXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVvdDN5WjBLMWJkV1pNcEVTYTZhL3hub2Voc0EzTjliRQo1RmVKbEZIM2pRY0kwZG5vK003aHB6WGJYVE85Q0w0VDlmNHF3S29WUDYxZVY4QTdnb1BsZGFOZk1GMHdEZ1lEClZSMFBBUUgvQkFRREFnR21NQThHQTFVZEpRUUlNQVlHQkZVZEpRQXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QXAKQmdOVkhRNEVJZ1FnL1Z1NE5kVTE1ZzROcCtuYW45aHVXeHZrSVdYcmsxb1dUY2FYVWJ5VklCMHdDZ1lJS29aSQp6ajBFQXdJRFNBQXdSUUloQU1GZElwUXBhNEt0VkFvN3c1SnZoQU9sNWpzWVVlUERDM2FIMzd0WGpqRzRBaUFICldTMmgyeXZxR1hFdW1VdHV2V3ZraVRvQlNMQTlHTjArZ0dtV1RxZk8rUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"admins"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNLekNDQWRHZ0F3SUJBZ0lRR1hxS2xVWVJ2MDZiMGhOcW8rVld0VEFLQmdncWhrak9QUVFEQWpCL01Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWZNQjBHQTFVRUNoTVdiM0puTVRFdVptbHVZbXh2WTJ0amFHRnBiaTVqYmpFaU1DQUdBMVVFCkF4TVpZMkV1YjNKbk1URXVabWx1WW14dlkydGphR0ZwYmk1amJqQWVGdzB4TnpFeE1URXdORFV6TVROYUZ3MHkKTnpFeE1Ea3dORFV6TVROYU1HRXhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJRXdwRFlXeHBabTl5Ym1saApNUll3RkFZRFZRUUhFdzFUWVc0Z1JuSmhibU5wYzJOdk1TVXdJd1lEVlFRRERCeEJaRzFwYmtCdmNtY3hNUzVtCmFXNWliRzlqYTJOb1lXbHVMbU51TUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFUUhwZWcvQU4KMzY5SGZXMFFpQlBZRjhLdGVWUElmTHVraXFVQjNiK0NqVmI0bUhmdjVoZThGc2Z4VGlJaUZwZnRNRE8zN2hoWApRT3l3Y3M2RDRMc1lpS05OTUVzd0RnWURWUjBQQVFIL0JBUURBZ2VBTUF3R0ExVWRFd0VCL3dRQ01BQXdLd1lEClZSMGpCQ1F3SW9BZy9WdTROZFUxNWc0TnArbmFuOWh1V3h2a0lXWHJrMW9XVGNhWFVieVZJQjB3Q2dZSUtvWkkKemowRUF3SURTQUF3UlFJaEFJZVAzK1I5WEFrMC95TFB5WHJUODJkNzZ6eGY1eDNERzY0eWNpREp5UXlTQWlCeAo4YzdzWWpkWkZDSW1lOWRkSFp3bjJYSVFNSVZPejRvODV5c05MVUEyN3c9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"crypto_config"</span>: &#123;</span><br><span class="line">				<span class="attr">"signature_hash_family"</span>: <span class="string">"SHA2"</span>,</span><br><span class="line">				<span class="attr">"identity_identifier_hash_function"</span>: <span class="string">"SHA256"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tls_root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNZakNDQWdtZ0F3SUJBZ0lRRHlYN0NqWFdXaUNIQ3F4U0FRUVlCREFLQmdncWhrak9QUVFEQWpDQmdqRUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhIekFkQmdOVkJBb1RGbTl5WnpFeExtWnBibUpzYjJOclkyaGhhVzR1WTI0eEpUQWpCZ05WCkJBTVRISFJzYzJOaExtOXlaekV4TG1acGJtSnNiMk5yWTJoaGFXNHVZMjR3SGhjTk1UY3hNVEV4TURRMU16RXoKV2hjTk1qY3hNVEE1TURRMU16RXpXakNCZ2pFTE1Ba0dBMVVFQmhNQ1ZWTXhFekFSQmdOVkJBZ1RDa05oYkdsbQpiM0p1YVdFeEZqQVVCZ05WQkFjVERWTmhiaUJHY21GdVkybHpZMjh4SHpBZEJnTlZCQW9URm05eVp6RXhMbVpwCmJtSnNiMk5yWTJoaGFXNHVZMjR4SlRBakJnTlZCQU1USEhSc2MyTmhMbTl5WnpFeExtWnBibUpzYjJOclkyaGgKYVc0dVkyNHdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CQndOQ0FBUi90TTNQQzAyYnVmQ2JvRUdEUUd3OQowdU9ZWUJZcGs0NkdFQnpsbXpmSXVGVEliR01HdjlmOG1hVXRBWTlnZVhVMy9CNkNSZHVmZGlvVzFRUk5vU3QwCm8xOHdYVEFPQmdOVkhROEJBZjhFQkFNQ0FhWXdEd1lEVlIwbEJBZ3dCZ1lFVlIwbEFEQVBCZ05WSFJNQkFmOEUKQlRBREFRSC9NQ2tHQTFVZERnUWlCQ0FDakJsL1NTN1BBQU1hZTBMMWoyb1dMQWtTSzBSR0xheko1UVkrUHVhbQp6REFLQmdncWhrak9QUVFEQWdOSEFEQkVBaUJSZHJYeXVUR2NNd3ZHVkZyQUpnRFI2RCtkMEgzdnkxTFNuYS9ICkRMVXNBUUlnZXNHMzhXYmVKZE1EdU9ONXdYMXhBSG1aMGVnM3kzVnlWMW5KSExrRWR6VT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Org12MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"Org12MSP"</span>,</span><br><span class="line">			<span class="attr">"root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNXekNDQWdHZ0F3SUJBZ0lRUkF5alVaSVM2aU9jZEpVc1lvWWhLekFLQmdncWhrak9QUVFEQWpCL01Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWZNQjBHQTFVRUNoTVdiM0puTVRJdVptbHVZbXh2WTJ0amFHRnBiaTVqYmpFaU1DQUdBMVVFCkF4TVpZMkV1YjNKbk1USXVabWx1WW14dlkydGphR0ZwYmk1amJqQWVGdzB4TnpFeU1EZ3dNalUzTXpaYUZ3MHkKTnpFeU1EWXdNalUzTXpaYU1IOHhDekFKQmdOVkJBWVRBbFZUTVJNd0VRWURWUVFJRXdwRFlXeHBabTl5Ym1saApNUll3RkFZRFZRUUhFdzFUWVc0Z1JuSmhibU5wYzJOdk1SOHdIUVlEVlFRS0V4WnZjbWN4TWk1bWFXNWliRzlqCmEyTm9ZV2x1TG1OdU1TSXdJQVlEVlFRREV4bGpZUzV2Y21jeE1pNW1hVzVpYkc5amEyTm9ZV2x1TG1OdU1Ga3cKRXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVlNHF5K05Bam02TDNLaFpQQkozL085dnpEd0ZGZ0NqZQpEalJnNzB5ZVJCbjBtY1oyUWVxdVRlaHNYckVxZ1EyRlhHTHNEaVI0bmRqNW5vM2JJS0NJTzZOZk1GMHdEZ1lEClZSMFBBUUgvQkFRREFnR21NQThHQTFVZEpRUUlNQVlHQkZVZEpRQXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QXAKQmdOVkhRNEVJZ1Fna29oTmZsSnFxQUJ6MzRISnpUMFlqWkNhUnNKYkFySmI4WDB5Znl2QkRRd3dDZ1lJS29aSQp6ajBFQXdJRFNBQXdSUUloQUpka3R6T1JJVEJVamlkYzBGakF5eVpNRG1xSHVOOWlBTExaUmVUTWJSOERBaUE5CklTNUQ4bXRQd0NoZDNtdmUrUUJScSswdWhRN1RTWVkzTDlVRFFoQlpHdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"admins"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNLekNDQWRLZ0F3SUJBZ0lSQU5JNlFQUldST1lHRjJOVVlVRFdqZE13Q2dZSUtvWkl6ajBFQXdJd2Z6RUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhIekFkQmdOVkJBb1RGbTl5WnpFeUxtWnBibUpzYjJOclkyaGhhVzR1WTI0eElqQWdCZ05WCkJBTVRHV05oTG05eVp6RXlMbVpwYm1Kc2IyTnJZMmhoYVc0dVkyNHdIaGNOTVRjeE1qQTRNREkxTnpNMldoY04KTWpjeE1qQTJNREkxTnpNMldqQmhNUXN3Q1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cApZVEVXTUJRR0ExVUVCeE1OVTJGdUlFWnlZVzVqYVhOamJ6RWxNQ01HQTFVRUF3d2NRV1J0YVc1QWIzSm5NVEl1ClptbHVZbXh2WTJ0amFHRnBiaTVqYmpCWk1CTUdCeXFHU000OUFnRUdDQ3FHU000OUF3RUhBMElBQlBRSzBXYXIKald2RmpHdFFLaWROcHlTdFVCdW5YUzUvRFE1NU8vLzB4cHppdXZoQTFQSS8xNTJzMkduQ3pxYnhSZElyenlQUwo0c2xvbzhZTkFtMlZvRzJqVFRCTE1BNEdBMVVkRHdFQi93UUVBd0lIZ0RBTUJnTlZIUk1CQWY4RUFqQUFNQ3NHCkExVWRJd1FrTUNLQUlKS0lUWDVTYXFnQWM5K0J5YzA5R0kyUW1rYkNXd0t5Vy9GOU1uOHJ3UTBNTUFvR0NDcUcKU000OUJBTUNBMGNBTUVRQ0lIbzZXRHlFbWFmRXNBSjh2bEs5dGY3M2E0WFp0N0VzME01d2x4b1JxeHdHQWlCWAp4dzFOS01XUzUxbUdyeXM2OEhLQ1l2R2M5c3Z1SThoVkhXbHRhWWFxakE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"crypto_config"</span>: &#123;</span><br><span class="line">				<span class="attr">"signature_hash_family"</span>: <span class="string">"SHA2"</span>,</span><br><span class="line">				<span class="attr">"identity_identifier_hash_function"</span>: <span class="string">"SHA256"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tls_root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNZakNDQWdtZ0F3SUJBZ0lRVlFSZ2V6SitValNQTGJ4SWQwZUhNakFLQmdncWhrak9QUVFEQWpDQmdqRUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhIekFkQmdOVkJBb1RGbTl5WnpFeUxtWnBibUpzYjJOclkyaGhhVzR1WTI0eEpUQWpCZ05WCkJBTVRISFJzYzJOaExtOXlaekV5TG1acGJtSnNiMk5yWTJoaGFXNHVZMjR3SGhjTk1UY3hNakE0TURJMU56TTIKV2hjTk1qY3hNakEyTURJMU56TTJXakNCZ2pFTE1Ba0dBMVVFQmhNQ1ZWTXhFekFSQmdOVkJBZ1RDa05oYkdsbQpiM0p1YVdFeEZqQVVCZ05WQkFjVERWTmhiaUJHY21GdVkybHpZMjh4SHpBZEJnTlZCQW9URm05eVp6RXlMbVpwCmJtSnNiMk5yWTJoaGFXNHVZMjR4SlRBakJnTlZCQU1USEhSc2MyTmhMbTl5WnpFeUxtWnBibUpzYjJOclkyaGgKYVc0dVkyNHdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CQndOQ0FBVHd3TlZTVU4rQ2dHWGdhVWxDVmRJRQpZejI1MDhTTE1heDhaczU2RVhEVEMyd3oweEVidTBzN2x5bWc2cUE5OVBtWWE3emwxV1pLbDZIeUpPOHJQQThPCm8xOHdYVEFPQmdOVkhROEJBZjhFQkFNQ0FhWXdEd1lEVlIwbEJBZ3dCZ1lFVlIwbEFEQVBCZ05WSFJNQkFmOEUKQlRBREFRSC9NQ2tHQTFVZERnUWlCQ0RSeFN3TzdnNk1ZUTF3ZWxPa3VKWmR0UlZTUlFuc09pbmFtL3cxT3R3RgptREFLQmdncWhrak9QUVFEQWdOSEFEQkVBaUJSN1g3WnUrTkxSYzdCZmI2ck1yYnNIQWpQangrVkNLKzNLalpRCjRwS3c3QUlnQk1PS3FHUG5FT2FwQVlNM2FuZUl3QW9TWVU5clUxMFpTZ014MTdmTnhyVT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Org1MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">			<span class="attr">"root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNWekNDQWYyZ0F3SUJBZ0lRSFNFM1hnd096YmFPMWtsSFpiYjZ5REFLQmdncWhrak9QUVFEQWpCOU1Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWVNQndHQTFVRUNoTVZiM0puTVM1bWFXNWliRzlqYTJOb1lXbHVMbU51TVNFd0h3WURWUVFECkV4aGpZUzV2Y21jeExtWnBibUpzYjJOclkyaGhhVzR1WTI0d0hoY05NVGN4TVRFeE1EUTFNekV6V2hjTk1qY3gKTVRBNU1EUTFNekV6V2pCOU1Rc3dDUVlEVlFRR0V3SlZVekVUTUJFR0ExVUVDQk1LUTJGc2FXWnZjbTVwWVRFVwpNQlFHQTFVRUJ4TU5VMkZ1SUVaeVlXNWphWE5qYnpFZU1Cd0dBMVVFQ2hNVmIzSm5NUzVtYVc1aWJHOWphMk5vCllXbHVMbU51TVNFd0h3WURWUVFERXhoallTNXZjbWN4TG1acGJtSnNiMk5yWTJoaGFXNHVZMjR3V1RBVEJnY3EKaGtqT1BRSUJCZ2dxaGtqT1BRTUJCd05DQUFSaEw3My9Zem5BYXd1eDV2bWNDRjNEUklva0ZuQ0xvVjJkTDc5cAppK3VoMGgrRkFLOXlLTDIzMGtiK0xwZ1JrMXNOQktnditrUkN2Snh5OWZVL2UxVmFvMTh3WFRBT0JnTlZIUThCCkFmOEVCQU1DQWFZd0R3WURWUjBsQkFnd0JnWUVWUjBsQURBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUNrR0ExVWQKRGdRaUJDQnRxbWM5SG5hMWZvdXcxemwwNjJLSGFSak12Ny9yNkdsWEYwcmdLMDVLaVRBS0JnZ3Foa2pPUFFRRApBZ05JQURCRkFpRUF5VUxOUjRWTk1sSUw3cEZaYWIvdWFucG1Fa2VBQnA3d3lEbk9JUjYwL1ZnQ0lGdVhOSWRQClo2V3ZQT2tac1Y4NDVJVDdMaGp5WDFUSld4MFlVVzBqWXlDSgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"admins"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNLRENDQWM2Z0F3SUJBZ0lRQ2tkelRBUkZSNDFXUEtKSGo3cmVxREFLQmdncWhrak9QUVFEQWpCOU1Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RWVNQndHQTFVRUNoTVZiM0puTVM1bWFXNWliRzlqYTJOb1lXbHVMbU51TVNFd0h3WURWUVFECkV4aGpZUzV2Y21jeExtWnBibUpzYjJOclkyaGhhVzR1WTI0d0hoY05NVGN4TVRFeE1EUTFNekV6V2hjTk1qY3gKTVRBNU1EUTFNekV6V2pCZ01Rc3dDUVlEVlFRR0V3SlZVekVUTUJFR0ExVUVDQk1LUTJGc2FXWnZjbTVwWVRFVwpNQlFHQTFVRUJ4TU5VMkZ1SUVaeVlXNWphWE5qYnpFa01DSUdBMVVFQXd3YlFXUnRhVzVBYjNKbk1TNW1hVzVpCmJHOWphMk5vWVdsdUxtTnVNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVCNHZ3ZTFOOFQ1MUQKL0F2OHd0ejUxNEg3WHZZSEVIaGhPY1NnZkpzckNCT3FlaVFXTS9YVklWVWNwL2dtQ25UZytHdHdwVmN3d0V5SApNaFJMeFFoWktLTk5NRXN3RGdZRFZSMFBBUUgvQkFRREFnZUFNQXdHQTFVZEV3RUIvd1FDTUFBd0t3WURWUjBqCkJDUXdJb0FnYmFwblBSNTJ0WDZMc05jNWRPdGloMmtZekwrLzYraHBWeGRLNEN0T1Nva3dDZ1lJS29aSXpqMEUKQXdJRFNBQXdSUUloQUtRdnphbVBBbWVBd2hhUy9FcldOUWhQMDFFdXZzeEhYVHNUVWhMZ3RZWmRBaUJUVmZoaQowOUZ3L1FVdU9WdGlWL25uSzN6YnExVWF4V1ZxdU16alJ5QXR5UT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"crypto_config"</span>: &#123;</span><br><span class="line">				<span class="attr">"signature_hash_family"</span>: <span class="string">"SHA2"</span>,</span><br><span class="line">				<span class="attr">"identity_identifier_hash_function"</span>: <span class="string">"SHA256"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tls_root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNYekNDQWdXZ0F3SUJBZ0lRZWVPVmtGYUk0M2NQQXVYSUVIWVpNakFLQmdncWhrak9QUVFEQWpDQmdERUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhIakFjQmdOVkJBb1RGVzl5WnpFdVptbHVZbXh2WTJ0amFHRnBiaTVqYmpFa01DSUdBMVVFCkF4TWJkR3h6WTJFdWIzSm5NUzVtYVc1aWJHOWphMk5vWVdsdUxtTnVNQjRYRFRFM01URXhNVEEwTlRNeE0xb1gKRFRJM01URXdPVEEwTlRNeE0xb3dnWUF4Q3pBSkJnTlZCQVlUQWxWVE1STXdFUVlEVlFRSUV3cERZV3hwWm05eQpibWxoTVJZd0ZBWURWUVFIRXcxVFlXNGdSbkpoYm1OcGMyTnZNUjR3SEFZRFZRUUtFeFZ2Y21jeExtWnBibUpzCmIyTnJZMmhoYVc0dVkyNHhKREFpQmdOVkJBTVRHM1JzYzJOaExtOXlaekV1Wm1sdVlteHZZMnRqYUdGcGJpNWoKYmpCWk1CTUdCeXFHU000OUFnRUdDQ3FHU000OUF3RUhBMElBQkJ1OW02YW1BMUJSd0U1OWZ2RmdMUGI5TWRmRwpwK3FhQUVNdk9sUE9FK25tNzJYZVFMemxNTmlJWjl1TVhlUXJadDFGcEYxcTErKzVVNVB2R2xDaGxFV2pYekJkCk1BNEdBMVVkRHdFQi93UUVBd0lCcGpBUEJnTlZIU1VFQ0RBR0JnUlZIU1VBTUE4R0ExVWRFd0VCL3dRRk1BTUIKQWY4d0tRWURWUjBPQkNJRUlFa2FpSXFJZDVoWG1PRmxOM3JnTXJjZG8wUWZGOWVKMEpTTE85UkM5RkZMTUFvRwpDQ3FHU000OUJBTUNBMGdBTUVVQ0lRQ1lJekJuVnJ1a05WK1lRV3dmV3dITGI2Qm81YWFXU3NaRlVib3F3UUd5ClRBSWdLYWYwbHdNWGJPd2p2T1czMjU1L0ZOcGg4RkJ2blFGaHpIRHJsc0tnbWM0PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Org22MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"Org22MSP"</span>,</span><br><span class="line">			<span class="attr">"root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNQekNDQWVhZ0F3SUJBZ0lSQUtWODZxb05Vc0tLMS9MLzVQMU05MWd3Q2dZSUtvWkl6ajBFQXdJd2NURUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhHREFXQmdOVkJBb1REMk5uWW1Ob2FXNWhMbU52YlM1amJqRWJNQmtHQTFVRUF4TVNZMkV1ClkyZGlZMmhwYm1FdVkyOXRMbU51TUI0WERURTVNRFV4TXpBNU1ERXdNMW9YRFRJNU1EVXhNREE1TURFd00xb3cKY1RFTE1Ba0dBMVVFQmhNQ1ZWTXhFekFSQmdOVkJBZ1RDa05oYkdsbWIzSnVhV0V4RmpBVUJnTlZCQWNURFZOaApiaUJHY21GdVkybHpZMjh4R0RBV0JnTlZCQW9URDJOblltTm9hVzVoTG1OdmJTNWpiakViTUJrR0ExVUVBeE1TClkyRXVZMmRpWTJocGJtRXVZMjl0TG1OdU1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRWFKRGQKaTB5Rk1tam1HOHpGOHY1Zm9yQ2M4RkhXYVFiQ0JITFpNVmxTZmFvYThCNlZtUzNnaUF5YnRrdytzVXZINnhLVQpOYVErNEZWS1VwYm1pQWJZc0tOZk1GMHdEZ1lEVlIwUEFRSC9CQVFEQWdHbU1BOEdBMVVkSlFRSU1BWUdCRlVkCkpRQXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QXBCZ05WSFE0RUlnUWd3dHA2SEZVTjhKeklNTEFrczVQOW5VdFMKWlUwdWVNKytyWUNNYUtXWXpVd3dDZ1lJS29aSXpqMEVBd0lEUndBd1JBSWdhUTB1UzBPbmdaS1VZSnhTZ0tzYgp5K09BNUU0SFdqT093Tmg3enVYY2UyQUNJQkdEMGJlbU1vQWdqMXdaMXl1WFpoTU5OZFh2RmVlaU5ZU1Z2ak14Cm14a1QKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"admins"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNGakNDQWIyZ0F3SUJBZ0lSQUtMSnY0Nmx5aEJkakdMV2MzbU1WQWd3Q2dZSUtvWkl6ajBFQXdJd2NURUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhHREFXQmdOVkJBb1REMk5uWW1Ob2FXNWhMbU52YlM1amJqRWJNQmtHQTFVRUF4TVNZMkV1ClkyZGlZMmhwYm1FdVkyOXRMbU51TUI0WERURTVNRFV4TXpBNU1ERXdNMW9YRFRJNU1EVXhNREE1TURFd00xb3cKV2pFTE1Ba0dBMVVFQmhNQ1ZWTXhFekFSQmdOVkJBZ1RDa05oYkdsbWIzSnVhV0V4RmpBVUJnTlZCQWNURFZOaApiaUJHY21GdVkybHpZMjh4SGpBY0JnTlZCQU1NRlVGa2JXbHVRR05uWW1Ob2FXNWhMbU52YlM1amJqQlpNQk1HCkJ5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEEwSUFCT09WVm0zbzhJTlBiWCtrOXpPZnNhVFhuOEcrSnByZ3lneE4KdjhobHVWMkRBbGlGWS9FVGk2aW10ZDBHakdvNWY4dnVaa3NrUmwvUnBUdVd4UERNVHJXalRUQkxNQTRHQTFVZApEd0VCL3dRRUF3SUhnREFNQmdOVkhSTUJBZjhFQWpBQU1Dc0dBMVVkSXdRa01DS0FJTUxhZWh4VkRmQ2N5REN3CkpMT1QvWjFMVW1WTkxualB2cTJBakdpbG1NMU1NQW9HQ0NxR1NNNDlCQU1DQTBjQU1FUUNJSHI4aWpxRytQZXoKQmNKQWZ6NXlsU1J1MUo2Nnl1ZkZldWlMREE2MHQ4RS9BaUJHSlM1K25wRzkvalFqcFcxZzdKMTA3cFhSZkoxMApTU1prOTlmM2NqVGlnZz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"</span></span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"crypto_config"</span>: &#123;</span><br><span class="line">				<span class="attr">"signature_hash_family"</span>: <span class="string">"SHA2"</span>,</span><br><span class="line">				<span class="attr">"identity_identifier_hash_function"</span>: <span class="string">"SHA256"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tls_root_certs"</span>: [</span><br><span class="line">				<span class="string">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNSakNDQWV5Z0F3SUJBZ0lSQU5meGxrM3k3UTV2V1hBdUltNWFQbVF3Q2dZSUtvWkl6ajBFQXdJd2RERUwKTUFrR0ExVUVCaE1DVlZNeEV6QVJCZ05WQkFnVENrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY1REVk5oYmlCRwpjbUZ1WTJselkyOHhHREFXQmdOVkJBb1REMk5uWW1Ob2FXNWhMbU52YlM1amJqRWVNQndHQTFVRUF4TVZkR3h6ClkyRXVZMmRpWTJocGJtRXVZMjl0TG1OdU1CNFhEVEU1TURVeE16QTVNREV3TTFvWERUSTVNRFV4TURBNU1ERXcKTTFvd2RERUxNQWtHQTFVRUJoTUNWVk14RXpBUkJnTlZCQWdUQ2tOaGJHbG1iM0p1YVdFeEZqQVVCZ05WQkFjVApEVk5oYmlCR2NtRnVZMmx6WTI4eEdEQVdCZ05WQkFvVEQyTm5ZbU5vYVc1aExtTnZiUzVqYmpFZU1Cd0dBMVVFCkF4TVZkR3h6WTJFdVkyZGlZMmhwYm1FdVkyOXRMbU51TUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0QKUWdBRTMxcC9VeUFqYlRDZ1ZQNmhFdG0xUittbXllOGdWYWtRUE9HeFBHeDE0YjlZbk5jUFFHaC9vNU00VFg4SwozTllFdjdiOTNMSUoyNmR5N084MkZhSU1OS05mTUYwd0RnWURWUjBQQVFIL0JBUURBZ0dtTUE4R0ExVWRKUVFJCk1BWUdCRlVkSlFBd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBcEJnTlZIUTRFSWdRZ3ViN1l4UldnK0h4UkxLK2gKQlhBaGIvZzhXTThpME83NmIxTm5NaTZSQjNZd0NnWUlLb1pJemowRUF3SURTQUF3UlFJaEFOSzA1TXNDQ3BkZwovUXdvMk1jWHVxUW5EZkZqMUErYzhGK1huUE1BVmc5U0FpQm9tM3ZyMTMzdTNKV1NrQklCUlFzblRpMUNiVnY4ClAvb1BMVGEyMERmcEdnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="</span></span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"orderers"</span>: &#123;</span><br><span class="line">		<span class="attr">"Orderer11MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"endpoint"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord1.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7001</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord1.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7002</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord11.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord11.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord12.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord12.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Orderer12MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"endpoint"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord1.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7001</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord1.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7002</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord11.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord11.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord12.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord12.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Orderer1MSP"</span>: &#123;</span><br><span class="line">			<span class="attr">"endpoint"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord1.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7001</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord1.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7002</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord11.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord11.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer0.ord12.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"host"</span>: <span class="string">"orderer1.ord12.finblockchain.cn"</span>,</span><br><span class="line">					<span class="attr">"port"</span>: <span class="number">7050</span></span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It’s important to note that the certificates here are base64 encoded, and thus should decoded in a manner similar to the following:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@4ad40c1562dd:/opt/gopath/src/github.com/hyperledger/fabric/peer/artifacts<span class="comment"># ./discover --configFile config.yaml config --channel channelfft --server peer1.org1.finblockchain.cn:7051 | jq .msps.Orderer1MSP.root_certs[0] |sed "s/\"//g"|base64 --decode |openssl x509 -text -noout</span></span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            95:7d:c0:f0:f1:de:a7:<span class="built_in">fc</span>:6b:b1:31:8a:28:3e:5d:82</span><br><span class="line">    Signature Algorithm: ecdsa-with-SHA256</span><br><span class="line">        Issuer: C=US, ST=California, L=San Francisco, O=ord1.finblockchain.cn, CN=ca.ord1.finblockchain.cn</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Nov 11 04:53:13 2017 GMT</span><br><span class="line">            Not After : Nov  9 04:53:13 2027 GMT</span><br><span class="line">        Subject: C=US, ST=California, L=San Francisco, O=ord1.finblockchain.cn, CN=ca.ord1.finblockchain.cn</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: id-ecPublicKey</span><br><span class="line">                Public-Key: (256 bit)</span><br><span class="line">                pub: </span><br><span class="line">                    04:c1:f4:71:de:b6:52:2c:77:a1:d7:fd:33:5e:d1:</span><br><span class="line">                    13:6b:d9:62:ae:db:8f:6c:7e:db:36:d1:be:df:02:</span><br><span class="line">                    36:d7:11:e4:92:32:25:14:a2:ae:9d:44:8c:95:25:</span><br><span class="line">                    9e:8a:52:6e:fb:a1:ee:2f:ac:f2:df:bc:7a:1b:15:</span><br><span class="line">                    41:ca:85:22:7f</span><br><span class="line">                ASN1 OID: prime256v1</span><br><span class="line">                NIST CURVE: P-256</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment, Certificate Sign, CRL Sign</span><br><span class="line">            X509v3 Extended Key Usage: </span><br><span class="line">                Any Extended Key Usage</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                18:AC:DD:E3:19:70:83:69:F1:B4:7C:5E:B5:99:19:19:81:30:E5:9D:ED:26:12:40:50:34:4B:10:17:E7:FA:C2</span><br><span class="line">    Signature Algorithm: ecdsa-with-SHA256</span><br><span class="line">         30:44:02:20:2c:b0:28:89:46:66:ce:f9:83:0a:88:2a:f6:96:</span><br><span class="line">         30:0d:91:cb:92:23:ba:db:27:5c:1b:90:84:ed:e4:1f:64:30:</span><br><span class="line">         02:20:40:4e:14:06:f2:a1:cc:b7:6d:4d:44:0f:7d:ba:c5:2d:</span><br><span class="line">         d1:00:7c:da:d6:d8:b1:9c:bd:46:d9:ba:bc:ad:0d:f3</span><br></pre></td></tr></table></figure>
<h1 id="Endorsers-query"><a href="#Endorsers-query" class="headerlink" title="Endorsers query"></a>Endorsers query</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">discover --configFile config.yaml endorsers --channel channelfft --server peer1.org1.finblockchain.cn:7051 --chaincode fft</span><br></pre></td></tr></table></figure>
<p>Below is the output of an endorsers query for chaincode fft when the endorsement policy is <code>OR(&#39;Org1.peer&#39;, &#39;Org2.peer&#39;,...)</code>:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">"Chaincode"</span>: <span class="string">"fft"</span>,</span><br><span class="line">		<span class="attr">"EndorsersByGroups"</span>: &#123;</span><br><span class="line">			<span class="attr">"G31"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">					<span class="attr">"LedgerHeight"</span>: <span class="number">10586</span>,</span><br><span class="line">					<span class="attr">"Endpoint"</span>: <span class="string">"peer1.org1.finblockchain.cn:7051"</span>,</span><br><span class="line">					<span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICKDCCAc+gAwIBAgIRAIpwEdPGilRsUtB6wi5inMQwCgYIKoZIzj0EAwIwfTEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xHjAcBgNVBAoTFW9yZzEuZmluYmxvY2tjaGFpbi5jbjEhMB8GA1UE\nAxMYY2Eub3JnMS5maW5ibG9ja2NoYWluLmNuMB4XDTE3MTExMTA0NTMxM1oXDTI3\nMTEwOTA0NTMxM1owYDELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWEx\nFjAUBgNVBAcTDVNhbiBGcmFuY2lzY28xJDAiBgNVBAMTG3BlZXIxLm9yZzEuZmlu\nYmxvY2tjaGFpbi5jbjBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABNizeATUZb0Z\nKsTP12eQfrFPE7GzzwgqpVSrp4Nvy1nwaG108GQ37F/QX3WDap53BoqB0f5oT221\nMsqom2UF6bCjTTBLMA4GA1UdDwEB/wQEAwIHgDAMBgNVHRMBAf8EAjAAMCsGA1Ud\nIwQkMCKAIG2qZz0edrV+i7DXOXTrYodpGMy/v+voaVcXSuArTkqJMAoGCCqGSM49\nBAMCA0cAMEQCIGadPQTPriIHRsHETArs36OBZwfwgKDSPfLxxzAVbNt+AiAs5vnQ\n3tP9bbVmLCMHgLEZJiLf5cn50x5huC4NymNV6w==\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Layouts"</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">"quantities_by_group"</span>: &#123;</span><br><span class="line">					<span class="attr">"G31"</span>: <span class="number">1</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@6673a941ffd5:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto<span class="comment"># /opt/bin/discover --configFile discoverconfig.yaml endorsers --channel mychannel  --server peer0.org1.example.com:7051 --chaincode mycc</span></span><br></pre></td></tr></table></figure>
<p>Below is the output of an endorsers query for chaincode mycc when the endorsement policy is <code>AND(&#39;Org1.peer&#39;, &#39;Org2.peer&#39;)</code>:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"Chaincode"</span>: <span class="string">"mycc"</span>,</span><br><span class="line">                <span class="attr">"EndorsersByGroups"</span>: &#123;</span><br><span class="line">                        <span class="attr">"G0"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">                                        <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"Endpoint"</span>: <span class="string">"peer0.org1.example.com:7051"</span>,</span><br><span class="line">                                        <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICKTCCAc+gAwIBAgIRALDIidAvFqocYnZt5hdAeRMwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjAwMzExMDkxNDAwWhcNMzAwMzA5MDkxNDAw\nWjBqMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzENMAsGA1UECxMEcGVlcjEfMB0GA1UEAxMWcGVlcjAub3Jn\nMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABEqdiEuoEOXy\nwWQrQZcSgnkfT3uCun9BcIvKW0DUnNJDs4PQOV2Iu3NyMUCL78nmAF3Nhag54hZQ\npagAj1TKBC+jTTBLMA4GA1UdDwEB/wQEAwIHgDAMBgNVHRMBAf8EAjAAMCsGA1Ud\nIwQkMCKAIMdNxOMdQqEkx5wxkbcrf3JeXo6acV9gJCHfXJphc/TtMAoGCCqGSM49\nBAMCA0gAMEUCIQCmdmAHNccAdXEDw8C/lV38dBv9G2gAiesRFjbApOLqKwIgFcdB\nQDotyW+eRXxltEaeghx0+yR8ySzxuY8uncpeAgo=\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        ],</span><br><span class="line">                        <span class="attr">"G1"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">                                        <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"Endpoint"</span>: <span class="string">"peer1.org2.example.com:10051"</span>,</span><br><span class="line">                                        <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQEmktqnZ/zc3HJxBZfOanHTAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE8EGkRYAk0/uW\nBHUfxhI0GosdtTCSKaBIQxPWn4so7ONZxsf2s6Yst1SjOfiN8aG520oSvdCjtCvT\nPozgvQrnTqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgeDjPXKB3pohEI5nhdMtBEZDCEJBfGpQfiROlOBl0TngCIFX4D6E0\nphnDqHSRVPAI6Xt+mkJvDOq/P5qMIfy0rRns\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">                                        <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"Endpoint"</span>: <span class="string">"peer0.org2.example.com:9051"</span>,</span><br><span class="line">                                        <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQV9z6OE+mj/L1ez8wq6gcvjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMC5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEs3Zh2dODw9Ii\n731lgxDfzKDlfam9dhRHeK6eKTJxwM6C516apuBSqbdPFu9Gr1exM/UgNb79z1xS\nKTGwfc4wwqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgfC9075LAovdOm4mvUvZlUTQvZFiY362fBeIn8fGwjG0CID+Zb6Fn\n4hJkQyo3lHSy6tkH8yaXYGSffrYjG1AovwGt\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"Layouts"</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="attr">"quantities_by_group"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"G0"</span>: <span class="number">1</span>,</span><br><span class="line">                                        <span class="attr">"G1"</span>: <span class="number">1</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                ]</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">discover --configFile conf.yaml endorsers --channel mychannel  --server peer0.org1.example.com:7051 --chaincode vendor</span><br></pre></td></tr></table></figure>
<p>Below is the output of an endorsers query for chaincode vendor:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">"Chaincode"</span>: <span class="string">"vendor"</span>,</span><br><span class="line">		<span class="attr">"EndorsersByGroups"</span>: &#123;</span><br><span class="line">			<span class="attr">"G0"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">					<span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">"Endpoint"</span>: <span class="string">"peer0.org1.example.com:7051"</span>,</span><br><span class="line">					<span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICKTCCAc+gAwIBAgIRALDIidAvFqocYnZt5hdAeRMwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjAwMzExMDkxNDAwWhcNMzAwMzA5MDkxNDAw\nWjBqMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzENMAsGA1UECxMEcGVlcjEfMB0GA1UEAxMWcGVlcjAub3Jn\nMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABEqdiEuoEOXy\nwWQrQZcSgnkfT3uCun9BcIvKW0DUnNJDs4PQOV2Iu3NyMUCL78nmAF3Nhag54hZQ\npagAj1TKBC+jTTBLMA4GA1UdDwEB/wQEAwIHgDAMBgNVHRMBAf8EAjAAMCsGA1Ud\nIwQkMCKAIMdNxOMdQqEkx5wxkbcrf3JeXo6acV9gJCHfXJphc/TtMAoGCCqGSM49\nBAMCA0gAMEUCIQCmdmAHNccAdXEDw8C/lV38dBv9G2gAiesRFjbApOLqKwIgFcdB\nQDotyW+eRXxltEaeghx0+yR8ySzxuY8uncpeAgo=\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">					<span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">"Endpoint"</span>: <span class="string">"peer1.org1.example.com:8051"</span>,</span><br><span class="line">					<span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQJ0DXZSYmZfm26oFKtBoDdjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMS5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcx\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEnIatOWiCBfbc\nLUr4JlkdctBmZJ41YGca9kbz+CNBJRPx3CjH1pTJADfaojsZfpMWgTdXcaTQF8eR\nYbzIde3fBqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAgx03E4x1CoSTHnDGRtyt/cl5ejppxX2AkId9cmmFz9O0wCgYIKoZIzj0E\nAwIDRwAwRAIgYtxo1gBHQW0dVvn6jc4tOiq3Nyz/aOXFf6VibeCpWKoCIDKYk/92\nbFk/jE3yHeQHKSxOC1eNk0ak2gudrReKVlwJ\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">				&#125;</span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"G1"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">					<span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">"Endpoint"</span>: <span class="string">"peer0.org2.example.com:9051"</span>,</span><br><span class="line">					<span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQV9z6OE+mj/L1ez8wq6gcvjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMC5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEs3Zh2dODw9Ii\n731lgxDfzKDlfam9dhRHeK6eKTJxwM6C516apuBSqbdPFu9Gr1exM/UgNb79z1xS\nKTGwfc4wwqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgfC9075LAovdOm4mvUvZlUTQvZFiY362fBeIn8fGwjG0CID+Zb6Fn\n4hJkQyo3lHSy6tkH8yaXYGSffrYjG1AovwGt\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">					<span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">"Endpoint"</span>: <span class="string">"peer1.org2.example.com:10051"</span>,</span><br><span class="line">					<span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQEmktqnZ/zc3HJxBZfOanHTAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE8EGkRYAk0/uW\nBHUfxhI0GosdtTCSKaBIQxPWn4so7ONZxsf2s6Yst1SjOfiN8aG520oSvdCjtCvT\nPozgvQrnTqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgeDjPXKB3pohEI5nhdMtBEZDCEJBfGpQfiROlOBl0TngCIFX4D6E0\nphnDqHSRVPAI6Xt+mkJvDOq/P5qMIfy0rRns\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"Layouts"</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">"quantities_by_group"</span>: &#123;</span><br><span class="line">					<span class="attr">"G0"</span>: <span class="number">1</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">"quantities_by_group"</span>: &#123;</span><br><span class="line">					<span class="attr">"G1"</span>: <span class="number">1</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@6673a941ffd5:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto<span class="comment"># /opt/bin/discover --configFile discoverconfig.yaml endorsers --channel mychannel  --server peer0.org1.example.com:7051 --chaincode vendor --collection=vendor:vendor,vendorPrice</span></span><br></pre></td></tr></table></figure>
<p>Below is the output of an endorsers query with private data collection:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"Chaincode"</span>: <span class="string">"vendor"</span>,</span><br><span class="line">                <span class="attr">"EndorsersByGroups"</span>: &#123;</span><br><span class="line">                        <span class="attr">"G0"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">                                        <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"Endpoint"</span>: <span class="string">"peer1.org1.example.com:8051"</span>,</span><br><span class="line">                                        <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQJ0DXZSYmZfm26oFKtBoDdjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMS5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcx\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEnIatOWiCBfbc\nLUr4JlkdctBmZJ41YGca9kbz+CNBJRPx3CjH1pTJADfaojsZfpMWgTdXcaTQF8eR\nYbzIde3fBqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAgx03E4x1CoSTHnDGRtyt/cl5ejppxX2AkId9cmmFz9O0wCgYIKoZIzj0E\nAwIDRwAwRAIgYtxo1gBHQW0dVvn6jc4tOiq3Nyz/aOXFf6VibeCpWKoCIDKYk/92\nbFk/jE3yHeQHKSxOC1eNk0ak2gudrReKVlwJ\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">                                        <span class="attr">"LedgerHeight"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"Endpoint"</span>: <span class="string">"peer0.org1.example.com:7051"</span>,</span><br><span class="line">                                        <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICKTCCAc+gAwIBAgIRALDIidAvFqocYnZt5hdAeRMwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjAwMzExMDkxNDAwWhcNMzAwMzA5MDkxNDAw\nWjBqMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzENMAsGA1UECxMEcGVlcjEfMB0GA1UEAxMWcGVlcjAub3Jn\nMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABEqdiEuoEOXy\nwWQrQZcSgnkfT3uCun9BcIvKW0DUnNJDs4PQOV2Iu3NyMUCL78nmAF3Nhag54hZQ\npagAj1TKBC+jTTBLMA4GA1UdDwEB/wQEAwIHgDAMBgNVHRMBAf8EAjAAMCsGA1Ud\nIwQkMCKAIMdNxOMdQqEkx5wxkbcrf3JeXo6acV9gJCHfXJphc/TtMAoGCCqGSM49\nBAMCA0gAMEUCIQCmdmAHNccAdXEDw8C/lV38dBv9G2gAiesRFjbApOLqKwIgFcdB\nQDotyW+eRXxltEaeghx0+yR8ySzxuY8uncpeAgo=\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"Layouts"</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="attr">"quantities_by_group"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"G0"</span>: <span class="number">1</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                ]</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h1 id="Not-using-a-configuration-file"><a href="#Not-using-a-configuration-file" class="headerlink" title="Not using a configuration file"></a>Not using a configuration file</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@6673a941ffd5:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto<span class="comment"># /opt/bin/discover --peerTLSCA peerOrganizations/org1.example.com/users/Admin\@org1.example.com/tls/ca.crt --userKey peerOrganizations/org1.example.com/users/Admin\@org1.example.com/msp/keystore/d79db82aa64380f532b20498339998bb6f7a375d71a3eca3dd53c1403fe0755d_sk --userCert peerOrganizations/org1.example.com/users/Admin\@org1.example.com/msp/signcerts/Admin\@org1.example.com-cert.pem peers --server peer0.org1.example.com:7051 --MSP Org1MSP</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer0.org2.example.com:9051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQV9z6OE+mj/L1ez8wq6gcvjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMC5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEs3Zh2dODw9Ii\n731lgxDfzKDlfam9dhRHeK6eKTJxwM6C516apuBSqbdPFu9Gr1exM/UgNb79z1xS\nKTGwfc4wwqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgfC9075LAovdOm4mvUvZlUTQvZFiY362fBeIn8fGwjG0CID+Zb6Fn\n4hJkQyo3lHSy6tkH8yaXYGSffrYjG1AovwGt\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org2MSP"</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer1.org2.example.com:10051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQEmktqnZ/zc3HJxBZfOanHTAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcy\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE8EGkRYAk0/uW\nBHUfxhI0GosdtTCSKaBIQxPWn4so7ONZxsf2s6Yst1SjOfiN8aG520oSvdCjtCvT\nPozgvQrnTqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAg0lG+5sqhH6gdozNXjugzxvFbNJm9VxYDLohgnQC/zGwwCgYIKoZIzj0E\nAwIDRwAwRAIgeDjPXKB3pohEI5nhdMtBEZDCEJBfGpQfiROlOBl0TngCIFX4D6E0\nphnDqHSRVPAI6Xt+mkJvDOq/P5qMIfy0rRns\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer0.org1.example.com:7051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICKTCCAc+gAwIBAgIRALDIidAvFqocYnZt5hdAeRMwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjAwMzExMDkxNDAwWhcNMzAwMzA5MDkxNDAw\nWjBqMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzENMAsGA1UECxMEcGVlcjEfMB0GA1UEAxMWcGVlcjAub3Jn\nMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABEqdiEuoEOXy\nwWQrQZcSgnkfT3uCun9BcIvKW0DUnNJDs4PQOV2Iu3NyMUCL78nmAF3Nhag54hZQ\npagAj1TKBC+jTTBLMA4GA1UdDwEB/wQEAwIHgDAMBgNVHRMBAf8EAjAAMCsGA1Ud\nIwQkMCKAIMdNxOMdQqEkx5wxkbcrf3JeXo6acV9gJCHfXJphc/TtMAoGCCqGSM49\nBAMCA0gAMEUCIQCmdmAHNccAdXEDw8C/lV38dBv9G2gAiesRFjbApOLqKwIgFcdB\nQDotyW+eRXxltEaeghx0+yR8ySzxuY8uncpeAgo=\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">"MSPID"</span>: <span class="string">"Org1MSP"</span>,</span><br><span class="line">                <span class="attr">"Endpoint"</span>: <span class="string">"peer1.org1.example.com:8051"</span>,</span><br><span class="line">                <span class="attr">"Identity"</span>: <span class="string">"-----BEGIN CERTIFICATE-----\nMIICJzCCAc6gAwIBAgIQJ0DXZSYmZfm26oFKtBoDdjAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMS5leGFtcGxlLmNvbTAeFw0yMDAzMTEwOTE0MDBaFw0zMDAzMDkwOTE0MDBa\nMGoxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMQ0wCwYDVQQLEwRwZWVyMR8wHQYDVQQDExZwZWVyMS5vcmcx\nLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEnIatOWiCBfbc\nLUr4JlkdctBmZJ41YGca9kbz+CNBJRPx3CjH1pTJADfaojsZfpMWgTdXcaTQF8eR\nYbzIde3fBqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0j\nBCQwIoAgx03E4x1CoSTHnDGRtyt/cl5ejppxX2AkId9cmmFz9O0wCgYIKoZIzj0E\nAwIDRwAwRAIgYtxo1gBHQW0dVvn6jc4tOiq3Nyz/aOXFf6VibeCpWKoCIDKYk/92\nbFk/jE3yHeQHKSxOC1eNk0ak2gudrReKVlwJ\n-----END CERTIFICATE-----\n"</span></span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>It’s different from <strong>fabric-sample</strong> that is not specify <code>--tlsCert</code> and <code>--tlsKey</code>.</p>
]]></content>
      <categories>
        <category>区块链</category>
      </categories>
      <tags>
        <tag>fabric</tag>
        <tag>Hyperledger</tag>
        <tag>discover</tag>
      </tags>
  </entry>
  <entry>
    <title>Certified Hyperledger Fabric Administrator（CHFA）备考笔记</title>
    <url>/blockchain/undefined.html</url>
    <content><![CDATA[<h1 id="CHFA-介绍"><a href="#CHFA-介绍" class="headerlink" title="CHFA 介绍"></a>CHFA 介绍</h1><p>CHFA （Certified Hyperledger Fabric Administrator）是 Linux 基金会发放的认证证书，按照官方的说法，获得此证书的人，具备搭建一个安全的可商用的 Hyperledger Fabric 网络的能力，其中包括对网络的节点进行安装、配置、操作、管理和排错的能力。</p>
<p>证书有效期为 2 年，考试费 300 美刀，报名有效期为 12 个月，考试形式为在线考，考试时长2小时，我考试时的 Fabric 版本 1.4.1</p>
<p>考试结束后 36小 时可以官网 My Portal 看到成绩</p>
<p><img src="https://upyun.hoke58.cn/img/CHFA-20200430163026.png" alt="CHFA-20200430163026"></p>
<h1 id="备考笔记"><a href="#备考笔记" class="headerlink" title="备考笔记"></a>备考笔记</h1><p><img src="https://upyun.hoke58.cn/img/CHFA-CHFA.png" alt="CHFA-CHFA"></p>
<h2 id="Application-Lifecycle-Management-–-20"><a href="#Application-Lifecycle-Management-–-20" class="headerlink" title="Application Lifecycle Management – 20%"></a>Application Lifecycle Management – 20%</h2><h3 id="Install-and-Instantiate-chaincode-package"><a href="#Install-and-Instantiate-chaincode-package" class="headerlink" title="Install and Instantiate chaincode package"></a>Install and Instantiate chaincode package</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">peer chaincode install -n mycc -v <span class="variable">$&#123;VERSION&#125;</span> -l <span class="variable">$&#123;LANGUAGE&#125;</span> -p <span class="variable">$&#123;CC_SRC_PATH&#125;</span></span><br><span class="line"><span class="comment"># go env</span></span><br><span class="line">peer chaincode  install -n mycc -v 1.0 -p github.com/chaincode/chaincode_example02/go/</span><br><span class="line">peer chaincode instantiate -o orderer.example.com:7050 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C <span class="variable">$CHANNEL_NAME</span> -n mycc -v 1.0 -c <span class="string">'&#123;"Args":["init","a", "100", "b","200"]&#125;'</span> -P <span class="string">"AND ('Org1MSP.peer','Org2MSP.peer')"</span></span><br><span class="line"><span class="comment"># node</span></span><br><span class="line">peer chaincode install -n nodecc -v 1.0 -l node -p /opt/gopath/src/github.com/chaincode/chaincode_example02/node/</span><br><span class="line">peer chaincode instantiate -o orderer.example.com:7050 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C <span class="variable">$CHANNEL_NAME</span> -n mycc -l node -v 1.0 -c <span class="string">'&#123;"Args":["init","a", "100", "b","200"]&#125;'</span> -P <span class="string">"AND ('Org1MSP.peer','Org2MSP.peer')"</span></span><br><span class="line"><span class="comment"># java</span></span><br><span class="line">peer chaincode install -n javacc -v 1.0 -l java -p /opt/gopath/src/github.com/chaincode/chaincode_example02/java/</span><br><span class="line">peer chaincode instantiate -o orderer.example.com:7050 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C <span class="variable">$CHANNEL_NAME</span> -n mycc -l java -v 1.0 -c <span class="string">'&#123;"Args":["init","a", "100", "b","200"]&#125;'</span> -P <span class="string">"AND ('Org1MSP.peer','Org2MSP.peer')"</span></span><br><span class="line"></span><br><span class="line">peer chaincode package -n mycc -p github.com/chaincode/chaincode_example02/go -v 1.1 mycc-1.1.out</span><br></pre></td></tr></table></figure>
<h3 id="Configure-endorsement-policy"><a href="#Configure-endorsement-policy" class="headerlink" title="Configure endorsement policy"></a>Configure endorsement policy</h3><p>参上</p>
<h3 id="Define-collection-policy-for-private-data"><a href="#Define-collection-policy-for-private-data" class="headerlink" title="Define collection policy for private data"></a>Define collection policy for private data</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvcHJpdmF0ZV9kYXRhX3R1dG9yaWFsLmh0bWw=" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/private_data_tutorial.html">Docs » Tutorials » Using Private Data in Fabric<i class="fa fa-external-link"></i></span><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"collectionMarbles"</span>,</span><br><span class="line">    <span class="attr">"policy"</span>: <span class="string">"OR('Org1MSP.member', 'Org2MSP.member')"</span>,</span><br><span class="line">    <span class="attr">"requiredPeerCount"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"maxPeerCount"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"blockToLive"</span>:<span class="number">1000000</span>,</span><br><span class="line">    <span class="attr">"memberOnlyRead"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"memberOnlyWrite"</span>: <span class="literal">true</span></span><br><span class="line"> &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"collectionMarblePrivateDetails"</span>,</span><br><span class="line">    <span class="attr">"policy"</span>: <span class="string">"OR('Org1MSP.member')"</span>,</span><br><span class="line">    <span class="attr">"requiredPeerCount"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"maxPeerCount"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"blockToLive"</span>:<span class="number">3</span>,</span><br><span class="line">    <span class="attr">"memberOnlyRead"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"memberOnlyWrite"</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"endorsementPolicy"</span>: &#123;</span><br><span class="line">      <span class="attr">"signaturePolicy"</span>: <span class="string">"OR('Org1MSP.member')"</span></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">peer chaincode instantiate -o orderer.example.com:7050 --tls --cafile <span class="variable">$ORDERER_CA</span> -C mychannel -n marblesp -v 1.0 -c <span class="string">'&#123;"Args":["init"]&#125;'</span> -P <span class="string">"OR('Org1MSP.member','Org2MSP.member')"</span> --collections-config  <span class="variable">$GOPATH</span>/src/github.com/chaincode/marbles02_private/collections_config.json</span><br></pre></td></tr></table></figure>
<h3 id="Modify-or-upgrade-chaincode"><a href="#Modify-or-upgrade-chaincode" class="headerlink" title="Modify or upgrade chaincode"></a>Modify or upgrade chaincode</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">peer chaincode upgrade -o orderer.example.com:7050 --tls <span class="variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="variable">$ORDERER_CA</span> -C <span class="variable">$CHANNEL_NAME</span> -n mycc -v 2.0 -c <span class="string">'&#123;"Args":["init","a","90","b","210"]&#125;'</span> -P <span class="string">"OR ('Org1MSP.peer','Org2MSP.peer','Org3MSP.peer')"</span></span><br></pre></td></tr></table></figure>
<h2 id="Install-and-Configure-Network-–-25"><a href="#Install-and-Configure-Network-–-25" class="headerlink" title="Install and Configure Network – 25%"></a>Install and Configure Network – 25%</h2></li>
</ul>
<h3 id="Modify-the-world-state-database-configuration"><a href="#Modify-the-world-state-database-configuration" class="headerlink" title="Modify the world state database configuration"></a>Modify the world state database configuration</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY291Y2hkYl90dXRvcmlhbC5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/couchdb_tutorial.html">Docs » Tutorials » Using CouchDB<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY291Y2hkYl9hc19zdGF0ZV9kYXRhYmFzZS5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/couchdb_as_state_database.html">Docs » Architecture Reference » CouchDB as the State Database<i class="fa fa-external-link"></i></span></li>
</ul>
<ol>
<li>Enable CouchDB in Hyperledger Fabric</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#	COUCHDB_USER COUCHDB_PASSWORD 管理员用户名和密码，不填的话couchDB会采用"Admin Party"模式，即所有人做任何事</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  couchdb0:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">couchdb0</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-couchdb</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">COUCHDB_USER=</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">COUCHDB_PASSWORD=</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"5984:5984"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="string">peer0.org1.example.com:</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_LEDGER_STATE_STATEDATABASE=CouchDB</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb0:5984</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">couchdb0</span></span><br></pre></td></tr></table></figure>
<p>couchdb页面访问 <span class="exturl" data-url="aHR0cDovL2lwOjU5ODQvX3V0aWxzLw==" title="http://ip:5984/_utils/">http://ip:5984/_utils/<i class="fa fa-external-link"></i></span></p>
<ol start="2">
<li>Create an index<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"index"</span>: &#123;</span><br><span class="line">        <span class="attr">"fields"</span>: [<span class="string">"foo"</span>]  // these are the frequently queried fields</span><br><span class="line">    &#125;,</span><br><span class="line">    "name" : "foo-index",  // name of the index</span><br><span class="line">    "type" : "json"  // always json in this context</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>Marbles sample:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"index"</span>:&#123;</span><br><span class="line">      <span class="attr">"fields"</span>:[<span class="string">"docType"</span>,<span class="string">"owner"</span>] // Names of the fields to be queried</span><br><span class="line">  &#125;,</span><br><span class="line">  "ddoc":"indexOwnerDoc", // (optional) Name of the design document in which the index will be created.</span><br><span class="line">  "name":"indexOwner",</span><br><span class="line">  "type":"json"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>index files must be located under the path <code>META-INF/statedb/couchdb/indexes</code> which is located inside the directory where the chaincode resides</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"fields"</span>:[<span class="string">"docType"</span>,<span class="string">"owner"</span>]&#125;,<span class="attr">"ddoc"</span>:<span class="string">"indexOwnerDoc"</span>, <span class="attr">"name"</span>:<span class="string">"indexOwner"</span>,<span class="attr">"type"</span>:<span class="string">"json"</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Define-initial-multi-org-configuration-policy"><a href="#Define-initial-multi-org-configuration-policy" class="headerlink" title="Define initial multi-org configuration policy"></a>Define initial multi-org configuration policy</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Organizations:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="meta">&amp;OrdererOrg</span></span><br><span class="line"><span class="attr">        Name:</span> <span class="string">OrdererOrg</span></span><br><span class="line"><span class="attr">        ID:</span> <span class="string">OrdererMSP</span></span><br><span class="line"><span class="attr">        MSPDir:</span> <span class="string">crypto-config/ordererOrganizations/example.com/msp</span></span><br><span class="line"><span class="attr">        Policies:</span></span><br><span class="line"><span class="attr">            Readers:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('OrdererMSP.member')"</span></span><br><span class="line"><span class="attr">            Writers:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('OrdererMSP.member')"</span></span><br><span class="line"><span class="attr">            Admins:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('OrdererMSP.admin')"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="meta">&amp;Org1</span></span><br><span class="line"><span class="attr">        Name:</span> <span class="string">Org1MSP</span></span><br><span class="line"><span class="attr">        ID:</span> <span class="string">Org1MSP</span></span><br><span class="line"><span class="attr">        MSPDir:</span> <span class="string">crypto-config/peerOrganizations/org1.example.com/msp</span></span><br><span class="line"><span class="attr">        Policies:</span></span><br><span class="line"><span class="attr">            Readers:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('Org1MSP.admin', 'Org1MSP.peer', 'Org1MSP.client')"</span></span><br><span class="line"><span class="attr">            Writers:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('Org1MSP.admin', 'Org1MSP.client')"</span></span><br><span class="line"><span class="attr">            Admins:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('Org1MSP.admin')"</span></span><br><span class="line"><span class="attr">        AnchorPeers:</span></span><br><span class="line"><span class="attr">            - Host:</span> <span class="string">peer0.org1.example.com</span></span><br><span class="line"><span class="attr">              Port:</span> <span class="number">7051</span></span><br><span class="line"><span class="bullet">    -</span> <span class="meta">&amp;Org2</span></span><br><span class="line"><span class="attr">        Name:</span> <span class="string">Org2MSP</span></span><br><span class="line"><span class="attr">        ID:</span> <span class="string">Org2MSP</span></span><br><span class="line"><span class="attr">        MSPDir:</span> <span class="string">crypto-config/peerOrganizations/org2.example.com/msp</span></span><br><span class="line"><span class="attr">        Policies:</span></span><br><span class="line"><span class="attr">            Readers:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('Org2MSP.admin', 'Org2MSP.peer', 'Org2MSP.client')"</span></span><br><span class="line"><span class="attr">            Writers:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('Org2MSP.admin', 'Org2MSP.client')"</span></span><br><span class="line"><span class="attr">            Admins:</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">Signature</span></span><br><span class="line"><span class="attr">                Rule:</span> <span class="string">"OR('Org2MSP.admin')"</span></span><br><span class="line"><span class="attr">        AnchorPeers:</span></span><br><span class="line"><span class="attr">            - Host:</span> <span class="string">peer0.org2.example.com</span></span><br><span class="line"><span class="attr">              Port:</span> <span class="number">9051</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">Profiles:</span></span><br><span class="line"><span class="attr">    TwoOrgsOrdererGenesis:</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></span><br><span class="line"><span class="attr">        Orderer:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></span><br><span class="line"><span class="attr">            Organizations:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="meta">*OrdererOrg</span></span><br><span class="line"><span class="attr">            Capabilities:</span></span><br><span class="line">                <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererCapabilities</span></span><br><span class="line"><span class="attr">        Consortiums:</span></span><br><span class="line"><span class="attr">            SampleConsortium:</span></span><br><span class="line"><span class="attr">                Organizations:</span></span><br><span class="line"><span class="bullet">                    -</span> <span class="meta">*Org1</span></span><br><span class="line"><span class="bullet">                    -</span> <span class="meta">*Org2</span></span><br><span class="line"><span class="attr">    TwoOrgsChannel:</span></span><br><span class="line"><span class="attr">        Consortium:</span> <span class="string">SampleConsortium</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></span><br><span class="line"><span class="attr">        Application:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationDefaults</span></span><br><span class="line"><span class="attr">            Organizations:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="meta">*Org1</span></span><br><span class="line"><span class="bullet">                -</span> <span class="meta">*Org2</span></span><br><span class="line"><span class="attr">            Capabilities:</span></span><br><span class="line">                <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationCapabilities</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    SampleDevModeKafka:</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></span><br><span class="line"><span class="attr">        Capabilities:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelCapabilities</span></span><br><span class="line"><span class="attr">        Orderer:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></span><br><span class="line"><span class="attr">            OrdererType:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">            Kafka:</span></span><br><span class="line"><span class="attr">                Brokers:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">kafka.example.com:9092</span></span><br><span class="line"></span><br><span class="line"><span class="attr">            Organizations:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="meta">*OrdererOrg</span></span><br><span class="line"><span class="attr">            Capabilities:</span></span><br><span class="line">                <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererCapabilities</span></span><br><span class="line"><span class="attr">        Application:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationDefaults</span></span><br><span class="line"><span class="attr">            Organizations:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererOrg</span></span><br><span class="line"><span class="attr">        Consortiums:</span></span><br><span class="line"><span class="attr">            SampleConsortium:</span></span><br><span class="line"><span class="attr">                Organizations:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="meta">*Org1</span></span><br><span class="line"><span class="bullet">                -</span> <span class="meta">*Org2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    SampleMultiNodeEtcdRaft:</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></span><br><span class="line"><span class="attr">        Capabilities:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelCapabilities</span></span><br><span class="line"><span class="attr">        Orderer:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></span><br><span class="line"><span class="attr">            OrdererType:</span> <span class="string">etcdraft</span></span><br><span class="line"><span class="attr">            EtcdRaft:</span></span><br><span class="line"><span class="attr">                Consenters:</span></span><br><span class="line"><span class="attr">                - Host:</span> <span class="string">orderer.example.com</span></span><br><span class="line"><span class="attr">                  Port:</span> <span class="number">7050</span></span><br><span class="line"><span class="attr">                  ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                  ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                - Host:</span> <span class="string">orderer2.example.com</span></span><br><span class="line"><span class="attr">                  Port:</span> <span class="number">7050</span></span><br><span class="line"><span class="attr">                  ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                  ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                - Host:</span> <span class="string">orderer3.example.com</span></span><br><span class="line"><span class="attr">                  Port:</span> <span class="number">7050</span></span><br><span class="line"><span class="attr">                  ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                  ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                - Host:</span> <span class="string">orderer4.example.com</span></span><br><span class="line"><span class="attr">                  Port:</span> <span class="number">7050</span></span><br><span class="line"><span class="attr">                  ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                  ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                - Host:</span> <span class="string">orderer5.example.com</span></span><br><span class="line"><span class="attr">                  Port:</span> <span class="number">7050</span></span><br><span class="line"><span class="attr">                  ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">                  ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt</span></span><br><span class="line"><span class="attr">            Addresses:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">orderer.example.com:7050</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">orderer2.example.com:7050</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">orderer3.example.com:7050</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">orderer4.example.com:7050</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">orderer5.example.com:7050</span></span><br><span class="line"></span><br><span class="line"><span class="attr">            Organizations:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="meta">*OrdererOrg</span></span><br><span class="line"><span class="attr">            Capabilities:</span></span><br><span class="line">                <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererCapabilities</span></span><br><span class="line"><span class="attr">        Application:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationDefaults</span></span><br><span class="line"><span class="attr">            Organizations:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererOrg</span></span><br><span class="line"><span class="attr">        Consortiums:</span></span><br><span class="line"><span class="attr">            SampleConsortium:</span></span><br><span class="line"><span class="attr">                Organizations:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="meta">*Org1</span></span><br><span class="line"><span class="bullet">                -</span> <span class="meta">*Org2</span></span><br></pre></td></tr></table></figure>

<h3 id="Configure-Ordering-service-Kafka"><a href="#Configure-Ordering-service-Kafka" class="headerlink" title="Configure Ordering service (Kafka)"></a>Configure Ordering service (Kafka)</h3><ul>
<li><code>Orderer.OrdererType</code> is set to <code>kafka</code></li>
<li><code>Orderer.Kafka.Brokers</code></li>
<li><code>Orderer.AbsoluteMaxBytes</code></li>
</ul>
<p>kafka</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE=false</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">KAFKA_MIN_INSYNC_REPLICAS=1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">KAFKA_DEFAULT_REPLICATION_FACTOR=1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">KAFKA_MESSAGE_MAX_BYTES=1048576</span> <span class="comment"># 1 * 1024 * 1024 B</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">KAFKA_REPLICA_FETCH_MAX_BYTES=1048576</span> <span class="comment"># 1 * 1024 * 1024 B</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">KAFKA_LOG_RETENTION_MS=-1</span></span><br></pre></td></tr></table></figure>
<p>orderer</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TOPIC_REPLICATIONFACTOR=1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_VERBOSE=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_ENABLED=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_PRIVATEKEY_FILE=/var/hyperledger/orderer/kafka/tls/client.key</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_CERTIFICATE_FILE=/var/hyperledger/orderer/kafka/tls/client.crt</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_ROOTCAS_FILE=/var/hyperledger/orderer/kafka/tls/ca.crt</span></span><br></pre></td></tr></table></figure>
<h3 id="Configure-Hyperledger-Fabric-containers"><a href="#Configure-Hyperledger-Fabric-containers" class="headerlink" title="Configure Hyperledger Fabric containers"></a>Configure Hyperledger Fabric containers</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  peer-base:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-peer:$IMAGE_TAG</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></span><br><span class="line">      <span class="comment"># the following setting starts chaincode containers on the same</span></span><br><span class="line">      <span class="comment"># bridge network as the peers</span></span><br><span class="line">      <span class="comment"># https://docs.docker.com/compose/networking/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=$&#123;COMPOSE_PROJECT_NAME&#125;_byfn</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">FABRIC_LOGGING_SPEC=INFO</span></span><br><span class="line">      <span class="comment">#- FABRIC_LOGGING_SPEC=DEBUG</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_USELEADERELECTION=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_ORGLEADER=false</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_PROFILE_ENABLED=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=peer0.org1.example.com</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LISTENADDRESS=0.0.0.0:7051</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODEADDRESS=peer0.org1.example.com:7052</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org1.example.com:8051</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></span><br><span class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">peer</span> <span class="string">node</span> <span class="string">start</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  orderer-base:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-orderer:$IMAGE_TAG</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">FABRIC_LOGGING_SPEC=DEBUG</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_LISTENADDRESS=0.0.0.0</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_GENESISMETHOD=file</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_LOCALMSPID=OrdererMSP</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp</span></span><br><span class="line">      <span class="comment"># enabled TLS</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_ENABLED=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_KAFKA_TOPIC_REPLICATIONFACTOR=1</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_KAFKA_VERBOSE=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span></span><br><span class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">orderer</span></span><br></pre></td></tr></table></figure>
<h3 id="Define-network-config-options-block-creation-options-etc"><a href="#Define-network-config-options-block-creation-options-etc" class="headerlink" title="Define network config options (block creation options, etc)"></a>Define network config options (block creation options, etc)</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY29uZmlnX3VwZGF0ZS5odG1sI2VkaXRpbmctYS1jb25maWc=" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/config_update.html#editing-a-config">Docs » Operations Guides » Updating a Channel Configuration<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY2hhbm5lbF91cGRhdGVfdHV0b3JpYWwuaHRtbA==" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/channel_update_tutorial.html">Docs » Tutorials » Adding an Org to a Channel<i class="fa fa-external-link"></i></span></li>
</ul>
<p>configtx.yaml</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Orderer.BatchSize.absolute_max_bytes"</span>: <span class="number">102760448</span>,</span><br><span class="line">  <span class="attr">"Orderer.BatchSize.max_message_count"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">"Orderer.BatchSize.preferred_max_bytes"</span>: <span class="number">524288</span>,</span><br><span class="line">  <span class="attr">"Orderer.BatchTimeout"</span>: <span class="string">"2s"</span>,</span><br><span class="line">  "Orderer.MaxChannels": "1000", // defautl set 0 , this implies no maximum number of channels</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Enable-TLS-for-communication"><a href="#Enable-TLS-for-communication" class="headerlink" title="Enable TLS for communication"></a>Enable TLS for communication</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvZW5hYmxlX3Rscy5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/enable_tls.html">Docs » Operations Guides » Securing Communication With Transport Layer Security (TLS)<i class="fa fa-external-link"></i></span></li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># orderer </span></span><br><span class="line"><span class="comment"># enabled TLS</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_ENABLED=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span></span><br><span class="line"><span class="comment"># TLS client</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_CLIENTAUTHREQUIRED=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_CLIENTROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># enabled kafka client TLS</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_SERVER=kafkaserver</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_VERBOSE=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_ENABLED=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_PRIVATEKEY_FILE=/var/hyperledger/orderer/kafka/tls/client.key</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_CERTIFICATE_FILE=/var/hyperledger/orderer/kafka/tls/client.crt</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ORDERER_KAFKA_TLS_ROOTCAS_FILE=/var/hyperledger/orderer/kafka/tls/ca.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># peer</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt</span></span><br><span class="line"><span class="comment"># TLS client</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CLIENTAUTHREQUIRED=true</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CLIENTROOTCAS_FILES=</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CLIENTCERT_FILE=</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CLIENTKEY_FILE=</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CLI</span></span><br><span class="line"><span class="string">CORE_PEER_TLS_ENABLED</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">CORE_PEER_TLS_ROOTCERT_FILE=</span></span><br><span class="line"><span class="comment"># TLS client</span></span><br><span class="line"><span class="string">CORE_PEER_TLS_CLIENTAUTHREQUIRED</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">CORE_PEER_TLS_CLIENTCERT_FILE</span> <span class="string">=</span> </span><br><span class="line"><span class="string">CORE_PEER_TLS_CLIENTKEY_FILE</span> <span class="string">=</span></span><br></pre></td></tr></table></figure>

<h3 id="Generate-genesis-block"><a href="#Generate-genesis-block" class="headerlink" title="Generate genesis block"></a>Generate genesis block</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cryptogen	generate	--config=./crypto-config.yaml</span><br><span class="line"><span class="built_in">export</span>	FABRIC_CFG_PATH=<span class="variable">$PWD</span></span><br><span class="line">configtxgen -profile TwoOrgsOrdererGenesis -channelID byfn-sys-channel -outputBlock ./channel-artifacts/genesis.block</span><br><span class="line">configtxgen -profile SampleDevModeKafka -channelID byfn-sys-channel -outputBlock ./channel-artifacts/genesis.block</span><br></pre></td></tr></table></figure>

<h3 id="Configure-service-discovery-node-e-g-peer-and-orderer-addresses"><a href="#Configure-service-discovery-node-e-g-peer-and-orderer-addresses" class="headerlink" title="Configure service discovery node (e.g. peer and orderer addresses)"></a>Configure service discovery node (e.g. peer and orderer addresses)</h3><blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvZGlzY292ZXJ5LWNsaS5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/discovery-cli.html">Docs » Commands Reference » Service Discovery CLI<i class="fa fa-external-link"></i></span></p>
</blockquote>
<p><code>CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:8051</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">discover --configFile conf.yaml --peerTLSCA tls/ca.crt --userKey msp/keystore/ea4f6a38ac7057b6fa9502c2f5f39f182e320f71f667749100fe7dd94c23ce43_sk --userCert msp/signcerts/User1\@org1.example.com-cert.pem  --MSP Org1MSP saveConfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># Peer membership query</span></span><br><span class="line">discover --configFile conf.yaml peers --channel mychannel  --server peer0.org1.example.com:7051</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuration query</span></span><br><span class="line">discover --configFile conf.yaml config --channel mychannel  --server peer0.org1.example.com:7051</span><br><span class="line"><span class="comment"># certificates base64 decoded</span></span><br><span class="line">discover --configFile conf.yaml config --channel mychannel  --server peer0.org1.example.com:7051 | jq .msps.OrdererOrg.root_certs[0] | sed <span class="string">"s/\"//g"</span> | base64 --decode | openssl x509 -text -noout</span><br><span class="line"></span><br><span class="line"><span class="comment"># Endorsers query</span></span><br><span class="line">discover --configFile conf.yaml endorsers --channel mychannel  --server peer0.org1.example.com:7051 --chaincode mycc</span><br></pre></td></tr></table></figure>

<h2 id="Membership-Service-Provider-–-20"><a href="#Membership-Service-Provider-–-20" class="headerlink" title="Membership Service Provider – 20%"></a>Membership Service Provider – 20%</h2><h3 id="Configure-ACL"><a href="#Configure-ACL" class="headerlink" title="Configure ACL"></a>Configure ACL</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvYWNjZXNzX2NvbnRyb2wuaHRtbA==" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/access_control.html">https://hyperledger-fabric.readthedocs.io/en/release-1.4/access_control.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h5cGVybGVkZ2VyL2ZhYnJpYy9ibG9iL3JlbGVhc2UtMS4yL3NhbXBsZWNvbmZpZy9jb25maWd0eC55YW1s" title="https://github.com/hyperledger/fabric/blob/release-1.2/sampleconfig/configtx.yaml">https://github.com/hyperledger/fabric/blob/release-1.2/sampleconfig/configtx.yaml<i class="fa fa-external-link"></i></span></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Application:</span> <span class="meta">&amp;ApplicationDefaults</span></span><br><span class="line"><span class="attr">    ACLs:</span> <span class="meta">&amp;ACLsDefault</span></span><br><span class="line">        <span class="comment"># This section provides defaults for policies for various resources</span></span><br><span class="line">        <span class="comment"># in the system. These "resources" could be functions on system chaincodes</span></span><br><span class="line">        <span class="comment"># (e.g., "GetBlockByNumber" on the "qscc" system chaincode) or other resources</span></span><br><span class="line">        <span class="comment"># (e.g.,who can receive Block events). This section does NOT specify the resource's</span></span><br><span class="line">        <span class="comment"># definition or API, but just the ACL policy for it.</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># User's can override these defaults with their own policy mapping by defining the</span></span><br><span class="line">        <span class="comment"># mapping under ACLs in their channel definition</span></span><br><span class="line">        <span class="comment">#---Lifecycle System Chaincode (lscc) function to policy mapping for access control---#</span></span><br><span class="line">        <span class="comment"># ACL policy for lscc's "getid" function</span></span><br><span class="line">        <span class="string">lscc/ChaincodeExists:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for lscc's "getdepspec" function</span></span><br><span class="line">        <span class="string">lscc/GetDeploymentSpec:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for lscc's "getccdata" function</span></span><br><span class="line">        <span class="string">lscc/GetChaincodeData:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL Policy for lscc's "getchaincodes" function</span></span><br><span class="line">        <span class="string">lscc/GetInstantiatedChaincodes:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment">#---Query System Chaincode (qscc) function to policy mapping for access control---#</span></span><br><span class="line">        <span class="comment"># ACL policy for qscc's "GetChainInfo" function</span></span><br><span class="line">        <span class="string">qscc/GetChainInfo:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for qscc's "GetBlockByNumber" function</span></span><br><span class="line">        <span class="string">qscc/GetBlockByNumber:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for qscc's  "GetBlockByHash" function</span></span><br><span class="line">        <span class="string">qscc/GetBlockByHash:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for qscc's "GetTransactionByID" function</span></span><br><span class="line">        <span class="string">qscc/GetTransactionByID:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for qscc's "GetBlockByTxID" function</span></span><br><span class="line">        <span class="string">qscc/GetBlockByTxID:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment">#---Configuration System Chaincode (cscc) function to policy mapping for access control---#</span></span><br><span class="line">        <span class="comment"># ACL policy for cscc's "GetConfigBlock" function</span></span><br><span class="line">        <span class="string">cscc/GetConfigBlock:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for cscc's "GetConfigTree" function</span></span><br><span class="line">        <span class="string">cscc/GetConfigTree:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for cscc's "SimulateConfigTreeUpdate" function</span></span><br><span class="line">        <span class="string">cscc/SimulateConfigTreeUpdate:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment">#---Miscellanesous peer function to policy mapping for access control---#</span></span><br><span class="line">        <span class="comment"># ACL policy for invoking chaincodes on peer</span></span><br><span class="line">        <span class="string">peer/Propose:</span> <span class="string">/Channel/Application/Writers</span></span><br><span class="line">        <span class="comment"># ACL policy for chaincode to chaincode invocation</span></span><br><span class="line">        <span class="string">peer/ChaincodeToChaincode:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment">#---Events resource to policy mapping for access control###---#</span></span><br><span class="line">        <span class="comment"># ACL policy for sending block events</span></span><br><span class="line">        <span class="string">event/Block:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">        <span class="comment"># ACL policy for sending filtered block events</span></span><br><span class="line">        <span class="string">event/FilteredBlock:</span> <span class="string">/Channel/Application/Readers</span></span><br><span class="line">    <span class="comment"># Organizations lists the orgs participating on the application side of the</span></span><br><span class="line">    <span class="comment"># network.</span></span><br><span class="line"><span class="attr">    Organizations:</span></span><br><span class="line">    <span class="comment"># Policies defines the set of policies at this level of the config tree</span></span><br><span class="line">    <span class="comment"># For Application policies, their canonical path is</span></span><br><span class="line">    <span class="comment">#   /Channel/Application/&lt;PolicyName&gt;</span></span><br><span class="line"><span class="attr">    Policies:</span> <span class="meta">&amp;ApplicationDefaultPolicies</span></span><br><span class="line"><span class="attr">        Readers:</span></span><br><span class="line"><span class="attr">            Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line"><span class="attr">            Rule:</span> <span class="string">"ANY Readers"</span></span><br><span class="line"><span class="attr">        Writers:</span></span><br><span class="line"><span class="attr">            Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line"><span class="attr">            Rule:</span> <span class="string">"ANY Writers"</span></span><br><span class="line"><span class="attr">        Admins:</span></span><br><span class="line"><span class="attr">            Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line"><span class="attr">            Rule:</span> <span class="string">"MAJORITY Admins"</span></span><br></pre></td></tr></table></figure>

<h3 id="Create-end-user-identity"><a href="#Create-end-user-identity" class="headerlink" title="Create end user identity"></a>Create end user identity</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=<span class="variable">$HOME</span>/fabric-ca/clients/admin</span><br><span class="line">fabric-ca-client enroll -u http://admin:adminpw@localhost:7054</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=<span class="variable">$HOME</span>/fabric-ca/clients/admin</span><br><span class="line">fabric-ca-client register --id.name admin2 --id.affiliation org1.department1 --id.attrs <span class="string">'hf.Revoker=true,admin=true:ecert'</span></span><br><span class="line"></span><br><span class="line">fabric-ca-client register -d --id.name admin2 --id.affiliation org1.department1 --id.attrs <span class="string">'"hf.Registrar.Roles=peer,client",hf.Revoker=true'</span></span><br><span class="line">fabric-ca-client register -d --id.name admin2 --id.affiliation org1.department1 --id.attrs <span class="string">'"hf.Registrar.Roles=peer,client"'</span> --id.attrs hf.Revoker=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=<span class="variable">$HOME</span>/fabric-ca/clients/admin</span><br><span class="line">fabric-ca-client register --id.name peer1 --id.type peer --id.affiliation org1.department1 --id.secret peer1pw</span><br><span class="line">fabric-ca-client register --id.name client1 --id.type client --id.affiliation bu1.department1.Team1</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=<span class="variable">$HOME</span>/fabric-ca/clients/peer1</span><br><span class="line">fabric-ca-client enroll -u http://peer1:peer1pw@localhost:7054 -M <span class="variable">$FABRIC_CA_CLIENT_HOME</span>/msp</span><br></pre></td></tr></table></figure>
<h3 id="Revoke-an-identity"><a href="#Revoke-an-identity" class="headerlink" title="Revoke an identity"></a>Revoke an identity</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">fabric-ca-client revoke -e &lt;enrollment_id&gt; -r &lt;reason&gt;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=<span class="variable">$HOME</span>/fabric-ca/clients/admin</span><br><span class="line">fabric-ca-client revoke -e peer1</span><br><span class="line"></span><br><span class="line">serial=$(openssl x509 -<span class="keyword">in</span> userecert.pem -serial -noout | cut -d <span class="string">"="</span> -f 2)</span><br><span class="line">aki=$(openssl x509 -<span class="keyword">in</span> userecert.pem -text | awk <span class="string">'/keyid/ &#123;gsub(/ *keyid:|:/,"",$1);print tolower($0)&#125;'</span>)</span><br><span class="line">fabric-ca-client revoke -s <span class="variable">$serial</span> -a <span class="variable">$aki</span> -r affiliationchange</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generating a CRL (Certificate Revocation List)</span></span><br><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=~/clientconfig</span><br><span class="line">fabric-ca-client gencrl -M ~/msp</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=~/clientconfig</span><br><span class="line">fabric-ca-client gencrl --caname <span class="string">""</span> --revokedafter 2017-09-13T16:39:57-08:00 --revokedbefore 2017-09-21T16:39:57-08:00 -M ~/msp</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FABRIC_CA_CLIENT_HOME=~/clientconfig</span><br><span class="line">fabric-ca-client gencrl --caname <span class="string">""</span> --expireafter 2017-09-13T16:39:57-08:00 --expirebefore 2018-09-13T16:39:57-08:00  --revokedafter 2017-09-13T16:39:57-08:00 --revokedbefore 2017-09-21T16:39:57-08:00 -M ~/msp</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Attribute-Based Access Control</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">fabric-ca-client register --id.name user1 --id.secret user1pw --id.type client --id.affiliation org1 --id.attrs <span class="string">'app1Admin=true:ecert,email=user1@gmail.com'</span></span><br><span class="line"></span><br><span class="line">fabric-ca-client enroll -u http://user1:user1pw@localhost:7054 --enrollment.attrs <span class="string">"email,phone:opt"</span></span><br><span class="line"></span><br><span class="line">fabric-ca-client register --id.name user1 --id.secret user1pw --id.type client --id.affiliation org1 --id.attrs <span class="string">'hf.Affiliation=org1:ecert'</span></span><br></pre></td></tr></table></figure>

<h3 id="Configure-and-start-Hyperledger-Fabric-CA"><a href="#Configure-and-start-Hyperledger-Fabric-CA" class="headerlink" title="Configure and start Hyperledger Fabric CA"></a>Configure and start Hyperledger Fabric CA</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMtY2EucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvc2VydmVyY29uZmlnLmh0bWw=" title="https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/serverconfig.html">https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/serverconfig.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMtY2EucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY2xpZW50Y29uZmlnLmh0bWw=" title="https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/clientconfig.html">https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/clientconfig.html<i class="fa fa-external-link"></i></span><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">1.4</span><span class="number">.1</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">7054</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    origins:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"*"</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">crlsizelimit:</span> <span class="number">512000</span></span><br><span class="line"><span class="attr">tls:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  certfile:</span></span><br><span class="line"><span class="attr">  keyfile:</span></span><br><span class="line"><span class="attr">  clientauth:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">noclientcert</span></span><br><span class="line"><span class="attr">    certfiles:</span></span><br><span class="line"><span class="attr">ca:</span></span><br><span class="line"><span class="attr">  name:</span></span><br><span class="line"><span class="attr">  keyfile:</span></span><br><span class="line"><span class="attr">  certfile:</span></span><br><span class="line"><span class="attr">  chainfile:</span></span><br><span class="line"><span class="attr">crl:</span></span><br><span class="line"><span class="attr">  expiry:</span> <span class="number">24</span><span class="string">h</span></span><br><span class="line"><span class="attr">registry:</span></span><br><span class="line"><span class="attr">  maxenrollments:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">  identities:</span></span><br><span class="line"><span class="attr">     - name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">       pass:</span> <span class="string">adminpw</span></span><br><span class="line"><span class="attr">       type:</span> <span class="string">client</span></span><br><span class="line"><span class="attr">       affiliation:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">       attrs:</span></span><br><span class="line">          <span class="string">hf.Registrar.Roles:</span> <span class="string">"*"</span></span><br><span class="line">          <span class="string">hf.Registrar.DelegateRoles:</span> <span class="string">"*"</span></span><br><span class="line">          <span class="string">hf.Revoker:</span> <span class="literal">true</span></span><br><span class="line">          <span class="string">hf.IntermediateCA:</span> <span class="literal">true</span></span><br><span class="line">          <span class="string">hf.GenCRL:</span> <span class="literal">true</span></span><br><span class="line">          <span class="string">hf.Registrar.Attributes:</span> <span class="string">"*"</span></span><br><span class="line">          <span class="string">hf.AffiliationMgr:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">db:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">sqlite3</span></span><br><span class="line"><span class="attr">  datasource:</span> <span class="string">fabric-ca-server.db</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      certfiles:</span></span><br><span class="line"><span class="attr">      client:</span></span><br><span class="line"><span class="attr">        certfile:</span></span><br><span class="line"><span class="attr">        keyfile:</span></span><br><span class="line"><span class="attr">ldap:</span></span><br><span class="line"><span class="attr">   enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">   url:</span> <span class="attr">ldap://&lt;adminDN&gt;:&lt;adminPassword&gt;@&lt;host&gt;:&lt;port&gt;/&lt;base&gt;</span></span><br><span class="line"><span class="attr">   tls:</span></span><br><span class="line"><span class="attr">      certfiles:</span></span><br><span class="line"><span class="attr">      client:</span></span><br><span class="line"><span class="attr">         certfile:</span></span><br><span class="line"><span class="attr">         keyfile:</span></span><br><span class="line"><span class="attr">   attribute:</span></span><br><span class="line"><span class="attr">      names:</span> <span class="string">['uid','member']</span></span><br><span class="line"><span class="attr">      converters:</span></span><br><span class="line"><span class="attr">         - name:</span></span><br><span class="line"><span class="attr">           value:</span></span><br><span class="line"><span class="attr">      maps:</span></span><br><span class="line"><span class="attr">         groups:</span></span><br><span class="line"><span class="attr">            - name:</span></span><br><span class="line"><span class="attr">              value:</span></span><br><span class="line"><span class="attr">affiliations:</span></span><br><span class="line"><span class="attr">   org1:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">department1</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">department2</span></span><br><span class="line"><span class="attr">   org2:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">department1</span></span><br><span class="line"><span class="attr">signing:</span></span><br><span class="line"><span class="attr">    default:</span></span><br><span class="line"><span class="attr">      usage:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">digital</span> <span class="string">signature</span></span><br><span class="line"><span class="attr">      expiry:</span> <span class="number">8760</span><span class="string">h</span></span><br><span class="line"><span class="attr">    profiles:</span></span><br><span class="line"><span class="attr">      ca:</span></span><br><span class="line"><span class="attr">         usage:</span></span><br><span class="line"><span class="bullet">           -</span> <span class="string">cert</span> <span class="string">sign</span></span><br><span class="line"><span class="bullet">           -</span> <span class="string">crl</span> <span class="string">sign</span></span><br><span class="line"><span class="attr">         expiry:</span> <span class="number">43800</span><span class="string">h</span></span><br><span class="line"><span class="attr">         caconstraint:</span></span><br><span class="line"><span class="attr">           isca:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">           maxpathlen:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      tls:</span></span><br><span class="line"><span class="attr">         usage:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">signing</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">key</span> <span class="string">encipherment</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">server</span> <span class="string">auth</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">client</span> <span class="string">auth</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">key</span> <span class="string">agreement</span></span><br><span class="line"><span class="attr">         expiry:</span> <span class="number">8760</span><span class="string">h</span></span><br><span class="line"><span class="attr">csr:</span></span><br><span class="line"><span class="attr">   cn:</span> <span class="string">fabric-ca-server</span></span><br><span class="line"><span class="attr">   keyrequest:</span></span><br><span class="line"><span class="attr">     algo:</span> <span class="string">ecdsa</span></span><br><span class="line"><span class="attr">     size:</span> <span class="number">256</span></span><br><span class="line"><span class="attr">   names:</span></span><br><span class="line"><span class="attr">      - C:</span> <span class="string">US</span></span><br><span class="line"><span class="attr">        ST:</span> <span class="string">"North Carolina"</span></span><br><span class="line"><span class="attr">        L:</span></span><br><span class="line"><span class="attr">        O:</span> <span class="string">Hyperledger</span></span><br><span class="line"><span class="attr">        OU:</span> <span class="string">Fabric</span></span><br><span class="line"><span class="attr">   hosts:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">db1216d39a1d</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">   ca:</span></span><br><span class="line"><span class="attr">      expiry:</span> <span class="number">131400</span><span class="string">h</span></span><br><span class="line"><span class="attr">      pathlength:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">idemix:</span></span><br><span class="line"><span class="attr">  rhpoolsize:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">  nonceexpiration:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  noncesweepinterval:</span> <span class="number">15</span><span class="string">m</span></span><br><span class="line"><span class="attr">bccsp:</span></span><br><span class="line"><span class="attr">    default:</span> <span class="string">SW</span></span><br><span class="line"><span class="attr">    sw:</span></span><br><span class="line"><span class="attr">        hash:</span> <span class="string">SHA2</span></span><br><span class="line"><span class="attr">        security:</span> <span class="number">256</span></span><br><span class="line"><span class="attr">        filekeystore:</span></span><br><span class="line"><span class="attr">            keystore:</span> <span class="string">msp/keystore</span></span><br><span class="line"><span class="attr">cacount:</span></span><br><span class="line"><span class="attr">cafiles:</span></span><br><span class="line"><span class="attr">intermediate:</span></span><br><span class="line"><span class="attr">  parentserver:</span></span><br><span class="line"><span class="attr">    url:</span></span><br><span class="line"><span class="attr">    caname:</span></span><br><span class="line"><span class="attr">  enrollment:</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="attr">    profile:</span></span><br><span class="line"><span class="attr">    label:</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">    certfiles:</span></span><br><span class="line"><span class="attr">    client:</span></span><br><span class="line"><span class="attr">      certfile:</span></span><br><span class="line"><span class="attr">      keyfile:</span></span><br><span class="line"><span class="attr">cfg:</span></span><br><span class="line"><span class="attr">  identities:</span></span><br><span class="line"><span class="attr">    passwordattempts:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">operations:</span></span><br><span class="line"><span class="attr">    listenAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9443</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        cert:</span></span><br><span class="line"><span class="attr">            file:</span></span><br><span class="line"><span class="attr">        key:</span></span><br><span class="line"><span class="attr">            file:</span></span><br><span class="line"><span class="attr">        clientAuthRequired:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        clientRootCAs:</span></span><br><span class="line"><span class="attr">            files:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">metrics:</span></span><br><span class="line"><span class="attr">    provider:</span> <span class="string">disabled</span></span><br><span class="line"><span class="attr">    statsd:</span></span><br><span class="line"><span class="attr">        network:</span> <span class="string">udp</span></span><br><span class="line"><span class="attr">        address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8125</span></span><br><span class="line"><span class="attr">        writeInterval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">        prefix:</span> <span class="string">server</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cn:</span> <span class="string">fabric-ca-server</span></span><br><span class="line"><span class="attr">names:</span></span><br><span class="line"><span class="attr">   - C:</span> <span class="string">US</span></span><br><span class="line"><span class="attr">     ST:</span> <span class="string">"North Carolina"</span></span><br><span class="line"><span class="attr">     L:</span></span><br><span class="line"><span class="attr">     O:</span> <span class="string">Hyperledger</span></span><br><span class="line"><span class="attr">     OU:</span> <span class="string">Fabric</span></span><br><span class="line"><span class="attr">hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">host1.example.com</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">ca:</span></span><br><span class="line"><span class="attr">   expiry:</span> <span class="number">131400</span><span class="string">h</span></span><br><span class="line"><span class="attr">   pathlength:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">fabric-ca-server init -b admin:adminpw</span><br><span class="line">fabric-ca-server start -b &lt;admin&gt;:&lt;adminpw&gt;</span><br><span class="line">fabric-ca-server start -b admin:adminpw --cfg.affiliations.allowremove --cfg.identities.allowremove</span><br></pre></td></tr></table></figure>

<h3 id="Configure-Hyperledger-Fabric-for-hardware-security-module"><a href="#Configure-Hyperledger-Fabric-for-hardware-security-module" class="headerlink" title="Configure Hyperledger Fabric for hardware security module"></a>Configure Hyperledger Fabric for hardware security module</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#############################################################################</span></span><br><span class="line"><span class="comment"># BCCSP (BlockChain Crypto Service Provider) section is used to select which</span></span><br><span class="line"><span class="comment"># crypto library implementation to use</span></span><br><span class="line"><span class="comment">#############################################################################</span></span><br><span class="line"><span class="attr">bccsp:</span></span><br><span class="line"><span class="attr">  default:</span> <span class="string">PKCS11</span></span><br><span class="line"><span class="attr">  pkcs11:</span></span><br><span class="line"><span class="attr">    Library:</span> <span class="string">/usr/local/Cellar/softhsm/2.1.0/lib/softhsm/libsofthsm2.so</span></span><br><span class="line"><span class="attr">    Pin:</span> <span class="number">98765432</span></span><br><span class="line"><span class="attr">    Label:</span> <span class="string">ForFabric</span></span><br><span class="line"><span class="attr">    hash:</span> <span class="string">SHA2</span></span><br><span class="line"><span class="attr">    security:</span> <span class="number">256</span></span><br><span class="line"><span class="attr">    filekeystore:</span></span><br><span class="line">      <span class="comment"># The directory used for the software file-based keystore</span></span><br><span class="line"><span class="attr">      keystore:</span> <span class="string">msp/keystore</span></span><br></pre></td></tr></table></figure>

<h2 id="Network-Maintenance-and-Operations-–-20"><a href="#Network-Maintenance-and-Operations-–-20" class="headerlink" title="Network Maintenance and Operations – 20%"></a>Network Maintenance and Operations – 20%</h2><h3 id="Add-a-peer-to-existing-organization"><a href="#Add-a-peer-to-existing-organization" class="headerlink" title="Add a peer to existing organization"></a>Add a peer to existing organization</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem &amp;&amp; <span class="built_in">export</span> CHANNEL_NAME=mychannel</span><br><span class="line">peer channel fetch 0 mychannel.block -o orderer.example.com:7050 -c <span class="variable">$CHANNEL_NAME</span> --tls --cafile <span class="variable">$ORDERER_CA</span></span><br><span class="line">peer channel join -b <span class="variable">$CHANNEL_NAME</span>.block</span><br></pre></td></tr></table></figure>
<h3 id="Create-a-channel"><a href="#Create-a-channel" class="headerlink" title="Create a channel"></a>Create a channel</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvYnVpbGRfbmV0d29yay5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/build_network.html">Docs » Tutorials » Building Your First Network<i class="fa fa-external-link"></i></span></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span><br><span class="line">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><br><span class="line">CORE_PEER_LOCALMSPID=<span class="string">"Org1MSP"</span></span><br><span class="line">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span><br><span class="line"></span><br><span class="line">peer channel create -o orderer.example.com:7050 -c <span class="variable">$CHANNEL_NAME</span> -f ./channel-artifacts/channel.tx</span><br><span class="line">peer channel create -o orderer.example.com:7050 -c <span class="variable">$CHANNEL_NAME</span> -f ./channel-artifacts/channel.tx --tls <span class="variable">$CORE_PEER_TLS_ENABLED</span> --cafile</span><br><span class="line">peer channel join -b <span class="variable">$CHANNEL_NAME</span>.block</span><br><span class="line">peer channel list &amp;&gt;channel-list.txt</span><br></pre></td></tr></table></figure>
<h3 id="Add-an-org-to-a-channel"><a href="#Add-an-org-to-a-channel" class="headerlink" title="Add an org to a channel"></a>Add an org to a channel</h3><p><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY2hhbm5lbF91cGRhdGVfdHV0b3JpYWwuaHRtbA==" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/channel_update_tutorial.html">Docs » Tutorials » Adding an Org to a Channel<i class="fa fa-external-link"></i></span></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> org3-artifacts</span><br><span class="line">../../bin/cryptogen generate --config=./org3-crypto.yaml</span><br><span class="line"><span class="built_in">export</span> FABRIC_CFG_PATH=<span class="variable">$PWD</span> &amp;&amp; ../../bin/configtxgen -printOrg Org3MSP &gt; ../channel-artifacts/org3.json</span><br><span class="line"><span class="built_in">cd</span> ../ &amp;&amp; cp -r crypto-config/ordererOrganizations org3-artifacts/crypto-config/</span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it cli bash</span><br><span class="line"><span class="built_in">export</span> ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem  &amp;&amp; <span class="built_in">export</span> CHANNEL_NAME=mychannel</span><br><span class="line">peer channel fetch config config_block.pb -o orderer.example.com:7050 -c <span class="variable">$CHANNEL_NAME</span> --tls --cafile <span class="variable">$ORDERER_CA</span></span><br><span class="line"></span><br><span class="line">configtxlator proto_decode --input config_block.pb --<span class="built_in">type</span> common.Block | jq .data.data[0].payload.data.config &gt; config.json</span><br><span class="line"></span><br><span class="line">jq -s <span class="string">'.[0] * &#123;"channel_group":&#123;"groups":&#123;"Application":&#123;"groups": &#123;"Org3MSP":.[1]&#125;&#125;&#125;&#125;&#125;'</span> config.json ./channel-artifacts/org3.json &gt; modified_config.json</span><br><span class="line">configtxlator proto_encode --input config.json --<span class="built_in">type</span> common.Config --output config.pb</span><br><span class="line">configtxlator proto_encode --input modified_config.json --<span class="built_in">type</span> common.Config --output modified_config.pb</span><br><span class="line">configtxlator compute_update --channel_id <span class="variable">$CHANNEL_NAME</span> --original config.pb --updated modified_config.pb --output org3_update.pb</span><br><span class="line">configtxlator proto_decode --input org3_update.pb --<span class="built_in">type</span> common.ConfigUpdate | jq . &gt; org3_update.json</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'&#123;"payload":&#123;"header":&#123;"channel_header":&#123;"channel_id":"'</span><span class="variable">$CHANNEL_NAME</span><span class="string">'", "type":2&#125;&#125;,"data":&#123;"config_update":'</span>$(cat org3_update.json)<span class="string">'&#125;&#125;&#125;'</span> | jq . &gt; org3_update_in_envelope.json</span><br><span class="line">configtxlator proto_encode --input org3_update_in_envelope.json --<span class="built_in">type</span> common.Envelope --output org3_update_in_envelope.pb</span><br><span class="line"></span><br><span class="line">peer channel signconfigtx -f org3_update_in_envelope.pb</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can issue all of these commands at once</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_LOCALMSPID=<span class="string">"Org2MSP"</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt</span><br><span class="line"><span class="built_in">export</span> CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp</span><br><span class="line"><span class="built_in">export</span> CORE_PEER_ADDRESS=peer0.org2.example.com:9051</span><br><span class="line"></span><br><span class="line">peer channel update -f org3_update_in_envelope.pb -c <span class="variable">$CHANNEL_NAME</span> -o orderer.example.com:7050 --tls --cafile <span class="variable">$ORDERER_CA</span></span><br><span class="line"></span><br><span class="line">docker-compose -f docker-compose-org3.yaml up -d</span><br><span class="line">docker <span class="built_in">exec</span> -it Org3cli bash</span><br><span class="line"><span class="built_in">export</span> ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem &amp;&amp; <span class="built_in">export</span> CHANNEL_NAME=mychannel</span><br><span class="line">peer channel fetch 0 mychannel.block -o orderer.example.com:7050 -c <span class="variable">$CHANNEL_NAME</span> --tls --cafile <span class="variable">$ORDERER_CA</span></span><br><span class="line">peer channel join -b mychannel.block</span><br><span class="line"><span class="comment"># switch peer1.org3</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer1.org3.example.com/tls/ca.crt &amp;&amp; <span class="built_in">export</span> CORE_PEER_ADDRESS=peer1.org3.example.com:12051</span><br><span class="line">peer channel join -b mychannel.block</span><br></pre></td></tr></table></figure>

<h3 id="Update-channel-configuration"><a href="#Update-channel-configuration" class="headerlink" title="Update channel configuration"></a>Update channel configuration</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvY29uZmlnX3VwZGF0ZS5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/config_update.html">Docs » Operations Guides » Updating a Channel Configuration<i class="fa fa-external-link"></i></span><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> MAXBATCHSIZEPATH=<span class="string">".channel_group.groups.Orderer.values.BatchSize.value.max_message_count"</span></span><br><span class="line">jq <span class="string">"<span class="variable">$MAXBATCHSIZEPATH</span>"</span> config.json</span><br><span class="line">jq <span class="string">"<span class="variable">$MAXBATCHSIZEPATH</span> = 20"</span> config.json &gt; modified_config.json</span><br><span class="line">jq <span class="string">"<span class="variable">$MAXBATCHSIZEPATH</span>"</span> modified_config.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the Necessary Signatures</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_LOCALMSPID=<span class="string">"OrdererMSP"</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><br><span class="line"><span class="built_in">export</span> CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer channel signconfigtx -f</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Update-a-Hyperledger-Fabric-Instance"><a href="#Update-a-Hyperledger-Fabric-Instance" class="headerlink" title="Update a Hyperledger Fabric Instance"></a>Update a Hyperledger Fabric Instance</h3><p><span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvdXBncmFkaW5nX3lvdXJfbmV0d29ya190dXRvcmlhbC5odG1s" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/upgrading_your_network_tutorial.html">Docs » Tutorials » Upgrading Your Network Components<i class="fa fa-external-link"></i></span></p>
<ol>
<li>Clean up<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./byfn.sh down</span><br></pre></td></tr></table></figure></li>
<li>Generate the crypto and bring up the network<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git fetch origin</span><br><span class="line"></span><br><span class="line">git checkout v1.3.0</span><br><span class="line"></span><br><span class="line">./byfn.sh generate</span><br><span class="line"></span><br><span class="line">./byfn.sh up -t 3000 -i 1.3.0</span><br></pre></td></tr></table></figure></li>
<li>Get the newest samples<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git checkout v1.4.1</span><br></pre></td></tr></table></figure></li>
<li>Upgrade the orderer containers<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> CH_NAME=testchainid</span><br><span class="line"></span><br><span class="line">docker stop orderer.example.com</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LEDGERS_BACKUP=./ledgers-backup</span><br><span class="line"><span class="built_in">export</span> IMAGE_TAG=$(go env GOARCH)-1.4.1</span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$LEDGERS_BACKUP</span></span><br><span class="line"></span><br><span class="line">docker cp orderer.example.com:/var/hyperledger/production/orderer/ ./<span class="variable">$LEDGERS_BACKUP</span>/orderer.example.com</span><br><span class="line"></span><br><span class="line">docker-compose -f docker-compose-cli.yaml up -d --no-deps orderer.example.com</span><br></pre></td></tr></table></figure></li>
<li>Upgrade the peer containers<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker stop peer0.org1.example.com</span><br><span class="line">mkdir -p <span class="variable">$LEDGERS_BACKUP</span></span><br><span class="line"></span><br><span class="line">docker cp <span class="variable">$PEER</span>:/var/hyperledger/production ./<span class="variable">$LEDGERS_BACKUP</span>/<span class="variable">$PEER</span></span><br><span class="line"></span><br><span class="line">CC_CONTAINERS=$(docker ps | grep dev-<span class="variable">$PEER</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$CC_CONTAINERS</span>"</span> ] ; <span class="keyword">then</span> docker rm -f <span class="variable">$CC_CONTAINERS</span> ; <span class="keyword">fi</span></span><br><span class="line">CC_IMAGES=$(docker images | grep dev-<span class="variable">$PEER</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$CC_IMAGES</span>"</span> ] ; <span class="keyword">then</span> docker rmi -f <span class="variable">$CC_IMAGES</span> ; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">docker-compose -f docker-compose-cli.yaml up -d --no-deps <span class="variable">$PEER</span></span><br></pre></td></tr></table></figure></li>
<li>Verify peer upgrade completion<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker-compose -f docker-compose-cli.yaml stop cli</span><br><span class="line"></span><br><span class="line">docker-compose -f docker-compose-cli.yaml up -d --no-deps cli</span><br><span class="line"></span><br><span class="line">CH_NAME=mychannel</span><br><span class="line">ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</span><br><span class="line"></span><br><span class="line">peer chaincode invoke -o orderer.example.com:7050 --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses peer0.org2.example.com:9051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt --tls --cafile <span class="variable">$ORDERER_CA</span> -C <span class="variable">$CH_NAME</span> -n mycc -c <span class="string">'&#123;"Args":["invoke","a","b","10"]&#125;'</span></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n mycc -c <span class="string">'&#123;"Args":["query","a"]&#125;'</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Diagnostics-and-Troubleshooting-–-15"><a href="#Diagnostics-and-Troubleshooting-–-15" class="headerlink" title="Diagnostics and Troubleshooting – 15%"></a>Diagnostics and Troubleshooting – 15%</h2><h3 id="Query-and-analyse-peer-logs"><a href="#Query-and-analyse-peer-logs" class="headerlink" title="Query and analyse peer logs"></a>Query and analyse peer logs</h3><h3 id="Query-and-analyse-CA-logs"><a href="#Query-and-analyse-CA-logs" class="headerlink" title="Query and analyse CA logs"></a>Query and analyse CA logs</h3><h3 id="Query-and-analyse-Orderer-logs"><a href="#Query-and-analyse-Orderer-logs" class="headerlink" title="Query and analyse Orderer logs"></a>Query and analyse Orderer logs</h3><h3 id="Query-and-analyse-chaincode-logs"><a href="#Query-and-analyse-chaincode-logs" class="headerlink" title="Query and analyse chaincode logs"></a>Query and analyse chaincode logs</h3><h1 id="CHFA-Environment"><a href="#CHFA-Environment" class="headerlink" title="CHFA Environment"></a>CHFA Environment</h1><ul>
<li>Each task on this exam must be completed on a designated Fabric node, most of which run<br>Fabric under ​docker/docker-compose​.</li>
<li>Most​ of the networks are based off of ​byfn​ with configuration files located under <code>/srv/fabric-samples​</code>, unless otherwise noted in the instructions.</li>
<li>For most tasks, you can connect to the CLI node with a command such as:<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it cli bash</span><br></pre></td></tr></table></figure></li>
<li>At the start of each task, you will be directed to which Fabric node you should ​ssh​ to in order to complete the task.</li>
<li>You can ssh to a Fabric node with a command such as:<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ssh fabadm@&lt;nodename&gt;</span><br></pre></td></tr></table></figure></li>
<li>The ​fabadm​ user should be used for all tasks, unless otherwise indicated.</li>
<li>You can assume elevated privileges on any node by issuing the following command:<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo -i</span><br></pre></td></tr></table></figure></li>
<li>You can also use ​sudo​ to execute commands with elevated privileges at any time.</li>
<li>You must return to the base node (hostname ​node-1​) after completing each task.</li>
<li>The exam is based on Fabric v1.4</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li>官网： <span class="exturl" data-url="aHR0cHM6Ly90cmFpbmluZy5saW51eGZvdW5kYXRpb24ub3JnL2NlcnRpZmljYXRpb24vY2VydGlmaWVkLWh5cGVybGVkZ2VyLWZhYnJpYy1hZG1pbmlzdHJhdG9yLWNoZmEv" title="https://training.linuxfoundation.org/certification/certified-hyperledger-fabric-administrator-chfa/">https://training.linuxfoundation.org/certification/certified-hyperledger-fabric-administrator-chfa/<i class="fa fa-external-link"></i></span></li>
<li>fabric 文档： <span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvdHV0b3JpYWxzLmh0bWw=" title="https://hyperledger-fabric.readthedocs.io/en/release-1.4/tutorials.html">https://hyperledger-fabric.readthedocs.io/en/release-1.4/tutorials.html<i class="fa fa-external-link"></i></span></li>
<li>fabric-ca 文档： <span class="exturl" data-url="aHR0cHM6Ly9oeXBlcmxlZGdlci1mYWJyaWMtY2EucmVhZHRoZWRvY3MuaW8vZW4vcmVsZWFzZS0xLjQvdXNlcnMtZ3VpZGUuaHRtbA==" title="https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/users-guide.html">https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/users-guide.html<i class="fa fa-external-link"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>区块链</category>
      </categories>
      <tags>
        <tag>Hyperledger</tag>
        <tag>CHFA</tag>
        <tag>Fabric</tag>
        <tag>fabric-ca</tag>
      </tags>
  </entry>
</search>
